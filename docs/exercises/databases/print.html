<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>COMSM0085 Databases Exercises</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="databases/1/sql-introduction.html"><strong aria-hidden="true">1.</strong> SQL introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/1/setup.html"><strong aria-hidden="true">1.1.</strong> Set up the database</a></li><li class="chapter-item expanded "><a href="databases/1/er-diagram.html"><strong aria-hidden="true">1.2.</strong> ER diagram</a></li><li class="chapter-item expanded "><a href="databases/1/er2.html"><strong aria-hidden="true">1.3.</strong> More modelling</a></li></ol></li><li class="chapter-item expanded "><a href="databases/2/sql-beginners.html"><strong aria-hidden="true">2.</strong> SQL for beginners</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/2/explore-database.html"><strong aria-hidden="true">2.1.</strong> Explore the database</a></li><li class="chapter-item expanded "><a href="databases/2/elections.html"><strong aria-hidden="true">2.2.</strong> Bristol elections</a></li><li class="chapter-item expanded "><a href="databases/2/census.html"><strong aria-hidden="true">2.3.</strong> The UK census</a></li><li class="chapter-item expanded "><a href="databases/2/normalforms.html"><strong aria-hidden="true">2.4.</strong> Normal forms</a></li></ol></li><li class="chapter-item expanded "><a href="databases/3/sql-intermediate.html"><strong aria-hidden="true">3.</strong> Intermediate SQL</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/3/exercises.html"><strong aria-hidden="true">3.1.</strong> Exercises</a></li></ol></li><li class="chapter-item expanded "><a href="databases/4/sql-java.html"><strong aria-hidden="true">4.</strong> SQL and Java</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/4/jdbc.html"><strong aria-hidden="true">4.1.</strong> JDBC</a></li><li class="chapter-item expanded "><a href="databases/4/hibernate.html"><strong aria-hidden="true">4.2.</strong> Hibernate</a></li><li class="chapter-item expanded "><a href="databases/4/sqlite.html"><strong aria-hidden="true">4.3.</strong> SQLite</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">COMSM0085 Databases Exercises</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#introduction-to-sql" id="introduction-to-sql">Introduction to SQL</a></h1>
<p>This is the first of four activities to teach you relational databases and the SQL programming language.</p>
<h2><a class="header" href="#videos" id="videos">Videos</a></h2>
<p>The videos for this activity are:</p>
<table><thead><tr><th>Video</th><th align="right">Length</th><th>Mediasite Link</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/429083c5-b684-4d31-9b8b-44a8cd235423.mp4/QualityLevels(699000)">Installing MariaDB</a></td><td align="right">24 minutes, optional</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/2a24bf2b1190463391295aeb8adc392b1d">mediasite link</a></td><td><a href="https://cs-uob.github.io/COMS10012/slides/MariaDB%20installation.pdf">PDF</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/ad6c51a3-c7ee-4143-875c-7b400815c61d.mp4/QualityLevels(699000)">Introduction to Relational Modelling 1</a></td><td align="right">30 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/43f44fe7c4c3422cbf7faddfa68cebd11d">mediasite link</a></td><td><a href="https://cs-uob.github.io/COMS10012/slides/Relational%20modelling%201.pdf">PDF</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/aaaf526a-eb05-44d8-b25f-55fa121ef494.mp4/QualityLevels(699000)">Introduction to Relational Modelling 2</a></td><td align="right">7 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/dd89be0cabbe409ebda7755f8a8ec8cf1d">mediasite link</a></td><td><a href="https://cs-uob.github.io/COMS10012/slides/Relational%20modelling%202.pdf">PDF</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/54d63f28-708e-406d-a774-45570ca38e88.mp4/QualityLevels(699000)">SQL Create-Drop Scripts</a></td><td align="right">26 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/11542b725bf64dbca856056c705a22261d">mediasite link</a></td><td><a href="https://cs-uob.github.io/COMS10012/slides/CREATE-DROP%20scripts.pdf">PDF</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/b71c5518-25fb-4b94-920d-293bef725846.mp4/QualityLevels(699000)">SQL SELECT</a></td><td align="right">11 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/bdbc27f3871e4555b324b8766d3426711d">mediasite link</a></td><td><a href="https://cs-uob.github.io/COMS10012/slides/SQL%20SELECT.pdf">PDF</a></td></tr>
</tbody></table>
<p>The first video is optional but should help you if you are having problems installing MariaDB on Alpine linux.</p>
<h2><a class="header" href="#exercises" id="exercises">Exercises</a></h2>
<ul>
<li><a href="databases/1/./setup.html">Set up the database</a></li>
<li><a href="databases/1/./er-diagram.html">ER diagrams</a></li>
<li><a href="databases/1/./er2.html">More modelling</a></li>
</ul>
<h1><a class="header" href="#set-up-the-database" id="set-up-the-database">Set up the database</a></h1>
<h2><a class="header" href="#history" id="history">History</a></h2>
<p>In this unit, we will be using the free database MariaDB, which is a clone of MySQL and was written by the same author - Michael &quot;Monty&quot; Widenius, from Finland. The history behind the naming is that Monty first created MySQL (named after his daughter, My) which became the most popular open-source database. He sold MySQL to Sun, who were in turn bought by Oracle - who are famous for their commercial database software. As a result, Monty created a clone of MySQL called MariaDB (named after his other daughter). MySQL and MariaDB are compatible in many ways and most of what we learn on this unit will apply equally to both of them, although both Oracle (for MySQL) and the open-source community (for MariaDB) have added new features to their databases.</p>
<p>Although we will be using MariaDB, in some places the name MySQL will still appear - most notably as the name of the command-line program that you use to access the database.</p>
<h2><a class="header" href="#install-the-database" id="install-the-database">Install the database</a></h2>
<p>Open the Alpine virtual machine and install the database with</p>
<pre><code class="language-sh">$ sudo apk add mariadb mariadb-client
</code></pre>
<p>The <code>mariadb</code> package contains the server that stores the data and lets clients log in. <code>mariadb-client</code> is a command-line client (with the command name <code>mysql</code>); later on we will also use a Java client to access a database from a Java application.</p>
<p>The database server is now installed, but we still need to create a database:</p>
<pre><code class="language-sh">$ sudo /etc/init.d/mariadb setup
</code></pre>
<p>Files in <code>/etc/init.d</code> are service scripts; services are commands that can be started automatically when the machine starts and often run in the background - in this case the mariadb service runs the server so that clients can connect to it. We had to use the full path as the <code>/etc/init.d</code> folder is not normally in your PATH variable, as it's mostly used by the system rather than directly by users. We are manually calling the service's <code>setup</code> command to create the database - if you look inside the service script, you'll see that it calls the <code>mariadb_install_db</code> program to create a database in <code>/var/lib/mysql</code>. This path is not writable for normal users, so we need sudo on this command.</p>
<p>If you read the output of this command, you will see a warning about security. This is important and we will come back to it.</p>
<p>We now have a database, but the server is not running yet. We can start it for now with</p>
<pre><code class="language-sh">$ sudo rc-service mariadb start
</code></pre>
<p>Check that the service is running with</p>
<pre><code class="language-sh">$ rc-status
</code></pre>
<p>This should show <code>mariadb [ started ]</code> somewhere at the bottom under the &quot;manual&quot; runlevel. This means we've started the server, but it won't start automatically next time we restart the machine. Let's change that:</p>
<pre><code class="language-sh">$ sudo rc-update add mariadb default
</code></pre>
<p>This adds the mariadb service to the &quot;default&quot; runlevel, which is for things that you want to start when the machine starts. For example, the ssh service is already here otherwise you would not be able to log in to the machine with <code>vagrant ssh</code> at all. Check with another <code>rc-status</code> that mariadb is still running, but now listed under &quot;default&quot;.</p>
<h2><a class="header" href="#security" id="security">Security</a></h2>
<p>You now have a running database and you can log in with <code>mysql</code>. However, the database will allow anyone to log in and change anything, which is not what you want - especially not on a production machine.</p>
<p>Most distributions come with a <code>mysql_secure_installation</code> script that prompts you for a database root password and sets up accounts. We are going to do a similar thing, but with a custom setup for our purposes.</p>
<p>The setup file is located at the address given below. You can download it for example with <code>wget ADDRESS</code> in Alpine linux; <code>wget</code> is a download program. Place it in the same folder as your Vagrantfile (in <code>/vagrant</code>, if you're doing the download from within Alpine).</p>
<pre><code>https://cs-uob.github.io/COMS10012/resources/databases/secure-setup.sql
</code></pre>
<ul>
<li>Run <code>mysql -u root</code>. This should log you in as root without any authentication, which explains why I am making such a fuss about security! Quit again by typing Control+D.</li>
<li>Run <code>mysql -u root -e 'source /vagrant/secure-setup.sql'</code>. The <code>-e</code> command means &quot;run the following command line argument as a script&quot;, as you know already from sed and several other tools; <code>source</code> means &quot;load a file and run it&quot; and the file in question is part of the lab package I have prepared for you.</li>
<li>Run <code>mysql -u root</code> again. This time, it will not let you in, which is what we want.</li>
</ul>
<p>The secure-setup script is as follows:</p>
<pre><code class="language-sql">UPDATE mysql.user SET Password=PASSWORD('BA/458cR-5p.') WHERE User='root';
DELETE FROM mysql.user WHERE User='';
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
DROP DATABASE IF EXISTS test;
DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
FLUSH PRIVILEGES;
</code></pre>
<p>The first line sets a root password, and also shows the absolute minimum standard for a password: 12 characters, mix of uppercase, lowercase and symbols, random-ish. This is the password that you will be using to log in as root to your database on the VM, but of course you can change it if you want to.</p>
<ul>
<li>Type <code>mysql -u root -p</code> on the command line and press Enter. <code>-p</code> means &quot;if a password is needed, prompt for one&quot;. You will be asked for the root password, type it in (without the quotes) and you should be let back in to the database. Once you are in, if you'd like to, you can use the first command from the secure-setup script to set a new password of your own.</li>
</ul>
<p>The next two lines remove some default users: one with the empty username, and all versions of root that let you log in over the network. The only versions of root that still exist are now &quot;localhost&quot; (e.g. from the same machine), 127.0.0.1 (same thing but using IPV4 notation) and &quot;::1&quot; (same in IPv6). This means that now, if your VM is connected to the internet, you cannot log in as root remotely at all, even with the password, which is the correct attitude to security. To administer a database, you should always first log in to the machine via ssh using a key file, then log in to the database from the machine itself.</p>
<p>Next in the setup script, we remove the default test database and user.</p>
<p>Finally, <code>FLUSH PRIVILEGES</code> updates the in-memory cache of the users table, making your new permissions take effect.</p>
<p>Note: what happens when you install the mariadb package (or install it from a ZIP file) depends on the distribution. For some distributions, installing the package automatically creates a database, and adds the server to the default runlevel. Alpine will not do any of these things for you - you have to configure it itself, which is a good opportunity to learn what's going on behind the scenes in other distributions. Most distributions will not, however, configure the security settings automatically - some of them prompt for a root password at installation, but typically leave the test database and let root login remotely. Wherever you install mariadb or mysql, please check this yourself - an unsecured database is something that hackers will be keeping an eye out for.</p>
<h2><a class="header" href="#importing-sample-data" id="importing-sample-data">Importing sample data</a></h2>
<p>I have prepared some sample data that we will be using in this and the following weeks.</p>
<p>First, download the following two files and place them in the same folder as your Vagrantfile. You can do this the same way as you did before with the secure setup file.</p>
<pre><code>https://cs-uob.github.io/COMS10012/resources/databases/sample-data.sql
https://cs-uob.github.io/COMS10012/resources/databases/sampledata.tar
</code></pre>
<p>If you are using a local copy of this repository, you can also find the files under <code>/resources/databases</code>.</p>
<p>The <code>tar</code> file is a <em>tape archive</em>: a file that contains further files and folders, as if it were a folder itself. Extract it by going to <code>/vagrant</code> in Alpine and run</p>
<pre><code>tar xvf sampledata.tar
</code></pre>
<p>This creates a folder sampledata with the files we need.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Note that <code>tar</code> uses an older convention where options are not prefixed with a dash; the options here are x=extract a file, v=verify (print the name of every processed file to standard output), f=the filename is in the following argument.</p>
<p>To create a tar file yourself, the command would be <code>tar cvf ARCHIVE.tar FILE1 FILE2...</code> where c=create the archive if it doesn't exist, and assume all arguments not consumed by another flag refer to files to be added. In fact, <code>tar xvf ARCHIVE.tar FILES...</code> also works and only extracts the named files from the archive.</p>
</div>
</div>
<p>Load the sample data with the following command, which will ask for your root password:</p>
<pre><code class="language-sh">$ mysql -u root -p -e &quot;source /vagrant/sample-data.sql&quot;
</code></pre>
<p>This pulls in some data in CSV files (have a look at the script if you want) and creates a default user &quot;vagrant&quot; who can log in to the database without a password, but can only read and not write the two sample databases &quot;census&quot; and &quot;elections&quot;. There is another database called &quot;data&quot; which starts out empty, and &quot;vagrant&quot; can both read and write it.</p>
<p>You can now log in to the database and try the following:</p>
<ul>
<li><code>mysql</code> on its own logs you in, you now get the database prompt <code>MariaDB [(none)]&gt;</code> to show that you haven't loaded a particular database yet.</li>
<li><code>SHOW DATABASES;</code> on the database prompt gives you a list of databases which you have access too.</li>
<li>Select one with the USE command, for example <code>USE elections;</code>. Your prompt should now read <code>MariaDB [elections]&gt;</code>.</li>
<li><code>SHOW TABLES;</code> will show the tables in the selected database.</li>
<li>There's a Party table in the elections database, so <code>SELECT * FROM Party;</code> will show you the data.</li>
<li>You could also use <code>DESCRIBE Party;</code> to show a list of columns and types in the Party table.</li>
<li>Finally, <code>exit</code> or Control+D on a line of its own gets you back to the shell.</li>
</ul>
<p>You can open the SQL and CSV files under <code>/vagrant/sampledata</code> to compare with the output you get from MariaDB. Study this until it makes sense to you. The <code>setup.sql</code> files contain the database schemas and the <code>import.sql</code> ones pull in the sample data.</p>
<h2><a class="header" href="#on-a-lab-machine" id="on-a-lab-machine">On a lab machine</a></h2>
<p>On a lab machine, to save disk space your VMs may not remain between reboots - and because they are not hosted on the network file system, if you log in to a different machine next time, your changes will not be saved either but you will get the VM reinstalled from scratch. To make sure the database is ready whenever you need it, open the <code>Vagrantfile</code> in a text editor and make the following changes.</p>
<ul>
<li>On the line starting <code>apk add</code>, add the packages <code>mariadb</code> and <code>mariadb-client</code> to the end, separated by spaces.</li>
<li>Download and save the three setup files (<code>sample-data.sql</code>, <code>secure-setup.sql</code> and <code>sampledata.tar</code>) in the same folder as your Vagrantfile (this is on the host machine, so it will not get deleted along with the VM).</li>
<li>Extract the tar file so that there is a folder <code>sampledata/</code> in the same folder as your Vagrantfile.</li>
<li>Following the <code>apk add</code> line in your Vagrantfile, add the following lines:</li>
</ul>
<pre><code class="language-sh">/etc/init.d/mariadb setup
rc-update add mariadb default
rc-service mariadb start
mysql -u root -e 'source /vagrant/sample-data.sql'
mysql -u root -e 'source /vagrant/secure-setup.sql'
</code></pre>
<p>This ensures that whenever vagrant recreates the VM, it installs the database for us. The commands are basically the ones that we have done just now, except that we source the sample data before running the secure setup. This is so that the sample data command does not need a password, as none has been set so far - that only happens during the secure setup command.</p>
<h1><a class="header" href="#reading-an-er-diagram" id="reading-an-er-diagram">Reading an ER diagram</a></h1>
<p>Here is an ER diagram for a fictional university database:</p>
<p><img src="databases/1/../img/uni-diagram.png" alt="ER diagram" /></p>
<p>The foreign key columns are not included in the tables - in this diagram, they are implied by the relationships, e.g. the <code>Unit.director</code> column comes from the &quot;directs&quot; relationship.</p>
<p>Looking at the diagram and the table schemas, answer the following questions for yourself:</p>
<ul>
<li>Which relationships are mandatory or optional? (For example, must every unit have at least one student enrolled?)</li>
<li>Which relationships are one-one, one-many or many-many?</li>
<li>How do the above affect the placement of foreign keys? For example, why is the foreign key for &quot;lecturer belongs to research group&quot; on the Lecturer table?</li>
</ul>
<h1><a class="header" href="#drawing-an-er-diagram" id="drawing-an-er-diagram">Drawing an ER diagram</a></h1>
<p>Draw an ER diagram for the following scenario.</p>
<blockquote>
<p>The University of Bristol Hoverboard Society (HovSoc) wants to create a database to manage its membership and events. Each member has a name, an optional student number, a contact e-mail address and a hoverboard riding skill level (represented as an integer, minimum 0). We assume that e-mail addresses are unique among members.</p>
<p>The committee consists of some of the members, each of which has a unique committee role. We assume that committee roles do not change during the year and that each committee role must be filled every year.</p>
<p>An event has a date, a name, a location, an optional description and an organiser who must be a society member (not necessarily a committee member). An event is attended by a set of members. There is never more than one event at the same location on the same date but event names are not unique.</p>
</blockquote>
<p>You can draw the diagram with pen and paper or you can use a free modelling tool like <a href="https://draw.io">draw.io</a>. </p>
<ul>
<li>For draw.io, open the &quot;Entity Relation&quot; section in the menu on the left and use the &quot;Table&quot; (first item) object for tables. Clicking on it adds a table to your diagram.</li>
<li>To add a row to a table, select an existing row and press Control-D (duplicate item). To delete a row, press the delete key.</li>
<li>To add a relationship, select a table by clicking its header and drag one of the blue triangles that appear round the edges onto another table. You can change the type of a relationship in the details panel on the right (the &quot;line start&quot; and &quot;line end&quot; boxes).</li>
<li>File/Save as lets you download your diagram in an XML-based format, which you can open and edit later. File/Export as lets you download it as an image.</li>
</ul>
<h1><a class="header" href="#implementing-a-schema" id="implementing-a-schema">Implementing a Schema</a></h1>
<p>Write a CREATE/DROP script for the schema that you have just designed.</p>
<ul>
<li>A create/drop script starts with a sequence of DROP TABLE IF EXISTS statements followed by a sequence of CREATE TABLE scripts. The effect of running it is to make sure all tables exist and are empty, whether or not the tables existed before.</li>
<li>If table A has a foreign key to table B then you must create table B before A and drop table A before dropping B. The simple way to do this is work out the CREATE order, then put all DROP statements in the exact opposite order.</li>
</ul>
<p>Save your script as a file (the extension <code>.sql</code> is usual for SQL scripts).</p>
<p>To test that it works, log in to the database with <code>mysql</code> on the command line in the lab machine, from a terminal in the same folder as your create/drop script. Then run the command</p>
<pre><code>USE data;
</code></pre>
<p>to select the (initially empty) database called <code>data</code>, on which you have read and write permissions. Note that there is a semicolon at the end.</p>
<p>As long as you started your MariaDB session in the folder with your script, you can now run the command <code>\. SCRIPTNAME.SQL</code>, that is a backslash, a period, a space and then the name of the script. As this is a command directly for the MariaDB client rather than a command to be run on the server, it does not take a semicolon.</p>
<p>If you get any errors, then <code>SHOW ERRORS;</code> will display more information. If not, check with <code>SHOW TABLES;</code> that your tables exist.</p>
<p>Now, run the script a second time. If the order of all commands is correct, then it should run through again without errors.</p>
<h1><a class="header" href="#more-modelling" id="more-modelling">More modelling</a></h1>
<p>Using what you have learnt so far about relational modelling, think about and discuss in groups how you would model a university database to store student's academic progress, such as units enrolled on and completed, marks obtained etc. based on your understanding of how the University of Bristol works. For example, a unit can have different assessments with different weights. You will of course also need a <code>Students</code> table, and you can make the model more involved if you like by including that different students are on different degree programmes, and that sometimes students have to resit units.</p>
<p>You should end up with a more detailed version of the model briefly shown at the top of the previous page - if you have the time you can make both an ER diagram and a create/drop script.</p>
<p>This is also a good point to mention another fact of how marks and credit points work: exam boards. At the end of each academic year around May, your unit directors all report their marks for each student to an exam board, which sits and decides on final marks and awarding credit. For example, an exam board can moderate the marks for a unit. This is why you do not get your exam marks until a long time after the exam has happened, even if it's a multiple choice exam that can be marked automatically: the marks still have to go through an exam board. (There is another, smaller exam board around the start of Teaching Block 2 so you don't have to wait until summer for your January exam marks to be released.)
If you want to model this in your schema, the idea here is that a student has two marks associated with each unit: the &quot;actual mark&quot; (the input to the exam board) and the &quot;agreed mark&quot; (the one that comes out of the board and goes on your transcript). Of course, for most students most of the time, the two are the same. Your schema will need to store &quot;agreed marks&quot; explicitly, but there are ways of doing the model that does not store the &quot;actual mark&quot; directly. Think about how you could recompute it from other information in the database - we will of course learn how to do this in SQL in a later activity.</p>
<p>The key idea in relational modelling is not to store information more than once if you can avoid it. If you have stored in several places that Fred is taking Introduction to Programming, and then Fred switches his units, you don't want to end up with a situation where this change is only reflected in some parts of the database.</p>
<h1><a class="header" href="#sql-for-beginners" id="sql-for-beginners">SQL for beginners</a></h1>
<p>This is the second activity of four to teach you relational databases and the SQL programming language.</p>
<h2><a class="header" href="#videos-1" id="videos-1">Videos</a></h2>
<p>The videos for this activity are:</p>
<table><thead><tr><th>Video</th><th align="right">Length</th><th>Mediasite Link</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/bab37acb-e69a-4718-8ba8-a2dceee71a99.mp4/QualityLevels(699000)">SQL JOIN, part 1</a></td><td align="right">10 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/87fc5f25f4d446f99149a58289899e8d1d">mediasite link</a></td><td><a href="https://cs-uob.github.io/COMS10012/slides/SQL%20JOIN%20part%201.pdf">PDF</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/ab90d187-69b6-43fa-a9ed-3a9a9ea0a3b3.mp4/QualityLevels(699000)">SQL JOIN, part 2</a></td><td align="right">10 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/26c1ecb043034568987acc2d3eedc8371d">mediasite link</a></td><td><a href="https://cs-uob.github.io/COMS10012/slides/SQL%20JOIN%20part%202.pdf">PDF</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/f050a7fb-3341-44ab-84f0-59268215ed70.mp4/QualityLevels(699000)">SQL ORDER BY</a></td><td align="right">9 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/135220e25bf542099703ca40a900722e1d">mediasite link</a></td><td><a href="https://cs-uob.github.io/COMS10012/slides/SQL%20ORDER%20BY.pdf">PDF</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/d68cd782-7813-4280-b650-6111bed23469.mp4/QualityLevels(699000)">Normal Forms</a></td><td align="right">56 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/6a2edd198312428e846371a3bfd0625c1d">mediasite link</a></td><td><a href="https://cs-uob.github.io/COMS10012/slides/Normal%20forms.pdf">PDF</a></td></tr>
</tbody></table>
<p>The normal forms one continues where the introduction to relational modelling left off. It is a long but connected piece of content (1 hour) that you will probably want to watch pieces of several times.</p>
<h2><a class="header" href="#exercises-1" id="exercises-1">Exercises</a></h2>
<ul>
<li><a href="databases/2/./explore-database.html">Explore the database</a></li>
<li><a href="databases/2/./elections.html">Bristol elections</a></li>
<li><a href="databases/2/./census.html">The UK census</a></li>
<li><a href="databases/2/./normalforms.html">Normal forms</a></li>
</ul>
<h1><a class="header" href="#explore-the-database" id="explore-the-database">Explore the database</a></h1>
<p>Open the virtual machine and type <code>mysql</code>. Assuming you have installed the database correctly as in the previous activity, you should see the prompt <code>MariaDB [(none)]&gt;</code> which shows that you are connected to a database server but you have not selected a database yet.</p>
<p>Have a look at the databases that exist with the command</p>
<pre><code>SHOW DATABASES;
</code></pre>
<p>Like all SQL commands, it needs a semicolon at the end. You should see four databases including <code>census</code> and <code>elections</code>. Let's select one of them:</p>
<pre><code>USE elections;
</code></pre>
<p>SQL keywords like <code>USE</code> are not case-sensitive, but it is convention to write them in all upper case. SQL names of tables, columns etc. like <code>elections</code> however are case-sensitive. Your prompt should now show <code>MariaDB [elections]&gt;</code>.</p>
<p>Have a look at the tables in this database with</p>
<pre><code>SHOW TABLES;
</code></pre>
<p>You should see <code>Candidate</code>, <code>Party</code> and <code>Ward</code>. Let's have a look at one:</p>
<pre><code>DESCRIBE Candidate;
</code></pre>
<p>The output will look like this:</p>
<pre><code>+-------+--------------+------+-----+---------+----------------+
| Field | Type         | Null | Key | Default | Extra          |
+-------+--------------+------+-----+---------+----------------+
| id    | int(11)      | NO   | PRI | NULL    | auto_increment |
| name  | varchar(100) | NO   | UNI | NULL    |                |
| party | int(11)      | YES  | MUL | NULL    |                |
| ward  | int(11)      | YES  | MUL | NULL    |                |
| votes | int(11)      | YES  |     | NULL    |                |
+-------+--------------+------+-----+---------+----------------+
</code></pre>
<p>The first two columns tell you the names and types of columns in this table. The third column (Null) tells you if NULL values are allowed in this column. The Key column tells us that id is the primary key (PRI), name has a unique constraint (UNI), party and ward are foreign keys (MUL) and there are no key constraints at all on votes.</p>
<p>For even more information, try this:</p>
<pre><code>SHOW CREATE TABLE Candidate;
</code></pre>
<p>The output is a bit messy but it shows you (more or less) the statement used to create the table. From here we can read off the details of the foreign keys:</p>
<pre><code>CONSTRAINT `Candidate_ibfk_1` FOREIGN KEY (`party`) REFERENCES `Party` (`id`)
CONSTRAINT `Candidate_ibfk_2` FOREIGN KEY (`ward`) REFERENCES `Ward` (`id`)
</code></pre>
<p>So the <code>party</code> column is a foreign key pointing at the <code>id</code> column in the <code>Party</code> table.</p>
<p>Now let's look at some data. This command shows you all entries in the Candidate table:</p>
<pre><code>SELECT * FROM Candidate;
</code></pre>
<p>There are 141 entries. Looking at the first one:</p>
<pre><code>+-----+--------------------------------+-------+------+-------+
| id  | name                           | party | ward | votes |
+-----+--------------------------------+-------+------+-------+
|   1 | Patrick Dorian Hulme           |     1 |    1 |    16 |
</code></pre>
<p>The party and ward ids on their own don't tell us much, but as they are foreign keys we can use them to join on the tables that do contain this information:</p>
<pre><code>SELECT * FROM Candidate
INNER JOIN Party ON Party.id = Candidate.party
INNER JOIN Ward ON Ward.id = Candidate.ward;
</code></pre>
<p>On the MariaDB prompt, if you don't end with a semicolon then the program assumes you want to type a command over multiple lines, and shows the continuation prompt <code>-&gt;</code> for the next ones. This also allows you to copy-paste multi-line commands from a text editor into the MariaDB client. Ending a line with a semicolon executes the query and drops you back to the main prompt.</p>
<p>You will now see a much longer listing, starting like this (I have shortened some columns):</p>
<pre><code>+-----+----------------------+-------+------+-------+----+--------------+----+-----------+------------+
| id  | name                 | party | ward | votes | id | name         | id | name      | electorate |
+-----+----------------------+-------+------+-------+----+--------------+----+-----------+------------+
|   7 | Matthew Simon Melias |     7 |    1 |  1067 |  7 | Conservative |  1 | Avonmouth |       9185 |
</code></pre>
<p>The first thing to note is that the results are no longer in the same order: P. D. Hulme is no longer at the top. Unless you tell the database that you want a particular order, it is allowed to choose its own one and depending on what joins you do, this might change.</p>
<p>There are several columns here named id, one from each of the tables - in general, doing <code>SELECT *</code> on a joined table gets you more data than you need.
This would be a nicer query unless you're actially interested in the ids:</p>
<pre><code>SELECT Candidate.name AS name,
Party.name AS party,
Ward.name AS ward,
votes,
electorate
FROM Candidate
INNER JOIN Party ON Party.id = Candidate.party
INNER JOIN Ward ON Ward.id = Candidate.ward;
</code></pre>
<p>Here is the start of the output that I get:</p>
<pre><code>+----------------------+--------------+-----------+-------+------------+
| name                 | party        | ward      | votes | electorate |
+----------------------+--------------+-----------+-------+------------+
| Matthew Simon Melias | Conservative | Avonmouth |  1067 |       9185 |
</code></pre>
<p>Explore the elections database a bit to get a feel for how the data is structured.
For example, what party and ward did Patrick Dorian Hulme from above stand for?
What is the schema of the elections database - you might want to draw a diagram?</p>
<h1><a class="header" href="#bristol-elections" id="bristol-elections">Bristol elections</a></h1>
<p>In 2014, Bristol held council elections for 24 of its wards. Each ward elected one councillor to represent the ward on the city council. The results are in the <code>elections</code> database, with the following schema as you have hopefully just discovered:</p>
<p><img src="databases/2/../img/elections.png" alt="elections ER diagram" /></p>
<p>From an ER diagram you can derive a <em>JOIN strategy</em>, a way of representing all the useful information in a database. For individual queries, you may only need a subset of this information so you can leave off unnecessary parts of the full JOIN strategy. In this case, the following would work:</p>
<pre><code>SELECT Candidate.name AS name, Party.name AS party, Ward.name AS ward, Candidate.votes, Ward.electorate
FROM Candidate 
INNER JOIN Party ON Candidate.party = Party.id
INNER JOIN Ward ON Candidate.ward = Ward.id
</code></pre>
<h2><a class="header" href="#exercises-2" id="exercises-2">Exercises</a></h2>
<p>Find SQL statements to answer the following questions. Your answer to each question should be a single query, and you should not hard-code any ids. For example, if a question is about the Labour party, you should use the string <code>'Labour'</code> in your query somewhere, not look up the party id and hard-code that in your query.</p>
<p>Although you can answer all the exercises in this section by taking the join strategy and adding clauses where necessary, there is sometimes a quicker way. But if you don't know where to start, consider how you would extract the result you want from the joined table. The WHERE clause determines which rows appear in the result and the SELECT clause picks the columns that appear in the result.</p>
<ol>
<li>List the names of all parties that stood in the election, ordered alphabetically by name.</li>
<li>List the names of all parties that stood in the Bedminster ward.</li>
<li>How many votes did Labour get in the Stockwood ward?</li>
<li>List the names, parties and number of votes obtained for all candidates in the Southville ward. Order the candidates by number of votes obtained descending (winner comes first).</li>
<li>List the name, party and number of votes obtained for the winner only in the Knowle ward. <em>(Hint: apart from changing the ward name, you only need one small modification to the statement from the last question. You may assume no ties.)</em></li>
</ol>
<h1><a class="header" href="#the-2011-uk-census" id="the-2011-uk-census">The 2011 UK Census</a></h1>
<p>In 2011, the UK took a census of all households. We will look at the data for one particular question: &quot;KS608 Occupation&quot;.</p>
<h2><a class="header" href="#background-uk-geography" id="background-uk-geography">Background: UK Geography</a></h2>
<p>The United Kingdom of Great Britain and Northern Ireland (UK) is a country that contains the individual countries England, Wales, Scotland (at the time of writing) and Northern Ireland (but not the Republic of Ireland). The census data for this question comes from the Office of National Statistics (ONS) which is for England and Wales only. Scotland and Northern Ireland have separate statistical offices.</p>
<p>England itself can be divided into 9 regions: </p>
<ul>
<li>The North West</li>
<li>Yorkshire and The Humber</li>
<li>The North East</li>
<li>The West Midlands</li>
<li>The East Midlands</li>
<li>The South West</li>
<li>The East</li>
<li>The South East</li>
<li>London</li>
</ul>
<p>The UK used to be further divided into counties but these are much less important nowadays. In fact there is a mix of counties, unitary authorities and boroughs - 152 in total. These are all called &quot;county-level units&quot; (CLUs).</p>
<p>The smallest relevant unit for political and statistical purposes is the electoral ward, often simply called ward. Wards elect their own councillors (as we have seen) and national statistics are available at a ward level. There were 8570 wards at the time of the 2011 census. For example, the City of Bristol unitary authority contained 35 wards, of which the University of Bristol was in the Cabot ward.</p>
<p>Each statistical unit (ward, county, unitary authority etc.) is assigned a 9-character code by the ONS of the form <code>Xaabbbbbb</code> where X is E for England and W for Wales. The first two digits <code>aa</code> identify the type of unit: 05 is a ward, 06 a unitary authority; in England only E12 is a region, E08 is a borough (metropolitan), E09 is a borough of London and E10 is a county. The last 6 digits identify the individual unit. Finally, the codes for all of England and Wales are E92000001 and W92000004. </p>
<p>An interactive online map of the statistical units of the UK is available online at <a href="http://ukdataexplorer.com/census/">UK data explorer</a> or <a href="https://datashine.org.uk">DataShine</a>. All census data for individual questions is publicly available. (The most interesting data - correlations between questions - is not all openly available due to privacy issues. Researchers can apply to the ONS to get access to particular data sets.)</p>
<h2><a class="header" href="#data-format" id="data-format">Data format</a></h2>
<p>The <code>census</code> database has the following schema.</p>
<p><img src="databases/2/../img/census.png" alt="census ER diagram" /></p>
<p>For wards in England, the <code>parent</code> FK points at the county table and identifies the CLU (county-level unit) to which the ward belongs. For wards in Wales, the <code>Ward.parent</code> column is <code>NULL</code> which you need to take into account when working out a JOIN strategy.</p>
<h2><a class="header" href="#ks608-occupation" id="ks608-occupation">KS608: Occupation</a></h2>
<p>Question KS608 on the 2011 census asked all UK citizens in employment and between the ages of 16 and 74 to classify themselves as one of 9 occupation classes.</p>
<ul>
<li>Have a look at the <code>Occupation</code> table in the <code>census</code> database to see the 9 occupation classes.</li>
</ul>
<p>The answers to the question are recorded in the <code>Statistic</code> table in the following format. Gender is 1 for women an 0 for men; in the 2011 census these where the only gender options.</p>
<pre><code>+-----------+-------+--------+------+
| wardId    | occId | gender | data |
+-----------+-------+--------+------+
| E05000001 |     1 |      1 |   54 |
+-----------+-------+--------+------+
</code></pre>
<p>This row records that in ward <code>E05000001</code> (Aldersgate), 54 women (gender=1) said that they worked as &quot;Managers, directors and senior officials&quot; (occId=1).</p>
<p>Note how (in the ER diagram) the primary key of the Statistic table is a composite of three columns (wardId, occId, gender). This is exactly what you would expect in a table that has one data value per ward, occupation class and gender.</p>
<h2><a class="header" href="#exercises-3" id="exercises-3">Exercises</a></h2>
<ol>
<li>The university of Bristol is situated in the <code>Cabot</code> ward (ward names are not always distinct, but this one is). Find the names and codes of the CLU, region and country containing the Cabot ward (CLU = county level unit = &quot;row in County table&quot;).</li>
<li>If you used multiple SQL queries for the last question, do it in one single query now. (In other words, find a join strategy for the tables you need.)</li>
<li>Find the number of women in occupation class 1 (managers etc.) in the Cabot ward. You may use ward code for Cabot that you found in the first query and the occupation id 1 directly - you do not need any JOINs for this query.</li>
<li>For the Stoke Bishop ward (E05002003), list the 9 occupation class names and the number of men in each occupation. Your table should have two columns called <code>name</code> and <code>number</code>. You can use the provided ward code, you do not need to join on the ward name.</li>
</ol>
<p>We will soon be able to do more interesting statistical queries on the census data but for that we need SQL's statistical functions which we will learn next week.</p>
<p>Here's a slightly more tricky question to finish off with. It can be done with only the techniques that we have learnt so far.</p>
<ul>
<li>Find all ward names that are not unique, and print them in alphabetical order (only once each).</li>
</ul>
<p><em>There are 400 distinct such names in total (for example, there are 21 wards called 'Abbey') so your query will produce quite a long table. Your query might also take a while to execute, there are faster ways to do this but not with the material we've learnt so far. The table starts &quot;Abbey, Alexandra, All Saints&quot; and ends &quot;Worsley, Wyke, Yarborough&quot;.</em></p>
<h1><a class="header" href="#normal-forms" id="normal-forms">Normal Forms</a></h1>
<p>For this exercise, you may want to work in groups. There are two schemas, for both of which you have to decide which normal form(s) they are in, and how you would change the schemas to be in 3NF (BCNF if possible).</p>
<p>The standard way of doing this is:</p>
<ol>
<li>Identify the candidate key(s) in every table. </li>
<li>From this, deduce the key and non-key attributes in every table. </li>
<li>Find the functional dependencies (FDs) in each table.</li>
<li>Determine which normal forms from (1NF, 2NF, 3NF, BCNF) the schema does or does not satisfy.</li>
<li>If the schema is not in BCNF, normalise it as far as possible by splitting tables using Heath's Theorem on the FDs that are causing the problem.</li>
</ol>
<h2><a class="header" href="#schema-1" id="schema-1">Schema 1</a></h2>
<p>A school's database looks like this (it was set up by someone more used to spreadsheets): </p>
<table><thead><tr><th>stuId</th><th>name</th><th>gender</th><th>unit</th><th>grade</th></tr></thead><tbody>
<tr><td>101</td><td>Fred</td><td>M</td><td>Mathematics</td><td>75</td></tr>
<tr><td>101</td><td>Fred</td><td>M</td><td>German</td><td>65</td></tr>
<tr><td>101</td><td>Fred</td><td>M</td><td>English</td><td>90</td></tr>
<tr><td>102</td><td>Sam</td><td>X</td><td>Mathematics</td><td>60</td></tr>
<tr><td>102</td><td>Sam</td><td>X</td><td>English</td><td>60</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
</tbody></table>
<p>stuId is a student id that is unique per student. Students' names are not required to be unique, i.e. you can have two 'Fred's in the school. Gender is one of {M, F, X}. For each student and each unit they take, there is one row containing among other things the student name, unit name and the grade (0-100) that the student got on this unit. In the example above, we can see that Fred took three units (Mathematics, German and English). No two units have the same name but a unit name can appear several times in the database since many students can take the same unit. The first row of the example tells us that there is a student called Fred with id 101, who is male, and took the Mathematics unit and got a grade of 75 on it. </p>
<h2><a class="header" href="#schema-2" id="schema-2">Schema 2</a></h2>
<p>The CIA world factbook contains geographical, political and military information about the world. Here is part of one table listing principal cities from 2015:</p>
<table><thead><tr><th>*city</th><th>country</th><th align="right">pop</th><th align="right">co_pop</th><th>capital</th></tr></thead><tbody>
<tr><td>...</td><td>...</td><td align="right">...</td><td align="right">...</td><td>...</td></tr>
<tr><td>Paris</td><td>France</td><td align="right">10.8M</td><td align="right">66.8M</td><td>yes</td></tr>
<tr><td>Lyon</td><td>France</td><td align="right">1.6M</td><td align="right">66.8M</td><td>no</td></tr>
<tr><td>Marseille</td><td>France</td><td align="right">1.6M</td><td align="right">66.8M</td><td>no</td></tr>
<tr><td>Papeete</td><td>French Polynesia</td><td align="right">133K</td><td align="right">285K</td><td>yes</td></tr>
<tr><td>Libreville</td><td>Gabon</td><td align="right">707K</td><td align="right">1.7M</td><td>yes</td></tr>
<tr><td>...</td><td>...</td><td align="right">...</td><td align="right">...</td><td>...</td></tr>
</tbody></table>
<p>We will assume for this exercise that city names are globally unique and therefore the &quot;City&quot; column has been chosen as the primary key for this table. The &quot;pop&quot; column lists the city's population and the &quot;co_pop&quot; lists the population of the country in which the city is located (with abbreviations K = 1000, M=1000000). The &quot;capital&quot; column is a Boolean yes/no value that is set to &quot;yes&quot; for exactly one city in each country. (While the capital is included in the table for every country however small, non-captial cities are only included if they are of international significance.)</p>
<h1><a class="header" href="#intermediate-sql" id="intermediate-sql">Intermediate SQL</a></h1>
<p>This is the third of four activities to teach you relational databases and SQL.</p>
<h2><a class="header" href="#videos-2" id="videos-2">Videos</a></h2>
<p>The videos for this activity are:</p>
<table><thead><tr><th>Video</th><th align="right">Length</th><th>Mediasite Link</th></tr></thead><tbody>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/95f4f114-d85c-47f5-a533-0cb32f69b58c.mp4/QualityLevels(698000)">SQL insert/delete</a></td><td align="right">8 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/4f83435e7b3d46299042952b63d010bf1d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/f477bbcf-dbc3-4ca3-b684-679df2b7bfae.mp4/QualityLevels(698000)">SQL subqueries</a></td><td align="right">13 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/8b40ddf3273c4d4684a17a0d915b9fba1d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/abdfca9a-7cc2-489e-ab55-bf4033a89ee2.mp4/QualityLevels(698000)">SQL statistics</a>)</td><td align="right">22 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/deb1e6b1bf0542ebaabf0b60849e1a181d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/48f9ce6e-ae99-47e3-9e7f-2a91f7fd4f11.mp4/QualityLevels(698000)">SQL NULL</a></td><td align="right">7 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/2530533262754ce0a05e801f45562be41d">mediasite link</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/7e570b3a-50d1-4547-8c31-bc6df22f43b3.mp4/QualityLevels(698000)">SQL tips</a></td><td align="right">17 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/df78631257674700916b7bc94ba67ea31d">mediasite link</a></td></tr>
</tbody></table>
<h2><a class="header" href="#exercises-4" id="exercises-4">Exercises</a></h2>
<p>The exercises for this activity are all on one page:</p>
<ul>
<li><a href="databases/3/./exercises.html">Intermediate SQL</a></li>
</ul>
<h1><a class="header" href="#census-and-elections-exercises" id="census-and-elections-exercises">Census and elections exercises</a></h1>
<p>Here are some more advanced exercises based on the census and elections schemas from the last activity.</p>
<p>Your answer to each question should be a single SQL query, that is one semicolon at the end. JOINs, subqueries, WITH clauses etc. are allowed of course.
Where an identifier is given in the question you may use it, e.g. when I say &quot;the Cabot ward (E05001979)&quot; you can use the ward id directly and do not need to join on the ward table to look up the name, but if I say &quot;the Green party&quot; then you do need to join on the party table to look up the name instead of hard-coding the party id.</p>
<h2><a class="header" href="#elections" id="elections">Elections</a></h2>
<p><img src="databases/3/../img/elections.png" alt="elections ER diagram" /></p>
<ol>
<li>How many votes were cast in all of Bristol in the 2014 elections?</li>
<li>How many votes were cast in the 'Windmill Hill' ward and what percentage of the electorate in this ward does this represent? Your statement should produce a table with one row and two columns called 'votes' and 'percentage'.</li>
<li>List the names, parties and <em>percentage</em> of votes obtained for all candidates in the Southville ward. Order the candidates by percentage of votes obtained descending.</li>
<li>How successful (in % of votes cast) was the Conservative party in each ward?</li>
<li>Which rank did Labour end up in the 'Whitchurch Park' ward? Your statement should produce a table with a single row and column containing the answer as a number. You can assume no ties.</li>
<li>What is the total number of votes that each party got in the elections? Your result should be a table with two columns party, votes.</li>
<li>Find all wards where the Green party beat Labour and create a table with two columns ward, difference where the difference column is the number of Green votes minus the number of Labour votes. Your table should be ordered by difference, with the highest one first.</li>
</ol>
<h2><a class="header" href="#census" id="census">Census</a></h2>
<p><img src="databases/3/../img/census.png" alt="census ER diagram" /></p>
<ol>
<li>How many <em>women</em> work in sales and customer service occupations and live in the Cabot ward of Bristol (E05001979)?</li>
<li>How many <em>people</em> work in sales and customer service occupations and live in the Cabot ward of Bristol (E05001979)?</li>
<li>How many people work in caring, leisure and other service occupations (occupation class 6) in all of the City of Bristol CLU (E06000023)? </li>
<li>In the Cabot ward (E05001979), produce a table listing the names of the 9 occupation classes and the number of people in each of the classes in this ward.</li>
<li>Find the working population, ward name and CLU name for the smallest ward (by working population) in the 2011 census.</li>
<li>The same as the last question, but now produce a table with two rows, one for the smallest and one for the largest ward. There's no quicker way than repeating the last query twice, the question is how to stick the two &quot;copies&quot; together.</li>
<li>Find the average size of a ward's working population in the London (E12000007) region.</li>
<li>The same as the last question but now for every region - your query should produce a table with one row per region. The intention here is <em>not</em> to repeat the above query 9 times.</li>
<li>Produce a table that lists, for each of the 9 regions of England, the percentage of people in managerial (class 1) occupations who are women.</li>
<li>For all CLUs in the London (E12000007) region, produce a table with three columns called <code>CLU</code>, <code>occupation</code> and <code>count</code> such that:
<ul>
<li><code>CLU</code> is the CLU name.</li>
<li><code>count</code> is the number of people of the occupation class in question in the given CLU.</li>
<li><code>occupation</code> is the name of the occupation class.</li>
<li>Only rows with <code>count &gt;= 10000</code> appear in the table.</li>
<li>The table is sorted by <code>count</code> ascending.</li>
</ul>
</li>
<li>Create a table with three columns <code>occupation</code>, <code>women</code> and <code>men</code> and one row per occupation class. The <code>occupation</code> column should list the occupation class names. The <code>women</code> and <code>men</code> columns in each row should list the total number of women resp. men in the row's occupation class in the whole dataset. The intention here is not to have to copy-paste a subquery 9 times.</li>
<li>The same as question 9, but now with a 10th row in the table listing the value for all of England. You can use the string <code>'England'</code> for the region column.</li>
</ol>
<h1><a class="header" href="#sql-and-java" id="sql-and-java">SQL and Java</a></h1>
<p>In this activity you will learn how to connect to an SQL database from a Java program using the JDBC interface and the Hibernate ORM.</p>
<h2><a class="header" href="#videos-3" id="videos-3">Videos</a></h2>
<p>The videos for this activity are:</p>
<table><thead><tr><th>Video</th><th align="right">Length</th><th>Mediasite Link</th></tr></thead><tbody>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/be367d65-a5a2-4f4f-830e-0ed927529394.mp4/QualityLevels(698000)">JDBC</a></td><td align="right">27 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/cedf58e80c864e45a14701f27820b5cf1d">mediasite</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/77bd3dff-6d29-4c08-9daa-b36f83ee7cd3.mp4/QualityLevels(698000)">Hibernate</a></td><td align="right">19 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/6dfd04f0ea2a4ecc8b864ca8c0d127021d">mediasite</a></td></tr>
<tr><td><a href="https://ams-hsta-ims-ond.mediasite.com/MediasiteDeliver/vol01/bristoluniversity/MP4Video/1341a6b4-1fdb-49a2-b5f4-50eabbc8eaf9.mp4/QualityLevels(698000)">SQLite</a></td><td align="right">13 minutes</td><td><a href="https://mediasite.bris.ac.uk/Mediasite/Play/2d38e379917043b18447e46b96cc5fe61d">mediasite</a></td></tr>
</tbody></table>
<h2><a class="header" href="#exercises-5" id="exercises-5">Exercises</a></h2>
<p>The exercises for this activity are:</p>
<ul>
<li><a href="databases/4/./jdbc.html">JDBC</a></li>
<li><a href="databases/4/./hibernate.html">Hibernate</a></li>
<li><a href="databases/4/./sqlite.html">SQLite</a></li>
</ul>
<h1><a class="header" href="#jdbc" id="jdbc">JDBC</a></h1>
<p>In this activity you will learn to connect to a SQL database using Java and the JDBC classes.
JDBC (Java DataBase Connectivity) is a low-level, not particularly object-oriented mechanism for accessing a database, on top of which other systems (e.g. Hibernate ORM) can be built.</p>
<h2><a class="header" href="#jdbc-interfaces" id="jdbc-interfaces">JDBC Interfaces</a></h2>
<p>The JDBC classes live in the <code>java.sql</code> package. Most methods on these classes can throw a <code>SQLException</code> which is a checked exception, meaning your code won't compile if you don't handle it. For simple programs, this means wrapping in a <code>RuntimeException</code> to terminate the program if something goes wrong:</p>
<pre><code class="language-java">try {
    // do stuff with JDBC
} catch (SQLException e) {
    throw new RuntimeException(e);
}
</code></pre>
<p>Two comments on this pattern:</p>
<ol>
<li>In a real program e.g. web server, you of course do not want to take the server down whenever an individual method causes an error. Here you need to do something like log the error, and display an error message to that particular caller (e.g. HTTP 500 Internal Server Error) while keeping the rest of the server running. How you achieve this depends on which libraries or frameworks you are using.</li>
<li>Most JDBC work will actually take place in try-with-resources blocks, which work the same as far as exception handling is concerned but have an extra bracketed term immediately after the <code>try</code>.</li>
</ol>
<h2><a class="header" href="#try-with-resources" id="try-with-resources">Try-with-resources</a></h2>
<p>A resource is something that you need to close exactly once when you are done with it, but only if it got properly opened in the first place. For example, in C heap memory is a resource: you acquire (open) it with <code>malloc</code>, and when you are done you must call <code>free</code> exactly once on the memory, except if <code>malloc</code> returned NULL in the first place (allocation failed) in which case calling <code>free</code> is an error. (You do check your <code>malloc</code> return value for NULL, don't you?) It is also an error to call <code>free</code> twice on the same memory, and it is a memory leak not to call it at all.</p>
<p>In Java, we don't have to manage memory by hand, but there are other kinds of resources:</p>
<ul>
<li>Files.</li>
<li>Network connections.</li>
<li>Graphics objects in some drawing/window systems.</li>
<li>Database connections.</li>
</ul>
<p>To help manage these, Java provides an interface <code>java.lang.AutoCloseable</code> with a single method <code>void close()</code> and the try-with-resources construction:</p>
<pre><code class="language-java">try (Resource r = ...) {
    // do things with r here
}
</code></pre>
<p>As long as the resource implements <code>AutoCloseable</code> (it's a syntax error to use this pattern otherwise), this pattern guarantees that </p>
<ol>
<li>If the initialisation statement (in the round brackets) fails, either by returning null or throwing an exception, then the block will never be executed.</li>
<li>If the initialisation succeeds, then when the block exits, <code>r.close()</code> will be called exactly once, whether the block reached its end, exited early (e.g. return statement) or threw an exception.</li>
</ol>
<p>A try-with-resources block can, but does not have to, include one or more <code>catch</code> statements, in which case they apply to the block, the initialisation statement and the implied <code>close()</code>.</p>
<p>You can also include more than one resource in the try statement by separating them with semicolons inside the bracketed term.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Earlier versions of java used the <code>finally</code> keyword to achieve something similar, but it was more challenging to get right especially if the close function could also throw an exception. Since Java 7, try-with-resources is the correct pattern to use and you should almost never need a <code>finally</code> block. You can implement <code>AutoCloseable</code> on your own classes to support this.</p>
</div>
</div>
<h2><a class="header" href="#opening-a-connection" id="opening-a-connection">Opening a connection</a></h2>
<p>You open a connection by calling</p>
<pre><code class="language-java">try(Connection c = DriverManager.getConnection(connection_string)) {
    // do stuff with connection
} catch (SQLException e) {
    // handle exception, for example by wrapping in RuntimeException
}
</code></pre>
<p>The connection string is a string containing a URL such as </p>
<pre><code>jdbc:mariadb://localhost:3306/DATABASE?user=USER&amp;localSocket=/var/run/mysqld/mysqld.sock
</code></pre>
<p>When you try and open a connection, Java looks for a driver on your classpath that implements the addressing scheme (e.g. <code>mariadb</code>) that you have requested. This makes setting up the classpath a bit tricky, but we have maven to manage that for us.</p>
<p>However, we need to understand a bit about networking and security to make sense of that URL.</p>
<p>In a traditional database set-up, the database lives on its own machine (or cluster of machines) and applications connect to it over the network. To do this, by default, databases listen on TCP port 3306.</p>
<p>For security reasons, a competent adminstrator will set things up so that there is a firewall preventing access to the database from any machines except those of applications (and possibly developers and administrators), the database machine will certainly not be available directly from the internet. Then, applications will also need a username and password to connect to the database. Since these passwords are used by applications, and do not need to be remembered by humans, there is absolutely no excuse for choosing weak ones: the absolute minimum is something with 128 bits of entropy. Computers have no problems remembering something this long! In this case you add the extra <code>pass=</code> argument to the connection string, and to prevent passwords being sent unencrypted over the network (even if it's your internal network) you can also set up TLS or a similar tunneling technology.</p>
<p>On our Alpine machine, when we set up mariadb by default, the database server and client are both running on the same machine, so you can gain both security and performance by not using a network connection at all - instead when you type <code>mysql</code> it connects over a POSIX socket, another special type of file (type <code>s</code> in <code>ls -l</code>), in this case <code>/var/run/mysqld/mysqld.sock</code>. A POSIX socket is like a pair of pipes in that it allows bidirectional, concurrent communication between different processes, but with an API closer to that of a network (TCP) socket.</p>
<p>The point of all this discussion is that for your alpine machine, your connection string will look like this (all on one line with no newlines):</p>
<pre><code>jdbc:mariadb://localhost:3306/DATABASE?user=USER&amp;localSocket=/var/run/mysqld/mysqld.sock
</code></pre>
<p>The <code>localSocket</code> option overrides the host/port at the start. For this to work, you need the mariadb driver and a library called JNA (Java Native Access) on your classpath, and of course your system needs to support sockets.</p>
<p>The more standard connection string for a TCP connection would look like this:</p>
<pre><code>jdbc:mariadb://localhost:3306/DATABASE?user=USER
</code></pre>
<p>Which really does connect to TCP port 3306 on localhost.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>You can configure this on your Alpine machine if you wanted to: the main mariadb configuration file is <code>/etc/my.cnf</code> which in our case just contains a statement to include all files in the <code>/etc/my.cnf.d/</code> folder; in there we have <code>mariadb-server.cnf</code> which contains the lines</p>
<pre><code>[mysqld]
skip-networking
</code></pre>
<p>Remove the last line and restart the server (<code>rc-service mariadb restart</code>) and then your mariadb server (<code>mysqld</code>) will really be listening on port 3306.</p>
<p>We didn't notice this with the console client <code>mysql</code> because that by default tries the socket first, and then port 3306 if the socket doesn't exist. However the JDBC driver will only try exactly the options you give, and if you don't tell it to use the socket, it will try port 3306 and throw and exception if nothing is listening there.</p>
</div>
</div>
<h2><a class="header" href="#pom-file" id="pom-file">POM file</a></h2>
<p>Under <a href="databases/4//COMS10012/resources/jdbc/jdbc-example.tar">resources/jdbc/jdbc-example.tar</a> you can find a minimal JDBC application that uses the <code>elections</code> database. Download this to your Alpine VM with <code>wget</code> (or get it from the unit repository, if you have cloned it there) and extract it to an otherwise empty folder (<code>tar xvf jdbc-example.tar</code>). It contains a file <code>pom.xml</code> and a file <code>src/main/java/org/example/Example.java</code>.</p>
<p>In the POM file, we note the following dependencies:</p>
<pre><code class="language-xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.mariadb.jdbc&lt;/groupId&gt;
        &lt;artifactId&gt;mariadb-java-client&lt;/artifactId&gt;
        &lt;version&gt;2.7.1&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;net.java.dev.jna&lt;/groupId&gt;
        &lt;artifactId&gt;jna&lt;/artifactId&gt;
        &lt;version&gt;5.6.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;net.java.dev.jna&lt;/groupId&gt;
        &lt;artifactId&gt;jna-platform&lt;/artifactId&gt;
        &lt;version&gt;5.6.0&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>The first one is the mariadb JDBC driver. When maven runs a program, it automatically puts the dependencies on the classpath; if you left this off then creating the <code>Connection</code> would throw an exception.</p>
<p>The other two are the JNA (Java Native Access) libraries for your platform, that the driver uses to connect to a POSIX socket. If you left these off, the driver would ignore the <code>localSocket</code> option, try to connect to port 3306, and throw an exception because there is nothing listening there (unless you have configured it).</p>
<ul>
<li>Run <code>mvn compile</code> in the folder with the POM file to download the dependencies and compile the example program.</li>
<li>Run <code>mvn exec:java</code> to run the program. This uses the <code>exec-maven-plugin</code> configured later in the POM file to launch the program with the main class <code>org.example.Example</code> and the correct classpath. It should print out a list of parties.</li>
<li>If you want, you can use <code>mvn package</code> to build two JAR files in <code>target</code>: one is just the compiled example class, but the more interesting one has <code>jar-with-dependencies</code> in its name and contains the compiled class and all dependencies, namely the JDBC mariadb driver and JNA (and all their dependencies). You can run this jar with <code>java -cp jdbc-example-0.1-jar-with-dependencies.jar org.example.Example</code> without using maven if you want to. This file is built by the <code>maven-assembly-plugin</code> which we have also configured in the POM file.</li>
</ul>
<h2><a class="header" href="#sql-from-java" id="sql-from-java">SQL from Java</a></h2>
<p>In the <code>Example.java</code> class, we can see an example of JDBC in action:</p>
<pre><code class="language-java">private void readData(Connection c) {
    String SQL = &quot;SELECT id, name FROM Party&quot;;
    try (PreparedStatement s = c.prepareStatement(SQL)) {
        ResultSet r = s.executeQuery();
        while (r.next()) {
            int id = r.getInt(&quot;id&quot;);
            String name = r.getString(&quot;name&quot;);
            System.out.println(&quot;Party #&quot; + id + &quot; is: &quot; + name);
        }
    } catch (SQLException e) {
        throw new RuntimeException(e);
    }
}
</code></pre>
<ul>
<li>The SQL command goes in a string. If we wanted to add parameters for a prepared statement, we put question marks here.</li>
<li>We create a <code>PreparedStatement</code> in another try-with-resources block: we need to close statements as soon as we are done with them, but it's ok for a program to keep the database connection open for as long as it runs.</li>
<li>In this case, we have no parameters to pass, so we execute the query to get a <code>ResultSet</code>, a &quot;cursor&quot; (a kind of iterator) on the results. (A <code>ResultSet</code> is also a resource, but it closes automatically when its statement closes, so we don't have to handle this ourselves.)</li>
<li>We iterate over the rows of the result and do something with them, in this case printing to standard output.</li>
<li>All these operations can throw an <code>SQLException</code>, so we catch it at the end, and because this is just a small example program, we handle it by throwing an exception to terminate the whole program.</li>
</ul>
<h2><a class="header" href="#result-sets" id="result-sets">Result Sets</a></h2>
<p>Java is an object-oriented language with a compile-time type system: if you declare that a <code>class Person</code> has a field <code>int age</code>, then the compiler will stop you from ever trying to put a string in there. JDBC cannot offer you this level protection because when you compile your Java program, you don't know what tables and fields exist in the database (even if you do know, someone could change them after the program has been compiled).
So you have to fall back to some more C-like patterns for using the database.</p>
<p>A result set can either be pointing at a row in the database or not. If it is pointing at a row, you can read values with the <code>get...</code> methods. If the result set is not pointing at a row, then trying to read anything throws an SQLException. The rules here are:</p>
<ul>
<li>When you get the result set back, it starts out pointing <em>before the first row</em>, so reading immediately would throw an error.</li>
<li>Calling <code>boolean next()</code> tries to advance a row. If this returns true, then you have got a new row and can read from it; if you get false then you have stepped beyond the last row and it would be an error to read. (If there are no rows in your result at all, then the first call to <code>next()</code> will already return false.)</li>
</ul>
<p>The correct pattern to use the result set is normally a while loop, as each time you land in the loop body you're guaranteed to have found a row:</p>
<pre><code class="language-java">while (r.next()) {
    // we have a row, do something with it
}
</code></pre>
<p>There are however a couple of exceptions to this pattern. First, some statements like <code>select count(...)</code> will always return exactly one row - maybe the value in the row will be zero, but that's not the same thing as no row at all - so in this case you can do</p>
<pre><code class="language-java">if (r.next()) {
    // this should always happen    
} else {
    // this should never happen
    // throw an exception or something
}
</code></pre>
<p>It would still be an error to access the one row before calling <code>next()</code>, and we are not the kind of people who ignore return values from API calls.</p>
<p>Another special case is if you want to do something special with the first row:</p>
<pre><code class="language-java">if (r.next()) {
    // if we get here then there was at least one row
    // we're on the first row and can do something special with it
    do {
        // this block will be called exactly once for every row
        // including the first one
    } while (r.next())
} else {
    // if we get here then there were no rows at all
}
</code></pre>
<p>The <code>do-while</code> loop lets us write a block that is called exactly once for every row, while still letting us do something special with the first row without needing an ugly <code>boolean isFirstRow</code> flag or something like that.</p>
<p>Inside a result set, as long as we're sure we're on a row, we can read values from columns by declaring their name and type:</p>
<pre><code class="language-java">int id = r.getInt(&quot;id&quot;);
</code></pre>
<p>This tells JDBC that there is a column named <code>id</code> of type <code>int</code>, and to get its value. (You get an exception if the name or type are wrong.) Other methods include <code>getString</code>, <code>getDouble</code> etc.</p>
<p>For this reason, in your SQL statement, you want to be clear about the names and order of the colums you're fetching:</p>
<ul>
<li>If a column is something more complicated than a field, then give it an alias, e.g. <code>SELECT COUNT(1) AS c</code> then you can do <code>getInt(&quot;c&quot;)</code>.</li>
<li>Never do <code>SELECT *</code> from JDBC, always list exactly the columns you need. This both fixes the order you get them in, and is more efficient if you don't need all of them.</li>
</ul>
<h2><a class="header" href="#exercise-1" id="exercise-1">Exercise 1</a></h2>
<p>Modify the example program so it takes a party ID as a parameter, and displays only that party's name, or the string &quot;No party with this ID.&quot; if there isn't one in the database.</p>
<p>To do this you will have to change the following:</p>
<ul>
<li><code>main</code> reads a parameter off <code>args</code>, or prints an error message if you didn't pass an argument.</li>
<li><code>main</code> passes the parameter as an extra int argument to <code>readData</code>.</li>
<li>Set the parameter as a question mark in the prepared statement, and then bind the parameter to the statement. </li>
</ul>
<p>The command for binding a parameter is <code>s.setInt(pos, value)</code> where <code>pos</code> is the index of the parameter (question mark) in the string, <em>starting the count at 1 not 0</em>. So you simply want <code>s.setInt(1, value)</code>. Of course there are also <code>setString</code> etc. and these methods on the statement take a second parameter of the appropriate type.</p>
<p>The easiest way to run your command with a parameter is to build a jar with dependencies and then to call <code>java -cp JARFILE MAINCLASS PARAMETERS</code>, any further command line parameters to Java after the main class get passed as arguments to this class.</p>
<h2><a class="header" href="#exercise-2" id="exercise-2">Exercise 2</a></h2>
<p>A service is a piece of code that can be called by other code and typically accesses resources for them. This exercise is about writing a <code>DataService</code> that abstracts away the JDBC access for the rest of your program.</p>
<p>Create the following classes in their own files (you can use private fields with public constructors/getters/setters if you prefer):</p>
<pre><code class="language-java">public class Party {
    public int id;
    public String name;
}

public class Ward {
    public int id;
    public String name;
    public int electorate;
}

public class Candidate {
    public int id;
    public String name;
    public Party party;
    public Ward ward;
    public int votes;
}
</code></pre>
<p>Now, write a class <code>DataService</code> with the following description:</p>
<ul>
<li>DataService implements <code>AutoCloseable</code>. It has one public constructor that takes a connection string and creates a <code>Connection</code> using this string, which it stores in a private field. The <code>close()</code> method closes the connection.</li>
<li>A method <code>public List&lt;Party&gt; getParties()</code> that returns a list of all parties in the database, by using JDBC on the provided connection.</li>
<li>A method <code>public Party getParty(int id)</code> that returns the party for this id, if there is one, otherwise null.</li>
</ul>
<p>These methods should handle all possible cases (e.g. <code>getWards</code> must still work if there are no wards in the database). but they should not throw an SQLException. Instead, make your own exception class called something like <code>DataServiceException</code> derived from <code>RuntimeException</code> (this can be an inner class of <code>DataService</code> if you want) and wrap the <code>SQLException</code> in that.</p>
<p><em>This is not an excuse for sloppy programmers to ignore the exceptions, by the way!</em></p>
<p>Now, adapt the <code>Example</code> program so that</p>
<ul>
<li>The main program uses the <code>DataService</code> and the domain classes (e.g. <code>Party</code>) and doesn't know about JDBC directly.</li>
<li>If you pass an id as a parameter, it fetches the party with this id (if there is one) and displays party information from the <code>Party</code> instance.</li>
<li>If you don't pass an id, it displays the list of all parties.</li>
</ul>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>The <code>DataService</code> class is a resource, and it opens a connection in its constructor and closes it when you close the instance. This is a standard pattern and works perfectly if the programmer using it uses it in a try-with-resources block.</p>
<p>However, someone could create an instance, close it manually, and then try to continue using it, which would cause a <code>SQLException</code> on the connection. To handle this case by programming defensively, you could:</p>
<ol>
<li>In the close method, set the connection field to null after closing it as a sign that this instance has been closed.</li>
<li>In all other methods, check that the connection field is not null first thing in the method and throw and exception if it is (you can write your own private method for this). According to Java conventions, the correct exception to throw in this case is a <code>java.lang.IllegalStateException</code> which means roughly <em>you are calling a method at the wrong time</em> - in this case after closing the resource in question.</li>
</ol>
</div>
</div>
<h2><a class="header" href="#exercise-3" id="exercise-3">Exercise 3</a></h2>
<p>Implement a <code>Candidate getCandidate(int id)</code> method on the data service too. This will require you to use a JOIN in your SQL and to create instances of all three domain classes.</p>
<h1><a class="header" href="#hibernate" id="hibernate">Hibernate</a></h1>
<p>JDBC lets us connect to a database and pull out data, but we have to do a lot of manual coding to check and convert types, deal with result sets and exceptions etc. We can abstract away most of this into a service class like the <code>DataService</code> at the end of the last page, but we still have to write the data service - even though it is a lot of boilerplate code that we almost need to copy-paste from a template for each new class. We could write a script that given an ER diagram in some machine-readable format, automatically generates a data service for this class to automate all this - or we could use Hibernate to do this for us.</p>
<p>Hibernate is an object-relational mapping (ORM) framework, that is to say it automatically generates an advanced form of data service at runtime which includes many extra features such as sessions, transactions, caches and connection pools. It implements the Java Persistence Api (JPA), an API that in turn builds on JDBC for the purpose of implementing ORMs. Actually Hibernate has its own features that go beyond JPA, such as its own query language.</p>
<p>In a real application, you will be using an ORM most of the time, but you can fall back to SQL for more advanced queries that the ORM cannot support easily.</p>
<h2><a class="header" href="#example-application---set-up" id="example-application---set-up">Example application - set-up</a></h2>
<p>There is an example application in <a href="databases/4//COMS10012/resources/orm/orm.tar">resources/orm/orm.tar</a> which you can download and extract in your VM.</p>
<p>The POM file simply has an extra dependency on Hibernate:</p>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
    &lt;artifactId&gt;hibernate-core&lt;/artifactId&gt;
    &lt;version&gt;5.4.27.Final&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>Hibernate's configuration lives in <code>src/main/resources/hibernate.cfg.xml</code>. Hibernate uses a <em>Session Factory</em> to create sessions, in which you can make queries:</p>
<pre><code class="language-xml">&lt;?xml version = &quot;1.0&quot; encoding = &quot;utf-8&quot;?&gt;
&lt;!DOCTYPE hibernate-configuration SYSTEM 
&quot;http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd&quot;&gt;
&lt;hibernate-configuration&gt;
  &lt;session-factory&gt;
    
    &lt;!-- These properties set up the database connection. --&gt;
    &lt;property name=&quot;dialect&quot;&gt;org.hibernate.dialect.MySQLDialect&lt;/property&gt;
    &lt;property name=&quot;connection.url&quot;&gt;jdbc:mariadb://localhost/elections?localSocket=/var/run/mysqld/mysqld.sock&lt;/property&gt;
    &lt;property name=&quot;connection.username&quot;&gt;vagrant&lt;/property&gt;
    
    &lt;!-- Don't use this in production, use a connection pool instead. --&gt;
    &lt;property name=&quot;current_session_context_class&quot;&gt;thread&lt;/property&gt;

    &lt;!-- Display generated SQL on the console. --&gt;
    &lt;property name=&quot;show_sql&quot;&gt;true&lt;/property&gt;

    &lt;!-- The classes to map to database tables. --&gt;
    &lt;mapping class=&quot;org.example.Candidate&quot; /&gt;
    &lt;mapping class=&quot;org.example.Party&quot; /&gt;
    &lt;mapping class=&quot;org.example.Ward&quot; /&gt;
    
  &lt;/session-factory&gt;
&lt;/hibernate-configuration&gt;
</code></pre>
<ul>
<li>The <em>dialect</em> selects the SQL dialect to speak to the database, in this case <em>MySQL</em> (there's no separate MariaDB one because the two are for all practical purposes identical).</li>
<li>The connection string lives in <code>connection.url</code>, minus the username/password because there are separate properties for these. Note though that we have included the socket option here.</li>
<li>Username and, if you need it, password go in separate properties.</li>
<li>The connection pool is really important for performance in real applications, but we don't bother with that here and just say one connection per thread (we don't use multiple threads in our program so it doesn't matter as much).</li>
<li><code>show_sql</code> is a debuging property that prints all generated SQL to standard output. This is useful to know about when debugging your own applications.</li>
<li>Finally, we list all the classes we want Hibernate to take care of. In SPE, you are going to use the Spring Framework which takes care of this automatically, but for now we're listing them all.</li>
</ul>
<p>The classes themselves are standard Java value classes (private fields, public getter/setter) decorated with JPA annotations to explain to Hibernate how they work:</p>
<pre><code class="language-java">import javax.persistence.Entity;
import javax.persistence.Id;

@Entity
public class Party {
    @Id private int id;
    private String name;
    
    public Party() {}
    
    public int getId()      { return id; }
    public String getName() { return name; }

    public void setId(int id)         { this.id = id; }
    public void setName(String name)  { this.name = name; }
}
</code></pre>
<ul>
<li><code>@Entity</code> means this is something that maps to a table in the database. By default, Hibernate guesses the table name from the class name, but you could change this with a parameter e.g. <code>@Entity(name=&quot;Parties&quot;)</code>.</li>
<li><code>@Id</code> indicates the primary key.</li>
</ul>
<p>The candidate class is a bit more interesting as it has foreign keys:</p>
<pre><code class="language-java">@ManyToOne 
@JoinColumn(name = &quot;party&quot;)
private Party party;
</code></pre>
<ul>
<li><code>@ManyToOne</code> tells Hibernate that this is a foreign key for a many-to-one relationship (there is also <code>@ManyToMany</code>).</li>
<li><code>@JoinColumn</code> sets the name of the foreign key column, as the default here would be <code>party_id</code>.</li>
</ul>
<h2><a class="header" href="#example-application---querying" id="example-application---querying">Example application - querying</a></h2>
<p>Let's look at the main class (Example.java). First, Hibernate uses a session factory to manage its own database connections and sessions:</p>
<pre><code class="language-java">import org.hibernate.SessionFactory;
import org.hibernate.Session;
import org.hibernate.cfg.Configuration;

public class Example implements AutoCloseable {

  SessionFactory sessionFactory;

  public Example() {
    sessionFactory = new Configuration().configure().buildSessionFactory();
  }

  public void close() {
    sessionFactory.close();
  }

  // ...
}
</code></pre>
<p>You get one from the global <code>Configuration</code> class, to which you could pass parameters to override the ones in the XML file if you wanted to (this would let you change settings in response to command line arguments, for example). A session factory is a resource, so we make our own example class a resource too which lets us run it like this:</p>
<pre><code class="language-java">public static void main(String[] args) {
    try (Example example = new Example()) {
        example.run();
    }
  System.out.println(&quot;Done.&quot;);
  System.exit(0);
}
</code></pre>
<p>The exit command at the end makes sure the program exits even if Hibernate still has a background thread running.</p>
<p>In the <code>run()</code> method, we use a Hibernate session, which manages a database connection:</p>
<pre><code class="language-java">try (Session session = sessionFactory.openSession()) {
    // code
}
</code></pre>
<p>We then have three examples of using Hibernate.</p>
<h3><a class="header" href="#loading-an-entity-by-id" id="loading-an-entity-by-id">Loading an entity by ID</a></h3>
<pre><code class="language-java">Party p1 = session.get(Party.class, 1);
System.out.println(&quot;    The party with id=1 is: &quot; + p1.getName());
</code></pre>
<p>To fetch an instance by id, we just call <code>get</code> on the session with the class we want and the id. Passing the class both tells Hibernate which table to load from, and it tells the compiler what type of object to return - the way Java generics work, this lets us assign the result to a <code>Party</code> variable directly without having to do a cast.</p>
<h3><a class="header" href="#loading-with-a-query" id="loading-with-a-query">Loading with a query</a></h3>
<pre><code class="language-java">TypedQuery&lt;Ward&gt; query = session.createQuery(&quot;FROM Ward&quot;, Ward.class);
List&lt;Ward&gt; wards = query.getResultList();
System.out.println(&quot;  Wards:&quot;);
for (Ward ward : wards) {
    System.out.println(&quot;    &quot; + ward.getName());
}
</code></pre>
<p>A <code>TypedQuery</code> object takes a string in HQL, Hibernate's own query language (based on SQL) and the class of the object to return - this is so that the Java compiler can figure out the return type. <code>getResultList</code> returns all results as a list.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>The <code>TypedQuery</code> interface is part of JPA and is declared roughly as follows:</p>
<pre><code class="language-java">interface TypedQuery&lt;T&gt; {
  // ...
  List&lt;T&gt; getResultList();
}
</code></pre>
<p>This use of generics allows the compiler to be sure that the return type matches the type parameter you gave when you created the query. Of course, you don't create it directly but you ask for a query object from the Hibernate session, but behind the scenes there's an <a href="https://docs.jboss.org/hibernate/orm/5.2/javadocs/org/hibernate/query/internal/QueryImpl.html">org.hibernate.query.internal.QueryImpl<T></a> as well as many other Hibernate-related implementation classes.</p>
<p>These classes could take the type parameter as an argument to their constructor, but if you <a href="https://github.com/hibernate/hibernate-orm/blob/master/hibernate-core/src/main/java/org/hibernate/query/internal/QueryImpl.java">look at the sources</a>, they don't: it seems that Hibernate does a cast internally to get the types right, which is safe as long as the Hibernate developers know what they're doing.</p>
</div>
</div>
<h3><a class="header" href="#queries-with-joins-and-parameters" id="queries-with-joins-and-parameters">Queries with joins and parameters</a></h3>
<p>For a more involved example, we look at the following:</p>
<pre><code class="language-java">TypedQuery&lt;Candidate&gt; q = session.createQuery(&quot;FROM Candidate c WHERE c.party.name = :name&quot;, Candidate.class);
q.setParameter(&quot;name&quot;, &quot;Labour&quot;);
List&lt;Candidate&gt; candidates = q.getResultList();
System.out.println(&quot;  Labour Candidates:&quot;);
for (Candidate c : candidates) {
    System.out.println(&quot;    &quot; + c.getName() + &quot; (&quot; + c.getWard().getName() + &quot;)&quot;);
}
</code></pre>
<p>HQL, like SQL, allows a WHERE clause to filter results. It also allows prepared statements, but goes one better than JDBC in that parameters can have names. You declare a parameter with a colon in the query string (<code>:name</code>) and then use <code>setParameter(name, value)</code> to bind it - this method is written so that it can take a value of any type, presumably with a combination of overloading for int/float types and <code>Object</code> for everything else.</p>
<p>Hibernate will automatically do the JOINs necessary to fetch the party associated with each Candidate, the SQL it runs for this query looks like this on my machine:</p>
<pre><code class="language-SQL">select party0_.id as id1_1_0_, party0_.name as name2_1_0_ from Party party0_ 
where party0_.id=?

select candidate0_.id as id1_0_, candidate0_.name as name2_0_, 
candidate0_.party as party4_0_, candidate0_.votes as votes3_0_, 
candidate0_.ward as ward5_0_ from Candidate candidate0_ 
cross join Party party1_ where candidate0_.party=party1_.id and party1_.name=?
</code></pre>
<p>Hibernate has decided to do two queries here (maybe in parallel, so the order the statements are printed on the terminal may not be accurate). The first one is because if there is no party with the supplied name, then Hibernate can stop and return an empty list; if there is then it continues with the second query to join the two tables.</p>
<h2><a class="header" href="#the-n1-problem" id="the-n1-problem">The N+1 problem</a></h2>
<p>Note that in the queries above, Hibernate does not fetch the ward names. It doesn't matter here because they are already in Hibernate's cache from the previous query. However, if you comment out the first two queries and leave only the third one (lines 41-50 in Example.java), something horrible happens:</p>
<pre><code class="language-SQL">select candidate0_.id as id1_0_, candidate0_.name as name2_0_, candidate0_.party as party4_0_, candidate0_.votes as votes3_0_, candidate0_.ward as ward5_0_ from Candidate candidate0_ cross join Party party1_ where candidate0_.party=party1_.id and party1_.name=?
select party0_.id as id1_1_0_, party0_.name as name2_1_0_ from Party party0_ where party0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
</code></pre>
<p>Hibernate is firing off one query per ward! This is called the N+1 problem, because one HQL query that returns N results ends up producing N+1 SQL queries, which is horribly inefficient expecialy for large N.</p>
<p>Looking at the loop structure:</p>
<pre><code class="language-java">TypedQuery&lt;Candidate&gt; q = session.createQuery(&quot;FROM Candidate c WHERE c.party.name = :name&quot;, Candidate.class);
q.setParameter(&quot;name&quot;, &quot;Labour&quot;);
List&lt;Candidate&gt; candidates = q.getResultList();
System.out.println(&quot;  Labour Candidates:&quot;);
for (Candidate c : candidates) {
    System.out.println(&quot;    &quot; + c.getName() + &quot; (&quot; + c.getWard().getName() + &quot;)&quot;);
}
</code></pre>
<p>From the query itself, it is not clear to Hibernate whether ward names will be needed or not, so Hibernate does not JOIN them by default which would be more efficient if you don't actually need them. In the for loop at the bottom however, you do access the names, so on every pass through the loop, Hibernate is forced to run a new query to get the name of the relevant ward.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>How does Hibernate trigger a query off a simple <code>.getWard().getName()</code>, that you have implemented yourself in the Candidate and Ward classes?</p>
<p>The answer is that instead of actual Candidate objects, Hibernate creates a proxy subclass of Candidate at runtime and returns instances of this instead. These proxy objects have <code>getWard()</code> overridden to fire off another query if, and only if, they are actually called.</p>
</div>
</div>
<p>The solution here is to tell Hibernate at query time that you'll need the wards:</p>
<pre><code class="language-java">TypedQuery&lt;Candidate&gt; q = session.createQuery(&quot;FROM Candidate c JOIN FETCH c.ward WHERE c.party.name = :name&quot;, Candidate.class);
</code></pre>
<p>This is HQL for &quot;I'm going to use the wards, so please do a JOIN to load them too&quot;. And Hibernate now uses a single query for the Candidates again:</p>
<pre><code class="language-SQL">select party0_.id as id1_1_0_, party0_.name as name2_1_0_ from Party party0_ where party0_.id=?

select candidate0_.id as id1_0_0_, ward1_.id as id1_2_1_, candidate0_.name as name2_0_0_,
candidate0_.party as party4_0_0_, candidate0_.votes as votes3_0_0_,
candidate0_.ward as ward5_0_0_, ward1_.electorate as electora2_2_1_,
ward1_.name as name3_2_1_
from Candidate candidate0_
inner join Ward ward1_ on candidate0_.ward=ward1_.id
cross join Party party2_
where candidate0_.party=party2_.id and party2_.name=?
</code></pre>
<p>There is another way to solve this problem: if every time you load a Candidate, you want the ward name to be loaded as well, then you can declare this on the JPA annotation:</p>
<pre><code class="language-java">@ManyToOne(fetch = FetchType.EAGER)
</code></pre>
<h2><a class="header" href="#exercise-1-1" id="exercise-1-1">Exercise 1</a></h2>
<p>Implement a JPA/Hibernate example application for the census database using the Country, Region, County and Ward tables (ignore Statistic/Occupation for this exercise). You could implement the following in your main program for example:</p>
<ul>
<li>Given a ward code, load the ward and print out all related information (ward name, county name etc.).</li>
<li>Given a ward name, print out all the counties that have a ward with that name.</li>
</ul>
<p>Pay attention to avoiding the N+1 problem in the second case.</p>
<h2><a class="header" href="#exercise-2-1" id="exercise-2-1">Exercise 2</a></h2>
<p>What you have learnt so far will allow you to navigate upwards in the hierarchy, e.g. given a ward you can find its associated county. This exercise is about the other way round: given a county object, you want to find all wards in it.</p>
<p>To do this, add the following property to your County class:</p>
<pre><code class="language-java">@OneToMany(mappedBy = &quot;county&quot;)
private List&lt;Ward&gt; wards;
</code></pre>
<p>The argument to <code>mappedBy</code> must be the field name of the field in the Ward class that contains the county reference - you might have called it <code>parent</code> or something else in your class.</p>
<p>Then, add a getter and setter for this list property.</p>
<p>You have now created what is called a <em>bidirectional association</em>: a ward contains a county property, and a county contains a list of wards. You can navigate in both directions in your Java code.</p>
<p>Write a query that loads the City of Bristol county (E06000023) and prints a list of all its ward names with a Java for loop starting from the county object. Make sure you write your HQL query so that you don't cause an N+1 problem here.</p>
<p>This example also helps to explain why we don't make everything eager fetched by default: if you did that with bidirectional associations, then loading any object at all would load the entire database into memory!</p>
<h1><a class="header" href="#sqlite" id="sqlite">SQLite</a></h1>
<p><a href="https://sqlite.org/index.html">SQLite</a> is a really good tool for &quot;just getting stuff done&quot;, especially when you hit the limits of Microsoft Excel (or other spreadsheet software).</p>
<p>According to <a href="https://sqlite.org/index.html">its authors</a>, SQLite is used in some form in every single Windows 10, Mac, Android and iOS device as well as built into the Firefox, Chrome (including Edge) and Safari browsers: the browsers store their browsing history and cookies in SQLite-format databases and you can manually edit these with the command line tool if you like.</p>
<p>Currently in version 3.34.1, the command-line program is called <code>sqlite3</code> and exists for all major operating systems, you should be able to download it as a single file executable, put in in any folder you like and just run it. On Alpine, you can install the <code>sqlite</code> package with <code>apk</code>.</p>
<p>SQLite is an embedded database, which means there is no separate server process. Databases are simply files. When you run the command line tool, the tool fulfils both the client and server roles at once; when you use SQLite from a program, the SQLite driver also acts as the &quot;server&quot;.</p>
<h2><a class="header" href="#census-exercise" id="census-exercise">Census exercise</a></h2>
<p>You will need the census files from databases activity 1: make a folder with the <code>setup.sql</code> file and the census csv files. </p>
<p>Download or install sqlite and run <code>sqlite3 census.db</code> to create a database file.</p>
<p>To create the tables, the command <code>.read setup.sql</code> reads and executes the commands in a file (similar to <code>source</code> on the shell). SQLite system commands start with a dot and do not take a semicolon at the end - see <code>.help</code> for a list. (Don't run the <code>import.sql</code> file, that's MariaDB-specific.)</p>
<p>Use <code>.tables</code> to show the tables and check that they have been created. With <code>.schema Ward</code> for example you can show the create statement for a single table.</p>
<p>The source data is in simple CSV files, for example if (back on the shell) you did a <code>head -n 5 County.csv</code> you would see this:</p>
<pre><code>E09000001,&quot;City of London&quot;,E12000007,E92000001
E09000002,&quot;Barking and Dagenham&quot;,E12000007,E92000001
E09000003,Barnet,E12000007,E92000001
E09000004,Bexley,E12000007,E92000001
E09000005,Brent,E12000007,E92000001
</code></pre>
<p>which matches the following, from the setup script:</p>
<pre><code>CREATE TABLE County (
    code VARCHAR(10) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    parent VARCHAR(10),
    country VARCHAR(10),

    FOREIGN KEY (parent) REFERENCES Region(code),
    FOREIGN KEY (country) REFERENCES Country(code)
);
</code></pre>
<p>To import the data, run the following on the SQLite prompt:</p>
<pre><code>.mode csv
.header off
.import Country.csv Country
.import Region.csv Region
.import County.csv County
.import Ward.csv Ward
.import Occupation.csv Occupation
.import Statistic.csv Statistic
</code></pre>
<p>You should now have all the data imported and you could try any SQL queries from the previous exercises in this database. The SQL dialect of SQLite is not entirely the same as MariaDB: for example, SQLite can do INNER and LEFT OUTER JOIN (and CROSS JOIN) but it cannot do RIGHT OUTER or FULL OUTER JOIN.</p>
<p>SQLite is also extremely forgiving when it comes to data types: it treats types more or less as comments, so it will let you store a string in an integer column if you try. You can also write a CREATE TABLE statement and just leave out the types, SQLite will not mind. SQLite also <em>does not enforce your FOREIGN KEY constraints by default</em>, though you can <a href="https://sqlite.org/foreignkeys.html">turn this on</a> if you want to. These are all design choices made by the SQLite developers that might or might not be the best ones for any particular use case.</p>
<h2><a class="header" href="#modes-and-file-output" id="modes-and-file-output">Modes and file output</a></h2>
<p>SQLite has different ways of displaying a table of data. Try <code>.mode csv</code>, <code>.header on</code> then <code>SELECT * FROM Region;</code> to see the regions as a CSV file with headers (mode and header settings apply until you change them or quit SQLite). If you want to actually produce a CSV file, <code>.once FILENAME</code> tells SQLite to send the result of the following query only to a file, so you can work on a query until it does what you want, then run the <code>.once</code> command and re-run the query (SQLite supports readline on most platforms so the UP key gets the last line back) to send it to a file.</p>
<p>The default mode, <code>list</code>, shows columns separated by bar characters. You can also try <code>.mode column</code> which is a bit more human-readable, printing in lined-up columns with spaces in between. Or, if you want to include a table in a HTML page, <code>.mode html</code> prints the table with HTML tags. If you are on your host OS (not the alpine VM) and you have Excel installed, <code>.excel</code> opens the result of the following query in Excel.</p>
<p>You have now learned an extremely powerful way to analyze data that is presented to you in one or more CSV files - or any data format that you can easily export to CSV (for example most Excel files).</p>
<h2><a class="header" href="#sqlite-from-java" id="sqlite-from-java">SQLite from Java</a></h2>
<p>You can access a SQLite database from a Java program by using the JDBC driver. In Maven, declare the following dependency:</p>
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;org.xerial&lt;/groupId&gt;
  &lt;artifactId&gt;sqlite-jdbc&lt;/artifactId&gt;
  &lt;version&gt;3.34.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>The connection string takes the format <code>jdbc:sqlite:FILEPATH</code>. An absolute path to a file should always work (you have to spell it out and not use the <code>~</code> shortcut though), or if you are running a JAR file from the same folder as the database file then just giving the file name with no path should work too.</p>
<p>Exercise: write a minimal Maven/Java application that prints the region names from the sqlite database you just created.</p>
<h2><a class="header" href="#sqlite-from-python" id="sqlite-from-python">SQLite from Python</a></h2>
<p>Python is a great language for Data Science, and if you ever need to connect to a SQLite database from Python then here is how:</p>
<pre><code class="language-python"># you may have to 'pip install sqlite3'
import sqlite3
with sqlite3.connect('FILENAME') as connection:
    cursor = connection.cursor()
    for row in cursor.execute('SELECT * FROM Ward WHERE name LIKE ?', WARDNAME):
        # do something with row
        print(row)
</code></pre>
<ul>
<li>The <code>with</code> statement is the equivalent to Java's try-with-resources.</li>
<li>The <code>execute</code> statement executes a prepared statement. You put the statement itself in the first arguments, then the values to replace the placeholders as additional arguments.</li>
<li>The <code>execute</code> command returns an iterator that you can loop over, the rows themselves are python tuples (you can also do <code>.fetchall()</code> to get them in a list).</li>
</ul>
<p>See <a href="https://docs.python.org/3/library/sqlite3.html">the Python sqlite documentation</a> for more information.</p>
<p>One important warning here: if you write any data to the database, you have to call <code>connection.commit()</code> afterwards otherwise the data will not actually be written to disk.</p>
<h2><a class="header" href="#sqlite-from-c" id="sqlite-from-c">SQLite from C</a></h2>
<p>The final exercise here is to write a C program, following the instructions in the slides, that reads your SQLite <code>census.db</code>, iterates over the regions table and prints &quot;Region NAME is code CODE&quot;, where NAME/CODE are replaced with the region's name and code.</p>
<p>Of course you need to handle potential errors from the <code>sqlite3_</code> functions: it's only safe to continue if they return <code>SQLITE_OK</code>.</p>
<p>You will need to install the <code>sqlite-dev</code> package which contains the <code>sqlite3.h</code> header file, and link against the library with <code>-lsqlite3</code> in your <code>gcc</code> command.</p>
<p>If you are using <code>sqlite3_exec</code> with a callback function, the callback must return 0 on success and nonzero if it encountered an error, which will in turn cause <code>sqlite_exec</code> to return an error too.</p>
<p>For other methods, see <a href="https://www.sqlite.org/cintro.html">the SQLite C API</a>. For example <code>sqlite3_step</code> lets you iterate over the rows of a SQL result without using a callback function.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>

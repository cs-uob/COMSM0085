<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Dynamic structure, part 2 - Exercises</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../overview.html">Overview</a></li><li class="chapter-item expanded affix "><li class="part-title">Week 6: The Web</li><li class="chapter-item expanded "><a href="../http/index.html"><strong aria-hidden="true">1.</strong> HTTP</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../http/setup.html"><strong aria-hidden="true">1.1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="../http/explore.html"><strong aria-hidden="true">1.2.</strong> Exploring HTTP</a></li><li class="chapter-item expanded "><a href="../http/research.html"><strong aria-hidden="true">1.3.</strong> Online research</a></li><li class="chapter-item expanded "><a href="../http/server.html"><strong aria-hidden="true">1.4.</strong> A server in Java</a></li></ol></li><li class="chapter-item expanded "><a href="../html5/index.html"><strong aria-hidden="true">2.</strong> HTML5</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../html5/basic.html"><strong aria-hidden="true">2.1.</strong> Basic HTML5</a></li><li class="chapter-item expanded "><a href="../html5/templates.html"><strong aria-hidden="true">2.2.</strong> Templates</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Week 7: CSS</li><li class="chapter-item expanded "><a href="../css/index.html"><strong aria-hidden="true">3.</strong> CSS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../css/text.html"><strong aria-hidden="true">3.1.</strong> Styling Text</a></li><li class="chapter-item expanded "><a href="../css/framework.html"><strong aria-hidden="true">3.2.</strong> Frameworks</a></li></ol></li><li class="chapter-item expanded "><a href="../cssgrid/index.html"><strong aria-hidden="true">4.</strong> CSS grids</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cssgrid/intro.html"><strong aria-hidden="true">4.1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../cssgrid/curriculum.html"><strong aria-hidden="true">4.2.</strong> Curriculum exercise</a></li><li class="chapter-item expanded "><a href="../cssgrid/trees.html"><strong aria-hidden="true">4.3.</strong> Trees exercise (responsive layout)</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Week 8: Javascript</li><li class="chapter-item expanded "><a href="../js/index.html"><strong aria-hidden="true">5.</strong> JavaScript</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../js/single.html"><strong aria-hidden="true">5.1.</strong> A single-page app</a></li><li class="chapter-item expanded "><a href="../js/static.html"><strong aria-hidden="true">5.2.</strong> Static structure</a></li><li class="chapter-item expanded "><a href="../js/dynamic1.html"><strong aria-hidden="true">5.3.</strong> Dynamic structure, part 1</a></li><li class="chapter-item expanded "><a href="../js/dynamic2.html" class="active"><strong aria-hidden="true">5.4.</strong> Dynamic structure, part 2</a></li><li class="chapter-item expanded "><a href="../js/exercises.html"><strong aria-hidden="true">5.5.</strong> Further exercises</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Week 9: Web Scraping</li><li class="chapter-item expanded "><a href="../scrape/index.html"><strong aria-hidden="true">6.</strong> Web scraping</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../scrape/crawl.html"><strong aria-hidden="true">6.1.</strong> Crawling</a></li><li class="chapter-item expanded "><a href="../scrape/soup.html"><strong aria-hidden="true">6.2.</strong> BeautifulSoup</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Week 10: Practical Encryption</li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Practical Encryption</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">7.1.</strong> OpenSSL</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.2.</strong> PGP</div></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Exercises</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="dynamic-structure-part-2"><a class="header" href="#dynamic-structure-part-2">Dynamic structure, part 2</a></h2>
<p>The rest of <code>script.js</code> is concerned with displaying data about a given ward in
the <code>&lt;main&gt;</code> section of the page. In fact, it consists of just one function,
called <code>displayData</code>. Let us look at its structure, whilst eliding some of its
implementation details:</p>
<pre><code class="language-javascript">function displayData(id, name) {
  
  function buildPopulation(records) {
    ...
  }

  return function () {
    ...
  }
}
</code></pre>
<p>When called with two arguments <code>id</code> and <code>name</code>, the function <code>displayData</code> does two things:</p>
<ol>
<li>It defines a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Functions#nested_functions_and_closures">nested
function</a>
called <code>buildPopulation</code>. This is a function whose definition is <em>local</em> to
<code>displayData</code>: it can only be used within its body, but not in the rest of
the program. However, this function is allowed to refer to the arguments of
its enclosing function (i.e. <code>id</code> and <code>name</code>). We sometimes call this an <em>auxiliary function</em>, or a
<em>helper function</em>.</li>
<li>It returns an anonymous <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Functions#arrow_functions">arrow
function</a>.
Thus, <code>displayData</code> will return... a newly defined, anonymous function!
Recall that in the previous part of the script, <code>displayData</code> was used only
in one line, namely
<pre><code class="language-javascript">   b.onclick = displayData(id, name);
</code></pre>
<code>b</code> is a button, and its <code>onclick</code> property is a function that will be run
when it is clicked. Thus, <code>displayData</code> should return a function. To
construct such a function we need to know the <code>id</code> and <code>name</code> of the ward
whose data is to be displayed, so <code>displayData</code> needs to take them as
parameters.</li>
</ol>
<p>Both of these constitute examples of functional programming in action.</p>
<p>Let us now look in more detail in the function that is returned:</p>
<pre><code class="language-javascript">function displayData(id, name) {
  
  function buildPopulation(records) {
    ...
  }

  return function () {
    let wards = fetch(`https://opendata.bristol.gov.uk/api/v2/catalog/datasets/population-estimates-time-series-ward/records?limit=20&amp;select=mid_year,population_estimate&amp;refine=ward_2016_code:${id}`)
      .then(response =&gt; response.json())
      .then(data =&gt; {
        let heading = document.createElement('h1');
        heading.innerText = name;
        
        let population = buildPopulation(data.records);

        let dataPane = document.getElementById("dataPane");
        dataPane.textContent = '';
        dataPane.append(heading, population);
      })
      .catch(err =&gt; console.log(err));
  }
}
</code></pre>
<p>The pattern here is much the same as before: an HTTP request is made, its response is parsed as JSON, and then processed.</p>
<p>The endpoint is determined as before, but now asks for data from the
<a href="https://opendata.bristol.gov.uk/explore/dataset/population-estimates-time-series-ward/information/?disjunctive.ward_2016_name"><code>population-estimates-time-series-ward</code></a>
dataset, which contains estimates of the population that lives in each Bristol
ward. We extract only the <code>mid_year</code> and <code>population_estimate</code> fields, which
contain the year in the middle of which the population is estimated, and the
actual estimate itself. We also use a new feature of the API, namely the
<code>refine</code> query parameter. This allows us to extract only records one of whose
<em>facets</em> (i.e. fields of data) has a particular value. At this point in our
code, we know the variable <code>id</code> holds the ID of the ward whose population we
want to display, say <code>E05010914</code> for Southville. By peeking in some sample data,
we can work out that if we pass the query parameter</p>
<pre><code>refine=ward_2016_code:E05010914
</code></pre>
<p>we will only retrieve the population estimates for Southville.</p>
<p>The value <code>E050109141</code> is presumably stored in the <code>id</code> argument. However, <code>id</code>
is a variable in our JavaScript program, so it needs to be turned into a string,
which can then be spliced into the URL at the right position. Fortunately,
modern versions of JavaScript provide a neat way of doing this, namely <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals">template
literals</a>.
Instead of enclosing the URL string in single quotes as before, we now enclose
it in backticks. Then, we can use any JavaScript expression <code>e</code> that evaluates
to a string by writing <code>${e}</code> directly in the URL string. Thus,</p>
<pre><code class="language-javascript">`https://opendata.bristol.gov.uk/api/v2/catalog/datasets/population-estimates-time-series-ward/records?limit=20&amp;select=mid_year,population_estimate&amp;refine=ward_2016_code:${id}`
</code></pre>
<p>evaluates to the correct string at runtime.</p>
<p>The rest of the function is unremarkable. It creates an <code>&lt;h1&gt;</code> heading
containing the name of the ward. Then, it calls the local function
<code>buildPopulation</code>, passing the records in the data returned by the HTTP request.
The <code>&lt;main&gt;</code> tag is retrieved through its unique ID, its contents are erased,
and replaced by the heading and whatever was returned by <code>buildPopulation</code>.</p>
<p>A version of this function is run every time someone clicks a ward button.</p>
<h3 id="generating-tables"><a class="header" href="#generating-tables">Generating tables</a></h3>
<p>The rest of the application is contained in the auxiliary <code>buildPopulation</code> function:</p>
<pre><code class="language-javascript">  function buildPopulation(records) {

    // Make heading
    let heading = document.createElement('h2');
    heading.innerText = 'Population';

    // Make table
    let table = document.createElement('table');
    table.setAttribute('id','populationTable');

    // Make table header
    let header = document.createElement('tr');
    header.innerHTML = '&lt;th&gt;Year&lt;/th&gt;&lt;th&gt;Population&lt;/th&gt;&lt;/tr&gt;';
    table.appendChild(header);
    
    // Populate table
    records.sort((x1, x2) =&gt; x1.record.fields.mid_year &lt; x2.record.fields.mid_year ? -1 : 1)
      .forEach(r =&gt; {
        let year = document.createElement('td');
        year.innerText = r.record.fields.mid_year;
        let population = document.createElement('td');
        population.innerText = r.record.fields.population_estimate;

        let row = document.createElement('tr');
        row.append(year, population);
        table.appendChild(row);
    });
    
    let population = new DocumentFragment();
    population.append(heading, table);
    
    return population;
  }
</code></pre>
<p>Upon receiving an array <code>records</code>, this function sets out to build a new
<code>&lt;table&gt;</code> with two columns, Year and Population. After building its header, it
sorts the records by year. This is achieved through the build-in
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/sort"><code>sort</code></a>
function, which takes a higher-order argument that decides which of two records
comes first. It has a funny interface: negative numbers signify that the first
argument comes before the second, and positive arguments the opposite.</p>
<p>The program then iterates through the records, and makes a row <code>&lt;tr&gt;</code> for each
data point. Finally, it assembles this data into a table, prepends an <code>&lt;h2&gt;</code>
heading, and returns a <code>DocumentFragment</code> consisting of the heading and the
table.</p>
<p>Thus, this part of the application is responsible for retrieving and presenting
the requested data.</p>
<h3 id="exercises"><a class="header" href="#exercises">Exercises</a></h3>
<p><em>Exercise (easy)</em>. Make the app present only population estimates after the year
2015.</p>
<p>This may be achieved in two ways:</p>
<ul>
<li>by changing the REST API call; or</li>
<li>by processing the data after it has been fetched.</li>
</ul>
<p>The second one is significantly easier.</p>
<p>[Hint: Moreover, the second one can be achieved with one line of code if you use
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter">Array.filter</a>.]</p>
<p><em>Exercise</em>. Expand this application so it also presents an estimate of life
expectancy for each ward. I recommend that you define an auxiliary function</p>
<pre><code class="language-javascript">  function buildLifeExpectancy(records) {
    ...
  }
</code></pre>
<p>which, given the data, builds the necessary HTML elements - as above.</p>
<p>You will also face another problem, which is that you will need to use data from
two HTTP requests. The obvious way to do this is to nest two fetch calls:</p>
<pre><code class="language-javascript">fetch('first-URL')
  .then(response =&gt; response.json())
  .then(data1 =&gt;
    fetch('second-URL')
      .then(response =&gt; response.json())
      .then(data2 =&gt; {
        // ... here you can use both data1 and data2 ...
      });
  );
</code></pre>
<p>However, recent versions of JavaScript provide a neater way of doing this,
namely
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all"><code>Promise.all</code></a>.
This function accepts an array of promises, and returns a single 'composite'
promise. When all the premises in the array are resolved, it passes an array of
the returned values to its <code>then()</code> clause. In this particular instance, you
could do something like</p>
<pre><code class="language-javascript">Promise.all([fetch('first-URL'), fetch('second-URL')])
  .then([response1, response2] =&gt; Promise.all([response1.json(), response2.json()]))
  .then([data1, data2] =&gt; {
    // ... here you can use both data1 and data2 ...
  });
</code></pre>
<p>or, in a more succinct style:</p>
<pre><code class="language-javascript">Promise.all([fetch('first-URL'), fetch('second-URL')])
  .then(responses =&gt; Promise.all(responses.map(r =&gt; r.json())))
  .then([data1, data2] =&gt; {
    // ... here you can use both data1 and data2 ...
  });
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../js/dynamic1.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../js/exercises.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../js/dynamic1.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../js/exercises.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>

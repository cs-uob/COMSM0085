<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Exercises</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="overview.html">Overview</a></li><li class="chapter-item expanded affix "><li class="part-title">POSIX</li><li class="chapter-item expanded "><a href="posix1/index.html"><strong aria-hidden="true">1.</strong> POSIX Activity 1</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="posix1/ssh.html"><strong aria-hidden="true">1.1.</strong> Secure shell</a></li><li class="chapter-item expanded "><a href="posix1/install.html"><strong aria-hidden="true">1.2.</strong> Installing vagrant and alpine linux</a></li><li class="chapter-item expanded "><a href="posix1/admin.html"><strong aria-hidden="true">1.3.</strong> Alpine linux system administration</a></li><li class="chapter-item expanded "><a href="posix1/shell.html"><strong aria-hidden="true">1.4.</strong> Shell expansion</a></li></ol></li><li class="chapter-item expanded "><a href="posix2/index.html"><strong aria-hidden="true">2.</strong> POSIX Activity 2</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="posix2/permissions.html"><strong aria-hidden="true">2.1.</strong> File permissions</a></li><li class="chapter-item expanded "><a href="posix2/pipes.html"><strong aria-hidden="true">2.2.</strong> Pipes</a></li></ol></li><li class="chapter-item expanded "><a href="git/index.html"><strong aria-hidden="true">3.</strong> Git</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="git/git1.html"><strong aria-hidden="true">3.1.</strong> Git, part 1</a></li><li class="chapter-item expanded "><a href="git/git2.html"><strong aria-hidden="true">3.2.</strong> Git, part 2</a></li><li class="chapter-item expanded "><a href="git/git3.html"><strong aria-hidden="true">3.3.</strong> Git, part 3</a></li></ol></li><li class="chapter-item expanded "><a href="posix3/index.html"><strong aria-hidden="true">4.</strong> POSIX Activity 3</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="posix3/stat.html"><strong aria-hidden="true">4.1.</strong> inodes and system calls</a></li><li class="chapter-item expanded "><a href="posix3/script.html"><strong aria-hidden="true">4.2.</strong> shell scripting</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Build Tools</li><li class="chapter-item expanded "><a href="build2/index.html"><strong aria-hidden="true">5.</strong> Build Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="build2/c.html"><strong aria-hidden="true">5.1.</strong> C</a></li><li class="chapter-item expanded "><a href="build2/python.html"><strong aria-hidden="true">5.2.</strong> Python</a></li><li class="chapter-item expanded "><a href="build2/java.html"><strong aria-hidden="true">5.3.</strong> Java</a></li><li class="chapter-item expanded "><a href="build2/spring.html"><strong aria-hidden="true">5.4.</strong> Spring</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Databases</li><li class="chapter-item expanded "><a href="db1/sql-introduction.html"><strong aria-hidden="true">6.</strong> SQL introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="db1/setup.html"><strong aria-hidden="true">6.1.</strong> Set up the database</a></li><li class="chapter-item expanded "><a href="db1/er-diagram.html"><strong aria-hidden="true">6.2.</strong> ER diagram</a></li><li class="chapter-item expanded "><a href="db1/er2.html"><strong aria-hidden="true">6.3.</strong> More modelling</a></li></ol></li><li class="chapter-item expanded "><a href="db2/sql-beginners.html"><strong aria-hidden="true">7.</strong> SQL for beginners</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="db2/explore-database.html"><strong aria-hidden="true">7.1.</strong> Explore the database</a></li><li class="chapter-item expanded "><a href="db2/elections.html"><strong aria-hidden="true">7.2.</strong> Bristol elections</a></li><li class="chapter-item expanded "><a href="db2/census.html"><strong aria-hidden="true">7.3.</strong> The UK census</a></li><li class="chapter-item expanded "><a href="db2/normalforms.html"><strong aria-hidden="true">7.4.</strong> Normal forms</a></li></ol></li><li class="chapter-item expanded "><a href="db3/sql-intermediate.html"><strong aria-hidden="true">8.</strong> Intermediate SQL</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="db3/exercises.html"><strong aria-hidden="true">8.1.</strong> Exercises</a></li></ol></li><li class="chapter-item expanded "><a href="db4/sql-java.html"><strong aria-hidden="true">9.</strong> SQL and Java</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="db4/jdbc.html"><strong aria-hidden="true">9.1.</strong> JDBC</a></li><li class="chapter-item expanded "><a href="db4/hibernate.html"><strong aria-hidden="true">9.2.</strong> Hibernate</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Exercises</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>This page contains the exercises for part 1 (the first 5 weeks) of COMS10012 Software Tools, namely</p>
<ul>
<li>2 weeks of Posix</li>
<li>1 week of build tools</li>
<li>2 weeks of databases</li>
</ul>
<p>Each week contains two activities, and each activity has videos to watch (on the main site for each activity) and a set of practical exercises supported by a lab class (on this site).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="activity-1"><a class="header" href="#activity-1">Activity 1</a></h1>
<h2 id="videos"><a class="header" href="#videos">Videos</a></h2>
<p>Before this activity, you should watch the following videos - most of them are quite short. The videos are hosted on Microsoft Streams, and you will need to authenticate and be registered on the unit to watch them.</p>
<table><thead><tr><th>Video</th><th style="text-align: right">Length</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/0bbb61a4-9ddc-439a-9ec9-a7c36a3cd869?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">shell</a></td><td style="text-align: right">19 minutes</td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/6fe23d1f-f96c-419d-93e1-1d1ef15082d5?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">SSH</a></td><td style="text-align: right">7 minutes</td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/51c29280-dbc2-4a12-9f1d-5a54f3d72b6e?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Vagrant</a></td><td style="text-align: right">21 minutes</td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/185316e9-6c3d-4a8a-8a25-cdca64aa3f1d?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Package managers</a></td><td style="text-align: right">12 minutes</td></tr>
</tbody></table>
<h2 id="exercises"><a class="header" href="#exercises">Exercises</a></h2>
<ul>
<li><a href="posix1/./ssh.html">Secure shell</a></li>
<li><a href="posix1/./install.html">Installing vagrant and alpine linux</a></li>
<li><a href="posix1/./admin.html">Alpine linux system administration</a></li>
<li><a href="posix1/./shell.html">Shell expansion</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="secure-shell"><a class="header" href="#secure-shell">Secure shell</a></h1>
<p>Secure shell (SSH) is a protocol to allow you to remotely log in to another computer, such as a lab machine. Everyone I know of who uses SSH uses the free OpenSSH implementation, which is standard on every linux distribution that I know of and is also available for Windows and Mac - and even for the mobile operating systems iOS and Android.</p>
<p>We will see in more detail how SSH manages connections later on, but for now imagine that it opens a network connection between your own machine, and a shell running on a different machine. When you type something, SSH encrypts this and sends it to the other machine which decrypts it and passes it to the shell (or any other program you're running); when the shell replies then SSH encrypts that and sends it back to you. For this to work, (Open)SSH is actually two programs:</p>
<ul>
<li><code>ssh</code> is the client, which you run on your machine to connect to another machine.</li>
<li><code>sshd</code> is the server, or <em>daemon</em> in UNIX-speak. It runs in the background on the machine you want to connect to, and needs to be installed by the system administrator.</li>
</ul>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>SSH uses TCP port 22 by default.</p>
</div>
</div>
<h2 id="check-your-client"><a class="header" href="#check-your-client">Check your client</a></h2>
<p>First of all, let's check that the ssh client is working.</p>
<ul>
<li>Open a terminal on your own machine: linux, mac OS and windows subsystem for linux should be fine. Windows 10 CMD might work too if you have the windows version of openssh installed (for example if you have git installed which uses ssh behind the scenes).</li>
<li>Type <code>ssh localhost</code> and press ENTER. Several different things could happen:
<ul>
<li>If it asks for a password, then the ssh client is working, and a ssh server is running on your current machine. The password would be your user account password, but we don't actually want to log in again so cancel with Control+C.</li>
<li>If it succeeds without a password, then the client is working and a ssh server is running on your machine and either you do not have a password, or you already have a key set up. Type <code>exit</code> and press ENTER to get back to your previous shell.</li>
<li>If it shows &quot;connection refused&quot;, then you have the ssh client correctly working but no server running on your own machine. This is not a problem, as we're trying to log in to the lab machines, so we need a client on our machine and a server on the lab machine.</li>
<li>If it shows an error that ssh is not found, then you don't have (Open)SSH installed which is very unusual except on windows CMD - in which case please switch to using the windows subsystem for linux.</li>
</ul>
</li>
</ul>
<h2 id="connect-to-the-lab"><a class="header" href="#connect-to-the-lab">Connect to the lab</a></h2>
<p>The lab machines have names <code>it######.wks.bris.ac.uk</code> where the hashes represent a number from 075637 up to 075912. However, not all of them will be working at any one time, if everyone connects to the same machine then it will quickly get overloaded, and for security reasons the lab machines are not directly accessible from the internet. Instead, we will use two other machines to connect:</p>
<ul>
<li>The bastion host <code>seis.bris.ac.uk</code>. This is reachable over SSH from the internet, and is on a university network that lets you connect further to the lab machines. You should not attempt to do any work on seis itself, as most of the software you would like to use (like compilers) is not installed there. However, you do have a home directory on seis for storing things like SSH keys.</li>
<li>The load balancer <code>rd-mvb-linuxlab.bristol.ac.uk</code>. This connects you to a lab machine that is currently running and ensures that if everyone uses this method to connect, then they will be more or less equally distributed among the running machines.</li>
</ul>
<p>Try the following:</p>
<ul>
<li>On your terminal, type <code>ssh USERNAME@seis.bris.ac.uk</code> where you replace USERNAME with your university username, e.g. <code>aa20123</code>. Obviously, you will need a working internet connection for this.</li>
<li>If it asks you whether you are sure, type <code>yes</code> and press ENTER. SSH will only do this the first time you connect to a machine that you have never used before.</li>
<li>When prompted, enter your university password and press ENTER.</li>
<li>You should now see the prompt on seis, which looks something like <code>-bash-4.2$</code>. Try the command <code>uname -a</code> to print information about the system (uname on its own prints the operating system name, <code>-a</code> shows &quot;all&quot; information). The reply line should start <code>Linux seis-shell</code>, which is the operating system and host name.</li>
<li>On the seis prompt, type <code>ssh rd-mvb-linuxlab.bristol.ac.uk</code>. This might take a few seconds; say yes if it asks you if you're sure, then enter your password again when prompted. We didn't have to give a username again because you are already logged in to seis with your university username (<code>whoami</code> shows this) and when you ssh without giving a username, it uses the one you are currently logged in as.</li>
<li>You should now be connected to a lab machine, with a prompt of the form <code>USERNAME@it######:~$</code>. </li>
<li>Try <code>whoami</code> and <code>uname -a</code> to check who you are logged in as, and where; also try <code>hostname</code> which just prints the machine name.</li>
<li>Type <code>exit</code> twice to get back to your own machine. (Once gets you back to seis, twice closes the ssh connection completely.)</li>
</ul>
<p>Connecting to one machine through another machine (in this case seis) as a proxy is such a common use case that ssh in fact has an option for it. Note however that this will not normally work from a windows CMD terminal, although it does work on Windows Subsystem for Linux (and on Mac and Linux).</p>
<pre><code>ssh -J USERNAME@seis.bris.ac.uk USERNAME@rd-mvb-linuxlab.bristol.ac.uk
</code></pre>
<p>The <code>-J</code> for &quot;jump through this host&quot; even accepts a comma-separated list of hosts if you need to connect through more than one. However, you need to repeat your username for every machine.</p>
<p>You now know how to log in to a lab machine, but in both methods you had to type your password twice - let's make that easier. The answer is not to store your password in a file, but to use keys instead.</p>
<h2 id="setting-up-ssh-keys"><a class="header" href="#setting-up-ssh-keys">Setting up ssh keys</a></h2>
<p>When you connect to a machine, the client on your computer and the daemon on the machine you're logging in to run a cryptographic protocol to exchange keys and set up a shared secret key for the session, so that what one side encrypts the other side can decrypt again. It also authenticates you to the server using one of several methods. </p>
<p>You might have heard from a security source that there are three main authentication factors: something you know (password or PIN), something you have (physical key, digital key, ID card, passport) and something you are (biometrics). An authentication method that requires two of these is called two-factor authentication and this is considered good security practice. For ssh, this means:</p>
<ul>
<li>You can log in with a username and password, that is &quot;something you know&quot;. This is the default, but not the most secure.</li>
<li>You can log in with a (digital) key, that is &quot;something you have&quot;. This is more secure, as long as your key (which is just a file) doesn't get into the wrong hands, and also the most convenient as you can log into a lab machine or copy files without having to type your password.</li>
<li>You can log in with a key file that is itself protected with a password. This gets you two-factor authentication.</li>
</ul>
<p>The keys that SSH uses implement digital signatures. Each key comes as a pair of files:</p>
<ul>
<li>A private key (also known as secret key) in a file normally named <code>id_CIPHER</code> where CIPHER is the cipher in use. You need to keep this secure and only store it in places that only you have access to.</li>
<li>A public key in a file normally named <code>id_CIPHER.pub</code>. You can share this with the world, and you will need to store a copy of it on any machine or with any service that you want to log in to (for the lab, because the lab machines all share a file system, you only need to store it once - but seis has a separate file system so you need a separate copy there).</li>
</ul>
<p>Let's create a key pair:</p>
<ul>
<li>Type the command <code>ssh-keygen -t ed25519</code>. (If you get an &quot;unknown key type&quot; error, then you are using an outdated version of OpenSSH and for security reasons you should upgrade immediately.) <em>Note: type <code>ed25519</code> directly, do not replace this with your username. It stands for the &quot;Edwards curve over the prime <code>2^255-19</code>&quot; cryptographic group, if you want to know.</em></li>
<li>When it asks you where to save the file, just press ENTER to accept the default, but make a note of the path - normally it's a folder <code>.ssh</code> in your home directory.</li>
<li>If it asks you &quot;Overwrite (y/n)&quot;, say no (n, then ENTER) as it means you already have a key for something else - either ssh directly or something that uses it, like github. Restart key generation but pick a different file name.</li>
<li>When it asks you for a password, I recommend that you just press ENTER which doesn't set a password (good security, maximum convenience). If you do set a password, it will ask you to type it twice and then you will need the password and the key file to use this key (maximum security, less convenient).</li>
</ul>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>The <code>-t</code> parameter selects the cryptographic algorithm to use, in this case <code>ed25519</code>, which is modern, peer-reviewed, and generally considered one of the most secure public-key algorithms available. However some older ssh versions don't accept ed25519.</p>
<p>If you ever need to use SSH keys to a machine that doesn't like ed25519, then use the key type &quot;rsa&quot; instead. I would personally avoid the alternatives &quot;dsa&quot; and &quot;ecdsa&quot; if at all possible as there is speculation among cryptographers that there may be a flaw in the design.</p>
<p>For example, although seis supports ed25519, the old cs bastion host <code>snowy.cs.bris.ac.uk</code> still uses an older version of SSH, so you would need to generate a rsa key to connect to that.</p>
</div>
</div>
<p>Have a look at the folder where your keys are stored. <code>ls -l ~/.ssh</code> will do this, unless you chose somewhere else to store them when you created them:</p>
<pre><code>-rw-------. 1 vagrant vagrant  411 Oct  7 10:50 id_ed25519
-rw-r--r--. 1 vagrant vagrant   98 Oct  7 10:50 id_ed25519.pub
-rw-r--r--. 1 vagrant vagrant 1597 Oct  7 11:54 known_hosts
</code></pre>
<p>Note the permissions on these files in my example. The private key (first line) has a permissions line at the start of <code>(-)(rw-)(---)(---)</code> where I've added brackets to make clearer what is going on. The first bracket only applies to special file types (e.g. <code>d</code> for directory). Next, the owner permissions which are in this case read and write (the third one would be <code>x</code> if the file were an executable program). The last two brackets are the permissions for the group and for everyone else, and these are all off so no-one except yourself (and root) can read your key file. OpenSSH is picky about this and will refuse to use a private key that other people have access to.</p>
<p>The public key permissions are <code>(-)(rw-)(r--)(r--)</code> which means that the owner can read and write, and the group and everyone else (assuming they have access to the folder) can read the public key, which is fine. It's a public key after all.</p>
<p><code>known_hosts</code> is where SSH stores the public keys of computers you've already connected to: every time you answer yes to an &quot;Are you sure you want to connect?&quot; question when you connect to a new computer for the first time, it stores the result in this file and won't ask you again the next time. The file format is one key per line and you can edit the file yourself if you want to.</p>
<h2 id="set-up-key-access-on-seis"><a class="header" href="#set-up-key-access-on-seis">Set up key access on seis</a></h2>
<p>First, we need to upload our public key to the <code>~/.ssh</code> directory on seis. Even before this, we need to make sure the directory exists though:</p>
<ul>
<li>Log in to seis with ssh and your password.</li>
<li>Try <code>ls -al ~/.ssh</code>. If it complains the folder doesn't exist, create it with <code>mkdir ~/.ssh</code>.</li>
<li>Log out of seis again with <code>exit</code>.</li>
</ul>
<p>The command for copying a file is <code>scp</code> for secure copy, which works like <code>cp</code> but allows you to include remote hosts and does the copy over SSH. Run this from your own machine:</p>
<pre><code>scp ~/.ssh/id_ed25519.pub &quot;USERNAME@seis.bris.ac.uk:~/.ssh/&quot;
</code></pre>
<p>Obviously, replace USERNAME with your university username. This will ask for your password again. Note two things here: first, to set up access on seis, we are uploading the public key - not the private key! - and secondly, that we put double quotes around the destination. This is because the <code>~</code> character meaning home directory is handled by our shell, but we don't want our local shell to expand it, instead we want the shell on seis launched by scp to expand it to our home directory on that machine.</p>
<p>The general syntax of scp is <code>scp source destination</code> and source or destination  may be of the form <code>[USERNAME@]HOSTNAME:PATH</code> - if it contains a colon (<code>:</code>), then it refers to a file on a different machine.</p>
<p>Now log in to seis over ssh and type your password one last time. Then run the following:</p>
<pre><code>cd .ssh
cat id_ed25519.pub &gt;&gt; authorized_keys
chmod 600 authorized_keys
</code></pre>
<p>SSH will accept a public key if it is listed in the file <code>authorized_keys</code> in the user's <code>.ssh</code> folder, the format is one line per key. Instead of just copying <code>id_ed25519.pub</code> to <code>authorized_keys</code>, which would overwrite the latter file if it already existed, we use the construction <code>cat SOURCE &gt;&gt; DEST</code> to have our shell append the source file to the destination.</p>
<p>However, if the authorised keys file didn't exist already, then it has now been created with default permissions and SSH won't accept that for security reasons. <code>chmod</code> means change permissions (also known as &quot;mod bits&quot;) and 600 is the bit pattern we want in base 8, because that is how permissions work for historical reasons. Permissions are a bitfield of 9 bits, the first three are read/write/execute for the owner, the next three the same for the group, and then for everyone else. If you <code>ls -l</code> you will see this in a slightly more human-readable format, namely <code>rw-------</code> where a minus means that a bit is turned off.</p>
<p>Now type <code>exit</code> to get back to your own machine, and then <code>ssh USERNAME@seis.bris.ac.uk</code> to log back in to seis. It should log you in without asking for a password, and you have now set up key-based SSH authentication for seis.</p>
<p>Note: if you set a password on your SSH key earlier, then it will ask you for a password, and it will expect the key password not your uni password. You know not to ever reuse your uni password for anything else, right?</p>
<p>If for some reason something doesn't work with ssh, the first thing to try is to add the <code>-v</code> switch enable debugging information (you can even do <code>-vv</code> or <code>-vvv</code> to see even more detail, but we don't need that). If there is a problem with the permissions on your private key file for example, then you will see SSH complain in the debugging information.</p>
<h2 id="setting-up-keys-for-lab-machines"><a class="header" href="#setting-up-keys-for-lab-machines">Setting up keys for lab machines</a></h2>
<p>You can now get into seis with a key, but you want to be on a lab machine to get work done.</p>
<p>To connect from your machine to seis, you need a private key on your machine and a public key on seis. To connect from seis to a lab machine, it would seem like you need a public key on the lab machine and a private key on seis. You do not want to upload your private key to seis though for security reasons, so instead we are going to use a SSH feature called <em>agent forwarding</em> which means that if you SSH into one machine, then when you try and SSH further into another machine SSH will reuse the same key. The way to do this is to use the <code>-A</code> command line flag.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>The point of key-based authentication is that your private key never leaves your own machine, so even university administrators never get to see it, which would not be guaranteed if you stored a copy on a university machine.</p>
<p>Logging in to a machine does not send the key to that machine. Instead, the machine sends you a challenge - a long random number - and SSH digitally signs that with the private key on your own machine, and sends the signature back which the remote machine can verify with the public key. Seeing a signature like this does not let the machine create further signatures on your behalf, and it definitely does not reveal the key.</p>
<p>What agent forwarding does is it allows challenges and signatures to be forwarded across multiple connections, but the key never leaves your own machine.</p>
<p>This way, you can create one SSH key and use it for university, github and anything else that you access over SSH, and even if one service is breached then this does not give the attacker access to your accounts on the other services.</p>
</div>
</div>
<ul>
<li>Log in to seis with <code>ssh USERNAME@seis.bris.ac.uk</code>. You should not need a password anymore.</li>
<li>Log in to the lab machines with <code>ssh rd-mvb-linuxlab.bristol.ac.uk</code> and enter your password. Check that the <code>~/.ssh</code> folder exists and create it if it doesn't, as you did before on seis, then <code>exit</code> again to seis.</li>
<li>Copy your public key file from seis to the lab machines with <code>scp ~/.ssh/id_ed25519.pub &quot;rd-mvb-linuxlab.bristol.ac.uk:~/.ssh/&quot;</code>. This will ask for your password again.</li>
<li>Log in to a lab machine with <code>ssh rd-mvb-linuxlab.bristol.ac.uk</code> and enter your password one last time. On the lab machine, install the public key with the following:</li>
</ul>
<pre><code>cd .ssh
cat id_ed25519.pub &gt;&gt; authorized_keys
chmod 600 authorized_keys
</code></pre>
<ul>
<li>Log out of the lab machine and seis again by typing <code>exit</code> twice.</li>
</ul>
<p>The steps above were necessary because your home directory on seis is not the same as on the lab machines. However, your home directory is the same across all lab machines, so you don't need to install the key on each one separately. You might have noticed that when copying or <code>ssh</code>-ing from seis to the lab machines, you don't have to repeat your username: this is because it is the same on all these machines.</p>
<p>From now on, from you own machine, you should be able to get directly into a lab machine with the following command, which should not ask for your password at all:</p>
<pre><code>ssh -A -J USERNAME@seis.bris.ac.uk USERNAME@rd-mvb-linuxlab.bristol.ac.uk
</code></pre>
<p><em>Unfortunately, <code>-J</code> will not work on a windows CMD terminal, although it should work on Windows Subsystem for Linux. Once we have set up a configuration file, there will be a way to work around this problem. Mac and linux users should be fine though, as should anyone running these commands from an Alpine VM on their own machine, whatever their host OS.</em></p>
<h2 id="setting-up-a-configuration-file"><a class="header" href="#setting-up-a-configuration-file">Setting up a configuration file</a></h2>
<p>You now have a log in command that works, but you still have to type a lot, and you need to type your username twice. We can improve this by using a configuration file.</p>
<p>SSH reads two configuration files: one for all users at <code>/etc/ssh/ssh_config</code> (<code>/etc</code> is where POSIX programs typically store global settings) and a per-user one at <code>~/.ssh/config</code>. The site <a href="https://www.ssh.com/ssh/config/">https://www.ssh.com/ssh/config/</a> or just <code>man ssh_config | less</code> on a terminal contain the documentation (<code>man</code> means manual page, and <code>less</code> is a program that shows a file on page at a time and lets you scroll and search).</p>
<p>Create a file called simply <code>config</code> in your <code>.ssh</code> directory on your own machine. You can do this for example with <code>touch config</code> (make sure you're in the <code>.ssh</code> directory first, <code>cd ~/.ssh</code> gets you there), and then editing it in your favourite text editor. Add the following lines, replacing USERNAME with your username twice:</p>
<pre><code>Host seis
  HostName seis.bris.ac.uk
  User USERNAME

Host lab
  HostName rd-mvb-linuxlab.bristol.ac.uk
  ProxyJump seis
  User USERNAME
</code></pre>
<p>This now lets you use simply <code>ssh lab</code> to log in to a lab machine via seis (agent forwarding is implied when you use <code>ProxyJump</code>), or <code>ssh seis</code> if you want to access seis directly for example to update your keys there.</p>
<ul>
<li>Try <code>ssh lab</code> from your own machine. This will be your main way to log in to a lab machine from now onwards.</li>
</ul>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>If you want to learn another useful skill as you go along, here is one way to edit files on the command line. Many linux distributions have an editor called <code>nano</code> built in which runs in the terminal, so <code>nano config</code> edits the file called config (creating it if it doesn't exist, when you save for the first time). It is fairly self-explanatory, the command Control+X quits as you can see on the command bar at the bottom of the screen in nano and if you quit with unsaved changes, it will ask you if you want to save.</p>
<p>Nano is installed on seis and on the lab machines, so you can use it to edit a file remotely.</p>
<p>However, nano is not installed by default on alpine linux which we will be using for a lot of this unit - you can install it yourself with <code>sudo apk add nano</code>. </p>
<p>And something for Windows users:</p>
<p>If you are on Windows and are using OpenSSH through a CMD terminal, a bug in OpenSSH prevents the <code>-J</code> option from working. However, you can write your file like this instead:</p>
<pre><code># ~/.ssh/config file for WINDOWS CMD users only

Host seis
  HostName seis.bris.ac.uk
  User USERNAME

Host lab
  HostName rd-mvb-linuxlab.bristol.ac.uk
  ProxyCommand ssh.exe -W %h:%p seis
  User USERNAME
</code></pre>
<p>This should get <code>ssh lab</code> to work for you as well.</p>
</div>
</div>
<h2 id="using-different-keys"><a class="header" href="#using-different-keys">Using different keys</a></h2>
<p>You do not need this for the lab, but if you are ever managing different systems and accounts then you might use a different key file for each one. In this case, ssh on the command line lets you do <code>-i FILENAME</code> to select a private key file, and in the configuration file you can select a file for a particular host with the <code>IdentityFile FILENAME</code> line. By default, ssh will search for files in <code>.ssh</code> with names <code>id_CIPHER</code>, as you can see if you launch a connection with the <code>-vv</code> parameter which shows detailed debugging information.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installing-vagrant-and-alpine-linux"><a class="header" href="#installing-vagrant-and-alpine-linux">Installing vagrant and alpine linux</a></h1>
<p><a href="https://www.vagrantup.com/">Vagrant</a> is a program to manage virtual machines (VMs). Based on a configuration file called a <code>Vagrantfile</code>, it can download and configure disk images, which it calles boxes, and call other programs to run them. Vagrant does not run the VM by itself, so you will need another program like <a href="https://www.virtualbox.org/">virtualbox</a> for that.</p>
<h2 id="installing-on-your-own-machine"><a class="header" href="#installing-on-your-own-machine">Installing on your own machine</a></h2>
<p>To use vagrant on your own machine (recommended), follow these steps:</p>
<ul>
<li>Go to <a href="https://www.vagrantup.com/downloads">https://www.vagrantup.com/downloads</a> and download the version of vagrant for your operating system. Windows, Mac OS and common versions of linux are supported.</li>
<li>Download and install virtualbox from <a href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a>.</li>
<li>Reboot your machine.</li>
</ul>
<p>If you are on linux, you can of course also install the programs from your distribution's repository. Vagrant's developers actually recommend against this because they claim that some distributions package outdated versions, but it is your choice.</p>
<h2 id="configuring-a-box"><a class="header" href="#configuring-a-box">Configuring a box</a></h2>
<p>Next, you are going to configure a virtual machine using <a href="https://www.alpinelinux.org/">alpine linux</a>, a minimal linux distribution that we will be using in this unit. </p>
<ul>
<li>Create an empty folder somewhere.</li>
<li>In that folder, create a file called Vagrantfile (capitalised, and with no extension) and add the following lines to it - or just download the file from <a href="posix1/../resources/Vagrantfile">here</a>:</li>
</ul>
<pre><code class="language-ruby">Vagrant.configure(&quot;2&quot;) do |config|
  config.vm.box = &quot;generic/alpine314&quot;
  config.vm.synced_folder &quot;.&quot;, &quot;/vagrant&quot;

  config.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
    apk add libc6-compat
  SHELL
end
</code></pre>
<p>This configuration file is actually a script in the ruby programming language, but you don't need to learn that to use vagrant. Let's look at what it does.</p>
<ul>
<li><code>config.vm.box</code> selects the virtual machine image, or box in vagrant-speak, to use. You can see a list of available ones at https://app.vagrantup.com/boxes/search.</li>
<li><code>config.vm.synced_folder</code> sets up a shared folder between the guest (virtual machine) and host (your machine).</li>
<li>The <code>config.vm.provision</code> runs a provisioning command when the box is first downloaded and installed. These commands run as root on the virtual machine, and in this case we are using the <code>apk</code> package manager (we will talk about this later on) to install the packages <code>libc6-compat</code>.</li>
<li>The <code>&lt;&lt;-SHELL</code> construction is called a &quot;here document&quot;, and is a way in some programming languages of writing multi-line strings. It tells ruby to treat everything until the closing keyword SHELL (which is arbitrary) as a string, which can contain several lines.</li>
</ul>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Alpine linux uses the musl libc distribution, which is smaller than and has a few distinct differences from the normal GNU libc. To avoid these incompatibilities causing you hard-to-find problems when you are compiling C programs, we are installing <code>libc6-compat</code> that makes alpine compatible with the standard libc.</p>
</div>
</div>
<h2 id="running-vagrant"><a class="header" href="#running-vagrant">Running vagrant</a></h2>
<ul>
<li>Open a terminal in the folder containing the Vagrantfile. If you are on windows, both the windows CMD and the windows subsystem for linux terminal will work equally well for this purpose.</li>
<li>Run the command <code>vagrant up</code>. This starts the virtual machine configured in the current folder, and if it has not been downloaded and provisioned yet (as is the case when you run <code>up</code> for the first time) then it does this for you as well.</li>
<li>When vagrant tells you the machine is running, run <code>vagrant ssh</code> to log in to your virtual machine. If it asks you for a password, use <code>vagrant</code>.</li>
<li>You should now see the virtual machine prompt <code>alpine310:~$</code>. Try the command <code>ls /</code> and check that there is a folder called vagrant in the top-level folder, along with system ones with names like <code>usr</code> and <code>bin</code>.</li>
</ul>
<p>There are two kinds of errors you might get during <code>vagrant up</code>:</p>
<ul>
<li>If vagrant complains that it can't find a provider, then you have probably not installed virtualbox, or not rebooted since installing it.</li>
<li>If you get some odd crash or error message about hypervisors, see the page <a href="https://www.vagrantup.com/docs/installation">https://www.vagrantup.com/docs/installation</a> for instructions, section <em>Running Multiple Hypervisors</em>. Basically, you cannot run vagrant when another program is already using your processor's virtualisation subsystem, and the page gives instructions how to turn off the other one.</li>
</ul>
<h2 id="shutting-down-cleanly"><a class="header" href="#shutting-down-cleanly">Shutting down cleanly</a></h2>
<p>To exit the virtual machine, type <code>exit</code> which will get you back to the shell on the host machine. On the host, <code>vagrant halt</code> cleanly shuts down the virtual machine.</p>
<p>Promise yourself that you will always do this before turning off your computer, if you have been using vagrant!</p>
<h2 id="running-on-a-lab-machine"><a class="header" href="#running-on-a-lab-machine">Running on a lab machine</a></h2>
<p>Vagrant is already installed on the lab machines in MVB 2.11, so you can remotely log in and launch a box from there. This will get you exactly the same alpine environment as if you run on your own machine, and everyone should try this out too. If for some reason you cannot run vagrant on your machine, then as long as you have an internet connection you should still be able to run it on the lab machines.</p>
<p>First, we connect to a lab machine: open a terminal and run the command <code>ssh lab</code> that you configured in the previous section on SSH.</p>
<p>On the lab machine, we need to create a folder and load a Vagrantfile as above, but let's download the Vagrantfile from the unit webpage instead of typing it out. Run the following shell commands (the third one starting <code>wget</code> must be all on one line, even if your web browser has added a line break):</p>
<pre><code class="language-sh">mkdir softwaretools
cd softwaretools
wget https://raw.githubusercontent.com/cs-uob/COMS10012/master/exercises/part1/src/resources/Vagrantfile
</code></pre>
<p>You can call the top folder (softwaretools) anything you like and put it anywhere you want. You can now run <code>vagrant up</code> followed by <code>vagrant ssh</code> from inside that folder.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>When you <code>vagrant up</code>, vagrant internally connects port 22 on the guest (which <code>sshd</code> on the guest is listening to) to port 2222 on the host. When you provision a vagrant machine, this creates a key pair on the host and loads the public key into the guest. The private key is actually in the file <code>.vagrant/machines/default/virtualbox/private_key</code> on the host, and the public key in <code>/home/vagrant/.ssh/authorized_keys</code> on the guest. So what <code>vagrant ssh</code> does is launch <code>ssh -i KEYFILE vagrant@localhost -p 2222</code>.</p>
</div>
</div>
<h2 id="warning-about-lab-machines---read-carefully"><a class="header" href="#warning-about-lab-machines---read-carefully">Warning about lab machines - read carefully!</a></h2>
<p>Your files in your home directory on a lab machine are stored in a network folder, so that you see the same files whichever lab machine you log in to; they are also automatically backed up.</p>
<p>If lots of students created lots of VMs in their home folders, this would take up lots of space, and it would be slow: running an operating system over a network share causes both bandwidth and latency problems.</p>
<p>Instead, IT has configured vagrant on the lab machines to store VMs in the <code>/tmp</code> folder which is local to each machine. This means that:</p>
<ul>
<li>If you log in to a different lab machine, your VMs will be gone.</li>
<li>If you log in to the same lab machine but it has restarted since you last logged in, your VMs will be gone.</li>
<li>Your VMs, and with them any files you store in the VM itself, are not backed up.</li>
</ul>
<p>This is not as much a problem as it seems because this is how virtual machines are meant to work: if one is not available, vagrant downloads and provisions it. For this reason, for any software you want installed on your VMs in the lab machines, you should write the install command into the provisioning script in the Vagrantfile so it will be re-installed the next time Vagrant has to set up the VM. We will learn how to do this soon.</p>
<p>However, this still leaves files that you create on the VM itself, such as the ones you will create for the exercises in this unit. The basic warning is that <em>any files in your home directory will be lost when the VM is rebuilt</em>. That is why we have set up a shared folder which you can access as <code>/vagrant</code> on the VM, which maps to the folder containing your Vagrantfile on the host machine. Because this is stored under your home folder on the lab machine, it lives on the network file store and so it is backed up and available from all lab machines.</p>
<p>So whenever you log in to a VM on a lab machine to do some work, you should <code>cd /vagrant</code> and use that instead of your home folder for any files that you don't want to lose. If you are running vagrant on your own computer, then nothing will be deleted except if you give vagrant a command to rebuild the VM yourself.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="alpine-linux-system-administration"><a class="header" href="#alpine-linux-system-administration">Alpine linux system administration</a></h1>
<p>Start your alpine box if necessary by going to the folder with the <code>Vagrantfile</code> in your terminal, and typing <code>vagrant up</code>. Log in to your alpine linux box with <code>vagrant ssh</code>. We are going to get to know linux in general and alpine in particular a bit.</p>
<h2 id="the-file-system"><a class="header" href="#the-file-system">The file system</a></h2>
<p>Linux (and other POSIX-like operating systems) work with a single file hierarchy with a root folder <code>/</code>, although there may be different file systems mounted at different places under that. How files are organised in here are documented in the <a href="https://refspecs.linuxfoundation.org/FHS_3.0/fhs-3.0.html">Filesystem Hierarchy Standard (FHS)</a>. Have a look with the command <code>ls /</code>:</p>
<p><code>/bin</code> stands for binaries, that is programs that you can run. Have a look with <code>ls /bin</code>: there will be a lot of commands in here, including ls itself. Indeed you can find out where a program is with <code>which</code>, so <code>which ls</code> will show you <code>/bin/ls</code> for example.</p>
<p>If you have colours turned on (which is the default) you will see that a couple of files like <code>bash</code> are green, but the rest are blue - this indicates the file type, green is an executable program, blue is a link to another file. Have a look with <code>ls -l /bin</code>: the very first character of each line indicates the file type, the main ones being <code>-</code> for normal file, <code>d</code> for directory and <code>l</code> for a so-called <em>soft link</em>.</p>
<p>Note that, as you can see on the last entry of each line, most files here are links to <code>/bin/busybox</code>! Busybox is, in its own words:</p>
<blockquote>
<p>BusyBox is a multi-call binary that combines many common Unix
utilities into a single executable.  Most people will create a
link to busybox for each function they wish to use and BusyBox
will act like whatever it was invoked as.
(from <code>busybox --help</code>)</p>
</blockquote>
<p>Busybox is a distribution of the many common POSIX commands (you can see which ones with <code>busybox --help</code>) packed into a single program. This means that you can run for example <code>busybox ls</code> to run the ls command. However, when you call <code>ls</code> directly, your shell runs the <code>/bin/ls</code> command, which is just a link to busybox. </p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>How does busybox know which command you want?</p>
<p>Remember that in C, each program's main function can take an argument vector <code>char **argv</code> and that <code>argv[0]</code> is the name of the file that was used to call the program - this is what busybox looks at when you call <code>ls</code> or any of the other linked programs in <code>/bin</code>.</p>
</div>
</div>
<p>Busybox is used in alpine linux because alpine is a minimal linux distribution and busybox is a minimal implementation of lots of common commands. As a result, the alpine/busybox version of say ls might not have as many options as the ls on the lab machines.</p>
<p>Back to <code>ls /</code> and the folders in the root folder. <code>/etc</code> stores system-wide configuration files and typically only root (the administrator account) can change things in here. For example, system-wide ssh configuration lives in <code>/etc/ssh</code>.</p>
<p><code>/lib</code> contains dynamic libraries - windows calls these <code>.dll</code> files, POSIX uses <code>.so</code>. For example, <code>/lib/libc.so.6</code> is the C library, which allows C programs to use functions like <code>printf</code>. You can see with <code>ls -l /lib</code> that the C library is actually a link to <code>/lib/libc.musl-x86_64.so.1</code>: <a href="https://musl.libc.org/">musl</a> is a minimal implementation of the C library, which is the version that alpine linux chose to use by default. From their website:</p>
<blockquote>
<p>musl is an implementation of the C standard library built on top of the Linux system call API, including interfaces defined in the base language standard, POSIX, and widely agreed-upon extensions. musl is lightweight, fast, simple, free, and strives to be correct in the sense of standards-conformance and safety.</p>
</blockquote>
<p><code>/home</code> is the folder containing users' home directories, for example the default user vagrant gets <code>/home/vagrant</code>. The exception is root, the administrator account, who gets <code>/root</code>.</p>
<p><code>/sbin</code> (system binaries) is another collection of programs, typically ones that only system administrators will use. For example, <code>fdisk</code> creates or deletes partitions on a disk and lots of programs with <code>fs</code> in their name deal with managing file systems. <code>/sbin/halt</code>, run as root (or another user that you have allowed to do this), shuts down the system; there is also <code>/sbin/reboot</code>.</p>
<p><code>/usr</code> is a historical accident and a bit of a mess. A short history is on <a href="https://askubuntu.com/questions/130186/what-is-the-rationale-for-the-usr-directory">this stackexchange question</a> but essentially, in the earliest days,</p>
<ul>
<li><code>/bin</code> was only for binaries needed to start the system - or at least the most important binaries that needed to live on the faster of several disk drives, like your shell.</li>
<li><code>/usr/bin</code> was where most binaries lived which were available globally, for example across all machines in an organisation.</li>
<li><code>/usr/local/bin</code> was for binaries installed by a local administrator, for example for a department within an organisation.</li>
</ul>
<p>In any case, <code>/usr</code> and its subfolders are for normally read-only data, such as programs and configuration files but not temporary data or log files. It contains subfolders like <code>/usr/bin</code> or <code>/usr/lib</code> that duplicate folders in the root directory.</p>
<p>Ubuntu's way of cleaning this mess up is to make its <code>/bin</code> just a link to <code>/usr/bin</code> and putting everything in there. On alpine linux, there is still a distinction between the two, but most binaries in both folders are links to <code>/bin/busybox</code> anyway. For example, if you do <code>which ls</code> you find <code>/bin/ls</code>, but <code>which which</code> shows <code>/usr/bin/which</code>, but both of these are in fact just links to <code>/bin/busybox</code>.</p>
<p><code>/tmp</code> is a temporary filesystem that may be stored in RAM instead of on disk (but swapped out if necessary), and that does not have to survive rebooting the machine.</p>
<p><code>/var</code> holds files that vary over time, such as logs or caches.</p>
<p><code>/dev</code>, <code>/sys</code> and <code>/proc</code> are virtual file systems. One of the UNIX design principles is that almost every interaction with the operating system should look to a program like reading and writing a file, or in short <em>everything is a file</em>. For example, <code>/dev</code> offers an interface to devices such as hard disks (<code>/dev/sda</code> is the first SCSI disk in the system, and <code>/dev/sda1</code> the first partition on that), memory (<code>/dev/mem</code>), and a number of pseudoterminals or ttys that we will talk about later. <code>/proc</code> provides access to running processes; <code>/sys</code> provides access to system functions. For example, on some laptop systems, writing to <code>/sys/class/backlight/acpi_video0/brightness</code> changes the screen brightness.</p>
<p>The <code>/vagrant</code> folder is not part of the FHS, but is a convention for a shared folder with the host on vagrant virtual machines.</p>
<h2 id="package-managers"><a class="header" href="#package-managers">Package managers</a></h2>
<p>Linux has had package managers and repositories since the days when it was distributed on floppy disks. A repository is a collection of software that you can install, and can be hosted anywhere - floppy disk, CD-ROM, DVD or nowadays on the internet. A package manager is software that installs packages from a repository - so far, this sounds just like an <em>app store</em> but a package manager can do more. For one thing, you can ask to install different versions of a particular package if you need to. But the main point of a package manager is that packages can have dependencies on other packages, and when you install one then it installs the dependencies automatically.</p>
<p>Nano is a basic text editor that works in the console, and is installed in most linux distributions including the ones on seis and the lab machines, so you can use it to edit files remotely. However, in alpine linux it is not installed by default: type <code>nano</code> and you get <code>nano: command not found</code>. You can install it with the command</p>
<pre><code>sudo apk add nano
</code></pre>
<ul>
<li><code>sudo</code> (superuser do) allows you to run a command as root, also known as the administrator or superuser. Depending on how your system is configured, this might be not allowed at all (you can't do it on the lab machines), or require a password, but on the alpine/vagrant distribution you are allowed to do this. It is good practice to use sudo for system adminstration instead of logging in as root directly, but if you ever really need a root shell then <code>sudo bash</code> gets you one - with <code>#</code> instead of <code>$</code> as prompt to warn you that you are working as root.</li>
<li><code>apk</code> is the alpine linux package manager.</li>
<li><code>add PACKAGE</code> adds a package, which means download and install it and all its dependencies (nano is so small that it has none).</li>
</ul>
<p>You can now do <code>nano FILENAME</code> to edit a file. The keyboard shortcuts are at the bottom of the screen, the main one you need is Control+X to exit (it will ask if you want to save, if you have unsaved changes).</p>
<p>Next, install git with <code>sudo apk add git</code>. Git requires two dependencies (apart from the ones already installed on the base system), as you can see in the output:</p>
<pre><code>(1/3) Installing expat (2.2.8-r0)
(2/3) Installing pcre2 (10.33-r0)
(3/3) Installing git (2.22.4-r0)
</code></pre>
<p><code>expat</code> is an XML parser (for configuration files) and <code>pcre2</code> implements perl-compatible regular expressions for searching for text.</p>
<p>We can use apk to explore this further, try the following:</p>
<ul>
<li><code>apk info git</code> shows information about the git package, including a short description and the website.</li>
<li><code>apk info -a git</code> shows more information, including the dependencies (section &quot;depends on&quot;, there are 5 listed but two are already part of the base system, <code>libc.musl</code> is the C library and <code>libz</code> is a compression library similar to &quot;zip&quot;) and a list of all files installed by the package.</li>
</ul>
<p>Note how git is built out of a number of subcommands in <code>/usr/libexec</code>. For example, when you do <code>git branch</code>, that ends up calling <code>/usr/libexec/git-core/git-branch</code>.</p>
<p>The commands above did not require <code>sudo</code> as they do not change any files on the system.</p>
<h2 id="update-and-upgrade"><a class="header" href="#update-and-upgrade">Update and upgrade</a></h2>
<p>The repositories that you are using are recorded in <code>/etc/apk/repositories</code>, have a look at this file with <code>cat</code> or <code>nano</code> to see where they are, then look up the sites in your browser. There are folders for different processor architectures (the one in use is stored in <code>/etc/apk/arch</code>) and these contain all the packages as well as a file <code>APKINDEX.tar.gz</code> that contains a list of all packages and versions.</p>
<p>Two commands a system adminstrator should run regularly for security reasons:</p>
<ul>
<li><code>sudo apk update</code> fetches the new package list from the repository. This way, apk can tell you if any packages have been updated to new versions since you last checked.</li>
<li><code>sudo apk upgrade</code> upgrades every package that you already have installed to the latest version in your local package list (downloaded when you do an <code>apk update</code>).</li>
</ul>
<h2 id="lab-machines"><a class="header" href="#lab-machines">Lab machines</a></h2>
<p>If you are running a virtual machine on the lab machines, then your virtual machine might not be around after the lab machine reboots or you log out and in again and end up on a different machine - as the notice when you log in tells you, the virtual machines are stored under <code>/tmp</code>.</p>
<p>It would be annoying to have to reinstall your favourite packages every time you log in to a different machine, so you should put them in your Vagrantfile and then <code>vagrant up</code> will do this for you automatically. The Vagrantfile already contains a line <code>apk add libc6-compat</code> which installs a package by default - you can put as many as you like on this line separated by spaces. There is no <code>sudo</code> here because when vagrant is installing the system, it is running as root automatically.</p>
<ul>
<li>Add <code>nano</code> and <code>git</code> to this line so next time you rebuild the vagrant machine, they are added automatically.</li>
<li>Log out of your vagrant machine and do a <code>vagrant destroy</code> which removes the virtual machine. Then reload with <code>vagrant up</code> which will download and provision the box again.</li>
<li>Log in with <code>vagrant ssh</code> and check that git and nano are installed.</li>
</ul>
<p>For the next exercise, please also install the <code>gcc</code> package that gets you a C compiler, as well as <code>musl-dev</code> which contains header files like <code>stdio.h</code>. These, in case you wondered, live in <code>/usr/include</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="shell-expansion"><a class="header" href="#shell-expansion">Shell expansion</a></h1>
<p>This exercise is about studying shell expansion. You should run it on your alpine linux VM in vagrant, and you should have installed the <code>gcc</code> compiler.</p>
<p>Create a C program <code>arguments.c</code> with the following contents. You can use <code>nano arguments.c</code> for this, for example.</p>
<pre><code class="language-C">#include &lt;stdio.h&gt;

int main(int argc, char** argv) {
  for(int i=0; i &lt; argc; i++) {
    printf(&quot;Argument #%i: [%s]\n&quot;, i, argv[i]);
  }
  return 0;
}
</code></pre>
<p>Compile this with <code>gcc -Wall arguments.c -o arguments</code>. </p>
<h2 id="whitespace"><a class="header" href="#whitespace">Whitespace</a></h2>
<p>The program prints all its arguments, one per line. The program gets its arguments from the program that started it - in this case the shell.
Try running the program with the following commands:</p>
<pre><code>./arguments
./arguments hello
./arguments one two three
</code></pre>
<p>Now that you are familiar with what the program does, try the following:</p>
<pre><code>./arguments one       two
./arguments &quot;one two&quot;
./arguments &quot;one      two&quot;
</code></pre>
<p>How, based on these examples, does the shell handle whitespace in the line you type?</p>
<h2 id="pattern-matching"><a class="header" href="#pattern-matching">Pattern matching</a></h2>
<p>Try the following:</p>
<ul>
<li><code>./arguments *</code> in the folder that contains the arguments program, and its source code arguments.c.</li>
<li>Make an empty subfolder with <code>mkdir empty</code>, switch to it with <code>cd empty</code> and then run <code>../arguments *</code>. Since you are now in the subfolder, we need two dots at the start to say &quot;run the program arguments in the folder <em>above</em>&quot;. What happens?</li>
<li>Go back to the folder with the program by running <code>cd ..</code> and then do <code>ls</code> to check you're back in the right folder. In this folder, find three different ways to get the program to produce the following output:</li>
</ul>
<pre><code>Argument #0: [./arguments]
Argument #1: [*] 
</code></pre>
<h2 id="files-with-spaces-in-their-names"><a class="header" href="#files-with-spaces-in-their-names">Files with spaces in their names</a></h2>
<p>The command <code>touch FILENAME</code> creates a file. Create a file with a space in its name by typing <code>touch &quot;silly named file&quot;</code>. What would happen if you left the quuotes off (you can try it, then do <code>ls</code>)?</p>
<p>Start typing <code>ls sill</code> and then press TAB to autocomplete. Assuming you have no other files whose name starts with <em>sill</em>, what happens? Use this method to get the arguments program to print the following:</p>
<pre><code>Argument #0: [./arguments]
Argument #1: [Hello world!] 
</code></pre>
<p>The command <code>rm</code> (remove) deletes files again. Use it to remove your file with spaces in its name, using one of several methods to get the shell to pass the spaces through to <code>rm</code>.</p>
<h2 id="shell-variables"><a class="header" href="#shell-variables">Shell variables</a></h2>
<p>In the shell, <code>VARIABLE=VALUE</code> sets a variable to a value and <code>$VARIABLE</code> retrieves its value. For example, to save typing a filename twice:</p>
<pre><code>p=arguments
gcc -Wall $p.c -o $p
</code></pre>
<p>which expands to <code>gcc -Wall arguments.c -o arguments</code>. If you want to use a variable inside a word, you can use curly braces: <code>${a}b</code> means the value of the variable <code>a</code> followed by the letter b, whereas <code>$ab</code> would mean the value of the variable <code>ab</code>.</p>
<p>It is good practice to double-quote variables used like this, because if you tried for example to compile a program called <code>silly name.c</code> with a space in its name, then</p>
<pre><code>program=&quot;silly name&quot;
gcc -Wall $program.c -o $program
</code></pre>
<p>would expand to</p>
<pre><code>gcc -Wall silly name.c -o silly name
</code></pre>
<p>and this would confuse your compiler because you are telling it to compile three source files called <code>silly</code>, <code>name.c</code> and <code>name</code> to a program called <code>silly</code>. Correct would be:</p>
<pre><code>program=&quot;silly name&quot;
gcc -Wall &quot;$program.c&quot; -o &quot;$program&quot;
</code></pre>
<p>which expands to</p>
<pre><code>gcc -Wall &quot;silly name.c&quot; -o &quot;silly name&quot;
</code></pre>
<p>which does what you want - if you indeed want a program with a space in its name!</p>
<p>There is no harm in double-quoting a shell variable every time you want to use it, and this is good practice as it still works if the variable is set to a value that contains spaces.</p>
<p>Note that we also had to quote setting the variable name in the first place, because</p>
<pre><code>program=silly name
</code></pre>
<p>would translate as: set the variable <code>program</code> to the value <code>silly</code>, then execute the program <code>name</code>. Variable assignments only apply to the first argument following them, although you can assign more than one variable.</p>
<p>Note that this does not work as expected either:</p>
<pre><code>file=arguments gcc -Wall &quot;$file.c&quot; -o &quot;$file&quot;
</code></pre>
<p>The problem here is that the shell first reads the line and substitutes in the value of <code>$file</code> (unset variables expand to the empty string by default) before starting to execute the command, so you are reading the variable's value before writing it. Leaving off the quotes doesn't help: you need to set the variable on a separate line.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="activity-2"><a class="header" href="#activity-2">Activity 2</a></h1>
<h2 id="videos-1"><a class="header" href="#videos-1">Videos</a></h2>
<table><thead><tr><th>Video</th><th style="text-align: right">Length</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/67625d6d-1b0b-4c83-b2d0-cb451eb0a98e?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Permissions 1</a></td><td style="text-align: right">27 minutes</td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/d8cc15d9-a61a-4279-b6fa-da34c4722a4e?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Permissions 2</a></td><td style="text-align: right">22 minutes</td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/e896745c-fbfe-4730-bb45-7739be141011?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Pipes 1</a></td><td style="text-align: right">18 minutes</td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/3520bb75-d019-4706-8f35-9126a2c600c0?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Pipes 2</a></td><td style="text-align: right">18 minutes</td></tr>
</tbody></table>
<h2 id="exercises-1"><a class="header" href="#exercises-1">Exercises</a></h2>
<ul>
<li><a href="posix2/./permissions.html">File permissions</a></li>
<li><a href="posix2/./pipes.html">Pipes</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="file-permissions"><a class="header" href="#file-permissions">File permissions</a></h1>
<p>Log in to your vagrant VM for the following exercises.</p>
<h2 id="show-the-current-user"><a class="header" href="#show-the-current-user">Show the current user</a></h2>
<p>First, use the command <code>whoami</code> to see the current user name: it should be <code>vagrant</code>.</p>
<p>For this exercise it will be useful to display the user in the prompt, so do <code>sudo nano /etc/profile</code>. This file is a configuration file that is read by the shell when it starts up. Notice the lines:</p>
<pre><code>export CHARSET=UTF-8
export LANG=C.UTF-8
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export PAGER=less
export PS1='\h:\w\$ '
umask 022
</code></pre>
<p>The <code>export</code> ones set environment variables, for example the default <code>PATH</code> where the shell looks for programs. The <code>PAGER</code> is what programs such as the manual page viewer (<code>man</code>) use to display information one page at a time.</p>
<p>The <code>PS1</code> (prompt level 1) controls your shell prompt. Here <code>\h</code> means the hostname, <code>\w</code> the working directory and <code>\$</code> is the appropriate prompt symbol (<code>$</code> for normal users, <code>#</code> for root). This gets you a default prompt that looks like <code>alpine310:~$ </code> (note the space after the dollar sign, which is also in the PS1). Let's add the username: change the line to <code>export PS1='\u@\h:\w\$ '</code>. When you log out and in again, your prompt will now be <code>vagrant@alpine310:~$ </code>.</p>
<p>While you're here, you can <code>export EDITOR=nano</code> so that every user gets nano instead of vi as their default editor. Then save the file (Control+X in nano).</p>
<ul>
<li>Research online what <code>umask 022</code> does, note that the number is in base 8.</li>
</ul>
<h2 id="create-a-user-and-a-group"><a class="header" href="#create-a-user-and-a-group">Create a user and a group</a></h2>
<p>Create a new user with <code>sudo adduser NAME</code> - I'm going to be using <code>fred</code> as an example name in these notes. When it asks for a password, you can just use <code>fred</code> or something; it will complain about the password being too short but it will create the user anyway.</p>
<p>Check the user and group files with <code>tail /etc/passwd</code> and <code>tail /etc/group</code> to check that the new user has been created - <code>tail</code> displays the last 10 lines of a file by default; <code>tail -n N FILE</code> would display the last N lines. Your new user <code>fred</code> (or whatever you called them) should appear in both files. Also check with <code>ls -l /home</code> that the home directory for Fred exists and is set to the correct user and group.</p>
<p>Time to change user: <code>su fred</code> and enter the password. Notice that the prompt has changed to <code>fred@alpine310:/home/vagrant$</code> (at least if you started off in that folder). So the user has changed, and because <code>/home/vagrant</code> is no longer the current user's home directory, it gets written out in full. Run <code>cd</code> to go home followed by <code>pwd</code> and check that you are now in <code>/home/fred</code> or whatever you called your new user.</p>
<p>Next, create a user <code>george</code> (or some other name) add both your two new users, but not <code>vagrant</code>, to the group <code>users</code> (which already exists) as described in the video. Note: <code>fred</code> cannot use sudo, so you have to exit his terminal to get back to one running as vagrant for this.</p>
<h2 id="explore-file-permissions"><a class="header" href="#explore-file-permissions">Explore file permissions</a></h2>
<p>As user <code>fred</code> (or whatever you called your first new user), set up your home directory using what you learnt in the videos so that</p>
<ul>
<li>You can do everything (rwx).</li>
<li>Members of the <code>users</code> group can list files and change to your home directory, but not add/remove files. You will need to change the group of your home directory to <code>users</code> for this, as described in the videos.</li>
<li>Everyone else cannot do anything with your home directory.</li>
</ul>
<p>Create a file in your home directory, e.g. <code>nano readme.txt</code> then add some content.</p>
<p>Check, by using <code>su USERNAME</code> to log in as the different users, that:</p>
<ul>
<li><code>george</code> can view Fred's home directory but not create files there; </li>
<li><code>george</code> can view but not edit Fred's readme file; </li>
<li><code>vagrant</code> cannot list files in or enter Fred's home directory at all. What happens when you try?</li>
</ul>
<p><em>Of course, vagrant can use sudo to get around all these restrictions. Permissions do not protect you from anyone who can become root.</em></p>
<p>Also as <code>fred</code>, make a <code>private</code> subdirectory in your home folder that no-one but you can access (read, write or execute). Create a file <code>secret.txt</code> in there with <code>nano private/secret.txt</code> as user <code>fred</code> from Fred's home directory, and put something in it. Do not change any permissions on <code>secret.txt</code> itself.</p>
<p>Check as George that you can see the folder itself, but not cd into it nor list the file. Check that even knowing the file name (<code>cat /home/fred/private/secret.txt</code>) as George doesn't work.</p>
<p>Using <code>ls -l</code> as Fred in both <code>~</code> and <code>~/private</code>, compare the entries for the files <code>~/readme.txt</code>, <code>~/private/secret.txt</code> and the folder <code>~/private</code>. Why do the groups of the two files differ?</p>
<p>Note that, even though the secret file has read permissions for everyone by default, George cannot read it. The rule is that you need permissions on the whole path from <code>/</code> to a file to be able to access it.</p>
<p><em>This is another reminder that if you want to store coursework on a lab machine, then put it in a folder that is only accessible to you. Other students can read your home directory by default, and they would be able to steal your work and submit it as their own otherwise: this has happened in the past.</em></p>
<p><em>Altenatively you could remove permissions from everyone else on your home directory there, but this prevents you from being able to share files in specific folders that you do want to share with other students.</em></p>
<h2 id="setuid"><a class="header" href="#setuid">Setuid</a></h2>
<p>We are going to create a file to let George (and others in the users group) send Fred messages which go in a file in his home directory.</p>
<p>As Fred, create a file <code>message-fred.c</code> in your home directory and add the following lines:</p>
<pre><code class="language-C">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

const char *filename =&quot;/home/fred/messages.txt&quot;;

int main(int argc, char **argv) {
  if (argc != 2) {
    puts(&quot;Usage: message-fred MESSAGE&quot;);
    return 1;
  }
  FILE *file = fopen(filename, &quot;a&quot;);
  if (file == NULL) {
    puts(&quot;Error opening file&quot;);
    return 2;
  }
  int r = fputs(argv[1], file);
  if (r == EOF) {
    puts(&quot;Error writing message&quot;);
    return 2;
  }
  r = fputc('\n', file);
  if (r == EOF) {
    puts(&quot;Error writing newline&quot;);
    return 2;
  }
  fclose(file);
  return 0;
}
</code></pre>
<p>Compile it with <code>gcc -Wall message-fred.c -o message-fred</code> (you should not get any warnings) and check with <code>ls -l</code>, you will see a line like</p>
<pre><code>-rwxr-xr-x    1 fred     fred         19984 Oct 28 13:26 message-fred
</code></pre>
<p>These are the default permissions for a newly created executable file; note that gcc has set the three <code>+x</code> bits for you. Still as Fred, run <code>chmod u+s message-fred</code> and check the file again: you should now see <code>-rwsr-xr-x</code> for the file permissions. The <code>s</code> is the setuid bit.</p>
<p>As George (<code>su george</code>), go into Fred's home directory and run <code>./message-fred &quot;Hi from George!&quot;</code>. The quotes are needed here because the program accepts only a single argument.</p>
<p>Now run <code>ls -l</code> and notice that a <code>messages.txt</code> has appeared with owner and group <code>fred</code>. Check the contents with <code>cat messages.txt</code>. Although George cannot create and edit files in Fred's home directory himself (he can't edit <code>messages.txt</code> for example, although he can read it), the program <code>message-fred</code> ran as Fred, which let it create the file. George can send another message like this (<code>./message-fred &quot;Hi again!&quot;</code>), which gets appended to the file: try this out.</p>
<p>This shows how setuid programs can be used to allow other users to selectively perform specific tasks under a different user account.</p>
<p><strong>Warning</strong>: writing your own setuid programs is extremely dangerous if you don't know the basics of secure coding and hacking C programs, because a bug in such a program could let someone take over your user account. The absolute minimum you should know is the contents of our security units up to and including 4th year.</p>
<p>A general task for a security analyst might be finding all files with the setuid bit set on a system. You can try this yourself, but return to a vagrant shell first so that you're allowed to use sudo:</p>
<pre><code>sudo find / -perm /4000
</code></pre>
<p>You might get some errors relating to <code>/proc</code> files, which you can ignore: these are subprocesses that find uses to look at individual files.</p>
<p>Apart from <code>message-fred</code>, on alpine there are four such files by default: <code>sudo</code>, <code>mount</code>, <code>umount</code> and <code>bbsuid</code>. The first one you already know; look up what the next two do and think about why they are setuid. Specifically, what kinds of (un)mounting are non-root users allowed to do according to the manual pages?</p>
<p>The last one is busybox' general-purpose setuid helper. For example,</p>
<pre><code>ls -l /bin | grep bbsuid
</code></pre>
<p>shows that <code>/bin/su</code> is in fact a link to bbsuid on this system (a symlink to a setuid program inherits the setuid property). <code>grep STRING</code> here filters its input and only returns lines containing the string (or regular expression).</p>
<p>Have a look at the output of the following:</p>
<pre><code>ls -l /usr/bin | grep bbsuid
</code></pre>
<p>Look up what these programs do and think about why they have to be setuid root.</p>
<p>Also have a look at the <a href="https://github.com/alpinelinux/aports/blob/master/main/busybox/bbsuid.c">source code of bbsuid</a>: it's only around 100 lines of C and all it does is check that you're calling it from an approved filename, then launch busybox (still as root) to handle the command. The check is important because anyone can make a symlink to bbsuid and call it say <code>rm</code>, and if bbsuid didn't check for this then it would allow anyone to remove any file on the system as root.</p>
<h2 id="sudo"><a class="header" href="#sudo">Sudo</a></h2>
<p>Make sure your terminal is running as <code>fred</code> and try a <code>sudo ls</code>. You will see a general message, you will be asked for your password, and then you will get the error <code>fred is not in the sudoers file.  This incident will be reported.</code> (This means that an entry has been logged in <code>/var/log/messages</code>.)</p>
<p>So, <code>fred</code> can currently not use sudo. Switch back to <code>vagrant</code> and run the command <code>sudo cat /etc/sudoers</code>. Everything is commented out except <code>root ALL=(ALL) ALL</code> and the last line <code>#includedir /etc/sudoers.d</code> (this is not a comment!) which contains a single file <code>vagrant</code> with the line <code>vagrant ALL=(ALL) NOPASSWD: ALL</code> which is why vagrant can use sudo in the first place.</p>
<p>However, note the commented lines such as</p>
<pre><code># %wheel ALL=(ALL) NOPASSWD: ALL
# %sudo ALL=(ALL) ALL
</code></pre>
<p>If uncommented, the first one would let everyone in group wheel run commands using sudo (this is the default on some other linux distributions), whereas the second one would allow everyone in the group <code>sudo</code> to do this, but would prompt for their own password beforehand.</p>
<p>Let's allow people in the users group to reboot the machine. Open a root shell with <code>sudo su</code> as vagrant; this is so we don't get locked out if we break sudo.</p>
<p>Edit the sudoers file with <code>nano /etc/sudoers</code> as root, and add the following line:</p>
<pre><code>%users ALL=(ALL) /sbin/reboot
</code></pre>
<p>and save the sudoers file.</p>
<p>If you read the comment at the top of the file, it suggests using <code>visudo</code> to edit the file. Since we don't want to use vi, we can instead check the syntax with <code>visudo -c</code> and check that we get &quot;parsed OK&quot;; if not then we edit the file again to fix it (this is why we opened a root shell: if there's a syntax error in the file, sudo would refuse to run at all).</p>
<p>You can now switch back to <code>fred</code> (check the prompt to make sure you are Fred) and do <code>sudo reboot</code>. After asking for Fred's password, the virtual machine will now reboot, which you notice because you get kicked out of your ssh connection. Another <code>vagrant ssh</code> after a few seconds will get you back in again.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>After rebooting, your <code>/vagrant</code> shared folder might not work. In this case, log out and do <code>vagrant halt</code> then <code>vagrant up</code> and <code>vagrant ssh</code> again on the host machine.</p>
<p>When vagrant boots your VM, it automatically sets up the shared folder, but this doesn't always work if you reboot the VM yourself.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pipes"><a class="header" href="#pipes">Pipes</a></h1>
<p>The command <code>ls | head</code> runs ls and head and pipes the standard output of ls into the standard input of head.</p>
<p>The following shell commands are particularly useful in pipes:</p>
<ul>
<li><code>cat [FILENAME [FILENAME...]]</code> writes the contents of one or more files to standard output. This is a good way of starting a pipe. If you leave off all the filenames, cat just reads its standard input and writes it to standard output.</li>
<li><code>head [-n N]</code> reads its standard input and writes only the first N lines (default is 10 if you leave the option off) to standard output. You can also put a minus before the argument e.g. <code>head -n -2</code> to <em>skip the last 2 lines</em> and write all the rest.</li>
<li><code>tail [-n N]</code> is like head except that it writes the last N lines (with a minus, it skips the first N ones).</li>
<li><code>sort</code> reads all its standard input into a memory buffer, then sorts the lines and writes them all to standard output.</li>
<li><code>uniq</code> reads standard input and writes to standard output, but skips repeated lines that immediately follow each other, for example if there are three lines A, A, B then it would only write A, B but if it gets A, B, A it would write all three. A common way to remove duplicate lines is <code>... | sort | uniq | ...</code>.</li>
<li><code>grep [-iv] EXPRESSION</code> reads standard input and prints only lines that match the regular expression to standard output. With <code>-i</code> it is case-insensitive, and with <code>-v</code> it only prints lines that do <em>not</em> match the expression.</li>
<li><code>sed -e COMMAND</code> reads lines from standard input, transforms them according to the command and writes the results to standard output. <code>sed</code> has its own command language but the most common one is <code>s/SOURCE/DEST/</code> which changes substrings matching the source regular expression into the destination one.</li>
<li><code>wc [-l]</code> stands for word count, but with <code>-l</code> it counts lines instead. Putting a <code>wc -l</code> on the very end of a pipe is useful if you just want to know how many results a particular command or pipe produces, assuming the results come one per line.</li>
</ul>
<p>All these commands actually take an optional extra filename as argument, in which case they read from this file as input. For example, to display the first 10 lines of a file called <code>Readme.txt</code>, you could do either <code>cat Readme.txt | head</code> or <code>head Readme.txt</code>.</p>
<h2 id="word-list-exercises---pipes-and-regular-expressions"><a class="header" href="#word-list-exercises---pipes-and-regular-expressions">Word list exercises - pipes and regular expressions</a></h2>
<p>Most linux distributions come with a dictionary file <code>/usr/dict/words</code> that contains a list of English words in alphabetical order, for use in spell-checking programs. The list includes a selection of proper nouns, for example countries and cities. Alpine linux, true to its principles of being minimal, omits this file - but you can download one yourself with</p>
<pre><code>wget https://users.cs.duke.edu/~ola/ap/linuxwords -O words
</code></pre>
<p><code>wget</code> is one of two utilities for downloading files, the other being <code>curl</code>. Note that the option for output file name is a capital O, not a lowercase o or a zero.</p>
<p>Find one-line commands, possibly with pipes, to print the following to your terminal. You can either start each command with <code>cat words | ...</code> or do it without cat by providing the words file as an argument to the first command in your pipeline.</p>
<p><em>If English is not your native language, ignore the guessing part - it is not assessed.</em></p>
<ul>
<li>The first word in the file. <em>Can you guess what it will be, it is a city in Europe?</em></li>
<li>The last word in the file. <em>Can you guess this one, another city in Europe?</em></li>
<li>The number of words in the words file - there is one word per line.</li>
<li>The 6171st word in the file. <em>Can you read my mind and guess this word directly?</em></li>
<li>All words containing the letter Q, capitalised. (A regular expression containing a string of one or more letters matches all strings that contain the expression as a substring.)</li>
<li>All words starting with the letter X. The regular expression <code>X</code> would match an X anywhere in the word, but <code>^X</code> matches an X only at the start of the string.</li>
<li>All words ending in j. (The expression <code>'j$'</code> matches a j only at the end of the string, but you have to single-quote it to stop the shell from interpreting the dollar sign). <em>Can you guess the word - it is a city in eastern Europe?</em></li>
<li>The number of words containing the letter Q, ignoring case (e.g. capitalised or not).</li>
<li>The first five words containing the letter sequence <code>cl</code>.</li>
<li>All words containing the sequence &quot;kp&quot;, but not &quot;ckp&quot;. <em>Can you guess any of these?</em></li>
<li>The last 15 words of exactly two letters. The expression <code>.</code> (period) matches a single character, and <code>'^...$'</code> for example would match all strings of the format <em>exactly three characters between start and end of string</em>. You need to quote it because of the dollar sign.</li>
<li>All words from the first 100 words on the list, which contain the letter y.</li>
<li>The first five words that are among the last 100 words on the list, and contain the letter y (whether capitalised or not).</li>
<li>All three-letter words with no vowels (aeiou).The regular expression <code>'[aeiou]'</code> matches any string that contains one of the bracketed characters; you need quotes to stop the shell from interpreting the brackets. Remember to exclude words with capitalised vowels as well. <em>There are 12 of these, can you guess them all before looking?</em></li>
<li>All words of exactly 7 letters, where the third one is an e and the word ends &quot;-ded&quot;. <em>This kind of search is really useful for crosswords. There are 9 words of this form, can you guess them?</em></li>
</ul>
<p>Bonus regular expression question:</p>
<ul>
<li>Find all words that start with a P (whether capitalised or not), and contain at least four instances of the letter a. Putting a <code>*</code> after something in a regular expression searches for <em>any number of repetitions of this, including 0</em> so for example <code>'a*'</code> would find words with any number of the letter a, including 0 (which is not what you want here). You need single quotes to stop the shell from expanding the <code>*</code>. <em>Can you guess the words? There are essentially four of them, two demonyms (for some reason one of them has a plural in the list, the other doesn't), and two nouns which are not proper nouns.</em></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="activity-git"><a class="header" href="#activity-git">Activity: Git</a></h1>
<h2 id="videos-2"><a class="header" href="#videos-2">Videos</a></h2>
<table><thead><tr><th>Video</th><th style="text-align: right">Length</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/e30fddec-b920-43d0-9f84-f650041e2e0e?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Git, part 1</a></td><td style="text-align: right">21 minutes</td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/f9486304-e51d-434e-9ae2-7ace1d26068e?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Git, part 2</a></td><td style="text-align: right">27 minutes</td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/ee347f5e-20f4-4baf-87c6-abc58b40f66a?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Git, part 3</a></td><td style="text-align: right">19 minutes</td></tr>
</tbody></table>
<h2 id="exercises-2"><a class="header" href="#exercises-2">Exercises</a></h2>
<ul>
<li><a href="git/./git1.html">Git, part 1</a></li>
<li><a href="git/./git2.html">Git, part 2</a></li>
<li><a href="git/./git3.html">Git, part 3</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-part-1"><a class="header" href="#git-part-1">Git, part 1</a></h1>
<p>For this exercise, I am assuming that you are working on alpine linux and have nano, git and gcc with musl-dev installed as in the last exercise.</p>
<h2 id="configuring-your-identity"><a class="header" href="#configuring-your-identity">Configuring your identity</a></h2>
<p>Run the following two lines to set up git correctly. You only need to do this once when you install git, but not every time you create a new repository.</p>
<pre><code>git config --global user.name &quot;YOURNAME&quot;
git config --global user.email &quot;YOUREMAIL&quot;
</code></pre>
<p>where you obviously replace your name and email with something of your choice; I've put them in double quotes because this lets you include a space between your first and last names and the @ character in your email address.</p>
<p>This does not create a user account - git just uses your name and email to record the author in any commits you make, so you can put anything you like here (git will happily accept <code>-</code> as your email address, and it does not send you email). Of course, once you are working in a team with other students, you will probably want to use your real name so they know who has made which commits.</p>
<p>If you are running a VM on a lab machine, then you would need to reconfigure git every time vagrant rebuilds the VM, for example when you log in to a different lab machine. You can put these commands in your Vagrantfile, like anything else that you want to run when vagrant (re)builds your box, but they need to be run as the vagrant user and not the root user. So add the following block to your vagrantfile just before the <code>end</code> line, editing your name and email address obviously; the key point being the <code>privileged: false</code> entry which runs the commands as the <code>vagrant</code> user:</p>
<pre><code>config.vm.provision :shell, privileged: false, inline: &lt;&lt;-SHELL
    git config --global user.name &quot;YOURNAME&quot;
    git config --global user.email &quot;YOUREMAIL&quot;
SHELL
</code></pre>
<p>Of course this will only work if git is installed, but you've added git to the <code>apk add</code> line in the previous provision block already so it will be installed.</p>
<h2 id="a-sample-project-and-repository"><a class="header" href="#a-sample-project-and-repository">A sample project and repository</a></h2>
<p>Let's say you want to start developing a C program. Let's make a folder:</p>
<pre><code>mkdir project1
cd project1
git init
</code></pre>
<p>The last command created an empty git repository in a subfolder called <code>.git</code>. We can check with <code>git status</code> to see whether there are any changes, and git reports <code>nothing to commit</code>.</p>
<p>Create a file, for example with <code>nano main.c</code> and add some sample content like this (you should be able to copy-paste into your terminal):</p>
<pre><code class="language-C">// file: main.c
#include &lt;stdio.h&gt;

int main() {
    puts(&quot;Hi&quot;);
    return 0;
}
</code></pre>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>If you install the <code>nano-syntax</code> package, you get syntax highlighting in nano, but you need to configure this first. The syntax files themselves live in <code>/usr/share/nano</code>, for example <code>c.nanorc</code> for the C language, but you have to include the ones you want in a file <code>~/.nanorc</code>. For example, if this file contains the line <code>include /usr/share/nano/c.nanorc</code> then nano will do syntax highlighting on C files. You can turn this on and off with Alt+Y.</p>
<p>On another note - if you just want to print a simple string in C, then please use puts not printf. Printf with one argument is silly and, depending on how you write it, also insecure.</p>
</div>
</div>
<p>Do a <code>git status</code> and you will see <code>main.c</code> in red under <em>untracked files</em> - this is a new file that git does not know about yet. Do <code>git add main.c</code> followed by another <code>git status</code> and the file is now green under <em>files to be committed</em>.</p>
<p>Commit the file with <code>git commit -m &quot;first file&quot;</code> or something like that - you need double quotes if you want spaces in your commit message. Try <code>git status</code> again and you should see <em>nothing to commit, working tree clean</em> which means git is up to date with your files. Try <code>git log</code> and you will see that there is now one commit in the log.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Every git commit must have a commit message. You can either add one with the <code>-m</code> flag, or leave that off and git will drop you into the system default editor to write one. That is normally vi, which has a unique set of keyboard commands (the command to quit is <code>:q</code> followed by ENTER). You can run the shell command <code>export EDITOR=nano</code> to change your default editor, then a raw <code>git commit</code> will launch nano. If you want to keep this setting when you relaunch your shell next time you log in, then the export line has to go in a file called <code>.profile</code> in your home directory, which is a file that the bash shell processes when it starts up.</p>
<p>To keep a profile file around when vagrant rebuilds your VM if you're on a lab machine, I would put the file in <code>/vagrant/.profile</code> as that is backed up (it ends up in the folder on the host machine with the Vagrantfile) and then put the following command in your non-privileged provisioning block from the last advanced note: <code>ln -s /vagrant/.profile /home/vagrant/.profile</code>. This creates a soft link like you have already seen in <code>/bin</code> earlier.</p>
</div>
</div>
<h2 id="ignoring-files"><a class="header" href="#ignoring-files">Ignoring files</a></h2>
<p>Compile your code with <code>gcc main.c -o program</code>, and check with <code>./program</code> that it runs and prints <em>Hi</em>. (If you get an error that <code>stdio.h</code> doesn't exist, then you have installed gcc but not <code>musl-dev</code> which is the package that contains the header files.)</p>
<p>If you look at <code>git status</code> now, the program file shows as untracked, but we do not want to commit it: the repository works best when you store only your source code, and anyone who needs to can check out a copy and build from there. Among other things this means that people on different platforms e.g. linux and mac, intel and ARM and so on can each compile the version that works for them.</p>
<p>So we want to tell git to ignore the program and changes in it, which we do by creating a file called <code>.gitignore</code> and adding an expression on each line to say which file(s) or folders to ignore - you can use <code>*.o</code> to select all object code files, for example.</p>
<ul>
<li>Create a file <code>.gitignore</code> and add the single line <code>program</code> to it.</li>
<li>Do another <code>git status</code> and notice that while the program is now ignored, the ignore file is marked as new. This file does belong in the repository, so add it and commit it.</li>
<li>Check that <code>git status</code> reports <em>clean</em> again, and that <code>git log</code> contains two commits.</li>
</ul>
<h2 id="commit-and-checkout"><a class="header" href="#commit-and-checkout">Commit and checkout</a></h2>
<p>As you develop, you should regularly code, commit, repeat. To practice this, change <em>Hi</em> to <em>Hello</em> in the program, rebuild and run the program, then add and commit the source file again - check with <code>git status</code> at the end that you get <em>clean</em> again.</p>
<p>The command <code>git add .</code> adds all new and changed files and folders in the current folder in one go, and is typically the quickest way to add things when you want to commit all your changes since the last commit.</p>
<p>Sometimes you want to go back and look at another commit, or undo a commit that broke something - this is when you want a checkout.</p>
<ul>
<li>Use <code>git log</code> to show the history of your commits. (When you have more than one screen, <code>git log |less</code> lets you scroll.)</li>
<li>Note the first 6 or so characters of the commit hash of the commit where you added the ignore file, but before changing <em>Hi</em> to <em>Hello</em>. You need at least 6 characters, but only as many so that it's not ambiguous to git which commit you mean.</li>
<li>Run <code>git checkout HASH</code> where HASH is the 6 or however many you need characters of the commit in question. Git will print a warning about the HEAD pointer.</li>
<li>Check the source file, and notice that it is now back on <em>Hi</em>.</li>
<li>Use <code>git checkout master</code> to return to the latest version of your files, and git will set up the HEAD pointer again ready to accept new commits.</li>
</ul>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>If you actually want to undo a commit, then you have two options:</p>
<ul>
<li><code>git revert HASH</code> adds a new commit that returns the files to the state they were before the commit with the given hash. This is safe to use during team development, as it's just adding a new commit. If you have commits A, B and do <code>git revert B</code> then you get a new commit C so anyone else using the repository sees a sequence of commits A, B, C; but the state of the files in C is the same as in A.</li>
<li><code>git reset HASH</code> undoes commits by moving the HEAD pointer back to the commit with the given hash, but leaves the working copy alone (you can use the <code>--hard</code> option to change the files as well). This will break things if you have shared your newer commits with other developers, but it's safe to use to undo changes that you haven't pushed yet (we'll learn about this next time). The effect is as if the commits which you've reset had never happened.</li>
</ul>
<p>Note: if you want to revert a commit because you accidentally commited a file with secret information, and you've already pushed the commit, then you also have to look up online how to &quot;force push&quot; your changes to erase all traces of the file on github (or other online providers). If the secret file contained any passwords, even if you reverted the commit immediately, then you should consider the passwords compromised and change them at once.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-part-2"><a class="header" href="#git-part-2">Git, part 2</a></h1>
<p>In this exercise we will set up and use a git account on a remote provider. The &quot;big 3&quot; for hosting git repositories are:</p>
<ul>
<li><a href="https://github.com">github.com</a></li>
<li><a href="https://gitlab.com">gitlab.com</a></li>
<li><a href="https://bitbucket.org">bitbucket.org</a></li>
</ul>
<p>This exercise is based on github, as this is the most popular provider, but you can use one of the other two if you want as well (the slides show the equivalent version for gitlab) - although the web user interface and some advanced features are different, interacting with all three on the command line is identical and all three offer unlimited private and public repositories (within reason).</p>
<h2 id="set-things-up"><a class="header" href="#set-things-up">Set things up</a></h2>
<p>Go to <a href="https://github.com">github.com</a> and register with a username, an e-mail address and a password. You might have to click a confirmation link in an e-mail sent to you.</p>
<p>We are going to use git over SSH, so you need to let git know your public key (remember, you never give anyone your private key!). Click the icon in the top right corner of the screen that represents your avatar (you can of course set a custom one if you like) and choose <em>Settings</em> in the menu, then on the settings page choose <em>SSH and GPG keys</em>.</p>
<p>Choose <em>New SSH key</em>, and paste your SSH public key in the <code>Key</code> box - this is the file <code>~/.ssh/id_ed25519.pub</code> that you created in the last activity. (The file <code>id_ed25519</code> without <code>.pub</code> in the same folder is your private key, and you never paste that anywhere.) Give your key a title if you like, then add it with the green button. Github supports all common SSH key formats, but will warn you if you do something silly like upload a private key or a key in an outdated and weak cipher.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>If you have many devices (desktop, laptop) that you work from and many servers (github, gitlab, lab machine etc.) that you connect to, how do you manage keys?</p>
<p>Using the same public key for different services is not a security problem: even if one service gets hacked and you connect to it while it's under the hacker's control, that does not leak your private key. Unlike passwords, you can safely reuse public keys.</p>
<p>However, reusing public keys can be a privacy problem, because every service that you use the same public key (or e-mail address, or phone number etc.) can potentially work with the others to know that you are the same individual. It is no problem to use different keypairs for different services, in which case you probably want a block in your <code>~/.ssh/config</code> file with something like </p>
<pre><code>Host github.com
    IdentityFile FILENAME
</code></pre>
<p>to tell SSH that the key for this host is named something other than the default <code>id_ed25519</code>.</p>
<p>You can copy the same private key to different devices that you own, or you can set up a different key for each device and add the public keys of all of them to github and the different providers. This is a security/convenience trade-off, the security angle being what happens if one of your devices gets stolen or otherwise compromised.</p>
<p>If you are running this exercise on an alpine VM hosted on a lab machine, then because the lab machine does not belong to you, I would not use the same private key on your VM than on your own computer, especially not if you use your own computer to access other services than the university. If you want to use Github both from your own machine and from the lab machines, then create a separate keypair for each and enrol both the public keys with Github.</p>
</div>
</div>
<p>I am assuming that you will be running the git commands in the rest of this section on an alpine linux VM, either on your machine or on a lab machine, however if you have git installed on your own machine directly (which is a good idea) then you can run this exercise there too.</p>
<h2 id="a-note-on-naming"><a class="header" href="#a-note-on-naming">A note on naming</a></h2>
<p>When git first appeared, whenever you created a repository you started with one branch called <code>master</code>. Different workflows and branch naming conventions appeared over time (we will see one of these in the next activity).</p>
<p>As far as git is concerned, a branch name is just a string and any other name would do just as well (as long as it does not contain spaces, slashes or a few other special characters). As far as humans go, in 2020 it came to developers' attention that the term <code>master</code> is sometimes used in problematic ways in engineering in general and computing in partciular, specifically, a system where several components perform similar roles but one of them is the authoritative one in case of discrepancy has historically been called a <em>master/slave</em> system.</p>
<p>The git developers' first reaction was to make it easier to choose a different name for your first branch; the latest version of git prints a message on how to do this when you create a repository (the configuration setting is <code>init.defaultBranch</code>) and the online providers such as github offer a text field for this too. At the moment, <code>main</code> seems to be the most popular alternative name for the first branch, but at the time of writing there does not seem to be a clear consensus yet. I have seen both <code>default</code> and <code>root</code> suggested as first branch names, neither of which seems to have gained much traction though. Another contender for workflows which use a <code>develop</code> branch anyway is to use that as the initial branch. The latest post on the matter from <a href="https://sfconservancy.org/news/2020/jun/23/gitbranchname/">software freedom conservancy</a> is dated June 2020 and states that the matter is &quot;currently being discussed on our mailing list&quot;.</p>
<p>There has been some debate about whether the name &quot;master&quot; in git traces back to <em>master/slave</em> or another, less problematic use of word e.g. the phrase <em>master copy/master recording</em> from the music industry - the most authoritative source I can find on the matter is <a href="https://git.github.io/rev_news/2020/07/29/edition-65/">git rev news 65, July 2020</a> from the git developers themselves, which also states that a change of the default branch name might happen in Git 3.0 (the version installed in Alpine at the time of writing is 2.30.0).</p>
<p>There is another line of argument that the word <em>master</em> as a default branch name (and thus something developers will refer to a lot) is inherently problematic even if it came from a different origin than <em>master/slave</em>. This is a complicated issue as, among other things, half the cohort taking Software Tools is probably on a <em>Master's Degree</em> and one of the criteria for a first-class mark is showing <em>mastery</em> of the unit material - all terms that will be much harder to change than a simple repository name which is one line of commands to change. Git does not care what your branches are called after all, one string is as good as another (as long as it doesn't contain special characters or spaces).</p>
<p>However, a fresh installation of git will still call the branch <code>master</code> unless you change a configuration setting, and any book, tutorial, forum or stackexchange post online written about git before around mid-2020 will refer to <code>master</code> so there is currently no way around knowing that in the context of git, the term <code>master</code> refers to a branch with a particular role, but as a future developer you should also have an understanding of the community and conventions around your tools and you should definitely know that there is a currently ongoing discussion around this term.</p>
<p>For the 2020-21 academic year, I have decided to go with <code>master</code> for this unit as I don't feel it's my job to pre-empt a decision on the new default name - github is in favour of <code>main</code> but the git developers do not seem to have made a final decision yet; and because you will encounter the term <code>master</code> in git itself and in a lot of existing repositories and documentation (including the official <a href="https://git-scm.com/book/en/v2">git book</a> at the time of writing); it will be easy enough to update these notes for 2021-22 if everyone has switched to <code>main</code> or something else by then.</p>
<p>For your own repositories, you are free to choose whatever name you like, and you can configure this with the command</p>
<pre><code>git config --global init.defaultBranch NAME
</code></pre>
<p>and then follow the rest of the git exercises, mentally replacing <code>master</code> by <code>main</code> or your choice of other name. </p>
<p>When you create a repository on github, the default name you get depends on your settings, which seems to depend on when you created your account - if you create an account today, you will get <code>main</code> as the default name but on my account (which has been around for years) I still get <code>master</code>. The page you want to check while logged in to github is https://github.com/settings/repositories; if you get <code>main</code> as your default then please use that in the rest of this tutorial.</p>
<p>To finish with a quote from the git book:</p>
<blockquote>
<p>The &quot;master&quot; branch in Git is not a special branch. It is exactly like any other
branch. The only reason nearly every repository has one is that the git init
command creates it by default and most people don't bother to change it.</p>
</blockquote>
<h2 id="create-a-repository"><a class="header" href="#create-a-repository">Create a repository</a></h2>
<p>On the main page, you should see an empty <em>Repositories</em> bar on the left, with a new button. Use that to create a repository, on the next page give it a name and tick the <em>Add a README file</em> box.</p>
<p>On the repository page, there is a green <em>Code</em> button. Clicking that opens a box with three tabs: <em>HTTPS</em>, <em>SSH</em> and <em>GitHub CLI</em>.</p>
<p>Each repository has a two-part name: the first part is the owner's github username, the second part is the repository name. For example, the repository for this unit is called <code>cs-uob/COMS10012</code>. There are two ways to interact with a remote repository:</p>
<ul>
<li>Via HTTPS. This is ok if you are just cloning a public repository, as it does not require any authentication. To interact with a private repository or to push files, HTTPS requires username/password authentication, and we can do better than that.</li>
<li>Via SSH, using keys. This is the recommended way to use Git.</li>
</ul>
<p>Click the SSH tab and copy the URL there - it should be something like <code>git@github.com:USERNAME/REPONAME.git</code>.</p>
<p>On the command line, run the command <code>git clone git@github.com:USERNAME/REPONAME.git</code> where you replace USERNAME and REPONAME with the parts from the SSH tab of your repository. Git clones your repository and puts the content in a subfolder named after the repository name - you can change this by providing a different folder name as an extra command-line argument to <code>git clone</code>, or you can just move or rename the folder later on.</p>
<p><em>Note: certain OS/ISP/DNS combinations might get you &quot;resource temporarily unavailable&quot; when you try and access github via ssh. The problem is that the actual address is <code>ssh.github.com</code> and not all set-ups correctly pass on the redirection when you try and connect to github directly. If you are experiencing this error, you can either use <code>ssh.github.com</code> in place of <code>github.com</code>, or add an entry in your <code>~/.ssh/config</code> file as follows (if you have to create this file first, make sure it is not writable by anyone except yourself or ssh will refuse to accept it):</em></p>
<pre><code>Host github.com
  Hostname ssh.github.com
  Port 22
</code></pre>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Notice that git did not ask for your username. It can determine your identity from your public key, as that is stored in your user account.</p>
<p>In the last activity, we configured a name and e-mail address for git commits. When you push commits to github, this information will appear in every commit, but it does not have to match your Github account information - Github will let you push commits with any name you like, as you might be pushing them on behalf of someone else.</p>
</div>
</div>
<p>Go to that folder, and try <code>git remote show origin</code>. Here, <code>origin</code> is the default name of a <em>remote</em>, and the result should look a bit like this:</p>
<pre><code>* remote origin
  Fetch URL: git@github.com:USERNAME/REPONAME
  Push  URL: git@github.com:USERNAME/REPONAME
  HEAD branch: master
  Remote branch:
    master tracked
  Local branch configured for 'git pull':
    master merges with remote master
  Local ref configured for 'git push':
    master pushes to master (up to date)
</code></pre>
<p>The bits about <code>master</code> are to do with branches, which we will discuss in another activity in more detail. <em>You might see <code>main</code> instead of master, in which case please use <code>main</code> instead of <code>master</code> from now on.</em></p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>You can have several remotes with different names - for example if you fork (create your own copy of someone else's repository) then you get the original one as a second remote named <em>upstream</em>, so you can share changes back with them - this is the way you create new content for the <a href="https://cssbristol.co.uk">CSS website</a> for example.</p>
<p>You can also use folders as remotes: if you want to practice resolving merge conflicts, you could do the following:</p>
<pre><code>mkdir remote
cd remote
git init --bare
cd ..
mkdir user1
git clone remote user1
mkdir user2
git clone remote user2
</code></pre>
<p>This gets you a remote and two &quot;users&quot; in different folders to play with. The remote was set up with <code>--bare</code> so that it does not contain a working copy, but acts as a pure repository.</p>
<p>You can now <code>cd user1</code> to simulate user 1 doing work, and can fetch/push/pull as described below. (Ignore warnings about &quot;upstream&quot;, they will go away once you have committed a file to the repository.) Then you can <code>cd ../user2</code> to switch to a second working copy, which you can pretend is another user on another machine.</p>
<p>If you want to adjust the user names for the commits, then running <code>git config user.name &quot;YOURNAME&quot;</code> and <code>git config user.email &quot;YOUREMAIL&quot;</code> without the <code>--global</code> option from last time changes the settings just for one repository.</p>
</div>
</div>
<p>Do a <code>git status</code> and note that a new line appears compared to last activity:</p>
<pre><code>Your branch is up to date with 'origin/master'.
</code></pre>
<p>This line comes in four versions:</p>
<ul>
<li>Up to date: there have been no commits on your local or the remote repository since you last synchronised.</li>
<li>Ahead of remote: you have made commits locally that you have not yet pushed to the remote.</li>
<li>Behind remote: someone else, or you on a different computer, have made commits to the remote that you do not have on this computer yet.</li>
<li>Diverged from remote: both your computer and the remote have had different commits since the last time you synchronised. </li>
</ul>
<h2 id="practice-the-push-workflow"><a class="header" href="#practice-the-push-workflow">Practice the push workflow</a></h2>
<p>For this exercise, you should work in pairs or larger groups.</p>
<p>One person creates a private repository (tick the box to add a README file) and adds everyone else in the group to it. You all need to have an account with the same provider for this to work.</p>
<ul>
<li>On Github, the way to add people to a repository is on the repository page: choose <em>Settings</em> in the top menu, then <em>Manage access</em>. Here you can press <em>Invite a collaborator</em> and enter their Github username. This causes Github to send them an e-mail with a link they need to click to accept the invitation and be added to the repository. <em>Note: you must be logged in to github when you click the link on the invitation e-mail, otherwise you will get an error message.</em></li>
<li>On Gitlab, the place to add people is under <em>Members</em> in the left menu on the repository page, and there are different access levels - give them  <em>Maintainer</em> access to let them push commits.</li>
</ul>
<p>Everyone <code>git clone</code>s the repository to their own alpine VM (or their own machine directly).</p>
<p>Everyone does the following, one person at a time doing all steps (coordinate among each other):</p>
<ol>
<li>Imagine that it is mid-morning and you are starting on a day's coding.</li>
<li>First, make sure your terminal is in the folder with your working copy, and type <code>git fetch</code>.
<ul>
<li>If you get no update, then there were no changes on the remote since your last fetch and you are ready to start coding. (This should happen to the first person to do this step.)</li>
<li>If you get output, then there were changes on the remote. Do a <code>git status</code> to see details (everyone except the first person should see this). Notice the line <code>behind origin/master ... can be fast-forwarded.</code> which means you just need to <code>git pull</code> and you will get the latest version of the files. Do a <code>git log</code> too to see the last person's commit message.</li>
</ul>
</li>
<li>Do some coding: make a change to the repository - add or change a file, then commit your changes. You can use <code>nano FILENAME</code> to create and edit a file in your terminal, if you have installed it as described in the last activity.</li>
<li>Run the following push workflow to push your changes to the remote:
<ol>
<li>Do a <code>git fetch</code> to see if there were any remote changes (there shouldn't be, for this exercise).</li>
<li>Do a <code>git status</code> and make sure you are <code>ahead of origin</code>, not <code>diverged</code>.</li>
<li>Do a <code>git push</code> to send your changes to the remote.</li>
</ol>
</li>
</ol>
<p>You can now code as a team, as long as only one person at a time is working - clearly not ideal.</p>
<h2 id="resolve-a-fake-conflict-part-one"><a class="header" href="#resolve-a-fake-conflict-part-one">Resolve a fake conflict, part one</a></h2>
<p>Produce a &quot;fake&quot; conflict as follows:</p>
<ol>
<li>Two team members make sure they are <code>up to date</code> with their working copies (do a <code>git pull</code>, then <code>git status</code>). This represents you both starting coding in the morning.</li>
<li>One member adds or changes one file, then commits this change and pushes it by running the whole push workflow (fetch, status - check you're ahead, push).</li>
<li>At the same time as the first member is doing step 2, the second member adds or changes a different file, then commits this change. This represents two team members working in parallel, with the member one being the first one to complete their work and push a commit back to the remote.</li>
<li>The second member starts the push workflow with <code>git fetch</code>, then <code>git status</code>. Notice you have <code>diverged</code>. (If you were to try to <code>git push</code>, with or without fetching this would produce an error.)</li>
</ol>
<p>The commit graph of member two looks something like this:</p>
<p><img src="git/../resources/before-rebase.png" alt="diagram of commits before rebase" /></p>
<p>One way to resolve this conflict is a <em>rebase</em>, which is pretending that member two had actually fetched the <code>one</code> commit before starting their own work. The command for this which member two types is <code>git rebase origin/master</code> which means <em>pretend that everything in origin/master happened before I started my local changes</em> and gives the following graph:</p>
<p><img src="git/../resources/after-rebase.png" alt="diagram of commits after rebase" /></p>
<p>Indeed, if member two does a <code>git status</code> after the rebase, they will see <code>ahead of origin/master by 1 commit</code> and they can now <code>git push</code> to send their local changes to the remote repository.</p>
<p>Different companies and teams have different opinions on when a rebase makes sense: some places forbid rebasing like this entirely, at least for work that is genuninely shared between different people. There is more or less a general consensus that you should not rebase when different people were editing the same files, but it is a technique worth knowing about for conflicts like the one you just created where different people have edited different files, as it makes for a cleaner commit graph.</p>
<h2 id="fake-conflicts-part-two"><a class="header" href="#fake-conflicts-part-two">Fake conflicts, part two</a></h2>
<p>The other way to fix conflicts - and the only one that some people will use - is a merge. Let's do another fake conflict, but resolve it with a merge this time:</p>
<ol>
<li>Two team members both get their repositories up to date with the remote. If you have just followed the instructions above then team member one has to <code>git pull</code> and team member two is already up to date because they have just pushed; both team members should check with <code>git fetch</code> then <code>git status</code> that they are <code>up to date</code>.</li>
<li>Like before, team member one edits one file, commits it and does the whole push workflow (fetch, status - check you're ahead, push). The second team member at the same time, without another fetch, edits a different file and commits.</li>
<li>The second team member starts the push workflow: fetch, status - notice you've <code>diverged</code>.</li>
</ol>
<p>The second member's commit graph looks similar to the previous one before the rebase, perhaps with more commits in place of the <em>initial</em> one.</p>
<p>The second member is about to do a merge, which can either succeed (as it should here, because different people edited different files) or fail with a merge conflict (for example if different people edited the same file). If a merge succeeds, then git will make a merge commit and will drop them into their system's default editor, which is normally <code>vi</code>. Because we don't want to learn that right now, the second member should type <code>echo $EDITOR</code> in their shell and see what they get - if they get <code>nano</code> then they're fine, if they get an empty line then they should do <code>export EDITOR=nano</code>.</p>
<p>The second team member types <code>git pull</code>. Since this is a fake conflict (different files), this gets you into your editor, and you can see that on the first line is a suggested commit message starting with <code>Merge branch master</code>, which it is conventional to accept without changes - exit your editor again. Git replies <code>Merge made by the recursive strategy.</code> and your commit graph now looks something like this (the <code>...</code> stands for the last commit from the previous section):</p>
<p><img src="git/../resources/after-merge.png" alt="diagram of commits after merge" /></p>
<h2 id="resolving-a-real-conflict"><a class="header" href="#resolving-a-real-conflict">Resolving a real conflict</a></h2>
<p>And next, we'll practice dealing with a real conflict, where two people have edited the same file.</p>
<ol>
<li>Two team members get their repositories synchronised again: everyone does a <code>git pull</code>.</li>
<li>Team member one creates a file called <code>README.md</code> or edits it if it already exists, and adds a line like <code>Created by NAME</code> with their own name. Then they commit this change and run the push workflow: <code>git fetch</code>, <code>git status</code>, check they're <code>ahead</code>, <code>git push</code> to the remote.</li>
<li>Team member two, without fetching the latest commit, creates the same <code>README.md</code> file and adds a line <code>Created by NAME2</code> and commits this to their local repository. This simulates two people working on the same files in parallel since they both last fetched, and one of them (member one in this case) is the first to get their changes back to the remote.</li>
<li>Team member two starts the push workflow: <code>git fetch</code>, <code>git status</code> and notice that you have <code>diverged</code> again.</li>
<li>Run <code>git pull</code> as member two. You should see the following message:</li>
</ol>
<pre><code>CONFLICT (add/add): Merge conflict in README.md
Auto-merging README.md
Automatic merge failed; fix conflicts and then commit the result.
</code></pre>
<p>Open the file, for example <code>nano README.md</code> and notice that git has annotated it:</p>
<pre><code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
Created by NAME2.
=======
Created by NAME1.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; b955a75c7ca584ccf0c0bddccbcde46f445a7b30
</code></pre>
<p>The lines between <code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</code> and <code>=======</code> are the local changes (team member two) and the ones from <code>======</code> to <code>&gt;&gt;&gt;&gt;&gt;&gt; ...</code> are the ones in the commit fetched from the remote, for which the commit id is shown.</p>
<p>Member two now has to resolve the conflict by editing the file to produce the version they would like to commit. For example, you could remove all the offending lines and replace them with <code>Created by NAME1 and NAME2.</code></p>
<p>Member two can now do the following:</p>
<ul>
<li><code>git add README.md</code> (or whatever other files were affected).</li>
<li><code>git commit</code>. You could give a message directly, but a commit without a <code>-m</code> drops you into your editor and you'll see that git is suggesting <code>Merge branch master ...</code> as a default message here. It is conventional to leave this message as it is, just exit your editor without any changes.</li>
<li>Run another push workflow: <code>git fetch</code>, <code>git status</code> and notice you are now <code>ahead by 2 commits</code>: the first one was the work you did, the second is the merge commit. You're ahead, so finish the workflow with <code>git push</code>.</li>
</ul>
<p>Your commit graph looks the same as for the last merge that you did. </p>
<p>If you look at the repository's page on Github (<code>https://github.com/USERNAME/REPONAME</code>, where <code>USERNAME</code> is the name of the user who created the repository), then you can click on <em>Insights</em> in the top bar then <em>Network</em> on the left menu to see the commit history for the repository as a graph. Hovering over a commit node shows the committer, the message and the commit hash - and clicking on a node takes you to a page where you can see which changes were made in this commit.</p>
<p>On the main Github page for the repository, you can also click the clock icon with a number in the top right (on a wide enough screen it also shows the word <em>commits</em>) to go to a page showing all the commits on your repository in chronological order.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-part-3"><a class="header" href="#git-part-3">Git, part 3</a></h1>
<p>In this activity you will practice Git the way it is used in real teams. You will need to form a group for this activity, ideally more than two students.</p>
<h2 id="set-up"><a class="header" href="#set-up">Set-up</a></h2>
<p>One member makes a Git repository on one of the online providers, adds the other team members and shares the cloning URL. Everyone clones the repository.</p>
<p>The repository must have at least one commit for the following to work. This condition is satisfied if you chose your provider's option to create a readme file; if not then make a file now, commit it and push.</p>
<h2 id="the-develop-branch"><a class="header" href="#the-develop-branch">The develop branch</a></h2>
<p>By default, your repository has one branch named <code>master</code> (or <code>main</code> depending on how you or your provider set it up). But you don't want to do your work on this branch directly. Instead, one team member creates a <code>develop</code> branch with the command</p>
<pre><code>git checkout -b develop
</code></pre>
<p>The team member who created the develop branch should now make a commit on it.</p>
<p>This branch currently exists only in their local repository, and if they try and push they would get a warning about this.
What they need to do is</p>
<pre><code>git push --set-upstream origin develop
</code></pre>
<p>This adds an &quot;upstream&quot; entry on the local develop branch to say that it is linked to the copy of your repository called <code>origin</code>, which is the default name for the one you cloned the repository from.</p>
<p>You can check this with <code>git remote show origin</code>, which should display among other things:</p>
<pre><code>Remote branches:
  develop tracked
  master  tracked
Local branches configured for 'git pull':
  develop merges with remote develop
  master  merges with remote master
Local refs configured for 'git push':
  develop pushes to develop (up to date)
  master  pushes to master  (up to date)
</code></pre>
<p>Everyone else can now <code>git pull</code> and see the branch with <code>git branch -a</code>, the <code>-a</code> (all) option means include branches that only exist on the remote. They can switch to the develop branch with <code>git checkout develop</code>, which should show:</p>
<pre><code>Branch 'develop' set up to track remote branch 'develop' from 'origin'.
Switched to a new branch 'develop'
</code></pre>
<h2 id="feature-branches"><a class="header" href="#feature-branches">Feature branches</a></h2>
<p>Every team member now independently tries the following:</p>
<ul>
<li>Make a new branch with <code>git checkout -b NAME</code>, choosing a unique name for their feature branch.</li>
<li>Make a few commits on this branch.</li>
<li>Push your feature branch with <code>git push --set-upstream origin NAME</code>.</li>
<li>Make a few more commits.</li>
<li>Do a simple <code>git push</code> since you've already linked your branch to <code>origin</code>.</li>
</ul>
<p>Since everyone is working on a different branch, you will never get a conflict this way.</p>
<p>Anyone who is a project member can visit the github page can see all the feature branches there, but a normal <code>git branch</code> will not show other people's branches that you've never checked out yourself. Instead, you want to do <code>git branch -a</code>  again that will show you all the branches, with names like <code>remotes/origin/NAME</code> for branches that so far only exist on the origin repository. You can check these out like any other branch to see their contents in your working copy.</p>
<h2 id="merging"><a class="header" href="#merging">Merging</a></h2>
<p>When a feature is done, you want to merge it into develop. Everyone should try this, the procedure for this is</p>
<ol>
<li>Commit all your changes and push.</li>
<li>Fetch the latest changes from origin (a simple <code>git fetch</code> does this).</li>
<li><code>git checkout develop</code>, which switches you to the develop branch (the changes for your latest feature will disappear in the working copy, but they're still in the repository). You always merge into the currently active branch, so you need to be on <code>develop</code> to merge into it.</li>
<li><code>git status</code> to see if someone else has updated develop since you started your feature. If so, then <code>git pull</code> (you will be <em>behind</em> rather than <em>diverged</em> because you have not changed develop yourself yet).</li>
<li><code>git merge NAME</code> with the name of your feature branch.</li>
<li>Resolve conflicts, if necessary (see below).</li>
<li><code>git push</code> to share your new feature with the rest of the team.</li>
</ol>
<p>If no-one else has changed <code>develop</code> since you started your branch, or if you have only changed files that no-one else has changed, then the merge might succeed on the first attempt. It's still a good idea to check that the project is in a good state (for example, compile it again) just in case, and fix anything that's broken on the develop branch.</p>
<p>If the merge fails with a conflict, then you need to manually edit all the conflicted files (git will tell you which ones these are, do <code>git status</code> if you need a reminder) and <code>git commit</code> again.</p>
<p>The workflow for merging and resolving conflicts is essentially the same as the one from the last session, but since everyone is developing on a separate branch, the only time when you have to deal with a possible merge conflict is when you are merging your changes into develop - your own branches are &quot;private&quot; and you don't have to worry about hitting a conflict if you quickly want to commit and push your changes as the last thing you do before going home at the end of a long day's work.</p>
<h2 id="pull-requests"><a class="header" href="#pull-requests">Pull requests</a></h2>
<p>Pull requests are not a feature of the git software itself, but of the online providers. They let a team discuss and review a commit before merging it into a shared branch such as develop or master. Depending on the provider, branches can also be protected or assigned owners so that only the branch owner or developers with the right permissions can commit on certain branches.</p>
<p>The procedure for merging with a pull request on github, which you should try out:</p>
<ul>
<li>Commit and push your feature branch.</li>
<li>On github.com in your repository, choose <em>Pull Requests</em> in the top bar, then <em>New Pull Request</em> .</li>
<li>Set the <em>base</em> branch as the one you want to merge into, e.g. develop, and the <em>compare</em> branch as the one with your changes. Select <em>Create Pull Request</em>.</li>
<li>Add a title and description to start a discussion, then press <em>Create Pull Request</em> again to create the request.</li>
</ul>
<p>Anyone in the team can now go to <em>Pull Requests</em> in the top bar of the repository page and see the open requests. You can either comment on them, or if it is your role in the team to approve the request for this branch, you can approve the pull request which creates a merge.</p>
<p>Since a pull request is linked to a branch, you can use it for code review as follows:</p>
<ol>
<li>A developer creates a feature branch and submits a pull request.</li>
<li>The reviewer looks at the request. If they find bugs or other problems, they add a comment to the discussion.</li>
<li>The developer can address reviewer comments by making a new commit on their feature branch and pushing it, which automatically gets added to the discussion.</li>
<li>When the reviewer is happy, they approve the request which merges the latest version of the feature branch into the base branch (for example <code>develop</code>).</li>
</ol>
<p>There is just one complication left. Suppose the following happens:</p>
<ul>
<li>Your project starts out with commit <code>develop-1</code> setting up the initial version of the develop branch. Imagine there are two files, A and B.</li>
<li>You create a feature branch and make a commit <code>feature-1</code> which changes only file B.</li>
<li>In the meantime, someone else makes a feature that changes file A, and merges it as <code>develop-2</code> to the develop branch.</li>
</ul>
<p>You are now in the situation that <code>develop-2</code> has (new A, old B) and your <code>feature-1</code> has (old A, new B). Neither of these is what you want, you presumably want (new A, new B). We have met this situation before, but without branches. Graphically:</p>
<p><img src="git/../resources/pr-before-rebase.png" alt="diagram of commits before rebase" /></p>
<p>The solution here is to <em>rebase</em> your branch onto the latest commit on develop with <code>git rebase develop</code> and fix any conflicts that that causes, which produces the following situation:</p>
<p><img src="git/../resources/pr-after-rebase.png" alt="diagram of commits after rebase" /></p>
<p>If you now try and push your feature branch, you might get an error because the version of your feature branch on the origin repository still has the old version. The solution here is to force the push, which overwrites the old version, with</p>
<pre><code>git push --force origin BRANCHNAME
</code></pre>
<p>This is a <em>think before you type</em> kind of command because it can break things for other developers if you do it on a shared branch. The basic safety rules are:</p>
<ul>
<li>Only rebase on <em>private</em> branches.</li>
<li>Only force push on <em>private</em> branches, and only if it is absolutely necessary (for example to tidy up a rebase).</li>
</ul>
<p>A private branch is one that you know no-one else is working on, for example your own feature branches.</p>
<p>If you ever get into a situation where you need to rebase or force push on a shared branch such as develop or master, you generally need to make sure that everyone on the team knows what is going on, synchronises their repositories both before and after the dangerous operation, and does not make any commits or pushes while someone is working on it - basically they need, in concurrency terms, an exclusive lock on the whole repository while doing this operation.</p>
<p>This is one reason why the master and develop branches are kept separate - and some workflows even include a third branch called <code>release</code>. If merges into master or release only ever come from the develop branch, then a situation where you need to rebase these branches can never happen.</p>
<p>To summarise, the pull request workflow is:</p>
<ol>
<li>Commit and push your changes.</li>
<li>If necessary, rebase your feature branch on the develop branch.</li>
<li>Create a pull request.</li>
<li>If necessary, participate in a discussion or review and make extra commits to address points that other developers have raised.</li>
<li>Someone - usually not the developer who created the pull request - approves it, creating a merge commit in develop (or master).</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="activity-3"><a class="header" href="#activity-3">Activity 3</a></h1>
<h2 id="videos-3"><a class="header" href="#videos-3">Videos</a></h2>
<table><thead><tr><th>Video</th><th style="text-align: right">Length</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/a6b0b42d-21be-4d1e-960d-2323f437b46c?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">inodes</a></td><td style="text-align: right">28 minutes</td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/6b2eb8b5-bb65-4152-b27a-e5e71398741a?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">shell scripting 1</a></td><td style="text-align: right">17 minutes</td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/edbb35de-2b9f-46ce-99bc-e8468bdf9556?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">shell scripting 2</a></td><td style="text-align: right">21 minutes</td></tr>
</tbody></table>
<h2 id="exercises-3"><a class="header" href="#exercises-3">Exercises</a></h2>
<ul>
<li><a href="posix3/./stat.html">inodes and system calls</a></li>
<li><a href="posix3/./script.html">shell scripting</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="inodes-and-system-calls"><a class="header" href="#inodes-and-system-calls">Inodes and System Calls</a></h1>
<p>In this exercise we will look under the hood of the <code>stat</code> system call, which returns information about an inode.</p>
<p><em>Note: for this exercise it's even more important than usual that you are using Alpine linux in the emulator, as you will get different results if you try it on Windows Subsystem for Linux or on a Mac for example.</em></p>
<p>A system call is a way for a linux user or program to interact with the kernel, and there are usually at least three ways of calling each one:</p>
<ol>
<li>Execute the system call directly in assembly.</li>
<li>Use the wrapper function provided by your C library.</li>
<li>Use a command-line program provided by your distribution.</li>
</ol>
<h2 id="preparation"><a class="header" href="#preparation">Preparation</a></h2>
<p>Install the <code>musl-dev</code> package, which provides the header files for the C library, as well as <code>gcc</code> if you have not installed that yet.</p>
<p>Have a look at the manual page <code>man stat</code> for the <code>stat</code> system call. The abbreviated headers are:</p>
<pre><code class="language-C">#include &lt;sys/stat.h&gt;

int stat(const char *pathname, struct stat *statbuf);
int fstat(int fd, struct stat *statbuf);
int lstat(const char *pathname, struct stat *statbuf);
</code></pre>
<p><code>stat</code> is the main system call: you give it a pathname and it fills a <code>struct stat</code> for you with information about the inode associated with this pathname, however if the pathname is a symbolic link then it follows the link and returns information about the target inode. If you do not want this behaviour, you can use <code>lstat</code> instead.</p>
<p><code>fstat</code> takes an open file descriptor instead of a file name: this is fine for getting the inode information (in the kernel, a file descriptor contains an inode number) but you will not be able to get a file name back from this - remember, <em>files don't have names; names have files</em>.</p>
<p>Later in the manual page, it explains the <code>struct stat</code> contents. Let's have a look at the sources directly though:</p>
<ul>
<li><code>nano /usr/include/sys/stat.h</code> shows you the header file and the function definitions, including the bitmasks for the mode bits e.g. <code>#define S_IRUSR 0400</code> is the &quot;user can read&quot; bit and the file type bits e.g. <code>#define S_IFDIR 0040000</code>. Note, in C, numbers with a leading 0 are octal!</li>
<li>The definition of the <code>struct stat</code> is in another file included from <code>sys/stat.h</code>, namely <code>bits/stat.h</code>; open that in your editor too and have a look at it.</li>
<li>The types of the fields in the structure (<code>dev_t</code>) etc. are yet in another file - <code>bits/alltypes.h</code> if you're curious - but eventually they get defined as <code>long</code>, through intermediate definitions of <code>_Int64</code> etc. Basically, on a 64-bit machine, most of these fields are 64 bits.</li>
</ul>
<p>Run the following short C program to check the size of your <code>struct stat</code>; I get 144 bytes but note down if you get something different:</p>
<pre><code class="language-C">#include &lt;sys/stat.h&gt;
#include &lt;stdio.h&gt;
int main() {
    printf(&quot;Size: %lu bytes\n&quot;, sizeof(struct stat));
    return 0;
}
</code></pre>
<h2 id="the-assembly-level"><a class="header" href="#the-assembly-level">The assembly level</a></h2>
<p>Create a file with the following content - the convention for assembly files is usually to end in <code>.s</code>, so I've called mine <code>dostat.s</code>:</p>
<pre><code class="language-asm">.section .text
.global  _start

_start:
    mov $6,  %rax
    lea str, %rdi
    lea buf, %rsi
    syscall

    mov $60, %rax
    mov $0,  %rdi
    syscall

str: .asciz &quot;/dev/stdin&quot;

.section .data
buf: .skip 144
</code></pre>
<p>Change the 144 in the last line if you got a different size for your structure.</p>
<p>Let's see what's going on here:</p>
<ol>
<li><code>.section .text</code> is an assembly directive to say <em>the following is code</em>, more precisely <em>it goes in the code section (which we named 'text' for obscure historical reasons)</em>.</li>
<li><code>.global _start</code> says to export the label <code>_start</code> to the linker, which is the assembly version of <code>main</code>: in fact, C programs really start at <code>_start</code> too as you can check by setting a breakpoint on this label in a debugger, this function is part of the C library and it sets a few things up and then calls <code>main</code>. When you return from <code>main</code>, then <code>_start</code> does some cleanup and exits the program cleanly with the correct return value.</li>
<li>The way you invoke a system call is you put the system call number in the <code>rax</code> register, and parameters according to the platform convention - on Intel/AMD 64 bit, the first parameter goes in the <code>rdi</code> register, the second one in the <code>rsi</code> register. System calls and their parameters are documented <a href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">in this table</a> for example. Return values from system calls end up in the <code>rax</code> register again. Looking ahead a bit in our assembly code, system call 60 is <code>sys_exit</code> and takes an exit code in <code>rdi</code>, so the lines <code>mov $60, %rax; mov $0,  %rdi; syscall</code> are the equivalent of <code>return 0;</code> in a main function of a C program or <code>exit(0);</code> anywhere else (indeed, that is the last thing the C library <code>_start</code> will do when <code>main</code> returns to it).</li>
<li>System call 6 is <code>sys_lstat</code>, so the lines <code>mov $6,  %rax; lea str, %rdi; lea buf, %rsi; syscall</code> call <code>sys_lstat(str, buf)</code> where both <code>str</code> and <code>buf</code> are pointers. (<code>lea</code> stands for <em>load effective address</em> and is similar to the <code>&amp;var</code> address-of operator in C).</li>
<li><code>syscall</code> is an assembly instruction that hands control over to the operating system. It is comparable to a software interrupt as you might have learnt in Computer Architecture, but it is an optimised version (since many programs do a lot of system calls) that doesn't have the full overhead of the older interrupt mechanism on x86.</li>
<li><code>.asciz</code> is a zero-terminated string in C style (which is what the kernel expects). <code>.section .data</code> says <em>the following goes in the data section</em>, which we need because the buffer variable needs to be written to and the code section is read-only when a program is running. <code>.skip</code> reserves a block of the given size in bytes, similar to <code>byte buf[144];</code> in C (you can read <code>char</code> for <code>byte</code> if you want).</li>
</ol>
<p>Assemble the program with</p>
<ul>
<li><code>as dostat.s -g -o dostat.o</code></li>
<li><code>ld dostat.o -o dostat</code></li>
</ul>
<p>The first command is the assembler itself, which produces and object file (C compilers usually do this too, but you don't see it unless you ask for it). <code>-g</code> is the same as for gcc, it includes debug information. <code>ld</code> is the linker which produces an executable.</p>
<p>You can run the program with <code>./dostat</code>, but it will simply exit with status 0. What we want to do is debug it with <code>gdb dostat</code> (install <code>gdb</code> with <code>apk</code> if you don't have it installed already), then do the following:</p>
<ul>
<li><code>break _start</code> to set a breakpoint.</li>
<li><code>run</code> to start running (and hit the breakpoint).</li>
<li><code>si</code> steps a single assembly instruction. Do this until you have passed the first <code>syscall</code> and land on the line <code>mov $60, %rax</code>.</li>
<li>The memory at <code>buf</code> now contains filled-in <code>struct stat</code> for <code>/dev/stdin</code>, the standard input file. Look at this with <code>x/40xb &amp;buf</code> (memory dump, show 40 hex bytes starting at the buffer).</li>
</ul>
<p>Based on what you know about the <code>struct stat</code> memory layout, what is the inode number and mode of <code>/dev/stdin</code>? Note down the inode number in decimal, and the low 16 bits of the mode word in binary. Note that the memory layout is most likely little-endian, and you are working with 64-bit long integers.</p>
<p>From this information, and the bit patterns in <code>/usr/include/sys/stat.h</code>, decode the file type and permissions of <code>/dev/stdin</code>.</p>
<p>You can then quit gdb with <code>q</code>, and answer yes when it askes whether you want to terminate the program.</p>
<h2 id="the-c-level"><a class="header" href="#the-c-level">The C level</a></h2>
<p>We will now do the same in C. Create this program, I've called it <code>exstat.c</code>, then compile and run it:</p>
<pre><code class="language-C">#include &lt;sys/stat.h&gt;
#include &lt;stdio.h&gt;

int main() {
    struct stat buf;
    char *str = &quot;/dev/stdin&quot;;
    int r = lstat(str, &amp;buf);
    if (r != 0) {
        puts(&quot;An error occurred.&quot;);
        return 1;
    }
    printf(&quot;The inode number is %lu.\n&quot;, buf.st_ino);
    if (S_ISDIR(buf.st_mode)) { puts(&quot;It's a directory.&quot;);}
    if (S_ISCHR(buf.st_mode)) { puts(&quot;It's a character device.&quot;);}
    if (S_ISBLK(buf.st_mode)) { puts(&quot;It's a block device.&quot;);}
    if (S_ISREG(buf.st_mode)) { puts(&quot;It's a regular file.&quot;);}
    if (S_ISFIFO(buf.st_mode)) { puts(&quot;It's a FIFO.&quot;);}
    if (S_ISLNK(buf.st_mode)) { puts(&quot;It's a soft link.&quot;);}
    if (S_ISSOCK(buf.st_mode)) { puts(&quot;It's a socket.&quot;);}

    return 0;
}
</code></pre>
<p>Here we can see that we:</p>
<ol>
<li>Set up the buffer structure and execute the system call.</li>
<li>Check the return value! If it's not 0, then an error occurred - the file <code>/usr/include/bits/errno.h</code> contains a table of error codes, although the system call will return the negative error code in register <code>rax</code>. The <code>man stat</code> manual page explains the meaning of each error code for this particular system call.</li>
<li>Print the inode number (in decimal) and the file type.</li>
</ol>
<p>Check that you get the same inode number and file type as you did with the assembly version.</p>
<h2 id="symbolic-links"><a class="header" href="#symbolic-links">Symbolic links</a></h2>
<p>The point of checking the file type is that <code>/dev/stdin</code> is a symbolic link. To find out where it points, you can use this function:</p>
<pre><code class="language-C">#include &lt;unistd.h&gt;
ssize_t readlink(const char *pathname, char *buf, size_t bufsiz)
</code></pre>
<p>This is another system call wrapper (readlink is system call 89) which takes the pathname of a symbolic link and writes its contents (e.g. the file it points at) in a buffer. However, be aware of the following:</p>
<ul>
<li><code>readlink</code> does not zero-terminate its buffer! That is your responsibility as caller.</li>
<li>The returned value (yet another unsigned long) indicates what happened:
<ul>
<li>A positive value indicates the number of bytes written, so you know where to put the zero byte at the end.</li>
<li>If the return value is equal to the buffer size, then your buffer was too short, and the buffer may contain a truncated string.</li>
<li>If the return value was negative, then an error occurred.</li>
</ul>
</li>
</ul>
<p>In the assembly version, the negative error code would land directly in <code>rax</code>. This is why system calls return negative error codes, to distinguish them from successful return values as a successful call will never write a negative number of bytes.</p>
<p>However, the C wrapper is different as you can read in <code>man readlink</code>: it always returns -1 on error, but puts the error code (this time positive again) in a global variable called <code>errno</code>. You can match this against the codes in <code>errno.h</code> as before, and then check the manual page for an explanation of each one for this particular system call.</p>
<p><strong>Exercise</strong>: write a C program that, starting with a filename you pass in <code>argv[1]</code>:</p>
<ol>
<li><code>lstat</code>s the file and prints the inode number and file type of the file.</li>
<li>If the file is a symbolic link, calls <code>readlink</code> to get the link target and repeats from 1. for the target file.</li>
</ol>
<p>Since this is systems programming, make sure you check the return value of system calls, and correctly zero-terminate strings. If a system call fails, your program should print an error message and exit, and <em>never</em> look at the buffer or string the system call wrote to, as it might not contain valid data.</p>
<p>Call your program for <code>/dev/stdin</code> and <code>/dev/stdout</code> to follow the chain of soft links for these files. Also try it on a few standard files and directories (including soft links).</p>
<h2 id="on-the-command-line"><a class="header" href="#on-the-command-line">On the command line</a></h2>
<p>To check the results of your program, the <code>stat</code> command line program (<code>/bin/stat</code>, in fact yet another soft link to busybox) calls stat and prints the output to the terminal. You can see with <code>stat --help</code> that it offers lots of custom formats.</p>
<p>Note that the <code>stat</code> command line tool calls the <code>lstat</code> system call by default, e.g. it does not follow soft links. <code>stat -L</code> gets you the link-following version.</p>
<p>To see how the command line version works, we are going to have a look at its sources.</p>
<p>Clone the busybox repository with <code>git clone git://busybox.net/busybox.git</code> (if that doesn't work for some reason, try the https version). Inside the cloned folder, the source file is <code>coreutils/stat.c</code> - open that and have a look:</p>
<ul>
<li>The comments at the start are read by a custom build tool. The <code>//applet</code> line (currently line 38) says to build a command called <code>stat</code>.</li>
<li><code>file_type</code> (line 123 at the time of writing) is the code for turning mode bits into strings, note there are lots of <code>#ifdef</code>s depending on what options you compile busybox with. Also, if you <code>stat</code> a file that does not match any known type, you get the string &quot;weird file&quot;.</li>
<li>Most of the source file is the kind of &quot;plumbing&quot; that you need in any real C program. The interesting part is <code>do_stat</code> (line 588 at the time of writing):</li>
</ul>
<p>First, it allocates a <code>struct stat</code> buffer like we did before. </p>
<p>The key line is currently line 605 and following:</p>
<pre><code class="language-C">if ((option_mask32 &amp; OPT_DEREFERENCE ? stat : lstat) (filename, &amp;statbuf) != 0) {
    bb_perror_msg(&quot;can't stat '%s'&quot;, filename);
    return 0;
}
</code></pre>
<p>Based on the value of <code>OPT_DEREFERENCE</code> (the <code>-L</code> command line flag), we call either the <code>stat</code> or <code>lstat</code> system call wrapper in the C library, and complain and exit if we don't get a success return value - remember, in case of errors, <code>struct stat statbuf</code> could be corrupted so we shouldn't look at it.</p>
<p>The rest of the function is basically setting up one giant <code>printf</code> statement to output the results in the correct format. Note here that the <code>struct stat</code> still doesn't know anything about the file's name, as that's not in the inode, but the command-line program does because you gave the name as an argument. </p>
<p>If the file is a soft link, then we call a version of readlink - currently <code>xmalloc_readlink_or_warn</code> in line 713 - to display the link target. This function is implemented in <code>libbb/xreadlink.c</code> where it currently delegates to <code>xmalloc_readlink</code> on line 20, which calls <code>readlink</code> in a loop with increasing buffer sizes until it finds one that is big enough for the target - have a look at how this is implemented.</p>
<p>The main function for this utility is <code>stat_main</code>, currently on line 757. All this does is parse the command line arguments with <code>getopt32</code>, call the <code>do_stat</code> function in a loop for each command line argument (lines 787 and following in the current version) and then return success if all files were successfully processed, otherwise failure.</p>
<p>If nothing else, the learning point of this activity is that system programming in C and calling syscalls directly is a lot more involved than you may think! Please don't be that kind of programmer who <a href="https://rachelbythebay.com/w/2014/08/19/fork/">ignores system call error values, and makes terrible things happen</a>.</p>
<p>If you want to explore this code further, you can build your own busybox - install <code>ncurses</code> and <code>linux-headers</code>, then run <code>make menuconfig</code> to bring up a configuration menu (this is the part that uses ncurses, which is the menu system) and just select exit (with TAB then ENTER). Then you can <code>make</code> the whole thing.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="shell-scripting"><a class="header" href="#shell-scripting">Shell Scripting</a></h1>
<p>Shell scripting is a huge topic - the shell is a full programming language after all.
In the video for this activity you have only seen a very brief introduction.</p>
<h2 id="compile-helper-exercise"><a class="header" href="#compile-helper-exercise">Compile helper exercise</a></h2>
<p>Write a shell script in a file called <code>b</code> (for build) that does the following:</p>
<ul>
<li>Your script should run under any Bourne-compatible shell (e.g. not just <code>bash</code>), and it should be written so that you can call it with <code>./b</code>.</li>
<li><code>./b compile NAME</code> should compile the file of the given name, so for example <code>./b compile hello</code> should run <code>gcc -Wall -std=c11 -g hello.c -o hello</code>.</li>
<li>However, your script should accept both <code>./b compile hello</code> and <code>./b compile hello.c</code> as input, and do the same thing in both cases, namely compile <code>hello.c</code>. The output file for gcc in both cases should be called just <code>hello</code>.</li>
<li>If the source file you provided as an argument does not exist (adding <code>.c</code> if necessary) then the script should print an error message and return a nonzero exit status - <em>not</em> invoke the C compiler.</li>
<li><code>./b run NAME</code> should run the program, assuming it exists in the current folder, so both <code>./b run hello</code> and <code>./b run hello.c</code> should run <code>./hello</code>. If it does not exist, again print an error message and exit with a nonzero status, don't try and run the program.</li>
<li><code>./b build NAME</code> should first compile the C source file, and then if the compile was successful it should run the program. If the compile failed, it should not try and run the program.</li>
<li>If you call <code>./b</code> without any parameters, or <code>./b COMMAND</code> with a command other than compile or run or build, it should print some information on how to use it. If you call <code>./b compile</code> or another command with no filename at all, then the script should print an error message and exit with a nonzero exit status.</li>
</ul>
<p>You now have a useful tool for when you are developing C programs. Of course you can add other features of your own like a <code>debug</code> command that compiles the file and launches it in <code>gdb</code>.</p>
<p><em>If you already know about makefiles, you might wonder why we don't just use <code>make</code> for this. You are correct, but this is specifically a shell scripting exercise. We will learn about makefiles soon.</em></p>
<h2 id="strict-mode"><a class="header" href="#strict-mode">Strict Mode</a></h2>
<p>Some programming languages have an optional <em>strict mode</em> which treats some constructs as errors that people often do by mistake. It is similar in spirit to <code>-Werror</code> in C that treats all warnings as errors. <a href="http://redsymbol.net/articles/unofficial-bash-strict-mode/">This page</a> suggests using the following line near the top of your shell scripts: <code>set -euo pipefail</code>. (It also talks about IFS to improve string handling with spaces, but that's a separate matter.)</p>
<p>You might want to use these yourself if you get into shell scripting. <code>set</code> is a shell internal command that sets shell flags which controls how commands are run.</p>
<ul>
<li><code>set -e</code> makes the whole script exit if any command fails. This way, if you want to run a list of commands, you can just put them in a script with <code>set -e</code> at the top, and as long as all the commands succeed (return 0), the shell will carry on; it will stop running any further if any command returns nonzero. It is like putting <code>|| exit $?</code> on the end of every command.</li>
<li><code>set -u</code> means referencing an undefined variable is an error. This is good practice for lots of reasons.</li>
<li><code>set -o pipefail</code> changes how pipes work: normally, the return value of a pipe is that of the <em>last</em> command in the pipe. With the <code>pipefail</code> option, if any command in the pipeline fails (non-zero return) then the pipeline returns that command's exit code.</li>
</ul>
<p>A couple of notes on <code>set -u</code>: if you write something like <code>rm -rf $FOLDER/</code> and <code>$FOLDER</code> isn't set, then you don't accidentally end up deleting the whole system! Of course, most <code>rm</code> implementations will refuse to delete <code>/</code> without the <code>--no-preserve-root</code> option, and you should not have that trailing slash in the first place. There was a <a href="https://drj11.wordpress.com/2015/01/20/steaming/">bug in a beta version of Steam for linux</a> where it tried to do <code>rm -rf &quot;$STEAMROOT/&quot;*</code> to delete all files in a folder (which explains the slash), but the variable in some cases got set to the <em>empty string</em>, which <code>-u</code> would not protect against. This was an installer script, so it ran as root which made things even worse.</p>
<p><strong>Exercise</strong>: think of an example in a shell script where <code>pipefail</code> makes a difference, that is where the last command in a pipe could succeed even if a previous one fails. As a counter-example, <code>cat FILE | grep STRING</code> would fail even without <code>pipefail</code> if the file does not exist, because grep would immediately get end-of-file on standard input.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-tools-2"><a class="header" href="#build-tools-2">Build Tools 2</a></h1>
<h2 id="videos-4"><a class="header" href="#videos-4">Videos</a></h2>
<table><thead><tr><th>Video</th><th style="text-align: right">Length</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/9f6b781c-e2a4-4860-9a0a-ae795b19438e?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Build Tools 1</a></td><td style="text-align: right">24 minutes</td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/14fb7d93-0b2e-4d24-a452-28f232dce575?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Build Tools 2</a></td><td style="text-align: right">18 minutes</td></tr>
</tbody></table>
<h2 id="exercises-4"><a class="header" href="#exercises-4">Exercises</a></h2>
<ul>
<li><a href="build2/c.html">C</a></li>
<li><a href="build2/python.html">Python</a></li>
<li><a href="build2/java.html">Java</a></li>
<li><a href="build2/spring.html">Spring</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-tools-c"><a class="header" href="#build-tools-c">Build tools: C</a></h1>
<p>In this exercise you will practice the traditional way of building C projects from source. We are going to use the sqlite database as an example project to build.</p>
<p>Download the source file <a href="https://sqlite.org/2021/sqlite-autoconf-3340100.tar.gz">https://sqlite.org/2021/sqlite-autoconf-3340100.tar.gz</a> into your Alpine VM with <code>wget</code> or similar and extract it with <code>tar zxvf FILENAME</code>. This creates a subfolder, do a <code>cd</code> into it.</p>
<p>You can see a file called <code>INSTALL</code> which you can open in a text editor to find the standard instructions:</p>
<blockquote>
<p>Briefly, the shell commands <code>./configure; make; make install</code> should configure, build, and install this package.</p>
</blockquote>
<h2 id="configure"><a class="header" href="#configure">Configure</a></h2>
<p>If you look at the first line of the configure script, it starts <code>#! /bin/sh</code> as that path should be valid on just about any vaguely posix-compatible system. The whole thing is just over 16000 lines, so you don't want to read all of it.</p>
<p>Run the script with <code>./configure</code>. You can see that it does a lot of checking, including things like:</p>
<ul>
<li>Whether your system has a C compiler.</li>
<li>Whether your C compiler is gcc.</li>
<li>Whether your C compiler actually works.</li>
<li>Whether standard headers like <code>string.h</code> or <code>stdlib.h</code> exist.</li>
<li>Whether the readline library is installed on your system.</li>
</ul>
<p>Your configure script should run through and print <code>creating Makefile</code> on one of its last lines.</p>
<p>The configure script is basically a collection of tests for every single bug and oddity found on any system known to the autoconf developers that could break the build. For example, someone once reported a bug in a build on Sun OS 4 (released in 1988), so in lines 2422 and following of the configure script we read</p>
<blockquote>
<p><code># Use test -z because SunOS4 sh mishandles braces in ${var-val}.</code></p>
<p><code># It thinks the first close brace ends the variable substitution.</code></p>
<p><code>test -z &quot;$INSTALL_PROGRAM&quot; &amp;&amp; INSTALL_PROGRAM='${INSTALL}'</code></p>
</blockquote>
<h2 id="make"><a class="header" href="#make">Make</a></h2>
<p>Type <code>make</code> to build sqlite. If it's not installed, <code>sudo apk add make</code> will fix that.</p>
<p>Some of the compiler commands might take a while to run. While they're running, note the number of configuration variables (everything passed with a <code>-D</code>) involved; some of them turn on/off features (for example readline support is off if it can't find the header files for it on your system) and some of them set options specific to the operating system and compiler, for example <code>-DHAVE_STRING_H</code> defines whether <code>string.h</code> exists on your system.</p>
<p>These translate to <code>#ifdef</code> commands in the source files, for example in <code>shell.c</code> starting at line 121 we include readline, if the header files exist:</p>
<pre><code>#if HAVE_READLINE
# include &lt;readline/readline.h&gt;
# include &lt;readline/history.h&gt;
#endif
</code></pre>
<p>The last command run by the makefile is</p>
<pre><code>gcc [lots of options] -g -O2 -o sqlite3 sqlite3-shell.o sqlite3-sqlite3.o -lreadline -lcurses
</code></pre>
<p>This should build an executable <code>sqlite3</code> that you can run (use <code>.q</code> to quit again).</p>
<p><em>If you want to, you can now type <code>sudo make install</code> to copy the executable to <code>/usr/local/bin</code>.</em></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-tools-python"><a class="header" href="#build-tools-python">Build tools: Python</a></h1>
<p>Install Python and pip on Alpine with <code>sudo apk add python3 py3-pip</code>. You can now run it with <code>python3</code> and Control+D quits again.</p>
<p>We are going to practice installing the <a href="https://github.com/miyuchina/mistletoe">mistletoe</a> module, which renders markdown into HTML.</p>
<ul>
<li>In python, try the line <code>import mistletoe</code> and notice that you get <code>ModuleNotFoundError: No module named 'mistletoe'</code>. </li>
<li>Quit python again and try <code>sudo pip3 install mistletoe</code>. You should get a success message (and possibly a warning, explained below).</li>
<li>Open python again and repeat <code>import mistletoe</code>. This produces no output, so the module was loaded.</li>
</ul>
<p>Create a small sample markdown file as follows, called <code>hello.md</code> for example:</p>
<pre><code># Markdown Example

Markdown is a *markup* language.
</code></pre>
<p>Open python again and type the following. You need to indent the last line (four spaces is usual) and press ENTER twice at the end.</p>
<pre><code>import mistletoe
with open('hello.md', 'r') as file:
    mistletoe.markdown(file)
</code></pre>
<p>This should print the markdown rendered to HTML, e.g.</p>
<pre><code>&lt;h1&gt;Markdown Example&lt;/h1&gt;\n&lt;p&gt;Markdown is a &lt;em&gt;markup&lt;/em&gt; language.&lt;/p&gt;
</code></pre>
<style>
div.container { padding: 0; background-color: #efefef; }
div.advanced header { background-color: lightskyblue;   padding-left: 0.5ex; }
span.advanced-title::before { content: "Advanced note" }
div.container-content { padding: 1ex; }
div.container-content :first-child { margin-top: 0; }
div.container-content :last-child { margin-bottom: 0; }
</style>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Python version 3 came out in 2008 and has some syntax changes compared to Python 2; version 2 is now considered deprecated. On most systems, you simply use 'python' and 'pip' for the version 3 commands. Alpine is a bit of an exception here as it still calls the commands 'python3' and 'pip3', in case you are still using programs that require version 2.</p>
<p>When a language comes with its own package manager, sometimes you have a choice between using the OS package manager (e.g. apk) and the language one (e.g. pip) to install modules. Generally speaking, the language one will contain the most up-to-date versions and you should use that unless you have a reason to do otherwise.</p>
<p>At the time of writing for example, the Alpine repos contain pip version 19, but the python distribution itself contains version 21, so you get a warning when you are using the older one - complete with the command you should type to install the newer one, except that on Alpine you actually have to type <code class="language-plaintext">sudo pip3 install --upgrade pip</code>.</p>
<p>
You can in fact use pip without sudo, by passing the <code>--user</code> option which installs packages into a folder in your home directory (<code>~/.local</code>) instead of in /usr which requires root permissions. It is a matter of choice which one to use, except if you are on a machine without root rights (like a lab machine) where you have to use the user install option.
</p>
</div>
</div>
<h2 id="scipy"><a class="header" href="#scipy">Scipy</a></h2>
<p>In Maths B, we will be using <code>scipy</code> for statistics, so you may as well install that too. Unfortunately, <code>pip</code> will not help you here because scipy depends on a C library for fast linear algebra, and this doesn't exist for Alpine linux in the <code>pip</code> repositories. It does exist in the Alpine repos though, so <code>sudo apk add py3-scipy</code> will install it.</p>
<p>The following commands show if it is correctly installed, by sampling 5 times from a Normal distribution with mean 200 and standard deviation 10:</p>
<pre><code>from scipy.stats import norm
norm(loc=200, scale=10).rvs(5)
</code></pre>
<p>This should print an array of five values that are not too far off 200 (to be precise, with about 95% confidence they will be between 180 and 220 - more on this in Maths B later on).</p>
<p>You might want to install python and scipy on your host OS as well, as it's a really easy language to code in and you can use your favourite editor and even make graphical plots - you will probably learn about this in second year, and maybe again in third year if you take Machine Learning. In this case, if your host OS is Windows or Mac, I recommend that you install the <a href="https://docs.conda.io/en/latest/miniconda.html">miniconda</a> distribution (obviously the Python 3 version, not the Python 2 one) so that you can easily install scipy. This gets you two package managers: <code>conda install scipy</code> uses the conda one (which can handle the required C library) and <code>pip</code> for everything else. For Linux, you can install conda too, or just use the scipy packaged with your distribution.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-tools-java"><a class="header" href="#build-tools-java">Build tools: Java</a></h1>
<p>In the Java world,</p>
<ul>
<li>The <code>javac</code> compiler turns source files (<code>.java</code>) into <code>.class</code> files;</li>
<li>The <code>jar</code> tool packs class files into <code>.jar</code> files;</li>
<li>The <code>java</code> command runs class files or jar files.</li>
</ul>
<p>A Java Runtime Environment (JRE) contains only the <code>java</code> command, which is all you need to run java applications if you don't want to do any development. Many operating systems allow you to double-click jar files (at least ones containing a special file called a <code>manifest</code>) to run them in a JRE.</p>
<p>A Java Development Kit (JDK) contains the <code>javac</code> and <code>jar</code> tools as well as a JRE. This is what you need to develop in java.</p>
<p><code>maven</code> is a Java package manager and build tool. It is not part of the Java distribution, so you will need to install it separately.</p>
<p>You can do this exercise either on Alpine, or on your own machine where you have probably already installed Java for the OOP/Algorithms unit, and you can use your favourite editor. The exercises should work exactly the same way in both cases, there is nothing POSIX-specific here.</p>
<h2 id="installing-on-alpine"><a class="header" href="#installing-on-alpine">Installing on Alpine</a></h2>
<p>On Alpine, install the <code>openjdk8</code> and <code>maven</code> packages. Alpine's JDK does not end up on the <code>PATH</code>, presumably in case you want to have several different JDKs on the same machine, so you should run the following command and also add it to your <code>~/.profile</code>:</p>
<pre><code>export PATH=&quot;$PATH:/usr/lib/jvm/java-1.8-openjdk/bin/&quot;
</code></pre>
<p>This lets you run <code>javac</code>, although you could of course also run it by calling it with the full path to the file.</p>
<h2 id="installing-on-your-own-machine-1"><a class="header" href="#installing-on-your-own-machine-1">Installing on your own machine</a></h2>
<p>You have probably already installed the JDK following the instructions in the OOP/Algorithms unit; it should basically resolve to </p>
<ul>
<li>download the <a href="http://openjdk.java.net/">OpenJDK</a> distribution</li>
<li>unzip it somewhere</li>
<li>add the binaries folder to your <code>PATH</code></li>
<li>set the <code>JAVA_HOME</code> variable to point to the folder where you unzipped the JDK.</li>
</ul>
<p>To install maven, <a href="https://maven.apache.org/install.html">follow these instructions</a> which again involve downloading a ZIP file, unzipping it somewhere and then putting the <code>bin</code> subfolder on your <code>PATH</code>.</p>
<p>Note: <code>JAVA_HOME</code> must be set correctly for maven to work.</p>
<h2 id="running-maven"><a class="header" href="#running-maven">Running maven</a></h2>
<p>Open a shell (windows CMD is fine too) and type <code>mvn archetype:generate</code>. This lets you <em>generate an artifact from an archetype</em>, which is wizard-speak for create a new folder with a maven file.</p>
<p><em>If you get a &quot;not found&quot; error, then most likely the maven <code>bin</code> folder is not on your path. If you're on a POSIX system and have used your package manager, this should be set up automatically, but if you've downloaded and unzipped maven then you have to <code>export PATH=&quot;$PATH:...&quot;</code> where you replace the three dots with the path to the folder, and preferably put that line in your <code>~/.profile</code> too. On Windows, search online for instructions how to set up the path variable, or you can drag-and-drop the <code>mvn.cmd</code> file from an Explorer window into a Windows CMD terminal and it should paste the full path, then press SPACE and enter the arguments you want to pass.</em></p>
<p>The first time you run it, maven will download a lot of libraries.</p>
<p>Maven will first show a list of all archetypes known to humankind (2885 at the time of counting) but you can just press ENTER to use the default, 1744 (&quot;quickstart&quot;). Maven now asks you for the version to use, press ENTER again.</p>
<p>You now have to enter the triple of (groupId, artifactId, version) for your project - it doesn't really matter but I suggest the following:</p>
<pre><code>groupId: org.example
artifactId: project
version: 0.1
</code></pre>
<p>Just press ENTER again for the following questions, until you get a success message.</p>
<p>Maven has created a folder named after your artifactId, but you can move and rename it if you want and maven won't mind as long as you run it from inside the folder. Use <code>cd project</code> or whatever you called it to go inside the folder.</p>
<p>If you're in a POSIX shell, then <code>find .</code> should show everything in the folder (in Windows, <code>start .</code> opens it in Explorer instead):</p>
<pre><code>.
./src
./src/main
./src/main/java
./src/main/java/org
./src/main/java/org/example
./src/main/java/org/example/App.java
./src/test
./src/test/java
./src/test/java/org
./src/test/java/org/example
./src/test/java/org/example/AppTest.java
./pom.xml
</code></pre>
<p>This is the standard maven folder structure. Your java sources live under <code>src/main/java</code>, and the default package name is <code>org.example</code> or whatever you put as your groupId so the main file is currently <code>src/main/java/org/example/App.java</code>. Since it's common to develop Java from inside an IDE or an editor with &quot;folding&quot; for paths (such as VS code), this folder structure is not a problem, although it's a bit clunky on the terminal.</p>
<h2 id="the-pom-file"><a class="header" href="#the-pom-file">The POM file</a></h2>
<p>Have a look at <code>pom.xml</code> in an editor. The important parts you need to know about are:</p>
<p>The artifact's identifier (group id, artifact id, version):</p>
<pre><code class="language-xml">&lt;groupId&gt;org.example&lt;/groupId&gt;
&lt;artifactId&gt;project&lt;/artifactId&gt;
&lt;version&gt;0.1&lt;/version&gt;
</code></pre>
<p>The build properties determine what version of Java to compile against (by passing a flag to the compiler). Unfortunately, the default maven template seems to go with version 7 (which for complicated reasons is called 1.7), but version 8 was released back in 2014 which is stable enough for us, so please change the 1.7 to 1.8 (there are some major changes from version 9 onwards, which I won't go into here):</p>
<pre><code class="language-xml">&lt;properties&gt;
    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;
    &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;
&lt;/properties&gt;
</code></pre>
<p>The dependencies section is where you add libraries you want to use. By default, your project uses <code>junit</code>, a unit testing framework - note that this is declared with <code>&lt;scope&gt;test&lt;/scope&gt;</code> to say that it's only used for tests, not the project itself. You do not add this line when declaring your project's real dependencies.</p>
<pre><code class="language-xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;junit&lt;/groupId&gt;
        &lt;artifactId&gt;junit&lt;/artifactId&gt;
        &lt;version&gt;4.11&lt;/version&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>The <code>&lt;plugins&gt;</code> section contains the plugins that maven uses to compile and build your project. This section isn't mandatory, but it's included to &quot;lock&quot; the plugins to a particular version so that if a new version of a plugin is released, that doesn't change how your build works.</p>
<p>The one thing you should add here is the <code>exec-maven-plugin</code> as follows, so that you can actually run your project:</p>
<pre><code class="language-xml">&lt;plugin&gt;
    &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
    &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;3.0.0&lt;/version&gt;
    &lt;configuration&gt;
        &lt;mainClass&gt;org.example.App&lt;/mainClass&gt;
    &lt;/configuration&gt;
&lt;/plugin&gt;
</code></pre>
<p>The important line is the <code>mainClass</code> which you set to the full name (with path components) of your class with the <code>main()</code> function.</p>
<h2 id="compile-run-and-develop"><a class="header" href="#compile-run-and-develop">Compile, run and develop</a></h2>
<p><code>mvn compile</code> compiles the project. The very first time you do this, it will download a lot of plugins, after that it will be pretty fast. Like <code>make</code>, it only compiles files that have changed since the last run, but if this ever gets out of sync (for example because you cancelled a compile halfway through) then <code>mvn clean</code> will remove all compiled files so the next compile will rebuild everything.</p>
<p>The <code>App.java</code> file contains a basic &quot;Hello World!&quot; program (have a look at this file). You can run the compiled project with <code>mvn exec:java</code> if you've set up the plugin as above. After you've run it the first time and it's downloaded all the files it needs, lines coming from maven itself will start with <code>[INFO]</code> or <code>[ERROR]</code> or similar, so lines without any prefix like that are printed by your program itself. You should see the hello world message on your screen.</p>
<p>The development workflow is now as follows: you make your edits, then run <code>mvn compile test exec:java</code> to recompile, run your tests, then run the program. (Like <code>make</code>, you can put more than one target on a command, separated by spaces.)</p>
<p><code>mvn test</code> runs the tests in <code>src/test/java</code>. There is an example test already created for you (have a look).</p>
<p><code>mvn package</code> creates a jar file of your project in the <code>target/</code> folder.</p>
<p>I assume that you will be storing your Java projects in git repositories. In this case, you should create a file <code>.gitignore</code> in the same folder as the <code>pom.xml</code> and add the line <code>target/</code> to it, since you don't want the compiled classes and other temporary files and build reports in the repository. The <code>src/</code> folder, the <code>pom.xml</code> and the <code>.gitignore</code> file itself should all be checked in to the repository.</p>
<p><em>Exercise: make a change to the Java source code, then recompile and run with maven.</em></p>
<h2 id="adding-a-dependency"><a class="header" href="#adding-a-dependency">Adding a dependency</a></h2>
<p><a href="https://www.thymeleaf.org/">Thymeleaf</a> is a Java templating library. It lets you write a template file or string for example (depending on the syntax of your library)</p>
<pre><code>Hello, ${name}!
</code></pre>
<p>which you can later render with a particular name value. This is one of the standard ways of creating web applications, for example to display someone's profile page you would write a page template that takes care of the layout, styles, links etc. but uses template variables for the fields (name, email, photo etc.) which you render when someone accesses the profile page for a particular person. You will see this in more detail in your SPE project next year.</p>
<p>To use Thymeleaf or any other library, you first have to add it to your pom file. Go to <a href="https://mvnrepository.org">mvnrepository.org</a> and search for Thymeleaf, then find the latest stable (&quot;release&quot;) version. There is a box where you can copy the <code>&lt;dependency&gt;</code> block to paste in your pom file. The next <code>mvn compile</code> will download thymeleaf and all its dependencies.</p>
<p>Next, make a template file called <code>unit</code> in the folder <code>src/main/resources/templates</code> (you will have to create the folder first), and put the following lines in it:</p>
<pre><code>Unit: [(${name})]

In this unit, you will learn about:

[# th:each=&quot;topic: ${topics}&quot;]
  - [(${topic})]
[/]
</code></pre>
<p>This is thymeleaf &quot;text&quot; syntax, where the first line renders the value of a variable and the third-from-last line is the template equivalent of a 'for' loop that renders its contents once for each element in a list (or other collection data structure).</p>
<p>Thymeleaf needs to know where to find its template files, and in this example we are going to demonstrate loading resources from the classpath because that is the correct way to work with resources in a java application (there are special considerations for web applications, but they usually end up using the classpath in the end anyway).</p>
<p>In your Java source file, you can now do the following. First, the imports you will need:</p>
<pre><code class="language-java">import java.util.List;
import java.util.Arrays;

import org.thymeleaf.TemplateEngine;
import org.thymeleaf.context.Context;
import org.thymeleaf.templatemode.TemplateMode;
import org.thymeleaf.templateresolver.ClassLoaderTemplateResolver;
</code></pre>
<p>And the code:</p>
<pre><code class="language-java">ClassLoaderTemplateResolver resolver = new ClassLoaderTemplateResolver();
resolver.setTemplateMode(TemplateMode.TEXT);
resolver.setPrefix(&quot;templates/&quot;);

TemplateEngine engine = new TemplateEngine();
engine.setTemplateResolver(resolver);

Context c = new Context();
c.setVariable(&quot;name&quot;, &quot;Software Tools&quot;);
List&lt;String&gt; topics = Arrays.asList(&quot;Linux&quot;, &quot;Git&quot;, &quot;Maven&quot;);
c.setVariable(&quot;topics&quot;, topics);
String greeting = engine.process(&quot;unit&quot;, c);

System.out.println(greeting);
</code></pre>
<p>Compile and run this, and you should see:</p>
<pre><code>Unit: Software Tools

In this unit, you will learn about:

  - Linux
  - Git
  - Maven
</code></pre>
<p>Let's look at how the code works.</p>
<ol>
<li>A template resolver is a class that finds a template when you give it a name (here: &quot;unit&quot;). In this case we use a resolver that loads off the classpath, so we just have to put the template files somewhere under <code>src/main/resources</code>; we tell it that we want the template files treated as text (e.g. not HTML), and that the template files are in a subfolder called <code>templates</code>.</li>
<li>The template engine is the class that does the work of rendering the template, once the resolver has found the source file. </li>
<li>To render a template, you need a template name for the resolver to look up, and a context - an object on which you can set key/value parameters. In this case we're setting the key &quot;name&quot; to &quot;Software Tools&quot; and the key &quot;topics&quot; to a list of three topics. The names and types of keys obviously have to match what's in the template file.</li>
</ol>
<p><em>Exercise: rewrite this example to be a bit more object-oriented by creating a unit class:</em></p>
<pre><code class="language-java">public class Unit {
    private String name;
    private List&lt;String&gt; topics;
    public Unit(String name, List&lt;String&gt; topics) {
        this.name = name;
        this.topics = topics;
    }
    public String getName() { return this.name; }
    public List&lt;String&gt; getTopics() { return this.topics; }
}
</code></pre>
<p><em>You will still need one single <code>setVariable</code> call, and in the template the syntax <code>[(${unit.name})]</code> should translate into a call to the getter.</em></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="spring"><a class="header" href="#spring">Spring</a></h1>
<p>The <a href="https://spring.io/">Spring framework</a> helps you develop modern web / cloud / microservice / serverless / <em>(insert buzzword here)</em> applications in Java. Netflix, for example, uses it. You will probably use it too in your Software Project next year.</p>
<h2 id="vagrant-preparation"><a class="header" href="#vagrant-preparation">Vagrant preparation</a></h2>
<p>Web applications listen to a port (normally TCP port 80 for HTTP, 443 for HTTPS in production; 8000 or 8080 while in development). If you are following these exercises on your host OS, you can skip this preparation. If you are in Alpine on vagrant, then although you can quickly get an application to work on port 8080 inside the VM, you need one extra step to make it accessible from your browser outside the VM.</p>
<p>Add the line</p>
<pre><code>config.vm.network &quot;forwarded_port&quot;, guest: 8080, host: 8080
</code></pre>
<p>to your Vagrantfile just below the <code>config.vm.box</code> line, then restart the VM by logging out and doing <code>vagrant halt</code> then <code>vagrant up</code>. Your firewall may pop up a warning and ask you to approve this.</p>
<p>Now, while the VM is running, any connection to port 8080 on your host OS will be sent to the VM (this also means that if you're doing web development on the host, you can't use port 8080 for anything else while the VM is up - if you need port 8080, just pick another port number for the <code>guest</code> part).</p>
<h2 id="spring-set-up"><a class="header" href="#spring-set-up">Spring set-up</a></h2>
<p>Spring wants to make setting up a project as easy as possible, so go to <a href="https://start.spring.io/">start.spring.io</a> and you get a graphical interface to create a spring/maven project.</p>
<ul>
<li>Pick &quot;Maven Project&quot; and &quot;Java language&quot;.</li>
<li>Enter a group id and artifact id (you can use <code>org.example</code> and <code>project</code>).</li>
<li>Make sure &quot;packaging&quot; is on JAR and &quot;Java&quot; (version) is on 8, at least if you're on Alpine.</li>
<li>Under <em>Dependencies</em> on the right, click &quot;Add Dependencies&quot; and add &quot;Spring Web&quot;.</li>
<li>Click &quot;Generate&quot; at the bottom, this downloads a ZIP of a project (complete with pom.xml file and folders) that you can unzip either on the host or in the VM.</li>
</ul>
<p>To unzip the file in the VM, place it in the same folder as your Vagrantfile on the host, then inside the VM it will appear in the <code>/vagrant</code> folder. The command <code>unzip ZIPFILE</code> does exactly what its name suggests.</p>
<p>This project uses Spring Boot, a library and plugin to help with building and running Spring applications, so the only maven command you need is</p>
<pre><code>mvn spring-boot:run
</code></pre>
<p>which will recompile if necessary, and then run the application. Once it's running, you can go to <a href="http://localhost:8080">localhost:8080</a> in a browser on your host OS (whether the Spring application is running on the host, or inside the VM as long as you've set up the port forwarding as described above). You will see an error message as there's no pages yet, but the application is running. Stop it with Control+C.</p>
<h2 id="development"><a class="header" href="#development">Development</a></h2>
<p>Open the source file under <code>src/main/java/...</code>. I called mine &quot;project&quot; so the class is <code>ProjectApplication</code>, but the name doesn't matter.</p>
<ul>
<li>Add the <code>@RestController</code> annotation to the application class.</li>
<li>Create a method as follows:</li>
</ul>
<pre><code class="language-java">@GetMapping(&quot;/&quot;)
public String mainPage() {
    return &quot;Hello, Software Tools!\n&quot;;    
}
</code></pre>
<ul>
<li>Add the imports for the two annotations you've just used; they're both in the package <code>org.springframework.web.bind.annotation</code>.</li>
</ul>
<p>Now you can re-run the project with maven, go to <code>localhost:8080</code> on your browser and you should see the message. Congratulations - you've built your first Java/Maven/Spring web application!</p>
<p><em>You can also access the web page from the terminal with <code>wget localhost:8080 -q -O /dev/stdout</code> which should print &quot;Hello, Software Tools!&quot; on your terminal. If you just do <code>wget localhost:8080</code> it will save the output to a file with the default name <code>index.html</code>.</em></p>
<p>The <code>@GetMapping</code> means, when a HTTP GET request comes in for a URL with the path in the annotation (such as a browser would send), then run this function. For example, accessing <code>localhost:8080/pages/index.html</code> would look for a mapping <code>/pages/index.html</code> where as the <code>/</code> mapping covers when you type no path at all. You can start to see that URL paths on the web are modelled on POSIX paths as you learnt in this unit, with forward slashes and a concept of a &quot;root folder&quot; <code>/</code> which is what gets returned when you type a website's name in your browser without a path on the end.</p>
<p>You've seen that build tools like maven automate the process of downloading the libraries your project needs and compiling your project. The Spring Framework automates (as far as possible) the process of running these libraries when your application starts, and getting them all to work nicely together (there is a <em>lot</em> going on in the background from a web request arriving to your function being called to get the page contents).
The obvious next step would be to use thymeleaf to render HTML templates to make proper pages. This is indeed something you'll learn about later in this unit and in your second-year software project next year, but there are a few more steps you'll need to know to do this, and I don't want to go into that today - that's quite enough material for one workshop.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-to-sql"><a class="header" href="#introduction-to-sql">Introduction to SQL</a></h1>
<p>This is the first of four activities to teach you relational databases and the SQL programming language.</p>
<h2 id="videos-5"><a class="header" href="#videos-5">Videos</a></h2>
<p>The videos for this activity are:</p>
<table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/cc54562e-1a88-4d3a-95b2-f7dfaf9915de?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Installing MariaDB</a></td><td style="text-align: right">24 minutes, optional</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/MariaDB%20installation.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/b625867d-b140-47ac-835e-4c2d364202de?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Introduction to Relational Modelling 1</a></td><td style="text-align: right">30 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/Relational%20modelling%201.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/0dd48abb-3118-405f-9436-5e7b47f50044?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Introduction to Relational Modelling 2</a></td><td style="text-align: right">7 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/Relational%20modelling%202.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/12c2b1a3-668b-4622-b145-4d8ca3aa394b?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">SQL Create-Drop Scripts</a></td><td style="text-align: right">26 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/CREATE-DROP%20scripts.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/ba9df785-e9c8-4ab6-bb26-92a59cd66db1?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">SQL SELECT</a></td><td style="text-align: right">11 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/SQL%20SELECT.pdf">PDF</a></td></tr>
</tbody></table>
<p>The first video is optional but should help you if you are having problems installing MariaDB on Alpine linux.</p>
<h2 id="exercises-5"><a class="header" href="#exercises-5">Exercises</a></h2>
<ul>
<li><a href="db1/./setup.html">Set up the database</a></li>
<li><a href="db1/./er-diagram.html">ER diagrams</a></li>
<li><a href="db1/./er2.html">More modelling</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="set-up-the-database"><a class="header" href="#set-up-the-database">Set up the database</a></h1>
<h2 id="history"><a class="header" href="#history">History</a></h2>
<p>In this unit, we will be using the free database MariaDB, which is a clone of MySQL and was written by the same author - Michael &quot;Monty&quot; Widenius, from Finland. The history behind the naming is that Monty first created MySQL (named after his daughter, My) which became the most popular open-source database. He sold MySQL to Sun, who were in turn bought by Oracle - who are famous for their commercial database software. As a result, Monty created a clone of MySQL called MariaDB (named after his other daughter). MySQL and MariaDB are compatible in many ways and most of what we learn on this unit will apply equally to both of them, although both Oracle (for MySQL) and the open-source community (for MariaDB) have added new features to their databases.</p>
<p>Although we will be using MariaDB, in some places the name MySQL will still appear - most notably as the name of the command-line program that you use to access the database.</p>
<h2 id="install-the-database"><a class="header" href="#install-the-database">Install the database</a></h2>
<p>Open the Alpine virtual machine and install the database with</p>
<pre><code class="language-sh">$ sudo apk add mariadb mariadb-client
</code></pre>
<p>The <code>mariadb</code> package contains the server that stores the data and lets clients log in. <code>mariadb-client</code> is a command-line client (with the command name <code>mysql</code>); later on we will also use a Java client to access a database from a Java application.</p>
<p>The database server is now installed, but we still need to create a database:</p>
<pre><code class="language-sh">$ sudo /etc/init.d/mariadb setup
</code></pre>
<p>Files in <code>/etc/init.d</code> are service scripts; services are commands that can be started automatically when the machine starts and often run in the background - in this case the mariadb service runs the server so that clients can connect to it. We had to use the full path as the <code>/etc/init.d</code> folder is not normally in your PATH variable, as it's mostly used by the system rather than directly by users. We are manually calling the service's <code>setup</code> command to create the database - if you look inside the service script, you'll see that it calls the <code>mariadb_install_db</code> program to create a database in <code>/var/lib/mysql</code>. This path is not writable for normal users, so we need sudo on this command.</p>
<p>If you read the output of this command, you will see a warning about security. This is important and we will come back to it.</p>
<p>We now have a database, but the server is not running yet. We can start it for now with</p>
<pre><code class="language-sh">$ sudo rc-service mariadb start
</code></pre>
<p>Check that the service is running with</p>
<pre><code class="language-sh">$ rc-status
</code></pre>
<p>This should show <code>mariadb [ started ]</code> somewhere at the bottom under the &quot;manual&quot; runlevel. This means we've started the server, but it won't start automatically next time we restart the machine. Let's change that:</p>
<pre><code class="language-sh">$ sudo rc-update add mariadb default
</code></pre>
<p>This adds the mariadb service to the &quot;default&quot; runlevel, which is for things that you want to start when the machine starts. For example, the ssh service is already here otherwise you would not be able to log in to the machine with <code>vagrant ssh</code> at all. Check with another <code>rc-status</code> that mariadb is still running, but now listed under &quot;default&quot;.</p>
<h2 id="security"><a class="header" href="#security">Security</a></h2>
<p>You now have a running database and you can log in with <code>mysql</code>. However, the database will allow anyone to log in and change anything, which is not what you want - especially not on a production machine.</p>
<p>Most distributions come with a <code>mysql_secure_installation</code> script that prompts you for a database root password and sets up accounts. We are going to do a similar thing, but with a custom setup for our purposes.</p>
<p>The setup file is located at the address given below. You can download it for example with <code>wget ADDRESS</code> in Alpine linux; <code>wget</code> is a download program. Place it in the same folder as your Vagrantfile (in <code>/vagrant</code>, if you're doing the download from within Alpine).</p>
<pre><code>https://cs-uob.github.io/COMS10012/resources/databases/secure-setup.sql
</code></pre>
<ul>
<li>Run <code>mysql -u root</code>. This should log you in as root without any authentication, which explains why I am making such a fuss about security! Quit again by typing Control+D.</li>
<li>Run <code>mysql -u root -e 'source /vagrant/secure-setup.sql'</code>. The <code>-e</code> command means &quot;run the following command line argument as a script&quot;, as you know already from sed and several other tools; <code>source</code> means &quot;load a file and run it&quot; and the file in question is part of the lab package I have prepared for you.</li>
<li>Run <code>mysql -u root</code> again. This time, it will not let you in, which is what we want.</li>
</ul>
<p>The secure-setup script is as follows:</p>
<pre><code class="language-sql">UPDATE mysql.user SET Password=PASSWORD('BA/458cR-5p.') WHERE User='root';
DELETE FROM mysql.user WHERE User='';
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
DROP DATABASE IF EXISTS test;
DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
FLUSH PRIVILEGES;
</code></pre>
<p>The first line sets a root password, and also shows the absolute minimum standard for a password: 12 characters, mix of uppercase, lowercase and symbols, random-ish. This is the password that you will be using to log in as root to your database on the VM, but of course you can change it if you want to.</p>
<ul>
<li>Type <code>mysql -u root -p</code> on the command line and press Enter. <code>-p</code> means &quot;if a password is needed, prompt for one&quot;. You will be asked for the root password, type it in (without the quotes) and you should be let back in to the database. Once you are in, if you'd like to, you can use the first command from the secure-setup script to set a new password of your own.</li>
</ul>
<p>The next two lines remove some default users: one with the empty username, and all versions of root that let you log in over the network. The only versions of root that still exist are now &quot;localhost&quot; (e.g. from the same machine), 127.0.0.1 (same thing but using IPV4 notation) and &quot;::1&quot; (same in IPv6). This means that now, if your VM is connected to the internet, you cannot log in as root remotely at all, even with the password, which is the correct attitude to security. To administer a database, you should always first log in to the machine via ssh using a key file, then log in to the database from the machine itself.</p>
<p>Next in the setup script, we remove the default test database and user.</p>
<p>Finally, <code>FLUSH PRIVILEGES</code> updates the in-memory cache of the users table, making your new permissions take effect.</p>
<p>Note: what happens when you install the mariadb package (or install it from a ZIP file) depends on the distribution. For some distributions, installing the package automatically creates a database, and adds the server to the default runlevel. Alpine will not do any of these things for you - you have to configure it itself, which is a good opportunity to learn what's going on behind the scenes in other distributions. Most distributions will not, however, configure the security settings automatically - some of them prompt for a root password at installation, but typically leave the test database and let root login remotely. Wherever you install mariadb or mysql, please check this yourself - an unsecured database is something that hackers will be keeping an eye out for.</p>
<h2 id="importing-sample-data"><a class="header" href="#importing-sample-data">Importing sample data</a></h2>
<p>I have prepared some sample data that we will be using in this and the following weeks.</p>
<p>First, download the following two files and place them in the same folder as your Vagrantfile. You can do this the same way as you did before with the secure setup file.</p>
<pre><code>https://cs-uob.github.io/COMS10012/resources/databases/sample-data.sql
https://cs-uob.github.io/COMS10012/resources/databases/sampledata.tar
</code></pre>
<p>If you are using a local copy of this repository, you can also find the files under <code>/resources/databases</code>.</p>
<p>The <code>tar</code> file is a <em>tape archive</em>: a file that contains further files and folders, as if it were a folder itself. Extract it by going to <code>/vagrant</code> in Alpine and run</p>
<pre><code>tar xvf sampledata.tar
</code></pre>
<p>This creates a folder sampledata with the files we need.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Note that <code>tar</code> uses an older convention where options are not prefixed with a dash; the options here are x=extract a file, v=verify (print the name of every processed file to standard output), f=the filename is in the following argument.</p>
<p>To create a tar file yourself, the command would be <code>tar cvf ARCHIVE.tar FILE1 FILE2...</code> where c=create the archive if it doesn't exist, and assume all arguments not consumed by another flag refer to files to be added. In fact, <code>tar xvf ARCHIVE.tar FILES...</code> also works and only extracts the named files from the archive.</p>
</div>
</div>
<p>Load the sample data with the following command, which will ask for your root password:</p>
<pre><code class="language-sh">$ mysql -u root -p -e &quot;source /vagrant/sample-data.sql&quot;
</code></pre>
<p>This pulls in some data in CSV files (have a look at the script if you want) and creates a default user &quot;vagrant&quot; who can log in to the database without a password, but can only read and not write the two sample databases &quot;census&quot; and &quot;elections&quot;. There is another database called &quot;data&quot; which starts out empty, and &quot;vagrant&quot; can both read and write it.</p>
<p>You can now log in to the database and try the following:</p>
<ul>
<li><code>mysql</code> on its own logs you in, you now get the database prompt <code>MariaDB [(none)]&gt;</code> to show that you haven't loaded a particular database yet.</li>
<li><code>SHOW DATABASES;</code> on the database prompt gives you a list of databases which you have access too.</li>
<li>Select one with the USE command, for example <code>USE elections;</code>. Your prompt should now read <code>MariaDB [elections]&gt;</code>.</li>
<li><code>SHOW TABLES;</code> will show the tables in the selected database.</li>
<li>There's a Party table in the elections database, so <code>SELECT * FROM Party;</code> will show you the data.</li>
<li>You could also use <code>DESCRIBE Party;</code> to show a list of columns and types in the Party table.</li>
<li>Finally, <code>exit</code> or Control+D on a line of its own gets you back to the shell.</li>
</ul>
<p>You can open the SQL and CSV files under <code>/vagrant/sampledata</code> to compare with the output you get from MariaDB. Study this until it makes sense to you. The <code>setup.sql</code> files contain the database schemas and the <code>import.sql</code> ones pull in the sample data.</p>
<h2 id="on-a-lab-machine"><a class="header" href="#on-a-lab-machine">On a lab machine</a></h2>
<p>On a lab machine, to save disk space your VMs may not remain between reboots - and because they are not hosted on the network file system, if you log in to a different machine next time, your changes will not be saved either but you will get the VM reinstalled from scratch. To make sure the database is ready whenever you need it, open the <code>Vagrantfile</code> in a text editor and make the following changes.</p>
<ul>
<li>On the line starting <code>apk add</code>, add the packages <code>mariadb</code> and <code>mariadb-client</code> to the end, separated by spaces.</li>
<li>Download and save the three setup files (<code>sample-data.sql</code>, <code>secure-setup.sql</code> and <code>sampledata.tar</code>) in the same folder as your Vagrantfile (this is on the host machine, so it will not get deleted along with the VM).</li>
<li>Extract the tar file so that there is a folder <code>sampledata/</code> in the same folder as your Vagrantfile.</li>
<li>Following the <code>apk add</code> line in your Vagrantfile, add the following lines:</li>
</ul>
<pre><code class="language-sh">/etc/init.d/mariadb setup
rc-update add mariadb default
rc-service mariadb start
mysql -u root -e 'source /vagrant/sample-data.sql'
mysql -u root -e 'source /vagrant/secure-setup.sql'
</code></pre>
<p>This ensures that whenever vagrant recreates the VM, it installs the database for us. The commands are basically the ones that we have done just now, except that we source the sample data before running the secure setup. This is so that the sample data command does not need a password, as none has been set so far - that only happens during the secure setup command.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reading-an-er-diagram"><a class="header" href="#reading-an-er-diagram">Reading an ER diagram</a></h1>
<p>Here is an ER diagram for a fictional university database:</p>
<p><img src="db1/../resources/uni-diagram.png" alt="ER diagram" /></p>
<p>The foreign key columns are not included in the tables - in this diagram, they are implied by the relationships, e.g. the <code>Unit.director</code> column comes from the &quot;directs&quot; relationship.</p>
<p>Looking at the diagram and the table schemas, answer the following questions for yourself:</p>
<ul>
<li>Which relationships are mandatory or optional? (For example, must every unit have at least one student enrolled?)</li>
<li>Which relationships are one-one, one-many or many-many?</li>
<li>How do the above affect the placement of foreign keys? For example, why is the foreign key for &quot;lecturer belongs to research group&quot; on the Lecturer table?</li>
</ul>
<h1 id="drawing-an-er-diagram"><a class="header" href="#drawing-an-er-diagram">Drawing an ER diagram</a></h1>
<p>Draw an ER diagram for the following scenario.</p>
<blockquote>
<p>The University of Bristol Hoverboard Society (HovSoc) wants to create a database to manage its membership and events. Each member has a name, an optional student number, a contact e-mail address and a hoverboard riding skill level (represented as an integer, minimum 0). We assume that e-mail addresses are unique among members.</p>
<p>The committee consists of some of the members, each of which has a unique committee role. We assume that committee roles do not change during the year and that each committee role must be filled every year.</p>
<p>An event has a date, a name, a location, an optional description and an organiser who must be a society member (not necessarily a committee member). An event is attended by a set of members. There is never more than one event at the same location on the same date but event names are not unique.</p>
</blockquote>
<p>You can draw the diagram with pen and paper or you can use a free modelling tool like <a href="https://draw.io">draw.io</a>. </p>
<ul>
<li>For draw.io, open the &quot;Entity Relation&quot; section in the menu on the left and use the &quot;Table&quot; (first item) object for tables. Clicking on it adds a table to your diagram.</li>
<li>To add a row to a table, select an existing row and press Control-D (duplicate item). To delete a row, press the delete key.</li>
<li>To add a relationship, select a table by clicking its header and drag one of the blue triangles that appear round the edges onto another table. You can change the type of a relationship in the details panel on the right (the &quot;line start&quot; and &quot;line end&quot; boxes).</li>
<li>File/Save as lets you download your diagram in an XML-based format, which you can open and edit later. File/Export as lets you download it as an image.</li>
</ul>
<h1 id="implementing-a-schema"><a class="header" href="#implementing-a-schema">Implementing a Schema</a></h1>
<p>Write a CREATE/DROP script for the schema that you have just designed.</p>
<ul>
<li>A create/drop script starts with a sequence of DROP TABLE IF EXISTS statements followed by a sequence of CREATE TABLE scripts. The effect of running it is to make sure all tables exist and are empty, whether or not the tables existed before.</li>
<li>If table A has a foreign key to table B then you must create table B before A and drop table A before dropping B. The simple way to do this is work out the CREATE order, then put all DROP statements in the exact opposite order.</li>
</ul>
<p>Save your script as a file (the extension <code>.sql</code> is usual for SQL scripts).</p>
<p>To test that it works, log in to the database with <code>mysql</code> on the command line in the lab machine, from a terminal in the same folder as your create/drop script. Then run the command</p>
<pre><code>USE data;
</code></pre>
<p>to select the (initially empty) database called <code>data</code>, on which you have read and write permissions. Note that there is a semicolon at the end.</p>
<p>As long as you started your MariaDB session in the folder with your script, you can now run the command <code>\. SCRIPTNAME.SQL</code>, that is a backslash, a period, a space and then the name of the script. As this is a command directly for the MariaDB client rather than a command to be run on the server, it does not take a semicolon.</p>
<p>If you get any errors, then <code>SHOW ERRORS;</code> will display more information. If not, check with <code>SHOW TABLES;</code> that your tables exist.</p>
<p>Now, run the script a second time. If the order of all commands is correct, then it should run through again without errors.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="more-modelling"><a class="header" href="#more-modelling">More modelling</a></h1>
<p>Using what you have learnt so far about relational modelling, think about and discuss in groups how you would model a university database to store student's academic progress, such as units enrolled on and completed, marks obtained etc. based on your understanding of how the University of Bristol works. For example, a unit can have different assessments with different weights. You will of course also need a <code>Students</code> table, and you can make the model more involved if you like by including that different students are on different degree programmes, and that sometimes students have to resit units.</p>
<p>You should end up with a more detailed version of the model briefly shown at the top of the previous page - if you have the time you can make both an ER diagram and a create/drop script.</p>
<p>This is also a good point to mention another fact of how marks and credit points work: exam boards. At the end of each academic year around May, your unit directors all report their marks for each student to an exam board, which sits and decides on final marks and awarding credit. For example, an exam board can moderate the marks for a unit. This is why you do not get your exam marks until a long time after the exam has happened, even if it's a multiple choice exam that can be marked automatically: the marks still have to go through an exam board. (There is another, smaller exam board around the start of Teaching Block 2 so you don't have to wait until summer for your January exam marks to be released.)
If you want to model this in your schema, the idea here is that a student has two marks associated with each unit: the &quot;actual mark&quot; (the input to the exam board) and the &quot;agreed mark&quot; (the one that comes out of the board and goes on your transcript). Of course, for most students most of the time, the two are the same. Your schema will need to store &quot;agreed marks&quot; explicitly, but there are ways of doing the model that does not store the &quot;actual mark&quot; directly. Think about how you could recompute it from other information in the database - we will of course learn how to do this in SQL in a later activity.</p>
<p>The key idea in relational modelling is not to store information more than once if you can avoid it. If you have stored in several places that Fred is taking Introduction to Programming, and then Fred switches his units, you don't want to end up with a situation where this change is only reflected in some parts of the database.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sql-for-beginners"><a class="header" href="#sql-for-beginners">SQL for beginners</a></h1>
<p>This is the second activity of four to teach you relational databases and the SQL programming language.</p>
<h2 id="videos-6"><a class="header" href="#videos-6">Videos</a></h2>
<p>The videos for this activity are:</p>
<table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/159003c7-3c66-4256-9955-c0746fb54ca4?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">SQL JOIN, part 1</a></td><td style="text-align: right">10 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/SQL%20JOIN%20part%201.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/c3db4481-31ac-48f2-9a87-05bf0e4f3006?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">SQL JOIN, part 2</a></td><td style="text-align: right">10 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/SQL%20JOIN%20part%202.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/e2a860f3-9fbe-4d24-b579-e1fc79b50ca9?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">SQL ORDER BY</a></td><td style="text-align: right">9 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/SQL%20ORDER%20BY.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/23bf5561-f7bd-44af-986f-4a5038a1ea88?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Normal Forms 1</a></td><td style="text-align: right">5 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/Normal%20forms%201.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/1170b646-b19a-4a92-a59a-0ba9eecad6cd?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Normal Forms 2</a></td><td style="text-align: right">20 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/Normal%20forms%202.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/5805bf00-b9ae-4fe0-b7f3-ce5dc93ef213?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Normal Forms 3</a></td><td style="text-align: right">6 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/Normal%20forms%203.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/dc6ee719-d36b-41f2-b8a6-01ba638cbe7d?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Normal Forms 4</a></td><td style="text-align: right">24 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/Normal%20forms%204.pdf">PDF</a></td></tr>
</tbody></table>
<h2 id="exercises-6"><a class="header" href="#exercises-6">Exercises</a></h2>
<ul>
<li><a href="db2/./explore-database.html">Explore the database</a></li>
<li><a href="db2/.//elections.html">Bristol elections</a></li>
<li><a href="db2/./census.html">The UK census</a></li>
<li><a href="db2/./normalforms.html">Normal forms</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="explore-the-database"><a class="header" href="#explore-the-database">Explore the database</a></h1>
<p>Open the virtual machine and type <code>mysql</code>. Assuming you have installed the database correctly as in the previous activity, you should see the prompt <code>MariaDB [(none)]&gt;</code> which shows that you are connected to a database server but you have not selected a database yet.</p>
<p>Have a look at the databases that exist with the command</p>
<pre><code>SHOW DATABASES;
</code></pre>
<p>Like all SQL commands, it needs a semicolon at the end. You should see four databases including <code>census</code> and <code>elections</code>. Let's select one of them:</p>
<pre><code>USE elections;
</code></pre>
<p>SQL keywords like <code>USE</code> are not case-sensitive, but it is convention to write them in all upper case. SQL names of tables, columns etc. like <code>elections</code> however are case-sensitive. Your prompt should now show <code>MariaDB [elections]&gt;</code>.</p>
<p>Have a look at the tables in this database with</p>
<pre><code>SHOW TABLES;
</code></pre>
<p>You should see <code>Candidate</code>, <code>Party</code> and <code>Ward</code>. Let's have a look at one:</p>
<pre><code>DESCRIBE Candidate;
</code></pre>
<p>The output will look like this:</p>
<pre><code>+-------+--------------+------+-----+---------+----------------+
| Field | Type         | Null | Key | Default | Extra          |
+-------+--------------+------+-----+---------+----------------+
| id    | int(11)      | NO   | PRI | NULL    | auto_increment |
| name  | varchar(100) | NO   | UNI | NULL    |                |
| party | int(11)      | YES  | MUL | NULL    |                |
| ward  | int(11)      | YES  | MUL | NULL    |                |
| votes | int(11)      | YES  |     | NULL    |                |
+-------+--------------+------+-----+---------+----------------+
</code></pre>
<p>The first two columns tell you the names and types of columns in this table. The third column (Null) tells you if NULL values are allowed in this column. The Key column tells us that id is the primary key (PRI), name has a unique constraint (UNI), party and ward are foreign keys (MUL) and there are no key constraints at all on votes.</p>
<p>For even more information, try this:</p>
<pre><code>SHOW CREATE TABLE Candidate;
</code></pre>
<p>The output is a bit messy but it shows you (more or less) the statement used to create the table. From here we can read off the details of the foreign keys:</p>
<pre><code>CONSTRAINT `Candidate_ibfk_1` FOREIGN KEY (`party`) REFERENCES `Party` (`id`)
CONSTRAINT `Candidate_ibfk_2` FOREIGN KEY (`ward`) REFERENCES `Ward` (`id`)
</code></pre>
<p>So the <code>party</code> column is a foreign key pointing at the <code>id</code> column in the <code>Party</code> table.</p>
<p>Now let's look at some data. This command shows you all entries in the Candidate table:</p>
<pre><code>SELECT * FROM Candidate;
</code></pre>
<p>There are 141 entries. Looking at the first one:</p>
<pre><code>+-----+--------------------------------+-------+------+-------+
| id  | name                           | party | ward | votes |
+-----+--------------------------------+-------+------+-------+
|   1 | Patrick Dorian Hulme           |     1 |    1 |    16 |
</code></pre>
<p>The party and ward ids on their own don't tell us much, but as they are foreign keys we can use them to join on the tables that do contain this information:</p>
<pre><code>SELECT * FROM Candidate
INNER JOIN Party ON Party.id = Candidate.party
INNER JOIN Ward ON Ward.id = Candidate.ward;
</code></pre>
<p>On the MariaDB prompt, if you don't end with a semicolon then the program assumes you want to type a command over multiple lines, and shows the continuation prompt <code>-&gt;</code> for the next ones. This also allows you to copy-paste multi-line commands from a text editor into the MariaDB client. Ending a line with a semicolon executes the query and drops you back to the main prompt.</p>
<p>You will now see a much longer listing, starting like this (I have shortened some columns):</p>
<pre><code>+-----+----------------------+-------+------+-------+----+--------------+----+-----------+------------+
| id  | name                 | party | ward | votes | id | name         | id | name      | electorate |
+-----+----------------------+-------+------+-------+----+--------------+----+-----------+------------+
|   7 | Matthew Simon Melias |     7 |    1 |  1067 |  7 | Conservative |  1 | Avonmouth |       9185 |
</code></pre>
<p>The first thing to note is that the results are no longer in the same order: P. D. Hulme is no longer at the top. Unless you tell the database that you want a particular order, it is allowed to choose its own one and depending on what joins you do, this might change.</p>
<p>There are several columns here named id, one from each of the tables - in general, doing <code>SELECT *</code> on a joined table gets you more data than you need.
This would be a nicer query unless you're actially interested in the ids:</p>
<pre><code>SELECT Candidate.name AS name,
Party.name AS party,
Ward.name AS ward,
votes,
electorate
FROM Candidate
INNER JOIN Party ON Party.id = Candidate.party
INNER JOIN Ward ON Ward.id = Candidate.ward;
</code></pre>
<p>Here is the start of the output that I get:</p>
<pre><code>+----------------------+--------------+-----------+-------+------------+
| name                 | party        | ward      | votes | electorate |
+----------------------+--------------+-----------+-------+------------+
| Matthew Simon Melias | Conservative | Avonmouth |  1067 |       9185 |
</code></pre>
<p>Explore the elections database a bit to get a feel for how the data is structured.
For example, what party and ward did Patrick Dorian Hulme from above stand for?
What is the schema of the elections database - you might want to draw a diagram?</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bristol-elections"><a class="header" href="#bristol-elections">Bristol elections</a></h1>
<p>In 2014, Bristol held council elections for 24 of its wards. Each ward elected one councillor to represent the ward on the city council. The results are in the <code>elections</code> database, with the following schema as you have hopefully just discovered:</p>
<p><img src="db2/../resources/elections.png" alt="elections ER diagram" /></p>
<p>From an ER diagram you can derive a <em>JOIN strategy</em>, a way of representing all the useful information in a database. For individual queries, you may only need a subset of this information so you can leave off unnecessary parts of the full JOIN strategy. In this case, the following would work:</p>
<pre><code>SELECT Candidate.name AS name, Party.name AS party, Ward.name AS ward, Candidate.votes, Ward.electorate
FROM Candidate 
INNER JOIN Party ON Candidate.party = Party.id
INNER JOIN Ward ON Candidate.ward = Ward.id
</code></pre>
<h2 id="exercises-7"><a class="header" href="#exercises-7">Exercises</a></h2>
<p>Find SQL statements to answer the following questions. Your answer to each question should be a single query, and you should not hard-code any ids. For example, if a question is about the Labour party, you should use the string <code>'Labour'</code> in your query somewhere, not look up the party id and hard-code that in your query.</p>
<p>Although you can answer all the exercises in this section by taking the join strategy and adding clauses where necessary, there is sometimes a quicker way. But if you don't know where to start, consider how you would extract the result you want from the joined table. The WHERE clause determines which rows appear in the result and the SELECT clause picks the columns that appear in the result.</p>
<ol>
<li>List the names of all parties that stood in the election, ordered alphabetically by name.</li>
<li>List the names of all parties that stood in the Bedminster ward.</li>
<li>How many votes did Labour get in the Stockwood ward?</li>
<li>List the names, parties and number of votes obtained for all candidates in the Southville ward. Order the candidates by number of votes obtained descending (winner comes first).</li>
<li>List the name, party and number of votes obtained for the winner only in the Knowle ward. <em>(Hint: apart from changing the ward name, you only need one small modification to the statement from the last question. You may assume no ties.)</em></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-2011-uk-census"><a class="header" href="#the-2011-uk-census">The 2011 UK Census</a></h1>
<p>In 2011, the UK took a census of all households. We will look at the data for one particular question: &quot;KS608 Occupation&quot;.</p>
<h2 id="background-uk-geography"><a class="header" href="#background-uk-geography">Background: UK Geography</a></h2>
<p>The United Kingdom of Great Britain and Northern Ireland (UK) is a country that contains the individual countries England, Wales, Scotland (at the time of writing) and Northern Ireland (but not the Republic of Ireland). The census data for this question comes from the Office of National Statistics (ONS) which is for England and Wales only. Scotland and Northern Ireland have separate statistical offices.</p>
<p>England itself can be divided into 9 regions: </p>
<ul>
<li>The North West</li>
<li>Yorkshire and The Humber</li>
<li>The North East</li>
<li>The West Midlands</li>
<li>The East Midlands</li>
<li>The South West</li>
<li>The East</li>
<li>The South East</li>
<li>London</li>
</ul>
<p>The UK used to be further divided into counties but these are much less important nowadays. In fact there is a mix of counties, unitary authorities and boroughs - 152 in total. These are all called &quot;county-level units&quot; (CLUs).</p>
<p>The smallest relevant unit for political and statistical purposes is the electoral ward, often simply called ward. Wards elect their own councillors (as we have seen) and national statistics are available at a ward level. There were 8570 wards at the time of the 2011 census. For example, the City of Bristol unitary authority contained 35 wards, of which the University of Bristol was in the Cabot ward.</p>
<p>Each statistical unit (ward, county, unitary authority etc.) is assigned a 9-character code by the ONS of the form <code>Xaabbbbbb</code> where X is E for England and W for Wales. The first two digits <code>aa</code> identify the type of unit: 05 is a ward, 06 a unitary authority; in England only E12 is a region, E08 is a borough (metropolitan), E09 is a borough of London and E10 is a county. The last 6 digits identify the individual unit. Finally, the codes for all of England and Wales are E92000001 and W92000004. </p>
<p>An interactive online map of the statistical units of the UK is available online at <a href="http://ukdataexplorer.com/census/">UK data explorer</a> or <a href="https://datashine.org.uk">DataShine</a>. All census data for individual questions is publicly available. (The most interesting data - correlations between questions - is not all openly available due to privacy issues. Researchers can apply to the ONS to get access to particular data sets.)</p>
<h2 id="data-format"><a class="header" href="#data-format">Data format</a></h2>
<p>The <code>census</code> database has the following schema.</p>
<p><img src="db2/../resources/census.png" alt="census ER diagram" /></p>
<p>For wards in England, the <code>parent</code> FK points at the county table and identifies the CLU (county-level unit) to which the ward belongs. For wards in Wales, the <code>Ward.parent</code> column is <code>NULL</code> which you need to take into account when working out a JOIN strategy.</p>
<h2 id="ks608-occupation"><a class="header" href="#ks608-occupation">KS608: Occupation</a></h2>
<p>Question KS608 on the 2011 census asked all UK citizens in employment and between the ages of 16 and 74 to classify themselves as one of 9 occupation classes.</p>
<ul>
<li>Have a look at the <code>Occupation</code> table in the <code>census</code> database to see the 9 occupation classes.</li>
</ul>
<p>The answers to the question are recorded in the <code>Statistic</code> table in the following format. Gender is 1 for women an 0 for men; in the 2011 census these where the only gender options.</p>
<pre><code>+-----------+-------+--------+------+
| wardId    | occId | gender | data |
+-----------+-------+--------+------+
| E05000001 |     1 |      1 |   54 |
+-----------+-------+--------+------+
</code></pre>
<p>This row records that in ward <code>E05000001</code> (Aldersgate), 54 women (gender=1) said that they worked as &quot;Managers, directors and senior officials&quot; (occId=1).</p>
<p>Note how (in the ER diagram) the primary key of the Statistic table is a composite of three columns (wardId, occId, gender). This is exactly what you would expect in a table that has one data value per ward, occupation class and gender.</p>
<h2 id="exercises-8"><a class="header" href="#exercises-8">Exercises</a></h2>
<ol>
<li>The university of Bristol is situated in the <code>Cabot</code> ward (ward names are not always distinct, but this one is). Find the names and codes of the CLU, region and country containing the Cabot ward (CLU = county level unit = &quot;row in County table&quot;).</li>
<li>If you used multiple SQL queries for the last question, do it in one single query now. (In other words, find a join strategy for the tables you need.)</li>
<li>Find the number of women in occupation class 1 (managers etc.) in the Cabot ward. You may use ward code for Cabot that you found in the first query and the occupation id 1 directly - you do not need any JOINs for this query.</li>
<li>For the Stoke Bishop ward (E05002003), list the 9 occupation class names and the number of men in each occupation. Your table should have two columns called <code>name</code> and <code>number</code>. You can use the provided ward code, you do not need to join on the ward name.</li>
</ol>
<p>We will soon be able to do more interesting statistical queries on the census data but for that we need SQL's statistical functions which we will learn next week.</p>
<p>Here's a slightly more tricky question to finish off with. It can be done with only the techniques that we have learnt so far.</p>
<ul>
<li>Find all ward names that are not unique, and print them in alphabetical order (only once each).</li>
</ul>
<p><em>There are 400 distinct such names in total (for example, there are 21 wards called 'Abbey') so your query will produce quite a long table. Your query might also take a while to execute, there are faster ways to do this but not with the material we've learnt so far. The table starts &quot;Abbey, Alexandra, All Saints&quot; and ends &quot;Worsley, Wyke, Yarborough&quot;.</em></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="normal-forms"><a class="header" href="#normal-forms">Normal Forms</a></h1>
<p>For this exercise, you may want to work in groups. There are two schemas, for both of which you have to decide which normal form(s) they are in, and how you would change the schemas to be in 3NF (BCNF if possible).</p>
<p>The standard way of doing this is:</p>
<ol>
<li>Identify the candidate key(s) in every table. </li>
<li>From this, deduce the key and non-key attributes in every table. </li>
<li>Find the functional dependencies (FDs) in each table.</li>
<li>Determine which normal forms from (1NF, 2NF, 3NF, BCNF) the schema does or does not satisfy.</li>
<li>If the schema is not in BCNF, normalise it as far as possible by splitting tables using Heath's Theorem on the FDs that are causing the problem.</li>
</ol>
<h2 id="schema-1"><a class="header" href="#schema-1">Schema 1</a></h2>
<p>A school's database looks like this (it was set up by someone more used to spreadsheets): </p>
<table><thead><tr><th>stuId</th><th>name</th><th>gender</th><th>unit</th><th>grade</th></tr></thead><tbody>
<tr><td>101</td><td>Fred</td><td>M</td><td>Mathematics</td><td>75</td></tr>
<tr><td>101</td><td>Fred</td><td>M</td><td>German</td><td>65</td></tr>
<tr><td>101</td><td>Fred</td><td>M</td><td>English</td><td>90</td></tr>
<tr><td>102</td><td>Sam</td><td>X</td><td>Mathematics</td><td>60</td></tr>
<tr><td>102</td><td>Sam</td><td>X</td><td>English</td><td>60</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
</tbody></table>
<p>stuId is a student id that is unique per student. Students' names are not required to be unique, i.e. you can have two 'Fred's in the school. Gender is one of {M, F, X}. For each student and each unit they take, there is one row containing among other things the student name, unit name and the grade (0-100) that the student got on this unit. In the example above, we can see that Fred took three units (Mathematics, German and English). No two units have the same name but a unit name can appear several times in the database since many students can take the same unit. The first row of the example tells us that there is a student called Fred with id 101, who is male, and took the Mathematics unit and got a grade of 75 on it. </p>
<h2 id="schema-2"><a class="header" href="#schema-2">Schema 2</a></h2>
<p>The CIA world factbook contains geographical, political and military information about the world. Here is part of one table listing principal cities from 2015:</p>
<table><thead><tr><th>*city</th><th>country</th><th style="text-align: right">pop</th><th style="text-align: right">co_pop</th><th>capital</th></tr></thead><tbody>
<tr><td>...</td><td>...</td><td style="text-align: right">...</td><td style="text-align: right">...</td><td>...</td></tr>
<tr><td>Paris</td><td>France</td><td style="text-align: right">10.8M</td><td style="text-align: right">66.8M</td><td>yes</td></tr>
<tr><td>Lyon</td><td>France</td><td style="text-align: right">1.6M</td><td style="text-align: right">66.8M</td><td>no</td></tr>
<tr><td>Marseille</td><td>France</td><td style="text-align: right">1.6M</td><td style="text-align: right">66.8M</td><td>no</td></tr>
<tr><td>Papeete</td><td>French Polynesia</td><td style="text-align: right">133K</td><td style="text-align: right">285K</td><td>yes</td></tr>
<tr><td>Libreville</td><td>Gabon</td><td style="text-align: right">707K</td><td style="text-align: right">1.7M</td><td>yes</td></tr>
<tr><td>...</td><td>...</td><td style="text-align: right">...</td><td style="text-align: right">...</td><td>...</td></tr>
</tbody></table>
<p>We will assume for this exercise that city names are globally unique and therefore the &quot;City&quot; column has been chosen as the primary key for this table. The &quot;pop&quot; column lists the city's population and the &quot;co_pop&quot; lists the population of the country in which the city is located (with abbreviations K = 1000, M=1000000). The &quot;capital&quot; column is a Boolean yes/no value that is set to &quot;yes&quot; for exactly one city in each country. (While the capital is included in the table for every country however small, non-captial cities are only included if they are of international significance.)</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="intermediate-sql"><a class="header" href="#intermediate-sql">Intermediate SQL</a></h1>
<p>This is the third of four activities to teach you relational databases and SQL.</p>
<h2 id="videos-7"><a class="header" href="#videos-7">Videos</a></h2>
<p>The videos for this activity are:</p>
<table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/b3075b96-6f51-420a-830c-0324441d0b6b?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">SQL insert/delete</a></td><td style="text-align: right">8 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/SQL%20insert%20and%20delete.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/4828f5ac-66e0-4b5b-89d4-7f4ecb01c734?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">SQL subqueries</a></td><td style="text-align: right">13 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/SQL%20Subqueries.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/011e902d-e640-4940-beac-54c10a6ac09b?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">SQL statistics</a></td><td style="text-align: right">22 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/SQL%20statistics.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/89c1e2e3-7704-49b3-9ce4-c8a9f89bfb3a?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">SQL NULL</a></td><td style="text-align: right">7 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/SQL%20NULL.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/83086484-7a0a-4c79-b8f4-6052d2e57753?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">SQL tips</a></td><td style="text-align: right">17 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/SQL%20tips.pdf">PDF</a></td></tr>
</tbody></table>
<h2 id="exercises-9"><a class="header" href="#exercises-9">Exercises</a></h2>
<p>The exercises for this activity are all on one page:</p>
<ul>
<li><a href="db3/./exercises.html">Intermediate SQL</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="census-and-elections-exercises"><a class="header" href="#census-and-elections-exercises">Census and elections exercises</a></h1>
<p>Here are some more advanced exercises based on the census and elections schemas from the last activity.</p>
<p>Your answer to each question should be a single SQL query, that is one semicolon at the end. JOINs, subqueries, WITH clauses etc. are allowed of course.
Where an identifier is given in the question you may use it, e.g. when I say &quot;the Cabot ward (E05001979)&quot; you can use the ward id directly and do not need to join on the ward table to look up the name, but if I say &quot;the Green party&quot; then you do need to join on the party table to look up the name instead of hard-coding the party id.</p>
<h2 id="elections"><a class="header" href="#elections">Elections</a></h2>
<p><img src="db3/../resources/elections.png" alt="elections ER diagram" /></p>
<ol>
<li>How many votes were cast in all of Bristol in the 2014 elections?</li>
<li>How many votes were cast in the 'Windmill Hill' ward and what percentage of the electorate in this ward does this represent? Your statement should produce a table with one row and two columns called 'votes' and 'percentage'.</li>
<li>List the names, parties and <em>percentage</em> of votes obtained for all candidates in the Southville ward. Order the candidates by percentage of votes obtained descending.</li>
<li>How successful (in % of votes cast) was the Conservative party in each ward?</li>
<li>Which rank did Labour end up in the 'Whitchurch Park' ward? Your statement should produce a table with a single row and column containing the answer as a number. You can assume no ties.</li>
<li>What is the total number of votes that each party got in the elections? Your result should be a table with two columns party, votes.</li>
<li>Find all wards where the Green party beat Labour and create a table with two columns ward, difference where the difference column is the number of Green votes minus the number of Labour votes. Your table should be ordered by difference, with the highest one first.</li>
</ol>
<h2 id="census"><a class="header" href="#census">Census</a></h2>
<p><img src="db3/../resources/census.png" alt="census ER diagram" /></p>
<ol>
<li>How many <em>women</em> work in sales and customer service occupations and live in the Cabot ward of Bristol (E05001979)?</li>
<li>How many <em>people</em> work in sales and customer service occupations and live in the Cabot ward of Bristol (E05001979)?</li>
<li>How many people work in caring, leisure and other service occupations (occupation class 6) in all of the City of Bristol CLU (E06000023)? </li>
<li>In the Cabot ward (E05001979), produce a table listing the names of the 9 occupation classes and the number of people in each of the classes in this ward.</li>
<li>Find the working population, ward name and CLU name for the smallest ward (by working population) in the 2011 census.</li>
<li>The same as the last question, but now produce a table with two rows, one for the smallest and one for the largest ward. There's no quicker way than repeating the last query twice, the question is how to stick the two &quot;copies&quot; together.</li>
<li>Find the average size of a ward's working population in the London (E12000007) region.</li>
<li>The same as the last question but now for every region - your query should produce a table with one row per region. The intention here is <em>not</em> to repeat the above query 9 times.</li>
<li>Produce a table that lists, for each of the 9 regions of England, the percentage of people in managerial (class 1) occupations who are women.</li>
<li>For all CLUs in the London (E12000007) region, produce a table with three columns called <code>CLU</code>, <code>occupation</code> and <code>count</code> such that:
<ul>
<li><code>CLU</code> is the CLU name.</li>
<li><code>count</code> is the number of people of the occupation class in question in the given CLU.</li>
<li><code>occupation</code> is the name of the occupation class.</li>
<li>Only rows with <code>count &gt;= 10000</code> appear in the table.</li>
<li>The table is sorted by <code>count</code> ascending.</li>
</ul>
</li>
<li>Create a table with three columns <code>occupation</code>, <code>women</code> and <code>men</code> and one row per occupation class. The <code>occupation</code> column should list the occupation class names. The <code>women</code> and <code>men</code> columns in each row should list the total number of women resp. men in the row's occupation class in the whole dataset. The intention here is not to have to copy-paste a subquery 9 times.</li>
<li>The same as question 9, but now with a 10th row in the table listing the value for all of England. You can use the string <code>'England'</code> for the region column.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sql-and-java"><a class="header" href="#sql-and-java">SQL and Java</a></h1>
<p>In this activity you will learn how to connect to an SQL database from a Java program using the JDBC interface and the Hibernate ORM.</p>
<h2 id="videos-8"><a class="header" href="#videos-8">Videos</a></h2>
<p>The videos for this activity are:</p>
<table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/2e9205a2-cb47-4ee7-9d3a-cd86d5e945c5?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">JDBC</a></td><td style="text-align: right">27 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/JDBC.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/d42cec3f-4531-4441-b543-b42a5601d835?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">Hibernate</a></td><td style="text-align: right">19 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/Hibernate.pdf">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/abe90adf-5faa-431e-b355-7c06875d6887?channelId=793a8a65-ed73-4803-820f-dd7f2c675f46">SQLite</a></td><td style="text-align: right">13 minutes</td><td><a href="https://uob.sharepoint.com/:b:/r/teams/UnitTeams-COMS10012-2021-22-TB-2-A/Shared%20Documents/Documents/SQLite.pdf">PDF</a></td></tr>
</tbody></table>
<h2 id="exercises-10"><a class="header" href="#exercises-10">Exercises</a></h2>
<p>The exercises for this activity are:</p>
<ul>
<li><a href="db4/./jdbc.html">JDBC</a></li>
<li><a href="db4/./hibernate.html">Hibernate</a></li>
<li><a href="db4/./sqlite.html">SQLite</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="jdbc"><a class="header" href="#jdbc">JDBC</a></h1>
<p>In this activity you will learn to connect to a SQL database using Java and the JDBC classes.
JDBC (Java DataBase Connectivity) is a low-level, not particularly object-oriented mechanism for accessing a database, on top of which other systems (e.g. Hibernate ORM) can be built.</p>
<h2 id="jdbc-interfaces"><a class="header" href="#jdbc-interfaces">JDBC Interfaces</a></h2>
<p>The JDBC classes live in the <code>java.sql</code> package. Most methods on these classes can throw a <code>SQLException</code> which is a checked exception, meaning your code won't compile if you don't handle it. For simple programs, this means wrapping in a <code>RuntimeException</code> to terminate the program if something goes wrong:</p>
<pre><code class="language-java">try {
    // do stuff with JDBC
} catch (SQLException e) {
    throw new RuntimeException(e);
}
</code></pre>
<p>Two comments on this pattern:</p>
<ol>
<li>In a real program e.g. web server, you of course do not want to take the server down whenever an individual method causes an error. Here you need to do something like log the error, and display an error message to that particular caller (e.g. HTTP 500 Internal Server Error) while keeping the rest of the server running. How you achieve this depends on which libraries or frameworks you are using.</li>
<li>Most JDBC work will actually take place in try-with-resources blocks, which work the same as far as exception handling is concerned but have an extra bracketed term immediately after the <code>try</code>.</li>
</ol>
<h2 id="try-with-resources"><a class="header" href="#try-with-resources">Try-with-resources</a></h2>
<p>A resource is something that you need to close exactly once when you are done with it, but only if it got properly opened in the first place. For example, in C heap memory is a resource: you acquire (open) it with <code>malloc</code>, and when you are done you must call <code>free</code> exactly once on the memory, except if <code>malloc</code> returned NULL in the first place (allocation failed) in which case calling <code>free</code> is an error. (You do check your <code>malloc</code> return value for NULL, don't you?) It is also an error to call <code>free</code> twice on the same memory, and it is a memory leak not to call it at all.</p>
<p>In Java, we don't have to manage memory by hand, but there are other kinds of resources:</p>
<ul>
<li>Files.</li>
<li>Network connections.</li>
<li>Graphics objects in some drawing/window systems.</li>
<li>Database connections.</li>
</ul>
<p>To help manage these, Java provides an interface <code>java.lang.AutoCloseable</code> with a single method <code>void close()</code> and the try-with-resources construction:</p>
<pre><code class="language-java">try (Resource r = ...) {
    // do things with r here
}
</code></pre>
<p>As long as the resource implements <code>AutoCloseable</code> (it's a syntax error to use this pattern otherwise), this pattern guarantees that </p>
<ol>
<li>If the initialisation statement (in the round brackets) fails, either by returning null or throwing an exception, then the block will never be executed.</li>
<li>If the initialisation succeeds, then when the block exits, <code>r.close()</code> will be called exactly once, whether the block reached its end, exited early (e.g. return statement) or threw an exception.</li>
</ol>
<p>A try-with-resources block can, but does not have to, include one or more <code>catch</code> statements, in which case they apply to the block, the initialisation statement and the implied <code>close()</code>.</p>
<p>You can also include more than one resource in the try statement by separating them with semicolons inside the bracketed term.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Earlier versions of java used the <code>finally</code> keyword to achieve something similar, but it was more challenging to get right especially if the close function could also throw an exception. Since Java 7, try-with-resources is the correct pattern to use and you should almost never need a <code>finally</code> block. You can implement <code>AutoCloseable</code> on your own classes to support this.</p>
</div>
</div>
<h2 id="opening-a-connection"><a class="header" href="#opening-a-connection">Opening a connection</a></h2>
<p>You open a connection by calling</p>
<pre><code class="language-java">try(Connection c = DriverManager.getConnection(connection_string)) {
    // do stuff with connection
} catch (SQLException e) {
    // handle exception, for example by wrapping in RuntimeException
}
</code></pre>
<p>The connection string is a string containing a URL such as </p>
<pre><code>jdbc:mariadb://localhost:3306/DATABASE?user=USER&amp;localSocket=/var/run/mysqld/mysqld.sock
</code></pre>
<p>When you try and open a connection, Java looks for a driver on your classpath that implements the addressing scheme (e.g. <code>mariadb</code>) that you have requested. This makes setting up the classpath a bit tricky, but we have maven to manage that for us.</p>
<p>However, we need to understand a bit about networking and security to make sense of that URL.</p>
<p>In a traditional database set-up, the database lives on its own machine (or cluster of machines) and applications connect to it over the network. To do this, by default, databases listen on TCP port 3306.</p>
<p>For security reasons, a competent adminstrator will set things up so that there is a firewall preventing access to the database from any machines except those of applications (and possibly developers and administrators), the database machine will certainly not be available directly from the internet. Then, applications will also need a username and password to connect to the database. Since these passwords are used by applications, and do not need to be remembered by humans, there is absolutely no excuse for choosing weak ones: the absolute minimum is something with 128 bits of entropy. Computers have no problems remembering something this long! In this case you add the extra <code>pass=</code> argument to the connection string, and to prevent passwords being sent unencrypted over the network (even if it's your internal network) you can also set up TLS or a similar tunneling technology.</p>
<p>On our Alpine machine, when we set up mariadb by default, the database server and client are both running on the same machine, so you can gain both security and performance by not using a network connection at all - instead when you type <code>mysql</code> it connects over a POSIX socket, another special type of file (type <code>s</code> in <code>ls -l</code>), in this case <code>/var/run/mysqld/mysqld.sock</code>. A POSIX socket is like a pair of pipes in that it allows bidirectional, concurrent communication between different processes, but with an API closer to that of a network (TCP) socket.</p>
<p>The point of all this discussion is that for your alpine machine, your connection string will look like this (all on one line with no newlines):</p>
<pre><code>jdbc:mariadb://localhost:3306/DATABASE?user=USER&amp;localSocket=/var/run/mysqld/mysqld.sock
</code></pre>
<p>The <code>localSocket</code> option overrides the host/port at the start. For this to work, you need the mariadb driver and a library called JNA (Java Native Access) on your classpath, and of course your system needs to support sockets.</p>
<p>The more standard connection string for a TCP connection would look like this:</p>
<pre><code>jdbc:mariadb://localhost:3306/DATABASE?user=USER
</code></pre>
<p>Which really does connect to TCP port 3306 on localhost.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>You can configure this on your Alpine machine if you wanted to: the main mariadb configuration file is <code>/etc/my.cnf</code> which in our case just contains a statement to include all files in the <code>/etc/my.cnf.d/</code> folder; in there we have <code>mariadb-server.cnf</code> which contains the lines</p>
<pre><code>[mysqld]
skip-networking
</code></pre>
<p>Remove the last line and restart the server (<code>rc-service mariadb restart</code>) and then your mariadb server (<code>mysqld</code>) will really be listening on port 3306.</p>
<p>We didn't notice this with the console client <code>mysql</code> because that by default tries the socket first, and then port 3306 if the socket doesn't exist. However the JDBC driver will only try exactly the options you give, and if you don't tell it to use the socket, it will try port 3306 and throw and exception if nothing is listening there.</p>
</div>
</div>
<h2 id="pom-file"><a class="header" href="#pom-file">POM file</a></h2>
<p>Under <a href="db4//COMS10012/resources/jdbc/jdbc-example.tar">resources/jdbc/jdbc-example.tar</a> you can find a minimal JDBC application that uses the <code>elections</code> database. Download this to your Alpine VM with <code>wget</code> (or get it from the unit repository, if you have cloned it there) and extract it to an otherwise empty folder (<code>tar xvf jdbc-example.tar</code>). It contains a file <code>pom.xml</code> and a file <code>src/main/java/org/example/Example.java</code>.</p>
<p>In the POM file, we note the following dependencies:</p>
<pre><code class="language-xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.mariadb.jdbc&lt;/groupId&gt;
        &lt;artifactId&gt;mariadb-java-client&lt;/artifactId&gt;
        &lt;version&gt;2.7.1&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;net.java.dev.jna&lt;/groupId&gt;
        &lt;artifactId&gt;jna&lt;/artifactId&gt;
        &lt;version&gt;5.6.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;net.java.dev.jna&lt;/groupId&gt;
        &lt;artifactId&gt;jna-platform&lt;/artifactId&gt;
        &lt;version&gt;5.6.0&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>The first one is the mariadb JDBC driver. When maven runs a program, it automatically puts the dependencies on the classpath; if you left this off then creating the <code>Connection</code> would throw an exception.</p>
<p>The other two are the JNA (Java Native Access) libraries for your platform, that the driver uses to connect to a POSIX socket. If you left these off, the driver would ignore the <code>localSocket</code> option, try to connect to port 3306, and throw an exception because there is nothing listening there (unless you have configured it).</p>
<ul>
<li>Run <code>mvn compile</code> in the folder with the POM file to download the dependencies and compile the example program.</li>
<li>Run <code>mvn exec:java</code> to run the program. This uses the <code>exec-maven-plugin</code> configured later in the POM file to launch the program with the main class <code>org.example.Example</code> and the correct classpath. It should print out a list of parties.</li>
<li>If you want, you can use <code>mvn package</code> to build two JAR files in <code>target</code>: one is just the compiled example class, but the more interesting one has <code>jar-with-dependencies</code> in its name and contains the compiled class and all dependencies, namely the JDBC mariadb driver and JNA (and all their dependencies). You can run this jar with <code>java -cp jdbc-example-0.1-jar-with-dependencies.jar org.example.Example</code> without using maven if you want to. This file is built by the <code>maven-assembly-plugin</code> which we have also configured in the POM file.</li>
</ul>
<h2 id="sql-from-java"><a class="header" href="#sql-from-java">SQL from Java</a></h2>
<p>In the <code>Example.java</code> class, we can see an example of JDBC in action:</p>
<pre><code class="language-java">private void readData(Connection c) {
    String SQL = &quot;SELECT id, name FROM Party&quot;;
    try (PreparedStatement s = c.prepareStatement(SQL)) {
        ResultSet r = s.executeQuery();
        while (r.next()) {
            int id = r.getInt(&quot;id&quot;);
            String name = r.getString(&quot;name&quot;);
            System.out.println(&quot;Party #&quot; + id + &quot; is: &quot; + name);
        }
    } catch (SQLException e) {
        throw new RuntimeException(e);
    }
}
</code></pre>
<ul>
<li>The SQL command goes in a string. If we wanted to add parameters for a prepared statement, we put question marks here.</li>
<li>We create a <code>PreparedStatement</code> in another try-with-resources block: we need to close statements as soon as we are done with them, but it's ok for a program to keep the database connection open for as long as it runs.</li>
<li>In this case, we have no parameters to pass, so we execute the query to get a <code>ResultSet</code>, a &quot;cursor&quot; (a kind of iterator) on the results. (A <code>ResultSet</code> is also a resource, but it closes automatically when its statement closes, so we don't have to handle this ourselves.)</li>
<li>We iterate over the rows of the result and do something with them, in this case printing to standard output.</li>
<li>All these operations can throw an <code>SQLException</code>, so we catch it at the end, and because this is just a small example program, we handle it by throwing an exception to terminate the whole program.</li>
</ul>
<h2 id="result-sets"><a class="header" href="#result-sets">Result Sets</a></h2>
<p>Java is an object-oriented language with a compile-time type system: if you declare that a <code>class Person</code> has a field <code>int age</code>, then the compiler will stop you from ever trying to put a string in there. JDBC cannot offer you this level protection because when you compile your Java program, you don't know what tables and fields exist in the database (even if you do know, someone could change them after the program has been compiled).
So you have to fall back to some more C-like patterns for using the database.</p>
<p>A result set can either be pointing at a row in the database or not. If it is pointing at a row, you can read values with the <code>get...</code> methods. If the result set is not pointing at a row, then trying to read anything throws an SQLException. The rules here are:</p>
<ul>
<li>When you get the result set back, it starts out pointing <em>before the first row</em>, so reading immediately would throw an error.</li>
<li>Calling <code>boolean next()</code> tries to advance a row. If this returns true, then you have got a new row and can read from it; if you get false then you have stepped beyond the last row and it would be an error to read. (If there are no rows in your result at all, then the first call to <code>next()</code> will already return false.)</li>
</ul>
<p>The correct pattern to use the result set is normally a while loop, as each time you land in the loop body you're guaranteed to have found a row:</p>
<pre><code class="language-java">while (r.next()) {
    // we have a row, do something with it
}
</code></pre>
<p>There are however a couple of exceptions to this pattern. First, some statements like <code>select count(...)</code> will always return exactly one row - maybe the value in the row will be zero, but that's not the same thing as no row at all - so in this case you can do</p>
<pre><code class="language-java">if (r.next()) {
    // this should always happen    
} else {
    // this should never happen
    // throw an exception or something
}
</code></pre>
<p>It would still be an error to access the one row before calling <code>next()</code>, and we are not the kind of people who ignore return values from API calls.</p>
<p>Another special case is if you want to do something special with the first row:</p>
<pre><code class="language-java">if (r.next()) {
    // if we get here then there was at least one row
    // we're on the first row and can do something special with it
    do {
        // this block will be called exactly once for every row
        // including the first one
    } while (r.next())
} else {
    // if we get here then there were no rows at all
}
</code></pre>
<p>The <code>do-while</code> loop lets us write a block that is called exactly once for every row, while still letting us do something special with the first row without needing an ugly <code>boolean isFirstRow</code> flag or something like that.</p>
<p>Inside a result set, as long as we're sure we're on a row, we can read values from columns by declaring their name and type:</p>
<pre><code class="language-java">int id = r.getInt(&quot;id&quot;);
</code></pre>
<p>This tells JDBC that there is a column named <code>id</code> of type <code>int</code>, and to get its value. (You get an exception if the name or type are wrong.) Other methods include <code>getString</code>, <code>getDouble</code> etc.</p>
<p>For this reason, in your SQL statement, you want to be clear about the names and order of the colums you're fetching:</p>
<ul>
<li>If a column is something more complicated than a field, then give it an alias, e.g. <code>SELECT COUNT(1) AS c</code> then you can do <code>getInt(&quot;c&quot;)</code>.</li>
<li>Never do <code>SELECT *</code> from JDBC, always list exactly the columns you need. This both fixes the order you get them in, and is more efficient if you don't need all of them.</li>
</ul>
<h2 id="exercise-1"><a class="header" href="#exercise-1">Exercise 1</a></h2>
<p>Modify the example program so it takes a party ID as a parameter, and displays only that party's name, or the string &quot;No party with this ID.&quot; if there isn't one in the database.</p>
<p>To do this you will have to change the following:</p>
<ul>
<li><code>main</code> reads a parameter off <code>args</code>, or prints an error message if you didn't pass an argument.</li>
<li><code>main</code> passes the parameter as an extra int argument to <code>readData</code>.</li>
<li>Set the parameter as a question mark in the prepared statement, and then bind the parameter to the statement. </li>
</ul>
<p>The command for binding a parameter is <code>s.setInt(pos, value)</code> where <code>pos</code> is the index of the parameter (question mark) in the string, <em>starting the count at 1 not 0</em>. So you simply want <code>s.setInt(1, value)</code>. Of course there are also <code>setString</code> etc. and these methods on the statement take a second parameter of the appropriate type.</p>
<p>The easiest way to run your command with a parameter is to build a jar with dependencies and then to call <code>java -cp JARFILE MAINCLASS PARAMETERS</code>, any further command line parameters to Java after the main class get passed as arguments to this class.</p>
<h2 id="exercise-2"><a class="header" href="#exercise-2">Exercise 2</a></h2>
<p>A service is a piece of code that can be called by other code and typically accesses resources for them. This exercise is about writing a <code>DataService</code> that abstracts away the JDBC access for the rest of your program.</p>
<p>Create the following classes in their own files (you can use private fields with public constructors/getters/setters if you prefer):</p>
<pre><code class="language-java">public class Party {
    public int id;
    public String name;
}

public class Ward {
    public int id;
    public String name;
    public int electorate;
}

public class Candidate {
    public int id;
    public String name;
    public Party party;
    public Ward ward;
    public int votes;
}
</code></pre>
<p>Now, write a class <code>DataService</code> with the following description:</p>
<ul>
<li>DataService implements <code>AutoCloseable</code>. It has one public constructor that takes a connection string and creates a <code>Connection</code> using this string, which it stores in a private field. The <code>close()</code> method closes the connection.</li>
<li>A method <code>public List&lt;Party&gt; getParties()</code> that returns a list of all parties in the database, by using JDBC on the provided connection.</li>
<li>A method <code>public Party getParty(int id)</code> that returns the party for this id, if there is one, otherwise null.</li>
</ul>
<p>These methods should handle all possible cases (e.g. <code>getWards</code> must still work if there are no wards in the database). but they should not throw an SQLException. Instead, make your own exception class called something like <code>DataServiceException</code> derived from <code>RuntimeException</code> (this can be an inner class of <code>DataService</code> if you want) and wrap the <code>SQLException</code> in that.</p>
<p><em>This is not an excuse for sloppy programmers to ignore the exceptions, by the way!</em></p>
<p>Now, adapt the <code>Example</code> program so that</p>
<ul>
<li>The main program uses the <code>DataService</code> and the domain classes (e.g. <code>Party</code>) and doesn't know about JDBC directly.</li>
<li>If you pass an id as a parameter, it fetches the party with this id (if there is one) and displays party information from the <code>Party</code> instance.</li>
<li>If you don't pass an id, it displays the list of all parties.</li>
</ul>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>The <code>DataService</code> class is a resource, and it opens a connection in its constructor and closes it when you close the instance. This is a standard pattern and works perfectly if the programmer using it uses it in a try-with-resources block.</p>
<p>However, someone could create an instance, close it manually, and then try to continue using it, which would cause a <code>SQLException</code> on the connection. To handle this case by programming defensively, you could:</p>
<ol>
<li>In the close method, set the connection field to null after closing it as a sign that this instance has been closed.</li>
<li>In all other methods, check that the connection field is not null first thing in the method and throw and exception if it is (you can write your own private method for this). According to Java conventions, the correct exception to throw in this case is a <code>java.lang.IllegalStateException</code> which means roughly <em>you are calling a method at the wrong time</em> - in this case after closing the resource in question.</li>
</ol>
</div>
</div>
<h2 id="exercise-3"><a class="header" href="#exercise-3">Exercise 3</a></h2>
<p>Implement a <code>Candidate getCandidate(int id)</code> method on the data service too. This will require you to use a JOIN in your SQL and to create instances of all three domain classes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hibernate"><a class="header" href="#hibernate">Hibernate</a></h1>
<p>JDBC lets us connect to a database and pull out data, but we have to do a lot of manual coding to check and convert types, deal with result sets and exceptions etc. We can abstract away most of this into a service class like the <code>DataService</code> at the end of the last page, but we still have to write the data service - even though it is a lot of boilerplate code that we almost need to copy-paste from a template for each new class. We could write a script that given an ER diagram in some machine-readable format, automatically generates a data service for this class to automate all this - or we could use Hibernate to do this for us.</p>
<p>Hibernate is an object-relational mapping (ORM) framework, that is to say it automatically generates an advanced form of data service at runtime which includes many extra features such as sessions, transactions, caches and connection pools. It implements the Java Persistence Api (JPA), an API that in turn builds on JDBC for the purpose of implementing ORMs. Actually Hibernate has its own features that go beyond JPA, such as its own query language.</p>
<p>In a real application, you will be using an ORM most of the time, but you can fall back to SQL for more advanced queries that the ORM cannot support easily.</p>
<h2 id="example-application---set-up"><a class="header" href="#example-application---set-up">Example application - set-up</a></h2>
<p>There is an example application in <a href="db4//COMS10012/resources/orm/orm.tar">resources/orm/orm.tar</a> which you can download and extract in your VM.</p>
<p>The POM file simply has an extra dependency on Hibernate:</p>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
    &lt;artifactId&gt;hibernate-core&lt;/artifactId&gt;
    &lt;version&gt;5.4.27.Final&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>Hibernate's configuration lives in <code>src/main/resources/hibernate.cfg.xml</code>. Hibernate uses a <em>Session Factory</em> to create sessions, in which you can make queries:</p>
<pre><code class="language-xml">&lt;?xml version = &quot;1.0&quot; encoding = &quot;utf-8&quot;?&gt;
&lt;!DOCTYPE hibernate-configuration SYSTEM 
&quot;http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd&quot;&gt;
&lt;hibernate-configuration&gt;
  &lt;session-factory&gt;
    
    &lt;!-- These properties set up the database connection. --&gt;
    &lt;property name=&quot;dialect&quot;&gt;org.hibernate.dialect.MySQLDialect&lt;/property&gt;
    &lt;property name=&quot;connection.url&quot;&gt;jdbc:mariadb://localhost/elections?localSocket=/var/run/mysqld/mysqld.sock&lt;/property&gt;
    &lt;property name=&quot;connection.username&quot;&gt;vagrant&lt;/property&gt;
    
    &lt;!-- Don't use this in production, use a connection pool instead. --&gt;
    &lt;property name=&quot;current_session_context_class&quot;&gt;thread&lt;/property&gt;

    &lt;!-- Display generated SQL on the console. --&gt;
    &lt;property name=&quot;show_sql&quot;&gt;true&lt;/property&gt;

    &lt;!-- The classes to map to database tables. --&gt;
    &lt;mapping class=&quot;org.example.Candidate&quot; /&gt;
    &lt;mapping class=&quot;org.example.Party&quot; /&gt;
    &lt;mapping class=&quot;org.example.Ward&quot; /&gt;
    
  &lt;/session-factory&gt;
&lt;/hibernate-configuration&gt;
</code></pre>
<ul>
<li>The <em>dialect</em> selects the SQL dialect to speak to the database, in this case <em>MySQL</em> (there's no separate MariaDB one because the two are for all practical purposes identical).</li>
<li>The connection string lives in <code>connection.url</code>, minus the username/password because there are separate properties for these. Note though that we have included the socket option here.</li>
<li>Username and, if you need it, password go in separate properties.</li>
<li>The connection pool is really important for performance in real applications, but we don't bother with that here and just say one connection per thread (we don't use multiple threads in our program so it doesn't matter as much).</li>
<li><code>show_sql</code> is a debuging property that prints all generated SQL to standard output. This is useful to know about when debugging your own applications.</li>
<li>Finally, we list all the classes we want Hibernate to take care of. In SPE, you are going to use the Spring Framework which takes care of this automatically, but for now we're listing them all.</li>
</ul>
<p>The classes themselves are standard Java value classes (private fields, public getter/setter) decorated with JPA annotations to explain to Hibernate how they work:</p>
<pre><code class="language-java">import javax.persistence.Entity;
import javax.persistence.Id;

@Entity
public class Party {
    @Id private int id;
    private String name;
    
    public Party() {}
    
    public int getId()      { return id; }
    public String getName() { return name; }

    public void setId(int id)         { this.id = id; }
    public void setName(String name)  { this.name = name; }
}
</code></pre>
<ul>
<li><code>@Entity</code> means this is something that maps to a table in the database. By default, Hibernate guesses the table name from the class name, but you could change this with a parameter e.g. <code>@Entity(name=&quot;Parties&quot;)</code>.</li>
<li><code>@Id</code> indicates the primary key.</li>
</ul>
<p>The candidate class is a bit more interesting as it has foreign keys:</p>
<pre><code class="language-java">@ManyToOne 
@JoinColumn(name = &quot;party&quot;)
private Party party;
</code></pre>
<ul>
<li><code>@ManyToOne</code> tells Hibernate that this is a foreign key for a many-to-one relationship (there is also <code>@ManyToMany</code>).</li>
<li><code>@JoinColumn</code> sets the name of the foreign key column, as the default here would be <code>party_id</code>.</li>
</ul>
<h2 id="example-application---querying"><a class="header" href="#example-application---querying">Example application - querying</a></h2>
<p>Let's look at the main class (Example.java). First, Hibernate uses a session factory to manage its own database connections and sessions:</p>
<pre><code class="language-java">import org.hibernate.SessionFactory;
import org.hibernate.Session;
import org.hibernate.cfg.Configuration;

public class Example implements AutoCloseable {

  SessionFactory sessionFactory;

  public Example() {
    sessionFactory = new Configuration().configure().buildSessionFactory();
  }

  public void close() {
    sessionFactory.close();
  }

  // ...
}
</code></pre>
<p>You get one from the global <code>Configuration</code> class, to which you could pass parameters to override the ones in the XML file if you wanted to (this would let you change settings in response to command line arguments, for example). A session factory is a resource, so we make our own example class a resource too which lets us run it like this:</p>
<pre><code class="language-java">public static void main(String[] args) {
    try (Example example = new Example()) {
        example.run();
    }
  System.out.println(&quot;Done.&quot;);
  System.exit(0);
}
</code></pre>
<p>The exit command at the end makes sure the program exits even if Hibernate still has a background thread running.</p>
<p>In the <code>run()</code> method, we use a Hibernate session, which manages a database connection:</p>
<pre><code class="language-java">try (Session session = sessionFactory.openSession()) {
    // code
}
</code></pre>
<p>We then have three examples of using Hibernate.</p>
<h3 id="loading-an-entity-by-id"><a class="header" href="#loading-an-entity-by-id">Loading an entity by ID</a></h3>
<pre><code class="language-java">Party p1 = session.get(Party.class, 1);
System.out.println(&quot;    The party with id=1 is: &quot; + p1.getName());
</code></pre>
<p>To fetch an instance by id, we just call <code>get</code> on the session with the class we want and the id. Passing the class both tells Hibernate which table to load from, and it tells the compiler what type of object to return - the way Java generics work, this lets us assign the result to a <code>Party</code> variable directly without having to do a cast.</p>
<h3 id="loading-with-a-query"><a class="header" href="#loading-with-a-query">Loading with a query</a></h3>
<pre><code class="language-java">TypedQuery&lt;Ward&gt; query = session.createQuery(&quot;FROM Ward&quot;, Ward.class);
List&lt;Ward&gt; wards = query.getResultList();
System.out.println(&quot;  Wards:&quot;);
for (Ward ward : wards) {
    System.out.println(&quot;    &quot; + ward.getName());
}
</code></pre>
<p>A <code>TypedQuery</code> object takes a string in HQL, Hibernate's own query language (based on SQL) and the class of the object to return - this is so that the Java compiler can figure out the return type. <code>getResultList</code> returns all results as a list.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>The <code>TypedQuery</code> interface is part of JPA and is declared roughly as follows:</p>
<pre><code class="language-java">interface TypedQuery&lt;T&gt; {
  // ...
  List&lt;T&gt; getResultList();
}
</code></pre>
<p>This use of generics allows the compiler to be sure that the return type matches the type parameter you gave when you created the query. Of course, you don't create it directly but you ask for a query object from the Hibernate session, but behind the scenes there's an <a href="https://docs.jboss.org/hibernate/orm/5.2/javadocs/org/hibernate/query/internal/QueryImpl.html">org.hibernate.query.internal.QueryImpl<T></a> as well as many other Hibernate-related implementation classes.</p>
<p>These classes could take the type parameter as an argument to their constructor, but if you <a href="https://github.com/hibernate/hibernate-orm/blob/master/hibernate-core/src/main/java/org/hibernate/query/internal/QueryImpl.java">look at the sources</a>, they don't: it seems that Hibernate does a cast internally to get the types right, which is safe as long as the Hibernate developers know what they're doing.</p>
</div>
</div>
<h3 id="queries-with-joins-and-parameters"><a class="header" href="#queries-with-joins-and-parameters">Queries with joins and parameters</a></h3>
<p>For a more involved example, we look at the following:</p>
<pre><code class="language-java">TypedQuery&lt;Candidate&gt; q = session.createQuery(&quot;FROM Candidate c WHERE c.party.name = :name&quot;, Candidate.class);
q.setParameter(&quot;name&quot;, &quot;Labour&quot;);
List&lt;Candidate&gt; candidates = q.getResultList();
System.out.println(&quot;  Labour Candidates:&quot;);
for (Candidate c : candidates) {
    System.out.println(&quot;    &quot; + c.getName() + &quot; (&quot; + c.getWard().getName() + &quot;)&quot;);
}
</code></pre>
<p>HQL, like SQL, allows a WHERE clause to filter results. It also allows prepared statements, but goes one better than JDBC in that parameters can have names. You declare a parameter with a colon in the query string (<code>:name</code>) and then use <code>setParameter(name, value)</code> to bind it - this method is written so that it can take a value of any type, presumably with a combination of overloading for int/float types and <code>Object</code> for everything else.</p>
<p>Hibernate will automatically do the JOINs necessary to fetch the party associated with each Candidate, the SQL it runs for this query looks like this on my machine:</p>
<pre><code class="language-SQL">select party0_.id as id1_1_0_, party0_.name as name2_1_0_ from Party party0_ 
where party0_.id=?

select candidate0_.id as id1_0_, candidate0_.name as name2_0_, 
candidate0_.party as party4_0_, candidate0_.votes as votes3_0_, 
candidate0_.ward as ward5_0_ from Candidate candidate0_ 
cross join Party party1_ where candidate0_.party=party1_.id and party1_.name=?
</code></pre>
<p>Hibernate has decided to do two queries here (maybe in parallel, so the order the statements are printed on the terminal may not be accurate). The first one is because if there is no party with the supplied name, then Hibernate can stop and return an empty list; if there is then it continues with the second query to join the two tables.</p>
<h2 id="the-n1-problem"><a class="header" href="#the-n1-problem">The N+1 problem</a></h2>
<p>Note that in the queries above, Hibernate does not fetch the ward names. It doesn't matter here because they are already in Hibernate's cache from the previous query. However, if you comment out the first two queries and leave only the third one (lines 41-50 in Example.java), something horrible happens:</p>
<pre><code class="language-SQL">select candidate0_.id as id1_0_, candidate0_.name as name2_0_, candidate0_.party as party4_0_, candidate0_.votes as votes3_0_, candidate0_.ward as ward5_0_ from Candidate candidate0_ cross join Party party1_ where candidate0_.party=party1_.id and party1_.name=?
select party0_.id as id1_1_0_, party0_.name as name2_1_0_ from Party party0_ where party0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
</code></pre>
<p>Hibernate is firing off one query per ward! This is called the N+1 problem, because one HQL query that returns N results ends up producing N+1 SQL queries, which is horribly inefficient expecialy for large N.</p>
<p>Looking at the loop structure:</p>
<pre><code class="language-java">TypedQuery&lt;Candidate&gt; q = session.createQuery(&quot;FROM Candidate c WHERE c.party.name = :name&quot;, Candidate.class);
q.setParameter(&quot;name&quot;, &quot;Labour&quot;);
List&lt;Candidate&gt; candidates = q.getResultList();
System.out.println(&quot;  Labour Candidates:&quot;);
for (Candidate c : candidates) {
    System.out.println(&quot;    &quot; + c.getName() + &quot; (&quot; + c.getWard().getName() + &quot;)&quot;);
}
</code></pre>
<p>From the query itself, it is not clear to Hibernate whether ward names will be needed or not, so Hibernate does not JOIN them by default which would be more efficient if you don't actually need them. In the for loop at the bottom however, you do access the names, so on every pass through the loop, Hibernate is forced to run a new query to get the name of the relevant ward.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>How does Hibernate trigger a query off a simple <code>.getWard().getName()</code>, that you have implemented yourself in the Candidate and Ward classes?</p>
<p>The answer is that instead of actual Candidate objects, Hibernate creates a proxy subclass of Candidate at runtime and returns instances of this instead. These proxy objects have <code>getWard()</code> overridden to fire off another query if, and only if, they are actually called.</p>
</div>
</div>
<p>The solution here is to tell Hibernate at query time that you'll need the wards:</p>
<pre><code class="language-java">TypedQuery&lt;Candidate&gt; q = session.createQuery(&quot;FROM Candidate c JOIN FETCH c.ward WHERE c.party.name = :name&quot;, Candidate.class);
</code></pre>
<p>This is HQL for &quot;I'm going to use the wards, so please do a JOIN to load them too&quot;. And Hibernate now uses a single query for the Candidates again:</p>
<pre><code class="language-SQL">select party0_.id as id1_1_0_, party0_.name as name2_1_0_ from Party party0_ where party0_.id=?

select candidate0_.id as id1_0_0_, ward1_.id as id1_2_1_, candidate0_.name as name2_0_0_,
candidate0_.party as party4_0_0_, candidate0_.votes as votes3_0_0_,
candidate0_.ward as ward5_0_0_, ward1_.electorate as electora2_2_1_,
ward1_.name as name3_2_1_
from Candidate candidate0_
inner join Ward ward1_ on candidate0_.ward=ward1_.id
cross join Party party2_
where candidate0_.party=party2_.id and party2_.name=?
</code></pre>
<p>There is another way to solve this problem: if every time you load a Candidate, you want the ward name to be loaded as well, then you can declare this on the JPA annotation:</p>
<pre><code class="language-java">@ManyToOne(fetch = FetchType.EAGER)
</code></pre>
<h2 id="exercise-1-1"><a class="header" href="#exercise-1-1">Exercise 1</a></h2>
<p>Implement a JPA/Hibernate example application for the census database using the Country, Region, County and Ward tables (ignore Statistic/Occupation for this exercise). You could implement the following in your main program for example:</p>
<ul>
<li>Given a ward code, load the ward and print out all related information (ward name, county name etc.).</li>
<li>Given a ward name, print out all the counties that have a ward with that name.</li>
</ul>
<p>Pay attention to avoiding the N+1 problem in the second case.</p>
<h2 id="exercise-2-1"><a class="header" href="#exercise-2-1">Exercise 2</a></h2>
<p>What you have learnt so far will allow you to navigate upwards in the hierarchy, e.g. given a ward you can find its associated county. This exercise is about the other way round: given a county object, you want to find all wards in it.</p>
<p>To do this, add the following property to your County class:</p>
<pre><code class="language-java">@OneToMany(mappedBy = &quot;county&quot;)
private List&lt;Ward&gt; wards;
</code></pre>
<p>The argument to <code>mappedBy</code> must be the field name of the field in the Ward class that contains the county reference - you might have called it <code>parent</code> or something else in your class.</p>
<p>Then, add a getter and setter for this list property.</p>
<p>You have now created what is called a <em>bidirectional association</em>: a ward contains a county property, and a county contains a list of wards. You can navigate in both directions in your Java code.</p>
<p>Write a query that loads the City of Bristol county (E06000023) and prints a list of all its ward names with a Java for loop starting from the county object. Make sure you write your HQL query so that you don't cause an N+1 problem here.</p>
<p>This example also helps to explain why we don't make everything eager fetched by default: if you did that with bidirectional associations, then loading any object at all would load the entire database into memory!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>

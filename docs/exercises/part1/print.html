<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Exercises</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="overview.html">Overview</a></li><li class="chapter-item expanded affix "><li class="part-title">Week 1: POSIX Systems</li><li class="chapter-item expanded "><a href="posix1/index.html"><strong aria-hidden="true">1.</strong> System Administration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="posix1/ssh.html"><strong aria-hidden="true">1.1.</strong> Secure shell</a></li><li class="chapter-item expanded "><a href="posix1/install.html"><strong aria-hidden="true">1.2.</strong> Installing Vagrant and Debian</a></li><li class="chapter-item expanded "><a href="posix1/admin.html"><strong aria-hidden="true">1.3.</strong> Debian system administration</a></li></ol></li><li class="chapter-item expanded "><a href="posix2/index.html"><strong aria-hidden="true">2.</strong> The POSIX Shell</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="posix2/shell.html"><strong aria-hidden="true">2.1.</strong> Shell expansion</a></li><li class="chapter-item expanded "><a href="posix2/pipes.html"><strong aria-hidden="true">2.2.</strong> Pipes</a></li><li class="chapter-item expanded "><a href="posix2/regex.html"><strong aria-hidden="true">2.3.</strong> Regular expressions</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Week 2: Version Control</li><li class="chapter-item expanded "><a href="git/index.html"><strong aria-hidden="true">3.</strong> Git</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="git/git.html"><strong aria-hidden="true">3.1.</strong> Git</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Week 3: Shell Scripting & Build Tools</li><li class="chapter-item expanded "><a href="posix3/index.html"><strong aria-hidden="true">4.</strong> Shell Scripting</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="posix3/permissions.html"><strong aria-hidden="true">4.1.</strong> File permissions</a></li><li class="chapter-item expanded "><a href="posix3/script.html"><strong aria-hidden="true">4.2.</strong> Shell scripting</a></li></ol></li><li class="chapter-item expanded "><a href="build2/index.html"><strong aria-hidden="true">5.</strong> Build Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="build2/c.html"><strong aria-hidden="true">5.1.</strong> C</a></li><li class="chapter-item expanded "><a href="build2/python.html"><strong aria-hidden="true">5.2.</strong> Python</a></li><li class="chapter-item expanded "><a href="build2/java.html"><strong aria-hidden="true">5.3.</strong> Java</a></li><li class="chapter-item expanded "><a href="build2/spring.html"><strong aria-hidden="true">5.4.</strong> Spring</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Week 4: Debugging</li><li class="chapter-item expanded "><a href="build1/index.html"><strong aria-hidden="true">6.</strong> Debugging</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="build1/exercise.html"><strong aria-hidden="true">6.1.</strong> Exercise</a></li></ol></li><li class="chapter-item expanded "><a href="posix4/index.html"><strong aria-hidden="true">7.</strong> Bonus POSIX (unassessed)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="posix4/stat.html"><strong aria-hidden="true">7.1.</strong> inodes and system calls</a></li><li class="chapter-item expanded "><a href="posix4/concurrent.html"><strong aria-hidden="true">7.2.</strong> Concurrent programming in POSIX</a></li><li class="chapter-item expanded "><a href="posix4/cpipe.html"><strong aria-hidden="true">7.3.</strong> Pipes in C</a></li><li class="chapter-item expanded "><a href="posix4/c_io.html"><strong aria-hidden="true">7.4.</strong> Input/Output in C</a></li><li class="chapter-item expanded "><a href="posix4/posix_io.html"><strong aria-hidden="true">7.5.</strong> Input/Output in POSIX</a></li><li class="chapter-item expanded "><a href="posix4/final.html"><strong aria-hidden="true">7.6.</strong> The final challenge</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Week 5: Databases</li><li class="chapter-item expanded "><a href="db1/sql-introduction.html"><strong aria-hidden="true">8.</strong> SQL introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="db1/setup.html"><strong aria-hidden="true">8.1.</strong> Set up the database</a></li><li class="chapter-item expanded "><a href="db1/er-diagram.html"><strong aria-hidden="true">8.2.</strong> ER diagram</a></li><li class="chapter-item expanded "><a href="db1/er2.html"><strong aria-hidden="true">8.3.</strong> More modelling</a></li><li class="chapter-item expanded "><a href="db2/explore-database.html"><strong aria-hidden="true">8.4.</strong> Explore the database</a></li><li class="chapter-item expanded "><a href="db2/elections.html"><strong aria-hidden="true">8.5.</strong> Bristol elections</a></li><li class="chapter-item expanded "><a href="db2/census.html"><strong aria-hidden="true">8.6.</strong> The UK census</a></li><li class="chapter-item expanded "><a href="db2/normalforms.html"><strong aria-hidden="true">8.7.</strong> Normal forms</a></li></ol></li><li class="chapter-item expanded "><a href="db3/sql-intermediate.html"><strong aria-hidden="true">9.</strong> Intermediate SQL</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="db3/exercises.html"><strong aria-hidden="true">9.1.</strong> Exercises</a></li></ol></li><li class="chapter-item expanded "><a href="db4/sql-java.html"><strong aria-hidden="true">10.</strong> SQL and Java</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="db4/jdbc.html"><strong aria-hidden="true">10.1.</strong> JDBC</a></li><li class="chapter-item expanded "><a href="db4/hibernate.html"><strong aria-hidden="true">10.2.</strong> Hibernate</a></li><li class="chapter-item expanded "><a href="db4/sqlite.html"><strong aria-hidden="true">10.3.</strong> SQLite</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Exercises</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>This page contains the exercises for Part 1 (the first 5 weeks) of COMSM0085 Software Tools.
Weeks usually contain two workbooks, and each workbook has associated videos to
watch before the lab (on the main page for each workbook) as well as a set of
practical exercises which you'll tackle before and during the lab.</p>
<p>Part 1 focuses on tools for setting up systems and writing code. We'll start
with system administration tasks (like connecting to machines via ssh and
updating software) and then move on to making good use of Unix tools,
progressing to shell scripting and how to automate or simplify tasks you might
encounter as a developer. Then we'll look at tools you can use to support
programming in several different languages, including version control and
debuggers. Finally, we'll cover how you can store structured information
effectively in a relational database, and write queries to interact with that
database.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="system-administration"><a class="header" href="#system-administration">System Administration</a></h1>
<h2 id="videos"><a class="header" href="#videos">Videos</a></h2>
<p>Before this activity, you should watch the following videos - most of them are quite short. The videos are hosted on Microsoft Stream, and you will need to authenticate via university log-in to watch them.</p>
<div class="table-wrapper"><table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/d2736b4b-80de-4740-9084-2ab458a9dbab">SSH</a></td><td style="text-align: right">10 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/ERXOIS-oCUxMmOguGB0ctO8BSWKpCskLDBmWM3c6wrk90A?e=IobhBb">slides</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/373abf95-52ce-45d2-82d0-28250d300184">Vagrant</a></td><td style="text-align: right">12 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EW4-UCx2St1Gl8AGPwTuq4EBhNt7-KfnKhbewow6w3WuJQ?e=bJeh4g">slides</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/9091bdf6-2242-4b43-b09e-9641f9401135">Package managers</a></td><td style="text-align: right">6 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EUPLvl82HzRGi-nyhSdiBicBb7EBnouRVnT6RAKKyzhqKQ?e=Ow5cmt">slides</a></td></tr>
</tbody></table>
</div>
<p><em>NB: The videos were recorded last year. Almost everything still applies, but you might see us talking about 'Alpine' or 'apk' -- the Linux VM we used to use, and its package manager. Look at the updated slides to see how Alpine-specific commands translate to Debian.</em></p>
<h2 id="exercises"><a class="header" href="#exercises">Exercises</a></h2>
<ul>
<li><a href="posix1/./ssh.html">Secure shell</a></li>
<li><a href="posix1/./install.html">Installing vagrant and Debian</a></li>
<li><a href="posix1/./admin.html">Debian system administration</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="secure-shell"><a class="header" href="#secure-shell">Secure shell</a></h1>
<p>Secure shell (SSH) is a protocol to allow you to remotely log in to another computer, such as a lab machine. Almost everyone who uses SSH uses the free OpenSSH implementation, which is standard on pretty much every Linux distribution and is also available for Windows and Mac - and even for the mobile operating systems iOS and Android.</p>
<p>We will see in more detail how SSH manages connections later on, but for now imagine that it opens a network connection between your own machine, and a shell running on a different machine. When you type something, SSH encrypts this and sends it to the other machine which decrypts it and passes it to the shell (or any other program you're running); when the shell replies then SSH encrypts that and sends it back to you. For this to work, (Open)SSH is actually two programs:</p>
<ul>
<li><code>ssh</code> is the client, which you run on your machine to connect to another machine.</li>
<li><code>sshd</code> is the server, or <em>daemon</em> in UNIX-speak. It runs in the background on the machine you want to connect to, and needs to be installed by the system administrator.</li>
</ul>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>SSH uses TCP port 22 by default.</p>
</div>
</div>
<h2 id="check-your-client"><a class="header" href="#check-your-client">Check your client</a></h2>
<p>First of all, let's check that the ssh client is working.</p>
<ul>
<li>Open a terminal on your own machine: linux, mac OS and windows subsystem for linux should be fine. Windows 10 CMD might work too if you have the windows version of openssh installed (for example if you have git installed which uses ssh behind the scenes).</li>
<li>Type <code>ssh localhost</code> and press ENTER. Several different things could happen:
<ul>
<li>If it asks for a password, then the ssh client is working, and a ssh server is running on your current machine. The password would be your user account password, but we don't actually want to log in again so cancel with Control+C.</li>
<li>If it succeeds without a password, then the client is working and a ssh server is running on your machine and either you do not have a password, or you already have a key set up. Type <code>exit</code> and press ENTER to get back to your previous shell.</li>
<li>If it shows "connection refused", then you have the ssh client correctly working but no server running on your own machine. This is not a problem, as we're trying to log in to the lab machines, so we need a client on our machine and a server on the lab machine.</li>
<li>If it shows an error that ssh is not found, then you don't have (Open)SSH installed which is very unusual except on windows CMD - in which case please switch to using the windows subsystem for linux.</li>
</ul>
</li>
</ul>
<h2 id="connect-to-the-lab"><a class="header" href="#connect-to-the-lab">Connect to the lab</a></h2>
<p>The lab machines have names <code>it######.wks.bris.ac.uk</code> where the hashes represent a number from 075637 up to 075912. However, not all of them will be working at any one time, if everyone connects to the same machine then it will quickly get overloaded, and for security reasons the lab machines are not directly accessible from the internet. Instead, we will use two other machines to connect:</p>
<ul>
<li>The bastion host <code>seis.bris.ac.uk</code>. This is reachable over SSH from the internet, and is on a university network that lets you connect further to the lab machines. You should not attempt to do any work on seis itself, as most of the software you would like to use (like compilers) is not installed there. However, you do have a home directory on seis for storing things like SSH keys.</li>
<li>The load balancer <code>rd-mvb-linuxlab.bristol.ac.uk</code>. This connects you to a lab machine that is currently running and ensures that if everyone uses this method to connect, then they will be more or less equally distributed among the running machines.</li>
</ul>
<p>Try the following:</p>
<ul>
<li>On your terminal, type <code>ssh USERNAME@seis.bris.ac.uk</code> where you replace USERNAME with your university username, e.g. <code>aa20123</code>. Obviously, you will need a working internet connection for this.</li>
<li>If it asks you whether you are sure, type <code>yes</code> and press ENTER. SSH will only do this the first time you connect to a machine that you have never used before.</li>
<li>When prompted, enter your university password and press ENTER.</li>
<li>You should now see the prompt on seis, which looks something like <code>-bash-4.2$</code>. Try the command <code>uname -a</code> to print information about the system (uname on its own prints the operating system name, <code>-a</code> shows "all" information). The reply line should start <code>Linux seis-shell</code>, which is the operating system and host name.</li>
<li>On the seis prompt, type <code>ssh rd-mvb-linuxlab.bristol.ac.uk</code>. This might take a few seconds; say yes if it asks you if you're sure, then enter your password again when prompted. We didn't have to give a username again because you are already logged in to seis with your university username (<code>whoami</code> shows this) and when you ssh without giving a username, it uses the one you are currently logged in as.</li>
<li>You should now be connected to a lab machine, with a prompt of the form <code>USERNAME@it######:~$</code>.</li>
<li>Try <code>whoami</code> and <code>uname -a</code> to check who you are logged in as, and where; also try <code>hostname</code> which just prints the machine name.</li>
<li>Type <code>exit</code> twice to get back to your own machine. (Once gets you back to seis, twice closes the ssh connection completely.)</li>
</ul>
<p>Connecting to one machine through another machine (in this case seis) as a proxy is such a common use case that ssh in fact has an option for it. Note however that this will not normally work from a windows CMD terminal, although it does work on Windows Subsystem for Linux (and on Mac and Linux).</p>
<pre><code>ssh -J USERNAME@seis.bris.ac.uk USERNAME@rd-mvb-linuxlab.bristol.ac.uk
</code></pre>
<p>The <code>-J</code> for "jump through this host" even accepts a comma-separated list of hosts if you need to connect through more than one. However, you need to repeat your username for every machine.</p>
<p>You now know how to log in to a lab machine, but in both methods you had to type your password twice - let's make that easier. The answer is not to store your password in a file, but to use keys instead.</p>
<h2 id="setting-up-ssh-keys"><a class="header" href="#setting-up-ssh-keys">Setting up ssh keys</a></h2>
<p>When you connect to a machine, the client on your computer and the daemon on the machine you're logging in to run a cryptographic protocol to exchange keys and set up a shared secret key for the session, so that what one side encrypts the other side can decrypt again. It also authenticates you to the server using one of several methods.</p>
<p>You might have heard from a security source that there are three main authentication factors: something you know (password or PIN), something you have (physical key, digital key, ID card, passport) and something you are (biometrics). An authentication method that requires two of these is called two-factor authentication and this is considered good security practice. For ssh, this means:</p>
<ul>
<li>You can log in with a username and password, that is "something you know". This is the default, but not the most secure.</li>
<li>You can log in with a (digital) key, that is "something you have". This is more secure, as long as your key (which is just a file) doesn't get into the wrong hands, and also the most convenient as you can log into a lab machine or copy files without having to type your password.</li>
<li>You can log in with a key file that is itself protected with a password. This gets you two-factor authentication.</li>
</ul>
<p>The keys that SSH uses implement digital signatures. Each key comes as a pair of files:</p>
<ul>
<li>A private key (also known as secret key) in a file normally named <code>id_CIPHER</code> where CIPHER is the cipher in use. You need to keep this secure and only store it in places that only you have access to.</li>
<li>A public key in a file normally named <code>id_CIPHER.pub</code>. You can share this with the world, and you will need to store a copy of it on any machine or with any service that you want to log in to (for the lab, because the lab machines all share a file system, you only need to store it once - but seis has a separate file system so you need a separate copy there).</li>
</ul>
<p>Let's create a key pair:</p>
<ul>
<li>On your own machine, make sure you are not connected to a lab machine or seis, then type the command <code>ssh-keygen -t ed25519</code>. (If you get an "unknown key type" error, then you are using an outdated version of OpenSSH and for security reasons you should upgrade immediately.) <em>Note: type <code>ed25519</code> directly, do not replace this with your username. It stands for the "Edwards curve over the prime <code>2^255-19</code>" cryptographic group, if you want to know.</em></li>
<li>When it asks you where to save the file, just press ENTER to accept the default, but make a note of the path - normally it's a folder <code>.ssh</code> in your home directory.</li>
<li>If it asks you "Overwrite (y/n)", say no (n, then ENTER) as it means you already have a key for something else - either ssh directly or something that uses it, like github. Restart key generation but pick a different file name.</li>
<li>When it asks you for a password, we recommend that you just press ENTER which doesn't set a password (good security, maximum convenience). If you do set a password, it will ask you to type it twice and then you will need the password and the key file to use this key (maximum security, less convenient).</li>
</ul>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>The <code>-t</code> parameter selects the cryptographic algorithm to use, in this case <code>ed25519</code>, which is modern, peer-reviewed, and generally considered one of the most secure public-key algorithms available. However some older ssh versions don't accept ed25519.</p>
<p>If you ever need to use SSH keys to a machine that doesn't like ed25519, then use the key type "rsa" instead. We would recommend you avoid the alternatives "dsa" and "ecdsa" if at all possible as there is speculation among cryptographers that there may be a flaw in the design.</p>
<p>For example, although seis supports ed25519, the old cs bastion host <code>snowy.cs.bris.ac.uk</code> still uses an older version of SSH, so you would need to generate a rsa key to connect to that.</p>
</div>
</div>
<p>Have a look at the folder where your keys are stored. <code>ls -l ~/.ssh</code> will do this, unless you chose somewhere else to store them when you created them:</p>
<pre><code>-rw-------. 1 vagrant vagrant  411 Oct  7 10:50 id_ed25519
-rw-r--r--. 1 vagrant vagrant   98 Oct  7 10:50 id_ed25519.pub
-rw-r--r--. 1 vagrant vagrant 1597 Oct  7 11:54 known_hosts
</code></pre>
<p>Note the permissions on these files in my example. The private key (first line) has a permissions line at the start of <code>(-)(rw-)(---)(---)</code> where I've added brackets to make clearer what is going on. The first bracket only applies to special file types (e.g. <code>d</code> for directory). Next, the owner permissions which are in this case read and write (the third one would be <code>x</code> if the file were an executable program). The last two brackets are the permissions for the group and for everyone else, and these are all off so no-one except yourself (and root) can read your key file. OpenSSH is picky about this and will refuse to use a private key that other people have access to.</p>
<p>The public key permissions are <code>(-)(rw-)(r--)(r--)</code> which means that the owner can read and write, and the group and everyone else (assuming they have access to the folder) can read the public key, which is fine. It's a public key after all.</p>
<p><code>known_hosts</code> is where SSH stores the public keys of computers you've already connected to: every time you answer yes to an "Are you sure you want to connect?" question when you connect to a new computer for the first time, it stores the result in this file and won't ask you again the next time. The file format is one key per line and you can edit the file yourself if you want to.</p>
<h2 id="set-up-key-access-on-seis"><a class="header" href="#set-up-key-access-on-seis">Set up key access on SEIS</a></h2>
<p>First, we need to upload our public key to the <code>~/.ssh</code> directory on seis. Even before this, we need to make sure the directory exists though:</p>
<ul>
<li>Log in to seis with ssh and your password.</li>
<li>Try <code>ls -al ~/.ssh</code>. If it complains the folder doesn't exist, create it with <code>mkdir ~/.ssh</code>.</li>
<li>Log out of seis again with <code>exit</code>.</li>
</ul>
<p>The command for copying a file is <code>scp</code> for secure copy, which works like <code>cp</code> but allows you to include remote hosts and does the copy over SSH. Run this from your own machine:</p>
<pre><code>scp ~/.ssh/id_ed25519.pub "USERNAME@seis.bris.ac.uk:~/.ssh/"
</code></pre>
<p>Obviously, replace USERNAME with your university username. This will ask for your password again. Note two things here: first, to set up access on seis, we are uploading the public key - not the private key! - and secondly, that we put double quotes around the destination. This is because the <code>~</code> character meaning home directory is handled by our shell, but we don't want our local shell to expand it, instead we want the shell on seis launched by scp to expand it to our home directory on that machine.</p>
<p>The general syntax of scp is <code>scp source destination</code> and source or destination  may be of the form <code>[USERNAME@]HOSTNAME:PATH</code> - if it contains a colon (<code>:</code>), then it refers to a file on a different machine.</p>
<p>Now log in to seis over ssh and type your password one last time. Then run the following:</p>
<pre><code>cd .ssh
cat id_ed25519.pub &gt;&gt; authorized_keys
chmod 600 authorized_keys
</code></pre>
<p>SSH will accept a public key if it is listed in the file <code>authorized_keys</code> in the user's <code>.ssh</code> folder, the format is one line per key. Instead of just copying <code>id_ed25519.pub</code> to <code>authorized_keys</code>, which would overwrite the latter file if it already existed, we use the construction <code>cat SOURCE &gt;&gt; DEST</code> to have our shell append the source file to the destination. <em>Note: it's <strong>authorized</strong>, the American spelling -- if you use the British spelling here OpenSSH won't know to read that file.</em></p>
<p>However, if the authorised keys file didn't exist already, then it has now been created with default permissions and SSH won't accept that for security reasons. <code>chmod</code> means change permissions (also known as "mod bits") and 600 is the bit pattern we want in base 8, because that is how permissions work for historical reasons. Permissions are a bitfield of 9 bits, the first three are read/write/execute for the owner, the next three the same for the group, and then for everyone else. If you <code>ls -l</code> you will see this in a slightly more human-readable format, namely <code>rw-------</code> where a minus means that a bit is turned off.</p>
<p>Now type <code>exit</code> to get back to your own machine, and then <code>ssh USERNAME@seis.bris.ac.uk</code> to log back in to seis. It should log you in without asking for a password, and you have now set up key-based SSH authentication for seis.</p>
<p><em>Note: if you set a password on your SSH key earlier, then it will ask you for a password, and it will expect the key password not your uni password. You know not to ever reuse your uni password for anything else, right?</em></p>
<p>If for some reason something doesn't work with ssh, the first thing to try is to add the <code>-v</code> switch enable debugging information (you can even do <code>-vv</code> or <code>-vvv</code> to see even more detail, but we don't need that). If there is a problem with the permissions on your private key file for example, then you will see SSH complain in the debugging information.</p>
<h2 id="setting-up-keys-for-lab-machines"><a class="header" href="#setting-up-keys-for-lab-machines">Setting up keys for lab machines</a></h2>
<p>You can now get into seis with a key, but you want to be on a lab machine to get work done.</p>
<p>To connect from your machine to seis, you need a private key on your machine and a public key on seis. To connect from seis to a lab machine, it would seem like you need a public key on the lab machine and a private key on seis. You do not want to upload your private key to seis though for security reasons, so instead we are going to use a SSH feature called <em>agent forwarding</em> which means that if you SSH into one machine, then when you try and SSH further into another machine SSH will reuse the same key. The way to do this is to use the <code>-A</code> command line flag.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>The point of key-based authentication is that your private key never leaves your own machine, so even university administrators never get to see it, which would not be guaranteed if you stored a copy on a university machine.</p>
<p>Logging in to a machine does not send the key to that machine. Instead, the machine sends you a challenge - a long random number - and SSH digitally signs that with the private key on your own machine, and sends the signature back which the remote machine can verify with the public key. Seeing a signature like this does not let the machine create further signatures on your behalf, and it definitely does not reveal the key.</p>
<p>What agent forwarding does is it allows challenges and signatures to be forwarded across multiple connections, but the key never leaves your own machine.</p>
<p>This way, you can create one SSH key and use it for university, github and anything else that you access over SSH, and even if one service is breached then this does not give the attacker access to your accounts on the other services.</p>
</div>
</div>
<ul>
<li>Log in to seis with <code>ssh USERNAME@seis.bris.ac.uk</code>. You should not need a password anymore.</li>
<li>Log in to the lab machines with <code>ssh rd-mvb-linuxlab.bristol.ac.uk</code> and enter your password. Check that the <code>~/.ssh</code> folder exists and create it if it doesn't, as you did before on seis, then <code>exit</code> again to seis.</li>
<li>Copy your public key file from seis to the lab machines with <code>scp ~/.ssh/id_ed25519.pub "rd-mvb-linuxlab.bristol.ac.uk:~/.ssh/"</code>. This will ask for your password again.</li>
<li>Log in to a lab machine with <code>ssh rd-mvb-linuxlab.bristol.ac.uk</code> and enter your password one last time. On the lab machine, install the public key with the following:</li>
</ul>
<pre><code>cd .ssh
cat id_ed25519.pub &gt;&gt; authorized_keys
chmod 600 authorized_keys
</code></pre>
<ul>
<li>Log out of the lab machine and seis again by typing <code>exit</code> twice.</li>
</ul>
<p>The steps above were necessary because your home directory on seis is not the same as on the lab machines. However, your home directory is the same across all lab machines, so you don't need to install the key on each one separately. You might have noticed that when copying or <code>ssh</code>-ing from seis to the lab machines, you don't have to repeat your username: this is because it is the same on all these machines.</p>
<p>From now on, from you own machine, you should be able to get directly into a lab machine with the following command, which should not ask for your password at all:</p>
<pre><code>ssh -A -J USERNAME@seis.bris.ac.uk USERNAME@rd-mvb-linuxlab.bristol.ac.uk
</code></pre>
<p><em>Unfortunately, <code>-J</code> will not work on a windows CMD terminal, although it should work on Windows Subsystem for Linux. Once we have set up a configuration file, there will be a way to work around this problem. Mac and Linux users should be fine though, as should anyone running these commands from a Linux VM on their own machine, whatever their host OS.</em></p>
<h2 id="setting-up-a-configuration-file"><a class="header" href="#setting-up-a-configuration-file">Setting up a configuration file</a></h2>
<p>You now have a log in command that works, but you still have to type a lot, and you need to type your username twice. We can improve this by using a configuration file.</p>
<p>SSH reads two configuration files: one for all users at <code>/etc/ssh/ssh_config</code> (<code>/etc</code> is where POSIX programs typically store global settings) and a per-user one at <code>~/.ssh/config</code>. The site <a href="https://www.ssh.com/ssh/config/">https://www.ssh.com/ssh/config/</a> or just <code>man ssh_config | less</code> on a terminal contain the documentation (<code>man</code> means manual page, and <code>less</code> is a program that shows a file on page at a time and lets you scroll and search).</p>
<p>Create a file called simply <code>config</code> in your <code>.ssh</code> directory on your own machine. You can do this for example with <code>touch config</code> (make sure you're in the <code>.ssh</code> directory first, <code>cd ~/.ssh</code> gets you there), and then editing it in your favourite text editor. Add the following lines, replacing USERNAME with your username twice:</p>
<pre><code>Host seis
  HostName seis.bris.ac.uk
  User USERNAME

Host lab
  HostName rd-mvb-linuxlab.bristol.ac.uk
  ProxyJump seis
  User USERNAME
</code></pre>
<p>This now lets you use simply <code>ssh lab</code> to log in to a lab machine via seis (agent forwarding is implied when you use <code>ProxyJump</code>), or <code>ssh seis</code> if you want to access seis directly for example to update your keys there.</p>
<ul>
<li>Try <code>ssh lab</code> from your own machine. This will be your main way to log in to a lab machine from now onwards.</li>
</ul>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>If you want to learn another useful skill as you go along, here is one way to edit files on the command line. Many linux distributions have an editor called <code>nano</code> built in which runs in the terminal, so <code>nano config</code> edits the file called config (creating it if it doesn't exist, when you save for the first time). It is fairly self-explanatory, the command Control+X quits as you can see on the command bar at the bottom of the screen in nano and if you quit with unsaved changes, it will ask you if you want to save.</p>
<p>Nano is installed on SEIS and on the lab machines, and within the Debian distro you will install in Vagrant, so you can use it to edit a file remotely.</p>
<p>And something for Windows users:</p>
<p>If you are on Windows and are using OpenSSH through a CMD terminal, a bug in OpenSSH prevents the <code>-J</code> option from working. However, you can write your file like this instead:</p>
<pre><code># ~/.ssh/config file for WINDOWS CMD users only

Host seis
  HostName seis.bris.ac.uk
  User USERNAME

Host lab
  HostName rd-mvb-linuxlab.bristol.ac.uk
  ProxyCommand ssh.exe -W %h:%p seis
  User USERNAME
</code></pre>
<p>This should get <code>ssh lab</code> to work for you as well.</p>
</div>
</div>
<h2 id="using-different-keys"><a class="header" href="#using-different-keys">Using different keys</a></h2>
<p>You do not need this for the lab, but if you are ever managing different systems and accounts then you might use a different key file for each one. In this case, ssh on the command line lets you do <code>-i FILENAME</code> to select a private key file, and in the configuration file you can select a file for a particular host with the <code>IdentityFile FILENAME</code> line. By default, ssh will search for files in <code>.ssh</code> with names <code>id_CIPHER</code>, as you can see if you launch a connection with the <code>-vv</code> parameter which shows detailed debugging information.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installing-vagrant-and-debian"><a class="header" href="#installing-vagrant-and-debian">Installing Vagrant and Debian</a></h1>
<p><a href="https://www.vagrantup.com/">Vagrant</a> is a program to manage virtual machines (VMs). Based on a configuration file called a <code>Vagrantfile</code>, it can download and configure disk images, which it calles boxes, and call other programs to run them. Vagrant does not run the VM by itself, so you will need another program like <a href="https://www.virtualbox.org/">virtualbox</a> for that.</p>
<h2 id="installing-on-your-own-machine"><a class="header" href="#installing-on-your-own-machine">Installing on your own machine</a></h2>
<p>To use vagrant on your own machine (recommended), follow these steps:</p>
<ul>
<li>Go to <a href="https://www.vagrantup.com/downloads">https://www.vagrantup.com/downloads</a> and download the version of vagrant for your operating system. Windows, Mac OS and common versions of Linux are supported.</li>
<li>Download and install Virtualbox from <a href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a>.</li>
<li>Reboot your machine.</li>
</ul>
<p>If you are on Linux, you can of course also install the programs from your distribution's repository. Vagrant's developers actually recommend against this because they claim that some distributions package outdated versions, but it is your choice.</p>
<h2 id="configuring-a-box"><a class="header" href="#configuring-a-box">Configuring a box</a></h2>
<p>Next, you are going to configure a virtual machine using <a href="https://www.debian.org/">Debian linux</a>, a Linux distribution that we will be using in this unit.</p>
<ul>
<li>Create an empty folder somewhere.</li>
<li>In that folder, create a file called Vagrantfile (capitalised, and with no extension) and add the following lines to it - or just download the file from <a href="posix1/../resources/Vagrantfile">here</a>:</li>
</ul>
<pre><code class="language-ruby">Vagrant.configure("2") do |config|
  config.vm.box = "generic/debian12"
  config.vm.synced_folder ".", "/vagrant"

  config.vm.provision "shell", inline: &lt;&lt;-SHELL
    echo "Post-provision installs go here"
  SHELL
end
</code></pre>
<p>This configuration file is actually a script in the ruby programming language, but you don't need to learn that to use vagrant. Let's look at what it does.</p>
<ul>
<li><code>config.vm.box</code> selects the virtual machine image, or box in vagrant-speak, to use. You can see a list of available ones at <a href="https://app.vagrantup.com/boxes/search">https://app.vagrantup.com/boxes/search</a>.</li>
<li><code>config.vm.synced_folder</code> sets up a shared folder between the guest (virtual machine) and host (your machine).</li>
<li>The <code>config.vm.provision</code> runs a provisioning command when the box is first downloaded and installed. These commands run as root on the virtual machine, and in this case we are using the <code>apt</code> package manager (we will talk about this later on) to install the packages <code>git</code>.</li>
<li>The <code>&lt;&lt;-SHELL</code> construction is called a "here document", and is a way in some programming languages of writing multi-line strings. It tells ruby to treat everything until the closing keyword SHELL (which is arbitrary) as a string, which can contain several lines.</li>
</ul>
<h2 id="running-vagrant"><a class="header" href="#running-vagrant">Running vagrant</a></h2>
<ul>
<li>Open a terminal in the folder containing the Vagrantfile. If you are on windows, both the windows CMD and the windows subsystem for linux terminal will work equally well for this purpose.</li>
<li>Run the command <code>vagrant up</code>. This starts the virtual machine configured in the current folder, and if it has not been downloaded and provisioned yet (as is the case when you run <code>up</code> for the first time) then it does this for you as well.</li>
<li>When vagrant tells you the machine is running, run <code>vagrant ssh</code> to log in to your virtual machine. If it asks you for a password, use <code>vagrant</code>.</li>
<li>You should now see the virtual machine prompt <code>vagrant@debian12:~$</code>. Try the command <code>ls /</code> and check that there is a folder called vagrant in the top-level folder, along with system ones with names like <code>usr</code> and <code>bin</code>.</li>
</ul>
<p>There are two kinds of errors you might get during <code>vagrant up</code>:</p>
<ul>
<li>If vagrant complains that it can't find a provider, then you have probably not installed virtualbox, or not rebooted since installing it.</li>
<li>If you get some odd crash or error message about hypervisors, see the page <a href="https://www.vagrantup.com/docs/installation">https://www.vagrantup.com/docs/installation</a> for instructions, section <em>Running Multiple Hypervisors</em>. Basically, you cannot run vagrant when another program is already using your processor's virtualisation subsystem, and the page gives instructions how to turn off the other one.</li>
</ul>
<h2 id="shutting-down-cleanly"><a class="header" href="#shutting-down-cleanly">Shutting down cleanly</a></h2>
<p>To exit the virtual machine, type <code>exit</code> which will get you back to the shell on the host machine. On the host, <code>vagrant halt</code> cleanly shuts down the virtual machine.</p>
<p>Promise yourself that you will always do this before turning off your computer, if you have been using Vagrant!</p>
<h2 id="running-on-a-lab-machine"><a class="header" href="#running-on-a-lab-machine">Running on a lab machine</a></h2>
<p>Vagrant is already installed on the lab machines in MVB 2.11, so you can remotely log in and launch a box from there. This will get you exactly the same Debian environment as when you run it on your own machine, and everyone should try this out too. If for some reason you cannot run Vagrant on your machine, then as long as you have an internet connection you should still be able to run it on the lab machines.</p>
<p>First, we connect to a lab machine: open a terminal and run the command <code>ssh lab</code> that you configured in the previous exercise on SSH.</p>
<p>On the lab machine, we need to create a folder and load a Vagrantfile as above, but let's download the Vagrantfile from the unit webpage instead of typing it out. Run the following shell commands (the third one starting <code>wget</code> must be all on one line, even if your web browser has added a line break):</p>
<pre><code class="language-sh">mkdir softwaretools
cd softwaretools
wget https://raw.githubusercontent.com/cs-uob/COMSM0085/master/exercises/part1/src/resources/Vagrantfile
</code></pre>
<p>You can call the top folder (softwaretools) anything you like and put it anywhere you want. You can now run <code>vagrant up</code> followed by <code>vagrant ssh</code> from inside that folder.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>When you <code>vagrant up</code>, vagrant internally connects port 22 on the guest (which <code>sshd</code> on the guest is listening to) to port 2222 on the host. When you provision a vagrant machine, this creates a key pair on the host and loads the public key into the guest. The private key is actually in the file <code>.vagrant/machines/default/virtualbox/private_key</code> on the host, and the public key in <code>/home/vagrant/.ssh/authorized_keys</code> on the guest. So what <code>vagrant ssh</code> does is launch <code>ssh -i KEYFILE vagrant@localhost -p 2222</code>.</p>
</div>
</div>
<h2 id="warning-about-lab-machines---read-carefully"><a class="header" href="#warning-about-lab-machines---read-carefully">Warning about lab machines - read carefully!</a></h2>
<p>Your files in your home directory on a lab machine are stored in a network folder, so that you see the same files whichever lab machine you log in to; they are also automatically backed up.</p>
<p>If lots of students created lots of VMs in their home folders, this would take up lots of space, and it would be slow: running an operating system over a network share causes both bandwidth and latency problems.</p>
<p>Instead, IT has configured vagrant on the lab machines to store VMs in the <code>/tmp</code> folder which is local to each machine. This means that:</p>
<ul>
<li>If you log in to a different lab machine, your VMs will be gone.</li>
<li>If you log in to the same lab machine but it has restarted since you last logged in, your VMs will be gone.</li>
<li>Your VMs, and with them any files you store in the VM itself, are not backed up.</li>
</ul>
<p>This is not as much a problem as it seems because this is how virtual machines are meant to work: if one is not available, vagrant downloads and provisions it. For this reason, for any software you want installed on your VMs in the lab machines, you should write the install command into the provisioning script in the Vagrantfile so it will be re-installed the next time Vagrant has to set up the VM. We will learn how to do this soon.</p>
<p>However, this still leaves files that you create on the VM itself, such as the ones you will create for the exercises in this unit. The basic warning is that <em>any files in your home directory will be lost when the VM is rebuilt</em>. That is why we have set up a shared folder which you can access as <code>/vagrant</code> on the VM, which maps to the folder containing your Vagrantfile on the host machine. Because this is stored under your home folder on the lab machine, it lives on the network file store and so it is backed up and available from all lab machines.</p>
<p>So whenever you log in to a VM on a lab machine to do some work, you should <code>cd /vagrant</code> and use that instead of your home folder for any files that you don't want to lose. If you are running vagrant on your own computer, then nothing in the VM will be deleted unless you give Vagrant a command to destroy or rebuild the VM yourself.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="debian-system-administration"><a class="header" href="#debian-system-administration">Debian system administration</a></h1>
<p>Start your Debian box if necessary by going to the folder with the <code>Vagrantfile</code> in your terminal, and typing <code>vagrant up</code>. Log in to your Debian box with <code>vagrant ssh</code>. We are going to get to know Linux in general and Debian in particular a bit.</p>
<h2 id="the-file-system"><a class="header" href="#the-file-system">The file system</a></h2>
<p>Linux (and other POSIX-like operating systems) work with a single file hierarchy with a root folder <code>/</code>, although there may be different file systems mounted at different places under that. How files are organised in here are documented in the <a href="https://refspecs.linuxfoundation.org/FHS_3.0/fhs-3.0.html">Filesystem Hierarchy Standard (FHS)</a>. Have a look with the command <code>ls /</code>:</p>
<p><code>/bin</code> stands for binaries, that is programs that you can run. Have a look with <code>ls /bin</code>: there will be a lot of commands in here, including ls itself. Indeed you can find out where a program is with <code>which</code>, so <code>which ls</code> will show you <code>/usr/bin/ls</code> for example.</p>
<p><code>/usr</code> is a historical accident and a bit of a mess. A short history is on <a href="https://askubuntu.com/questions/130186/what-is-the-rationale-for-the-usr-directory">this stackexchange question</a> but essentially, in the earliest days,</p>
<ul>
<li><code>/bin</code> was only for binaries needed to start the system - or at least the most important binaries that needed to live on the faster of several disk drives, like your shell.</li>
<li><code>/usr/bin</code> was where most binaries lived which were available globally, for example across all machines in an organisation.</li>
<li><code>/usr/local/bin</code> was for binaries installed by a local administrator, for example for a department within an organisation.</li>
</ul>
<p>In any case, <code>/usr</code> and its subfolders are for normally read-only data, such as programs and configuration files but not temporary data or log files. It contains subfolders like <code>/usr/bin</code> or <code>/usr/lib</code> that duplicate folders in the root directory. Debian's way of cleaning this mess up is to make its <code>/bin</code> just a link to <code>/usr/bin</code> and putting everything in there, but in some distributions there are real differences between the folders.</p>
<p>If you have colours turned on (which is the default) you will see some files are green, but others are blue - this indicates the file type, green is an executable program, blue is a link to another file. Have a look with <code>ls -l /bin</code>: the very first character of each line indicates the file type, the main ones being <code>-</code> for normal file, <code>d</code> for directory and <code>l</code> for a so-called <em>soft link</em>. You can see where each link links to at the end of this listing. For example, <code>slogin</code> links to <code>ssh</code>. Other links point at files stored elsewhere in the filesystem -- you'll see a lot of references to <code>/etc/alternatives/</code>.</p>
<p><code>/etc</code> stores system-wide configuration files and typically only root (the administrator account) can change things in here. For example, system-wide SSH configuration lives in <code>/etc/ssh</code>.</p>
<p><code>/lib</code> contains dynamic libraries - windows calls these <code>.dll</code> files, POSIX uses <code>.so</code>. For example, <code>/lib/x86_64-linux-gnu/libc.so.6</code> is the C library, which allows C programs to use functions like <code>printf</code>.</p>
<p><code>/home</code> is the folder containing users' home directories, for example the default user vagrant gets <code>/home/vagrant</code>. The exception is root, the administrator account, who gets <code>/root</code>.</p>
<p><code>/sbin</code> (system binaries) is another collection of programs, typically ones that only system administrators will use. For example, <code>fdisk</code> creates or deletes partitions on a disk and lots of programs with <code>fs</code> in their name deal with managing file systems. <code>/sbin/halt</code>, run as root (or another user that you have allowed to do this), shuts down the system; there is also <code>/sbin/reboot</code>.</p>
<p><code>/tmp</code> is a temporary filesystem that may be stored in RAM instead of on disk (but swapped out if necessary), and that does not have to survive rebooting the machine.</p>
<p><code>/var</code> holds files that vary over time, such as logs or caches.</p>
<p><code>/dev</code>, <code>/sys</code> and <code>/proc</code> are virtual file systems. One of the UNIX design principles is that almost every interaction with the operating system should look to a program like reading and writing a file, or in short <em>everything is a file</em>. For example, <code>/dev</code> offers an interface to devices such as hard disks (<code>/dev/sda</code> is the first SCSI disk in the system, and <code>/dev/sda1</code> the first partition on that), memory (<code>/dev/mem</code>), and a number of pseudoterminals or ttys that we will talk about later. <code>/proc</code> provides access to running processes; <code>/sys</code> provides access to system functions. For example, on some laptop systems, writing to <code>/sys/class/backlight/acpi_video0/brightness</code> changes the screen brightness.</p>
<p>The <code>/vagrant</code> folder is not part of the FHS, but is our convention for a shared folder with the host on Vagrant virtual machines.</p>
<h2 id="package-managers"><a class="header" href="#package-managers">Package managers</a></h2>
<p>Linux has had package managers and repositories since the days when it was distributed on floppy disks. A repository is a collection of software that you can install, and can be hosted anywhere - floppy disk, CD-ROM, DVD or nowadays on the internet. A package manager is software that installs packages from a repository - so far, this sounds just like an <em>app store</em> but a package manager can do more. For one thing, you can ask to install different versions of a particular package if you need to. But the main point of a package manager is that packages can have dependencies on other packages, and when you install one then it installs the dependencies automatically.</p>
<p>To illustrate this, we're going to go on a tour of one kind of software with which you'll want to get very familiar: text editors that work in the console. Text editing is fundamental to a lot of system administration tasks as well as programming, and people often find that a familiar editor becomes a favourite tool.</p>
<p>Two console-based text editors are already installed in Debian: <code>nano</code> and <code>vim</code>.</p>
<p><code>nano</code> is a basic text editor that works in the console, and is installed in most Linux distributions including the ones on seis and the lab machines, so you can use it to edit files remotely.  You can type <code>nano FILENAME</code> to edit a file. The keyboard shortcuts are at the bottom of the screen, the main one you need is Control+X to exit (it will ask if you want to save, if you have unsaved changes). Nano is considered fairly friendly as console editors go.</p>
<p><code>vim</code> is the 1991 improved version of the even older (1976) <code>vi</code> editor (which is also installed). It is a modal editor with a steep learning curve, but its extremely powerful editing grammar and widespread availability mean it regularly appears towards the top of lists of favourite text editors. If you want to get started with vim, I suggest you start by typing <code>vimtutor</code> at the commandline -- this opens vim with a file that guides you through basic vim usage.</p>
<p>Another console-based editor dating from the mid-70s is <code>emacs</code>, <code>vi</code>'s traditional Lisp-based rival. However, emacs is not installed by default: type <code>emacs</code> at the console and you will get <code>emacs: command not found</code>. You can install it with the command</p>
<pre><code>sudo apt install emacs-nox
</code></pre>
<ul>
<li><code>sudo</code> (superuser do) allows you to run a command as root, also known as the administrator or superuser. Depending on how your system is configured, this might be not allowed at all (you can't do it on the lab machines), or require a password, but on the Vagrant box you're using you are allowed to do this. It is good practice to use sudo for system adminstration instead of logging in as root directly, but if you ever really need a root shell then <code>sudo bash</code> gets you one - with <code>#</code> instead of <code>$</code> as prompt to warn you that you are working as root.</li>
<li><code>apt</code> is the Debian package manager.</li>
<li><code>install PACKAGE</code> adds a package, which means download and install it and all its dependencies (you'll see a list of these to confirm you want to install them -- you do).</li>
</ul>
<p>We're installing <code>emacs-nox</code> because this is the version of emacs packaged for use from the console. If you tried to install just <code>emacs</code> then the package manager would identify that you need a graphical display manager to run emacs' GUI mode and install a lot more dependencies to enable that, which we don't need.</p>
<p>Now that emacs is installed, you can launch it with <code>emacs</code>, and from there you should see some introductory instructions, including how to access an emacs tutorial which will teach you how to use it. (If you want to exit emacs, Control-X followed by Control-C should do it).</p>
<p>Other popular editors include</p>
<ul>
<li><code>mcedit</code>, a file editor which comes as part of the 'midnight commander' package, which you can install with <code>sudo apt install mc</code>. Launch the editor with <code>mcedit filename</code> and test it out (Alt-0 to exit).</li>
<li><code>tilde</code>, an editor with a GUI-esque menu system controlled through Alt-letter sequences. Install with <code>sudo apt install tilde</code>.</li>
<li><code>micro</code>, a simple editor somewhat like an advanced version of <code>nano</code>. Install with <code>sudo apt install micro</code>.</li>
</ul>
<p>You can also find out information about packages with <code>apt info PACKAGE</code> -- try this for one of the above.</p>
<p>I suggest that you try out some of these editors, and figure out how you prefer to edit files. Some of these tools might require time investment to learn, but doing this early in your CS career could be a good decision.</p>
<p>Whichever editor you end up deciding to use, you probably won't need to keep all the alternatives installed. You can leave <code>nano</code> and <code>vim</code> installed, but for the other editors you've tried out above and decided you don't like, you can (and should) remove them from the system with <code>sudo apt remove PACKAGE</code>.</p>
<h2 id="update-and-upgrade"><a class="header" href="#update-and-upgrade">Update and upgrade</a></h2>
<p>The repositories that you are using are recorded in <code>/etc/apt/sources.list</code>, have a look at this file with <code>cat</code> or <code>nano</code> to see where they are, then look up the sites in your browser. There are folders for different Debian versions and package index files for different architectures.</p>
<p>Two commands a system adminstrator should run regularly for security reasons:</p>
<ul>
<li><code>sudo apt update</code> fetches the new package list from the repository. This way, apt can tell you if any packages have been updated to new versions since you last checked.</li>
<li><code>sudo apt upgrade</code> upgrades every package that you already have installed to the latest version in your local package list (downloaded when you do an <code>apt update</code>).</li>
</ul>
<h2 id="lab-machines"><a class="header" href="#lab-machines">Lab machines</a></h2>
<p>If you are running a virtual machine on the lab machines, then your virtual machine might not be around after the lab machine reboots or you log out and in again and end up on a different machine - as the notice when you log in tells you, the virtual machines are stored under <code>/tmp</code>.</p>
<p>It would be annoying to have to reinstall your favourite packages (like your chosen text editor) every time you log in to a different machine, so you should put them in your Vagrantfile and then <code>vagrant up</code> will do this for you automatically. The Vagrantfile already contains a line <code>echo</code>, you can put an <code>apt install PACKAGE</code> line below this, and can list as many packages as you like. There is no <code>sudo</code> here because when Vagrant is installing the system, it is running as root automatically.</p>
<ul>
<li>Unless it is <code>nano</code> or <code>vim</code>, add the package for your favourite text editor to this line so next time you rebuild the Vagrant machine, they are added automatically.</li>
<li>Log out of your vagrant machine and do a <code>vagrant destroy</code> which removes the virtual machine. Then reload with <code>vagrant up</code> which will download and provision the box again.</li>
<li>Log in with <code>vagrant ssh</code> and check that the editor is installed.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-posix-shell"><a class="header" href="#the-posix-shell">The POSIX Shell</a></h1>
<h2 id="videos-1"><a class="header" href="#videos-1">Videos</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/a55ff501-9e8d-4bb3-a00e-b680596b2de3">The shell</a></td><td style="text-align: right">30 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EbOfjsNY9SJAkEXbMb9WorcBAQMW0QuKthcQHRBDvru8eg?e=HWh7D1">slides</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/7b2657a6-a2d4-4c34-a642-da993d468851">Pipes 1</a></td><td style="text-align: right">20 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EdOsJY_EYlRIveTotkGszNoBWeGx5efiVPJPhhbiQfydTQ?e=RHGVol">slides</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/d04fb18c-533b-4ffe-b8a1-f4d46e9b73d1">Pipes 2</a></td><td style="text-align: right">30 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EfGZcNx_ttNCsx8vpo2uZqIBERTzvUzap84BdzMfxLRuQw?e=Ty9yjZ">slides</a></td></tr>
</tbody></table>
</div>
<h2 id="exercises-1"><a class="header" href="#exercises-1">Exercises</a></h2>
<ul>
<li><a href="posix2/./shell.html">Shell expansion</a></li>
<li><a href="posix2/./pipes.html">Pipes</a></li>
<li><a href="posix2/./regex.html">Regular expressions</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="shell-expansion"><a class="header" href="#shell-expansion">Shell expansion</a></h1>
<p>This exercise is about studying shell expansion. You should run it on your Debian VM in Vagrant.</p>
<p>Create a C program <code>arguments.c</code> with the following contents. You can use <code>nano arguments.c</code> for this, for example.</p>
<pre><code class="language-C">#include &lt;stdio.h&gt;

int main(int argc, char** argv) {
  for(int i=0; i &lt; argc; i++) {
    printf("Argument #%i: [%s]\n", i, argv[i]);
  }
  return 0;
}
</code></pre>
<p>Compile this with <code>gcc -Wall arguments.c -o arguments</code>.</p>
<h2 id="whitespace"><a class="header" href="#whitespace">Whitespace</a></h2>
<p>The program prints all its arguments, one per line. The program gets its arguments from the program that started it - in this case the shell.
Try running the program with the following commands:</p>
<pre><code>./arguments
./arguments hello
./arguments one two three
</code></pre>
<p>Now that you are familiar with what the program does, try the following:</p>
<pre><code>./arguments one       two
./arguments "one two"
./arguments "one      two"
</code></pre>
<p>How, based on these examples, does the shell handle whitespace in the line you type?</p>
<h2 id="pattern-matching"><a class="header" href="#pattern-matching">Pattern matching</a></h2>
<p>Try the following:</p>
<ul>
<li><code>./arguments *</code> in the folder that contains the arguments program, and its source code arguments.c.</li>
<li>Make an empty subfolder with <code>mkdir empty</code>, switch to it with <code>cd empty</code> and then run <code>../arguments *</code>. Since you are now in the subfolder, we need two dots at the start to say "run the program arguments in the folder <em>above</em>". What happens?</li>
<li>Go back to the folder with the program by running <code>cd ..</code> and then do <code>ls</code> to check you're back in the right folder. In this folder, find three different ways to get the program to produce the following output:</li>
</ul>
<pre><code>Argument #0: [./arguments]
Argument #1: [*] 
</code></pre>
<h2 id="files-with-spaces-in-their-names"><a class="header" href="#files-with-spaces-in-their-names">Files with spaces in their names</a></h2>
<p>The command <code>touch FILENAME</code> creates a file. Create a file with a space in its name by typing <code>touch "silly named file"</code>. What would happen if you left the quotes off (you can try it, then do <code>ls</code>)?</p>
<p>Start typing <code>ls sill</code> and then press TAB to autocomplete. Assuming you have no other files whose name starts with <em>sill</em>, what happens? Use this method to get the arguments program to print the following:</p>
<pre><code>Argument #0: [./arguments]
Argument #1: [Hello world!] 
</code></pre>
<p>The command <code>rm</code> (remove) deletes files again. Use it to remove your file with spaces in its name, using one of several methods to get the shell to pass the spaces through to <code>rm</code>.</p>
<h2 id="shell-variables"><a class="header" href="#shell-variables">Shell variables</a></h2>
<p>In the shell, <code>VARIABLE=VALUE</code> sets a variable to a value and <code>$VARIABLE</code> retrieves its value. For example, to save typing a filename twice:</p>
<pre><code>p=arguments
gcc -Wall $p.c -o $p
</code></pre>
<p>which expands to <code>gcc -Wall arguments.c -o arguments</code>. If you want to use a variable inside a word, you can use curly braces: <code>${a}b</code> means the value of the variable <code>a</code> followed by the letter b, whereas <code>$ab</code> would mean the value of the variable <code>ab</code>.</p>
<p>It is good practice to double-quote variables used like this, because if you tried for example to compile a program called <code>silly name.c</code> with a space in its name, then</p>
<pre><code>program="silly name"
gcc -Wall $program.c -o $program
</code></pre>
<p>would expand to</p>
<pre><code>gcc -Wall silly name.c -o silly name
</code></pre>
<p>and this would confuse your compiler because you are telling it to compile three source files called <code>silly</code>, <code>name.c</code> and <code>name</code> to a program called <code>silly</code>. Correct would be:</p>
<pre><code>program="silly name"
gcc -Wall "$program.c" -o "$program"
</code></pre>
<p>which expands to</p>
<pre><code>gcc -Wall "silly name.c" -o "silly name"
</code></pre>
<p>which does what you want - if you indeed want a program with a space in its name!</p>
<p>There is no harm in double-quoting a shell variable every time you want to use it, and this is good practice as it still works if the variable is set to a value that contains spaces.</p>
<p>Note that we also had to quote setting the variable name in the first place, because</p>
<pre><code>program=silly name
</code></pre>
<p>would translate as: set the variable <code>program</code> to the value <code>silly</code>, then execute the program <code>name</code>. Variable assignments only apply to the first argument following them, although you can assign more than one variable.</p>
<p>Note that this does not work as expected either:</p>
<pre><code>file=arguments gcc -Wall "$file.c" -o "$file"
</code></pre>
<p>The problem here is that the shell first reads the line and substitutes in the value of <code>$file</code> (unset variables expand to the empty string by default) before starting to execute the command, so you are reading the variable's value before writing it. Leaving off the quotes doesn't help: you need to set the variable on a separate line.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pipes"><a class="header" href="#pipes">Pipes</a></h1>
<p>The command <code>ls | head</code> runs ls and head and pipes the standard output of ls into the standard input of head.</p>
<p>The following shell commands are particularly useful in pipes:</p>
<ul>
<li><code>cat [FILENAME [FILENAME...]]</code> writes the contents of one or more files to standard output. This is a good way of starting a pipe. If you leave off all the filenames, cat just reads its standard input and writes it to standard output.</li>
<li><code>head [-n N]</code> reads its standard input and writes only the first N lines (default is 10 if you leave the option off) to standard output. You can also put a minus before the argument e.g. <code>head -n -2</code> to <em>skip the last 2 lines</em> and write all the rest.</li>
<li><code>tail [-n N]</code> is like head except that it writes the last N lines (with a minus, it skips the first N ones).</li>
<li><code>sort</code> reads all its standard input into a memory buffer, then sorts the lines and writes them all to standard output.</li>
<li><code>uniq</code> reads standard input and writes to standard output, but skips repeated lines that immediately follow each other, for example if there are three lines A, A, B then it would only write A, B but if it gets A, B, A it would write all three. A common way to remove duplicate lines is <code>... | sort | uniq | ...</code>.</li>
<li><code>grep [-iv] EXPRESSION</code> reads standard input and prints only lines that match the regular expression to standard output. With <code>-i</code> it is case-insensitive, and with <code>-v</code> it only prints lines that do <em>not</em> match the expression.</li>
<li><code>sed -e COMMAND</code> reads lines from standard input, transforms them according to the command and writes the results to standard output. <code>sed</code> has its own command language but the most common one is <code>s/SOURCE/DEST/</code> which changes substrings matching the source regular expression into the destination one.</li>
<li><code>wc [-l]</code> stands for word count, but with <code>-l</code> it counts lines instead. Putting a <code>wc -l</code> on the very end of a pipe is useful if you just want to know how many results a particular command or pipe produces, assuming the results come one per line.</li>
</ul>
<p>All these commands actually take an optional extra filename as argument, in which case they read from this file as input. For example, to display the first 10 lines of a file called <code>Readme.txt</code>, you could do either <code>cat Readme.txt | head</code> or <code>head Readme.txt</code>.</p>
<h2 id="word-list-exercises---pipes-and-regular-expressions"><a class="header" href="#word-list-exercises---pipes-and-regular-expressions">Word list exercises - pipes and regular expressions</a></h2>
<p>Most Linux distributions (including Debian) come with a dictionary file <code>/usr/share/dict/words</code> that contains a list of English words in alphabetical order, for use in spell-checking programs. The list includes a selection of proper nouns, for example countries and cities. If you want to look at it on a system that doesn't have it, you can download it with:</p>
<pre><code>wget https://users.cs.duke.edu/~ola/ap/linuxwords -O words
</code></pre>
<p><code>wget</code> is one of two utilities for downloading files, the other being <code>curl</code>. Note that the option for output file name is a capital O, not a lowercase o or a zero.</p>
<p>Find one-line commands, possibly with pipes, to print the following to your terminal. You can either start each command with <code>cat /usr/share/dict/words | ...</code> or do it without cat by providing the words file as an argument to the first command in your pipeline.</p>
<p><em>If English is not your native language, ignore the guessing part - it is not assessed.</em></p>
<ul>
<li>The first word in the file. <em>Can you guess what it will be?</em></li>
<li>The last word in the file. <em>Can you guess this one?</em></li>
<li>The number of words in the words file - there is one word per line.</li>
<li>The 6171st word in the file. <em>Can you read my mind and guess this word directly?</em></li>
<li>All words containing the letter Q, capitalised. (A regular expression containing a string of one or more letters matches all strings that contain the expression as a substring.)</li>
<li>All words starting with the letter X. The regular expression <code>X</code> would match an X anywhere in the word, but <code>^X</code> matches an X only at the start of the string.</li>
<li>All words ending in j. (The expression <code>'j$'</code> matches a j only at the end of the string, but you have to single-quote it to stop the shell from interpreting the dollar sign).</li>
<li>The number of words containing the letter Q, ignoring case (e.g. capitalised or not).</li>
<li>The first five words containing the letter sequence <code>cl</code>.</li>
<li>All words containing the sequence "kp", but not "ckp". <em>Can you guess any of these?</em></li>
<li>The last 15 words of exactly two letters. The expression <code>.</code> (period) matches a single character, and <code>'^...$'</code> for example would match all strings of the format <em>exactly three characters between start and end of string</em>. You need to quote it because of the dollar sign.</li>
<li>All words from the first 100 words on the list, which contain the letter y.</li>
<li>The first five words that are among the last 100 words on the list, and contain the letter y (whether capitalised or not).</li>
<li>All three-letter words with no vowels (aeiou).The regular expression <code>'[aeiou]'</code> matches any string that contains one of the bracketed characters; you need quotes to stop the shell from interpreting the brackets. Remember to exclude words with capitalised vowels as well. <em>There are 343 of these.</em></li>
<li>All words of exactly 7 letters, where the third one is an e and the word ends "-ded". <em>This kind of search is really useful for crosswords. There are 14 words of this form, can you guess them?</em></li>
</ul>
<p>Bonus regular expression question:</p>
<ul>
<li>Find all words that start with a P (whether capitalised or not), and contain at least four instances of the letter a. Putting a <code>*</code> after something in a regular expression searches for <em>any number of repetitions of this, including 0</em> so for example <code>'a*'</code> would find words with any number of the letter a, including 0 (which is not what you want here). You need single quotes to stop the shell from expanding the <code>*</code>. <em>Can you guess the words? There are 14 hits in the solution but essentially five words: two demonyms and three nouns which are not proper nouns, all with possessive and plural forms (bar one which is its own plural).</em></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="regular-expressions"><a class="header" href="#regular-expressions">Regular expressions</a></h1>
<p>For this exercise you'll want to refer often to a manual for <code>grep</code>.
You can access one on the commandline by invoking <code>man grep</code>.
You've already tackled some problems involving regular expressions in a previous
exercise. Here are some more advanced questions that will require you to
understand more about <code>grep</code>, its options, and how regular expression syntax
works.</p>
<ol>
<li>Study the documentation for the <code>-w</code> option. Contrive a file such that <code>grep PATTERN FILE</code> returns two different lines but <code>grep -w PATTERN FILE</code> returns
only one line.</li>
<li>You'll have seen beforehand that you can count the results of a search with
<code>grep PATTERN FILE | wc -l</code>. However, <code>grep</code> also has a <code>-c</code> option which
counts matches. Can you find the situation where the <code>wc -l</code> approach and the
<code>-c</code> approach produce different results? Can you explain why?</li>
<li>Some words have different spelling between British English and American
English. For example, 'encyclopaedia' is valid in British English but not
American. Can you write a regular expression that would match both of these
words, but nothing else? How about matching both 'color' (American) and 'colour'
(British)?</li>
<li>UK postcodes follow a general schema of two letters followed by one number,
followed by an optional space, then another number, followed by two more letters. Can you write
a regular expression that would match such sequences?</li>
<li>In practice, the above is a simplified version of the system, and a better UK
postcode validator regex is known to be
<code>^(([A-Z]{1,2}[0-9][A-Z0-9]?|ASCN|STHL|TDCU|BBND|[BFS]IQQ|PCRN|TKCA) ?[0-9][A-Z]{2}|BFPO ?[0-9]{1,4}|(KY[0-9]|MSR|VG|AI)[ -]?[0-9]{4}|[A-Z]{2} ?[0-9]{2}|GE ?CX|GIR ?0A{2}|SAN ?TA1)$</code>. Try breaking apart this monster to
understand what is being tested, and find an example that would match the schema
described for the fourth question but fail to match this expression.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="activity-git"><a class="header" href="#activity-git">Activity: Git</a></h1>
<h2 id="videos-2"><a class="header" href="#videos-2">Videos</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/1fb28095-555d-40e5-8b3b-5fb18b178892">Git, part 1</a></td><td style="text-align: right">34 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/ETueHYft1rVKjld7jesRNBwBL-iNbDoDElJRwZ1BymcXnQ?e=obfTVF">slides</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/ea90c1c9-89cd-4cbf-9af1-14675bebdaea">Git, part 2</a></td><td style="text-align: right">27 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EZjMmRvbrndMkCf0wNwv93MBLorPR9KHzlMZ0iEJa1vBJg?e=08BmRQ">slides</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/ecb70e8b-a390-44fa-8bc1-5af08d79a065">Git, part 3</a></td><td style="text-align: right">19 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/Ed3pRweWtgBPlylvSqRa9eMBzieIVzJ_SYjJY-Hw10V_3Q?e=WGEyNg">slides</a></td></tr>
</tbody></table>
</div>
<h2 id="exercises-2"><a class="header" href="#exercises-2">Exercises</a></h2>
<ul>
<li><a href="git/./git.html">Git</a></li>
</ul>
<h2 id="reading"><a class="header" href="#reading">Reading</a></h2>
<p>Optional (but recommended).</p>
<ul>
<li><a href="https://www.man7.org/linux/man-pages/man7/giteveryday.7.html"><code>man 7 giteveryday</code></a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git"><a class="header" href="#git">Git</a></h1>
<p>Git is the defacto standard version control system used throughout CS.
It also lives up to its name as being a <em>pain</em> to use.  Take it
slow and take it as a chance to practice using the Git commandline.</p>
<p>This lab <em>should</em> work fine on pretty much any computer (well... maybe not
Windows) but we'd still recommend completing it in a virtual machine
(mostly because we can test the lab in a virtual machine...).</p>
<p>If you'd like a <code>Vagrantfile</code> to base your work on you can use the
following:</p>
<pre><code class="language-ruby">Vagrant.configure("2") do |config|
  config.vm.box = "generic/debian12"
  config.vm.synced_folder ".", "/vagrant"

  config.vm.provision "shell", inline: &lt;&lt;-SHELL
    apt-get update -y
    apt-get install -y git git-man apt-file
    apt-file update
  SHELL
end
</code></pre>
<h2 id="git-documentation"><a class="header" href="#git-documentation">Git documentation</a></h2>
<p>Git comes with <em>extensive</em> documentation.  Run:</p>
<pre><code>apropos git
</code></pre>
<p>To see all of it, or run:</p>
<pre><code>apropos git -a tutorial
</code></pre>
<p>To find documentation relating to git and (the <code>-a</code>) tutorials.
Read any of the documentation you think might be useful with the <code>man</code>
command.</p>
<p><strong>Task:</strong> There is a man page that documents the <em>everyday git</em>
commands you might want to use.  Find it with <code>apropos</code> and read it
with the <code>man</code> command.</p>
<p>You might also want to read the <code>gittutorial</code> pages...</p>
<h2 id="configuring-your-identity"><a class="header" href="#configuring-your-identity">Configuring your identity</a></h2>
<p>Git is all about tracking changes to source code.  That means it needs
to know <em>who</em> made <em>what</em> changes.</p>
<p>Run the following two lines to set up git correctly. You only need to do this once when you install git, but not every time you create a new repository.</p>
<pre><code>git config --global user.name "YOURNAME"
git config --global user.email "YOUREMAIL"
</code></pre>
<p>The name and email address aren't actually sent anywhere or
checked... they're just listed with alongside the changes you make to
the code so if somethings wrong later programmers know who to blame
(see <code>man git-blame</code>). You can put anything you like here (git will happily accept <code>-</code> as your email address, and it does not send you email).</p>
<p>This alters the <em>global</em> git configuration (the settings applied to
<em>every</em> git repository you work on), but you can also make these
changes on a repository by repository basis.  Just drop the <code>--global</code>
and run the command inside the git repository you want to apply the
changes to.  This is useful if you're <em>Bruce Wayne</em> and need to keep
your public and private development projects separate (or if you do
subcontracted development work).</p>
<h2 id="for-those-of-you-using-vagrant"><a class="header" href="#for-those-of-you-using-vagrant">For those of you using Vagrant</a></h2>
<p>If you are running a VM on a lab machine, then you would need to
reconfigure git every time vagrant rebuilds the VM, for example when
you log in to a different lab machine. You can put these commands in
your Vagrantfile, like anything else that you want to run when vagrant
(re)builds your box, but they need to be run as the vagrant user and
not the root user. So add the following block to your <code>Vagrantfile</code>
just before the <code>end</code> line, editing your name and email address
obviously.  Normally vagrant will run these provision blocks as the
system administrator <code>root</code>, but you can run it as the normal
<code>vagrant</code> user by adding the <code>privileged: false</code> keyword.</p>
<pre><code class="language-ruby">config.vm.provision :shell, privileged: false, inline: &lt;&lt;-SHELL
    git config --global user.name "YOURNAME"
    git config --global user.email "YOUREMAIL"
SHELL
</code></pre>
<p>If you start getting errors about the git command not being installed:
install it!  If you're using the Debian-based VM the command you need
is <code>apt</code> (see <code>man apt</code> if you're not familiar with it).<br />
Some people find having two provisioning blocks a bit messy.  You
could reduce them to just one block, but you'll need to use the <code>su</code>
command to ensure that you configure git as the <code>vagrant</code> user.</p>
<h2 id="a-sample-project-and-repository"><a class="header" href="#a-sample-project-and-repository">A sample project and repository</a></h2>
<p>Let's say you want to start developing a C program. Let's make a folder:</p>
<pre><code>mkdir project1
cd project1
git init
</code></pre>
<p>The last command created an empty git repository in a subfolder called <code>.git</code>. We can check with <code>git status</code> to see whether there are any changes, and git reports <code>nothing to commit</code>.</p>
<p>Create a file <code>main.c</code>, with your text editor and add some sample content like this (you should be able to copy-paste into your terminal):</p>
<pre><code class="language-C">// file: main.c
#include &lt;stdio.h&gt;

int main() {
    puts("Hi");
    return 0;
}
</code></pre>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Which text editor should you use?  It doesn't honestly matter, but it
needs to be able to write plain text documents (those without
formatting---so not Microsoft Word).</p>
<p>The <em>standard</em> editor is called <code>ed</code>: but don't use it!  It is
designed for back before computers had screens.</p>
<p>The <em>traditional</em> programmer editors are <code>vim</code> or <code>emacs</code>.  You
<em>should</em> learn one of them (Jo and Matt would both recommend <code>vim</code>)
but they're rather confusing if you've never used a programmers'
editor before.  Absolutely worth it though; just expect to be rather
slow at typing things for a week or two.</p>
<p>Easier editors include <code>nano</code> which works on the command line, <code>gedit</code>
which is a bit more graphical or Microsoft's <code>Visual Studio</code> which can
edit code on remote systems. They're all configurable and you can make
all of them do things like syntax highlighting and code completion.</p>
<p>We don't care what editor you use: but make sure you make it work for
you by configuring it.  You're going to be spending an awful lot of
your degree writing code: a bit of investment in text editor now will
pay dividends later on!</p>
<p>(and I think everyone judges people who are <em>still</em> using <code>nano</code> in
their final year...)</p>
</div>
</div>
<p>Do a <code>git status</code> and you will see <code>main.c</code> in red under <em>untracked files</em> - this is a new file that git does not know about yet. Do <code>git add main.c</code> followed by another <code>git status</code> and the file is now green under <em>files to be committed</em>.</p>
<p>Commit the file with <code>git commit -m "first file"</code> or something like that - you need double quotes if you want spaces in your commit message. Try <code>git status</code> again and you should see <em>nothing to commit, working tree clean</em> which means git is up to date with your files. Try <code>git log</code> and you will see that there is now one commit in the log.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Every git commit must have a commit message. You can either add one
with the <code>-m</code> flag, or leave that off and git will drop you into the
system default editor to write one. That is normally vim (the command
to quit is press the escape key then <code>ZZ</code>). You can change the default
editor by setting <em>environment variables</em> with command <code>export EDITOR=nano</code>.</p>
<p>If you want to keep this setting when you relaunch your shell next time you log in, then the export line has to go in a file called <code>.profile</code> in your home directory, which is a file that the bash shell processes when it starts up.</p>
<p>To keep a profile file around when vagrant rebuilds your VM you could
stick a provisioning line in to your vagrantfile to ensure the
<code>.profile</code> is updated:</p>
<pre><code>echo 'export EDITOR=ed' &gt;&gt;~vagrant/.profile
</code></pre>
</div>
</div>
<h2 id="ignoring-files"><a class="header" href="#ignoring-files">Ignoring files</a></h2>
<p>Compile your code with <code>gcc main.c -o program</code>, and check with
<code>./program</code> that it runs and prints <em>Hi</em>. (If you get an error that
<code>stdio.h</code> doesn't exist, then you have installed gcc but not the C
development libraries  Hint: <code>man apt-file</code>.)</p>
<p>If you look at <code>git status</code> now, the program file shows as untracked, but we do not want to commit it: the repository works best when you store only your source code, and anyone who needs to can check out a copy and build from there. Among other things this means that people on different platforms e.g. linux and mac, intel and ARM and so on can each compile the version that works for them.</p>
<p>So we want to tell git to ignore the program and changes in it, which we do by creating a file called <code>.gitignore</code> and adding an expression on each line to say which file(s) or folders to ignore - you can use <code>*.o</code> to select all object code files, for example.</p>
<ul>
<li>Create a file <code>.gitignore</code> and add the single line <code>program</code> to it.</li>
<li>Do another <code>git status</code> and notice that while the program is now ignored, the ignore file is marked as new. This file does belong in the repository, so add it and commit it.</li>
<li>Check that <code>git status</code> reports <em>clean</em> again, and that <code>git log</code> contains two commits.</li>
</ul>
<h2 id="commit-and-checkout"><a class="header" href="#commit-and-checkout">Commit and checkout</a></h2>
<p>As you develop, you should regularly code, commit, repeat. To practice this, change <em>Hi</em> to <em>Hello</em> in the program, rebuild and run the program, then add and commit the source file again - check with <code>git status</code> at the end that you get <em>clean</em> again.</p>
<p>The command <code>git add .</code> adds all new and changed files and folders in the current folder in one go, and is typically the quickest way to add things when you want to commit all your changes since the last commit.</p>
<p>Sometimes you want to go back and look at another commit, or undo a commit that broke something - this is when you want a checkout.</p>
<ul>
<li>Use <code>git log</code> to show the history of your commits. (When you have more than one screen, <code>git log |less</code> lets you scroll.)</li>
<li>Note the first 6 or so characters of the commit hash of the commit where you added the ignore file, but before changing <em>Hi</em> to <em>Hello</em>. You need at least 6 characters, but only as many so that it's not ambiguous to git which commit you mean.</li>
<li>Run <code>git checkout HASH</code> where HASH is the 6 or however many you need characters of the commit in question. Git will print a warning about the HEAD pointer.</li>
<li>Check the source file, and notice that it is now back on <em>Hi</em>.</li>
<li>Use <code>git checkout main</code> to return to the latest version of your files, and git will set up the HEAD pointer again ready to accept new commits.</li>
</ul>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>If you actually want to undo a commit, then you have two options:</p>
<ul>
<li><code>git revert HASH</code> adds a new commit that returns the files to the state they were before the commit with the given hash. This is safe to use during team development, as it's just adding a new commit. If you have commits A, B and do <code>git revert B</code> then you get a new commit C so anyone else using the repository sees a sequence of commits A, B, C; but the state of the files in C is the same as in A.</li>
<li><code>git reset HASH</code> undoes commits by moving the HEAD pointer back to the commit with the given hash, but leaves the working copy alone (you can use the <code>--hard</code> option to change the files as well). This will break things if you have shared your newer commits with other developers, but it's safe to use to undo changes that you haven't pushed yet (we'll learn about this next time). The effect is as if the commits which you've reset had never happened.</li>
</ul>
<p>Note: if you want to revert a commit because you accidentally commited a file with secret information, and you've already pushed the commit, then you also have to look up online how to "force push" your changes to erase all traces of the file on github (or other online providers). If the secret file contained any passwords, even if you reverted the commit immediately, then you should consider the passwords compromised and change them at once.</p>
</div>
</div>
<h1 id="part-2-git-forges"><a class="header" href="#part-2-git-forges">Part 2: Git forges</a></h1>
<p>In this exercise we will set up and use a git forge account with a
remote provider. The <em>typical</em> ones you usually see for hosting git repositories are:</p>
<ul>
<li><a href="https://github.com">github.com</a></li>
<li><a href="https://gitlab.com">gitlab.com</a></li>
<li><a href="https://bitbucket.org">bitbucket.org</a></li>
</ul>
<p>But <em>many</em> more exist.  You can even create your own with little more
than an SSH server.  Jo's favourite is one called
<a href="https://sr.ht">sourcehut</a> but you have to pay for it.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>If you do want to build your own git server from scratch it isn't that
hard but you have to muck about with <em>bare</em> git repos (that we don't
cover) and set some funky file permissions.  <a href="https://git-scm.com/book/en/v2/Git-on-the-Server-Getting-Git-on-a-Server">Instructions can be found
here for the brave.</a></p>
</div>
</div>
<p>This exercise is based on GitHub, as it is the most popular provider, but you can use one of the other two if you want as well---although the web user interface and some advanced features are different, interacting with all three on the command line is identical and all three offer unlimited private and public repositories (within reason).</p>
<h2 id="set-things-up"><a class="header" href="#set-things-up">Set things up</a></h2>
<p>Go to <a href="https://github.com">github.com</a> and register with a username, an e-mail address and a password. You might have to click a confirmation link in an e-mail sent to you.</p>
<p>We are going to use git over SSH, so you need to let git know your public key (remember, you never give anyone your private key!). Click the icon in the top right corner of the screen that represents your avatar (you can of course set a custom one if you like) and choose <em>Settings</em> in the menu, then on the settings page choose <em>SSH and GPG keys</em>.</p>
<p>Choose <em>New SSH key</em>, and paste your SSH public key in the <code>Key</code> box
(you created one last week, see <code>man ssh-keygen</code>). Give your key a
title if you like, then add it with the green button. Github supports
all common SSH key formats, but will warn you if you do something
silly like upload a private key or a key in an outdated and weak
cipher.  Some providers (Bitbucket) insist you use a specific type of
key (usually <code>ed25519</code>): add the appropriate flag when generating the
key to create it (<code>-t ed25519</code>) if you want that.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>If you have many devices (desktop, laptop) that you work from and many servers (github, gitlab, lab machine etc.) that you connect to, how do you manage keys?</p>
<p>Whilst ising the same public key for different services is not exactly
a security problem: even if one service gets hacked and you connect to
it while it's under the hacker's control, that does not leak your
private key; it feels a bit icky.  Generating keys is easy and it is
barely any more work to have separate keys per server and per machine
you use.</p>
<p>However, reusing public keys can be a privacy problem, because every service that you use the same public key (or e-mail address, or phone number etc.) can potentially work with the others to know that you are the same individual. It is no problem to use different keypairs for different services, in which case you probably want a block in your <code>~/.ssh/config</code> file with something like</p>
<pre><code>Host github.com
    User git
    IdentityFile ~/.ssh/github.com.key.or.whatever.you.called it.
</code></pre>
<p>Search the manual pages for <code>ssh_config</code> for full configuration options.</p>
</div>
</div>
<p>We are assuming that you will be running the git commands in the rest of this section on an VM, either on your machine or on a lab machine, however if you have git installed on your own machine directly (which is a good idea) then you can run this exercise there too.</p>
<h2 id="a-note-on-naming"><a class="header" href="#a-note-on-naming">A note on naming</a></h2>
<p>The name of the main branch changes: it used to be called <code>master</code>.
You may see the default branch named as either <code>master</code> or <code>main</code>, or  something else entirely. So long as you are consistent, the name of the
default branch doesn't matter at all (and you can configure it if you have a
preference), and you just need to know that in these exercises we will use <code>main</code>
to refer to the default branch and you should substitute that for your own default
branch name if it is different.</p>
<h2 id="create-a-repository"><a class="header" href="#create-a-repository">Create a repository</a></h2>
<p>On the main page, you should see an empty <em>Repositories</em> bar on the left, with a new button. Use that to create a repository, on the next page give it a name and tick the <em>Add a README file</em> box.</p>
<p>On the repository page, there is a green <em>Code</em> button. Clicking that opens a box with three tabs: <em>HTTPS</em>, <em>SSH</em> and <em>GitHub CLI</em>.</p>
<p>Each repository has a two-part name: the first part is the owner's github username, the second part is the repository name. For example, the repository for this unit is called <code>cs-uob/COMSM0085</code>. There are two ways to interact with a remote repository:</p>
<ul>
<li>Via HTTPS. This is ok if you are just cloning a public repository, as it does not require any authentication. To interact with a private repository or to push files, HTTPS requires username/password authentication, and we can do better than that.</li>
<li>Via SSH, using keys. This is the recommended way to use Git.</li>
</ul>
<p>Click the SSH tab and copy the URL there - it should be something like <code>git@github.com:USERNAME/REPONAME.git</code>.</p>
<p>On the command line, run the command <code>git clone git@github.com:USERNAME/REPONAME.git</code> where you replace USERNAME and REPONAME with the parts from the SSH tab of your repository. Git clones your repository and puts the content in a subfolder named after the repository name - you can change this by providing a different folder name as an extra command-line argument to <code>git clone</code>, or you can just move or rename the folder later on.</p>
<p><em>Note: certain OS/ISP/DNS combinations might get you "resource temporarily unavailable" when you try and access github via ssh. The problem is that the actual address is <code>ssh.github.com</code> and not all set-ups correctly pass on the redirection when you try and connect to github directly. If you are experiencing this error, you can either use <code>ssh.github.com</code> in place of <code>github.com</code>, or add an entry in your <code>~/.ssh/config</code> file as follows (if you have to create this file first, make sure it is not writable by anyone except yourself or ssh will refuse to accept it):</em></p>
<pre><code>Host github.com
  Hostname ssh.github.com
  Port 22
</code></pre>
<p>Go to that folder, and try <code>git remote show origin</code>. Here, <code>origin</code> is the default name of a <em>remote</em>, and the result should look a bit like this:</p>
<pre><code>* remote origin
  Fetch URL: git@github.com:USERNAME/REPONAME
  Push  URL: git@github.com:USERNAME/REPONAME
  HEAD branch: main
  Remote branch:
    main tracked
  Local branch configured for 'git pull':
    main merges with remote main
  Local ref configured for 'git push':
    main pushes to main (up to date)
</code></pre>
<p>The bits about <code>main</code> are to do with branches, which we will discuss in another activity in more detail.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>You can have several remotes with different names - for example if you fork (create your own copy of someone else's repository) then you get the original one as a second remote named <em>upstream</em>, so you can share changes back with them - this is the way you create new content for the <a href="https://cssbristol.co.uk">CSS website</a> for example.</p>
<p>You can also use folders as remotes: if you want to practice resolving merge conflicts, you could do the following:</p>
<pre><code>mkdir remote
cd remote
git init --bare
cd ..
mkdir user1
git clone remote user1
mkdir user2
git clone remote user2
</code></pre>
<p>This gets you a remote and two "users" in different folders to play with. The remote was set up with <code>--bare</code> so that it does not contain a working copy, but acts as a pure repository.</p>
<p>You can now <code>cd user1</code> to simulate user 1 doing work, and can fetch/push/pull as described below. (Ignore warnings about "upstream", they will go away once you have committed a file to the repository.) Then you can <code>cd ../user2</code> to switch to a second working copy, which you can pretend is another user on another machine.</p>
<p>If you want to adjust the user names for the commits, then running <code>git config user.name "YOURNAME"</code> and <code>git config user.email "YOUREMAIL"</code> without the <code>--global</code> option from last time changes the settings just for one repository.</p>
</div>
</div>
<p>Do a <code>git status</code> and note that a new line appears compared to last activity:</p>
<pre><code>Your branch is up to date with 'origin/main'.
</code></pre>
<p>This line comes in four versions:</p>
<ul>
<li>Up to date: there have been no commits on your local or the remote repository since you last synchronised.</li>
<li>Ahead of remote: you have made commits locally that you have not yet pushed to the remote.</li>
<li>Behind remote: someone else, or you on a different computer, have made commits to the remote that you do not have on this computer yet.</li>
<li>Diverged from remote: both your computer and the remote have had different commits since the last time you synchronised.</li>
</ul>
<h2 id="practice-the-push-workflow"><a class="header" href="#practice-the-push-workflow">Practice the push workflow</a></h2>
<p>For this exercise, you should work in pairs or larger groups.  Need
someone to work with?  Ask the person you're sitting next to.</p>
<p>One person creates a private repository (tick the box to add a README file) and adds everyone else in the group to it. You all need to have an account with the same provider for this to work.</p>
<ul>
<li>On Github, the way to add people to a repository is on the repository page: choose <em>Settings</em> in the top menu, then <em>Manage access</em>. Here you can press <em>Invite a collaborator</em> and enter their Github username. This causes Github to send them an e-mail with a link they need to click to accept the invitation and be added to the repository. <em>Note: you must be logged in to github when you click the link on the invitation e-mail, otherwise you will get an error message.</em></li>
</ul>
<p>Everyone <code>git clone</code>s the repository to their own Debian VM (or their own machine directly).</p>
<p>Everyone does the following, one person at a time doing all steps (coordinate among each other):</p>
<ol>
<li>Imagine that it is mid-morning and you are starting on a day's coding.</li>
<li>First, make sure your terminal is in the folder with your working copy, and type <code>git fetch</code>.
<ul>
<li>If you get no update, then there were no changes on the remote since your last fetch and you are ready to start coding. (This should happen to the first person to do this step.)</li>
<li>If you get output, then there were changes on the remote. Do a <code>git status</code> to see details (everyone except the first person should see this). Notice the line <code>behind origin/main ... can be fast-forwarded.</code> which means you just need to <code>git pull</code> and you will get the latest version of the files. Do a <code>git log</code> too to see the last person's commit message.</li>
</ul>
</li>
<li>Do some coding: make a change to the repository - add or change a file, then commit your changes. You can use <code>nano FILENAME</code> to create and edit a file in your terminal, if you have installed it as described in the last activity.</li>
<li>Run the following push workflow to push your changes to the remote:
<ol>
<li>Do a <code>git fetch</code> to see if there were any remote changes (there shouldn't be, for this exercise).</li>
<li>Do a <code>git status</code> and make sure you are <code>ahead of origin</code>, not <code>diverged</code>.</li>
<li>Do a <code>git push</code> to send your changes to the remote.</li>
</ol>
</li>
</ol>
<p>You can now code as a team, as long as only one person at a time is working - clearly not ideal.</p>
<h2 id="resolve-a-fake-conflict-part-one"><a class="header" href="#resolve-a-fake-conflict-part-one">Resolve a fake conflict, part one</a></h2>
<p>Produce a "fake" conflict as follows:</p>
<ol>
<li>Two team members make sure they are <code>up to date</code> with their working copies (do a <code>git pull</code>, then <code>git status</code>). This represents you both starting coding in the morning.</li>
<li>One member adds or changes one file, then commits this change and pushes it by running the whole push workflow (fetch, status - check you're ahead, push).</li>
<li>At the same time as the first member is doing step 2, the second member adds or changes a different file, then commits this change. This represents two team members working in parallel, with the member one being the first one to complete their work and push a commit back to the remote.</li>
<li>The second member starts the push workflow with <code>git fetch</code>, then <code>git status</code>. Notice you have <code>diverged</code>. (If you were to try to <code>git push</code>, with or without fetching this would produce an error.)</li>
</ol>
<p>The commit graph of member two looks something like this:</p>
<p><img src="git/../resources/before-rebase.png" alt="diagram of commits before rebase" /></p>
<p>One way to resolve this conflict is a <em>rebase</em>, which is pretending that member two had actually fetched the <code>one</code> commit before starting their own work. The command for this which member two types is <code>git rebase origin/main</code> which means <em>pretend that everything in origin/main happened before I started my local changes</em> and gives the following graph:</p>
<p><img src="git/../resources/after-rebase.png" alt="diagram of commits after rebase" /></p>
<p>Indeed, if member two does a <code>git status</code> after the rebase, they will see <code>ahead of origin/main by 1 commit</code> and they can now <code>git push</code> to send their local changes to the remote repository.</p>
<p>Different companies and teams have different opinions on when a rebase makes sense: some places forbid rebasing like this entirely, at least for work that is genuninely shared between different people. There is more or less a general consensus that you should not rebase when different people were editing the same files, but it is a technique worth knowing about for conflicts like the one you just created where different people have edited different files, as it makes for a cleaner commit graph.</p>
<h2 id="fake-conflicts-part-two"><a class="header" href="#fake-conflicts-part-two">Fake conflicts, part two</a></h2>
<p>The other way to fix conflicts - and the only one that some people will use - is a merge. Let's do another fake conflict, but resolve it with a merge this time:</p>
<ol>
<li>Two team members both get their repositories up to date with the remote. If you have just followed the instructions above then team member one has to <code>git pull</code> and team member two is already up to date because they have just pushed; both team members should check with <code>git fetch</code> then <code>git status</code> that they are <code>up to date</code>.</li>
<li>Like before, team member one edits one file, commits it and does the whole push workflow (fetch, status - check you're ahead, push). The second team member at the same time, without another fetch, edits a different file and commits.</li>
<li>The second team member starts the push workflow: fetch, status - notice you've <code>diverged</code>.</li>
</ol>
<p>The second member's commit graph looks similar to the previous one before the rebase, perhaps with more commits in place of the <em>initial</em> one.</p>
<p>The second member is about to do a merge, which can either succeed (as it should here, because different people edited different files) or fail with a merge conflict (for example if different people edited the same file). If a merge succeeds, then git will make a merge commit and will drop them into their system's default editor, which is normally <code>vi</code>. Because we don't want to learn that right now, the second member should type <code>echo $EDITOR</code> in their shell and see what they get - if they get <code>nano</code> then they're fine, if they get an empty line then they should do <code>export EDITOR=nano</code>.</p>
<p>The second team member types <code>git pull</code>. Since this is a fake conflict (different files), this gets you into your editor, and you can see that on the first line is a suggested commit message starting with <code>Merge branch main</code>, which it is conventional to accept without changes - exit your editor again. Git replies <code>Merge made by the recursive strategy.</code> and your commit graph now looks something like this (the <code>...</code> stands for the last commit from the previous section):</p>
<p><img src="git/../resources/after-merge.png" alt="diagram of commits after merge" /></p>
<h2 id="resolving-a-real-conflict"><a class="header" href="#resolving-a-real-conflict">Resolving a real conflict</a></h2>
<p>And next, we'll practice dealing with a real conflict, where two people have edited the same file.</p>
<ol>
<li>Two team members get their repositories synchronised again: everyone does a <code>git pull</code>.</li>
<li>Team member one creates a file called <code>README.md</code> or edits it if it already exists, and adds a line like <code>Created by NAME</code> with their own name. Then they commit this change and run the push workflow: <code>git fetch</code>, <code>git status</code>, check they're <code>ahead</code>, <code>git push</code> to the remote.</li>
<li>Team member two, without fetching the latest commit, creates the same <code>README.md</code> file and adds a line <code>Created by NAME2</code> and commits this to their local repository. This simulates two people working on the same files in parallel since they both last fetched, and one of them (member one in this case) is the first to get their changes back to the remote.</li>
<li>Team member two starts the push workflow: <code>git fetch</code>, <code>git status</code> and notice that you have <code>diverged</code> again.</li>
<li>Run <code>git pull</code> as member two. You should see the following message:</li>
</ol>
<pre><code>CONFLICT (add/add): Merge conflict in README.md
Auto-merging README.md
Automatic merge failed; fix conflicts and then commit the result.
</code></pre>
<p>Open the file, for example <code>nano README.md</code> and notice that git has annotated it:</p>
<pre><code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
Created by NAME2.
=======
Created by NAME1.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; b955a75c7ca584ccf0c0bddccbcde46f445a7b30
</code></pre>
<p>The lines between <code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</code> and <code>=======</code> are the local changes (team member two) and the ones from <code>======</code> to <code>&gt;&gt;&gt;&gt;&gt;&gt; ...</code> are the ones in the commit fetched from the remote, for which the commit id is shown.</p>
<p>Member two now has to resolve the conflict by editing the file to produce the version they would like to commit. For example, you could remove all the offending lines and replace them with <code>Created by NAME1 and NAME2.</code></p>
<p>Member two can now do the following:</p>
<ul>
<li><code>git add README.md</code> (or whatever other files were affected).</li>
<li><code>git commit</code>. You could give a message directly, but a commit without a <code>-m</code> drops you into your editor and you'll see that git is suggesting <code>Merge branch main ...</code> as a default message here. It is conventional to leave this message as it is, just exit your editor without any changes.</li>
<li>Run another push workflow: <code>git fetch</code>, <code>git status</code> and notice you are now <code>ahead by 2 commits</code>: the first one was the work you did, the second is the merge commit. You're ahead, so finish the workflow with <code>git push</code>.</li>
</ul>
<p>Your commit graph looks the same as for the last merge that you did.</p>
<p>If you look at the repository's page on Github (<code>https://github.com/USERNAME/REPONAME</code>, where <code>USERNAME</code> is the name of the user who created the repository), then you can click on <em>Insights</em> in the top bar then <em>Network</em> on the left menu to see the commit history for the repository as a graph. Hovering over a commit node shows the committer, the message and the commit hash - and clicking on a node takes you to a page where you can see which changes were made in this commit.</p>
<p>On the main Github page for the repository, you can also click the clock icon with a number in the top right (on a wide enough screen it also shows the word <em>commits</em>) to go to a page showing all the commits on your repository in chronological order.</p>
<h1 id="working-with-others"><a class="header" href="#working-with-others">Working with others</a></h1>
<p>In this activity you will practice Git the way it is used in real teams. You will need to form a group for this activity, ideally more than two students.</p>
<h2 id="set-up"><a class="header" href="#set-up">Set-up</a></h2>
<p>One member makes a Git repository on one of the online providers, adds the other team members and shares the cloning URL. Everyone clones the repository.</p>
<p>The repository must have at least one commit for the following to work. This condition is satisfied if you chose your provider's option to create a readme file; if not then make a file now, commit it and push.</p>
<h2 id="the-develop-branch"><a class="header" href="#the-develop-branch">The develop branch</a></h2>
<p>By default, your repository has one branch named <code>main</code>. But you don't want to do your work on this branch directly. Instead, one team member creates a <code>develop</code> branch with the command</p>
<pre><code>git checkout -b develop
</code></pre>
<p>The team member who created the develop branch should now make a commit on it.</p>
<p>This branch currently exists only in their local repository, and if they try and push they would get a warning about this.
What they need to do is</p>
<pre><code>git push --set-upstream origin develop
</code></pre>
<p>This adds an "upstream" entry on the local develop branch to say that it is linked to the copy of your repository called <code>origin</code>, which is the default name for the one you cloned the repository from.</p>
<p>You can check this with <code>git remote show origin</code>, which should display among other things:</p>
<pre><code>Remote branches:
  develop tracked
  main  tracked
Local branches configured for 'git pull':
  develop merges with remote develop
  main  merges with remote main
Local refs configured for 'git push':
  develop pushes to develop (up to date)
  main  pushes to main  (up to date)
</code></pre>
<p>Everyone else can now <code>git pull</code> and see the branch with <code>git branch -a</code>, the <code>-a</code> (all) option means include branches that only exist on the remote. They can switch to the develop branch with <code>git checkout develop</code>, which should show:</p>
<pre><code>Branch 'develop' set up to track remote branch 'develop' from 'origin'.
Switched to a new branch 'develop'
</code></pre>
<h2 id="feature-branches"><a class="header" href="#feature-branches">Feature branches</a></h2>
<p>Every team member now independently tries the following:</p>
<ul>
<li>Make a new branch with <code>git checkout -b NAME</code>, choosing a unique name for their feature branch.</li>
<li>Make a few commits on this branch.</li>
<li>Push your feature branch with <code>git push --set-upstream origin NAME</code>.</li>
<li>Make a few more commits.</li>
<li>Do a simple <code>git push</code> since you've already linked your branch to <code>origin</code>.</li>
</ul>
<p>Since everyone is working on a different branch, you will never get a conflict this way.</p>
<p>Anyone who is a project member can visit the github page can see all the feature branches there, but a normal <code>git branch</code> will not show other people's branches that you've never checked out yourself. Instead, you want to do <code>git branch -a</code>  again that will show you all the branches, with names like <code>remotes/origin/NAME</code> for branches that so far only exist on the origin repository. You can check these out like any other branch to see their contents in your working copy.</p>
<h2 id="merging"><a class="header" href="#merging">Merging</a></h2>
<p>When a feature is done, you want to merge it into develop. Everyone should try this, the procedure for this is</p>
<ol>
<li>Commit all your changes and push.</li>
<li>Fetch the latest changes from origin (a simple <code>git fetch</code> does this).</li>
<li><code>git checkout develop</code>, which switches you to the develop branch (the changes for your latest feature will disappear in the working copy, but they're still in the repository). You always merge into the currently active branch, so you need to be on <code>develop</code> to merge into it.</li>
<li><code>git status</code> to see if someone else has updated develop since you started your feature. If so, then <code>git pull</code> (you will be <em>behind</em> rather than <em>diverged</em> because you have not changed develop yourself yet).</li>
<li><code>git merge NAME</code> with the name of your feature branch.</li>
<li>Resolve conflicts, if necessary (see below).</li>
<li><code>git push</code> to share your new feature with the rest of the team.</li>
</ol>
<p>If no-one else has changed <code>develop</code> since you started your branch, or if you have only changed files that no-one else has changed, then the merge might succeed on the first attempt. It's still a good idea to check that the project is in a good state (for example, compile it again) just in case, and fix anything that's broken on the develop branch.</p>
<p>If the merge fails with a conflict, then you need to manually edit all the conflicted files (git will tell you which ones these are, do <code>git status</code> if you need a reminder) and <code>git commit</code> again.</p>
<p>The workflow for merging and resolving conflicts is essentially the same as the one from the last session, but since everyone is developing on a separate branch, the only time when you have to deal with a possible merge conflict is when you are merging your changes into develop - your own branches are "private" and you don't have to worry about hitting a conflict if you quickly want to commit and push your changes as the last thing you do before going home at the end of a long day's work.</p>
<h2 id="pull-requests"><a class="header" href="#pull-requests">Pull requests</a></h2>
<p>Pull requests are not a feature of the git software itself, but of the online providers. They let a team discuss and review a commit before merging it into a shared branch such as develop or main. Depending on the provider, branches can also be protected or assigned owners so that only the branch owner or developers with the right permissions can commit on certain branches.</p>
<p>The procedure for merging with a pull request on github, which you should try out:</p>
<ul>
<li>Commit and push your feature branch.</li>
<li>On github.com in your repository, choose <em>Pull Requests</em> in the top bar, then <em>New Pull Request</em> .</li>
<li>Set the <em>base</em> branch as the one you want to merge into, e.g. develop, and the <em>compare</em> branch as the one with your changes. Select <em>Create Pull Request</em>.</li>
<li>Add a title and description to start a discussion, then press <em>Create Pull Request</em> again to create the request.</li>
</ul>
<p>Anyone in the team can now go to <em>Pull Requests</em> in the top bar of the repository page and see the open requests. You can either comment on them, or if it is your role in the team to approve the request for this branch, you can approve the pull request which creates a merge.</p>
<p>Since a pull request is linked to a branch, you can use it for code review as follows:</p>
<ol>
<li>A developer creates a feature branch and submits a pull request.</li>
<li>The reviewer looks at the request. If they find bugs or other problems, they add a comment to the discussion.</li>
<li>The developer can address reviewer comments by making a new commit on their feature branch and pushing it, which automatically gets added to the discussion.</li>
<li>When the reviewer is happy, they approve the request which merges the latest version of the feature branch into the base branch (for example <code>develop</code>).</li>
</ol>
<p>There is just one complication left. Suppose the following happens:</p>
<ul>
<li>Your project starts out with commit <code>develop-1</code> setting up the initial version of the develop branch. Imagine there are two files, A and B.</li>
<li>You create a feature branch and make a commit <code>feature-1</code> which changes only file B.</li>
<li>In the meantime, someone else makes a feature that changes file A, and merges it as <code>develop-2</code> to the develop branch.</li>
</ul>
<p>You are now in the situation that <code>develop-2</code> has (new A, old B) and your <code>feature-1</code> has (old A, new B). Neither of these is what you want, you presumably want (new A, new B). We have met this situation before, but without branches. Graphically:</p>
<p><img src="git/../resources/pr-before-rebase.png" alt="diagram of commits before rebase" /></p>
<p>The solution here is to <em>rebase</em> your branch onto the latest commit on develop with <code>git rebase develop</code> and fix any conflicts that that causes, which produces the following situation:</p>
<p><img src="git/../resources/pr-after-rebase.png" alt="diagram of commits after rebase" /></p>
<p>If you now try and push your feature branch, you might get an error because the version of your feature branch on the origin repository still has the old version. The solution here is to force the push, which overwrites the old version, with</p>
<pre><code>git push --force origin BRANCHNAME
</code></pre>
<p>This is a <em>think before you type</em> kind of command because it can break things for other developers if you do it on a shared branch. The basic safety rules are:</p>
<ul>
<li>Only rebase on <em>private</em> branches.</li>
<li>Only force push on <em>private</em> branches, and only if it is absolutely necessary (for example to tidy up a rebase).</li>
</ul>
<p>A private branch is one that you know no-one else is working on, for example your own feature branches.</p>
<p>If you ever get into a situation where you need to rebase or force push on a shared branch such as develop or main, you generally need to make sure that everyone on the team knows what is going on, synchronises their repositories both before and after the dangerous operation, and does not make any commits or pushes while someone is working on it - basically they need, in concurrency terms, an exclusive lock on the whole repository while doing this operation.</p>
<p>This is one reason why the main and develop branches are kept separate - and some workflows even include a third branch called <code>release</code>. If merges into main or release only ever come from the develop branch, then a situation where you need to rebase these branches can never happen.</p>
<p>To summarise, the pull request workflow is:</p>
<ol>
<li>Commit and push your changes.</li>
<li>If necessary, rebase your feature branch on the develop branch.</li>
<li>Create a pull request.</li>
<li>If necessary, participate in a discussion or review and make extra commits to address points that other developers have raised.</li>
<li>Someone - usually not the developer who created the pull request - approves it, creating a merge commit in develop (or main).</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="shell-scripting"><a class="header" href="#shell-scripting">Shell Scripting</a></h1>
<h2 id="videos-3"><a class="header" href="#videos-3">Videos</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/71b186df-c373-4b98-ba34-035679cb1ec6">Permissions</a></td><td style="text-align: right">20 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EUQ3xxCL4xlHtQ1M6uaLdW4Bc2sxbrCrLNQcinAUgCjmOg?e=ciQDX2">slides</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/bbe017bf-c1b6-44a0-96cf-ef79a9b17f0e">shell scripting 1</a></td><td style="text-align: right">17 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/Ebuz7SukPjRLhMYQd3NJRkkBhgkFxVutnYmcv622ePSxkg?e=8hhLWP">slides</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/0a2a65bc-1655-4089-984f-53c9400dc2d3">shell scripting 2</a></td><td style="text-align: right">21 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EVMTcoOLqmVNiflYUpHfRhMB1XzttL_7gHYOux1qznX4ZA?e=mXRBtE">slides</a></td></tr>
</tbody></table>
</div>
<h2 id="exercises-3"><a class="header" href="#exercises-3">Exercises</a></h2>
<ul>
<li><a href="posix3/./permissions.html">File permissions</a></li>
<li><a href="posix3/./script.html">Shell scripting</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="file-permissions"><a class="header" href="#file-permissions">File permissions</a></h1>
<p>Log in to your Debian VM for the following exercises.</p>
<h2 id="create-a-user-and-a-group"><a class="header" href="#create-a-user-and-a-group">Create a user and a group</a></h2>
<p>Create a new user with <code>sudo adduser NAME</code> - I'm going to be using <code>brian</code> as an example name in these notes. When it asks for a password, you can just use <code>brian</code> or something; it will complain about the password being too short but it will create the user anyway. You can skip the GECOS information asking for a full name and phone number---it's just to help an admin contact you if needed.</p>
<p>Check the user and group files with <code>tail /etc/passwd</code> and <code>tail /etc/group</code> to check that the new user has been created - <code>tail</code> displays the last 10 lines of a file by default; <code>tail -n N FILE</code> would display the last N lines. Your new user <code>brian</code> (or whatever you called them) should appear in both files. Also check with <code>ls -l /home</code> that the home directory for Brian exists and is set to the correct user and group.</p>
<p>Time to change user: <code>su brian</code> and enter the password. Notice that the prompt has changed to <code>brian@debian12:/home/vagrant$</code> (at least if you started off in that folder). So the user has changed, and because <code>/home/vagrant</code> is no longer the current user's home directory, it gets written out in full. Run <code>cd</code> to go home followed by <code>pwd</code> and check that you are now in <code>/home/brian</code> or whatever you called your new user.</p>
<p>Next, create a user <code>nigel</code> (or some other name) add both your two new users, but not <code>vagrant</code>, to the group <code>users</code> (which already exists) using the command <code>sudo usermod -aG GROUPNAME USERNAME</code>, where group and username are changed accordingly. Note: <code>brian</code> cannot use sudo, so you have to exit his terminal to get back to one running as vagrant for this.</p>
<h2 id="explore-file-permissions"><a class="header" href="#explore-file-permissions">Explore file permissions</a></h2>
<p>As user <code>brian</code> (or whatever you called your first new user), set up your home directory using what you learnt in the videos so that</p>
<ul>
<li>You can do everything (rwx).</li>
<li>Members of the <code>users</code> group can list files and change to your home directory, but not add/remove files. You will need to change the group of your home directory to <code>users</code> for this, using the command <code>chgrp -R GROUPNAME DIRECTORY</code>.</li>
<li>Everyone else cannot do anything with your home directory.</li>
</ul>
<p>Create a file in your home directory, e.g. <code>nano readme.txt</code> then add some content.</p>
<p>Check, by using <code>su USERNAME</code> to log in as the different users, that:</p>
<ul>
<li><code>nigel</code> can view Brian's home directory but not create files there;</li>
<li><code>nigel</code> can view but not edit Brian's readme file;</li>
<li><code>vagrant</code> cannot list files in or enter Brian's home directory at all. What happens when you try?</li>
</ul>
<p><em>Of course, vagrant can use sudo to get around all these restrictions. Permissions do not protect you from anyone who can become root.</em></p>
<p>Also as <code>brian</code>, make a <code>private</code> subdirectory in your home folder that no-one but you can access (read, write or execute). Create a file <code>secret.txt</code> in there with <code>nano private/secret.txt</code> as user <code>brian</code> from Brian's home directory, and put something in it. Do not change any permissions on <code>secret.txt</code> itself.</p>
<p>Check as Nigel that you can see the folder itself, but not cd into it nor list the file. Check that even knowing the file name (<code>cat /home/brian/private/secret.txt</code>) as Nigel doesn't work.</p>
<p>Using <code>ls -l</code> as Brian in both <code>~</code> and <code>~/private</code>, compare the entries for the files <code>~/readme.txt</code>, <code>~/private/secret.txt</code> and the folder <code>~/private</code>. Why do the groups of the two files differ?</p>
<p>Note that, even though the secret file has read permissions for everyone by default, Nigel cannot read it. The rule is that you need permissions on the whole path from <code>/</code> to a file to be able to access it.</p>
<p><em>This is another reminder that if you want to store private files on a lab machine, then put it in a folder that is only accessible to you. Other students can read your home directory by default, and they would be able to look at your work. This has led to plagiarism problems in the past, but good news: we keep logs and can usually figure out what happened! <code>:-)</code>.</em></p>
<p><em>Altenatively you could remove permissions from everyone else on your home directory there, but this prevents you from being able to share files in specific folders that you do want to share with other students.</em></p>
<h2 id="setuid"><a class="header" href="#setuid">Setuid</a></h2>
<p>We are going to create a file to let Nigel (and others in the users group) send Brian messages which go in a file in his home directory.</p>
<p>As Brian, create a file <code>message-brian.c</code> in your home directory and add the following lines:</p>
<pre><code class="language-C">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

const char *filename ="/home/brian/messages.txt";

int main(int argc, char **argv) {
  if (argc != 2) {
    puts("Usage: message-brian MESSAGE");
    return 1;
  }
  FILE *file = fopen(filename, "a");
  if (file == NULL) {
    puts("Error opening file");
    return 2;
  }
  int r = fputs(argv[1], file);
  if (r == EOF) {
    puts("Error writing message");
    return 2;
  }
  r = fputc('\n', file);
  if (r == EOF) {
    puts("Error writing newline");
    return 2;
  }
  fclose(file);
  return 0;
}
</code></pre>
<p>Compile it with <code>gcc -Wall message-brian.c -o message-brian</code> (you should not get any warnings) and check with <code>ls -l</code>, you will see a line like</p>
<pre><code>-rwxr-xr-x    1 brian     brian         19984 Oct 28 13:26 message-brian
</code></pre>
<p>These are the default permissions for a newly created executable file; note that gcc has set the three <code>+x</code> bits for you. Still as Brian, run <code>chmod u+s message-brian</code> and check the file again: you should now see <code>-rwsr-xr-x</code> for the file permissions. The <code>s</code> is the setuid bit.</p>
<p>As Nigel (<code>su nigel</code>), go into Brian's home directory and run <code>./message-brian "Hi from Nigel!"</code>. The quotes are needed here because the program accepts only a single argument.</p>
<p>Now run <code>ls -l</code> and notice that a <code>messages.txt</code> has appeared with owner and group <code>brian</code>. Check the contents with <code>cat messages.txt</code>. Although Nigel cannot create and edit files in Brian's home directory himself (he can't edit <code>messages.txt</code> for example, although he can read it), the program <code>message-brian</code> ran as Brian, which let it create the file. Nigel can send another message like this (<code>./message-brian "Hi again!"</code>), which gets appended to the file: try this out.</p>
<p>This shows how setuid programs can be used to allow other users to selectively perform specific tasks under a different user account.</p>
<p><strong>Warning</strong>: writing your own setuid programs is extremely dangerous if you don't know the basics of secure coding and hacking C programs, because a bug in such a program could let someone take over your user account. The absolute minimum you should know is the contents of our security units up to and including 4th year.</p>
<p>A general task for a security analyst might be finding all files with the setuid bit set on a system. You can try this yourself, but return to a vagrant shell first so that you're allowed to use sudo:</p>
<pre><code>sudo find / -perm /4000
</code></pre>
<p>You might get some errors relating to <code>/proc</code> files, which you can ignore: these are subprocesses that find uses to look at individual files.</p>
<p>Apart from <code>message-brian</code>, you'll find a few files by default: <code>sudo</code>, <code>mount</code>, <code>umount</code> and <code>su</code>. The first one you already know; look up what the next two do and think about why they are setuid. Specifically, what kinds of (un)mounting are non-root users allowed to do according to the manual pages?</p>
<p>Look up the <code>passwd</code> program in the manual pages.  Why might that program need to be setuid?</p>
<h2 id="sudo"><a class="header" href="#sudo">Sudo</a></h2>
<p>Make sure your terminal is running as <code>brian</code> and try a <code>sudo ls</code>. You will see a general message, you will be asked for your password, and then you will get the error <code>brian is not in the sudoers file.  This incident will be reported.</code> (This means that an entry has been logged in <code>/var/log/messages</code>.)</p>
<p>So, <code>brian</code> can currently not use sudo. Switch back to <code>vagrant</code> and run the command <code>sudo cat /etc/sudoers</code>. Everything is commented out except <code>root ALL=(ALL) ALL</code> and the last line <code>#includedir /etc/sudoers.d</code> (this is not a comment!) which contains a single file <code>vagrant</code> with the line <code>vagrant ALL=(ALL) NOPASSWD: ALL</code> which is why vagrant can use sudo in the first place.</p>
<p>However, note the commented lines such as</p>
<pre><code># %wheel ALL=(ALL) NOPASSWD: ALL
# %sudo ALL=(ALL) ALL
</code></pre>
<p>If uncommented, the first one would let everyone in group wheel run commands using sudo (this is the default on some other linux distributions), whereas the second one would allow everyone in the group <code>sudo</code> to do this, but would prompt for their own password beforehand.</p>
<p>Let's allow people in the users group to reboot the machine. Open a root shell with <code>sudo su</code> as vagrant; this is so we don't get locked out if we break sudo.</p>
<p>Edit the sudoers file with <code>visudo</code> as root, and add the following line:</p>
<pre><code>%users ALL=(ALL) /sbin/reboot
</code></pre>
<p>and save the sudoers file.</p>
<p><strong>Warning:</strong>: Never edit <code>/etc/sudoers</code> directly and <em>always</em> use <code>visudo</code> instead.  If you make a mistake and add a syntax error to the file then <code>sudo</code> will refuse to work.  If your root account doesn't have a password (some people don't like that as a security precaution) then you'll have to spend the next half-hour figuring out how to break into your own computer and wrestle back control.  There is almost always a command to check a config file before replacing the current one: the same advice also applies to the ssh config files.  If you break them you might have to travel to wherever the server is with a keyboard and a monitor.</p>
<p>You can now switch back to <code>brian</code> (check the prompt to make sure you are Brian) and do <code>sudo reboot</code>. After asking for Brian's password, the virtual machine will now reboot, which you notice because you get kicked out of your ssh connection. Another <code>vagrant ssh</code> after a few seconds will get you back in again.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>After rebooting, your <code>/vagrant</code> shared folder might not work. In this case, log out and do <code>vagrant halt</code> then <code>vagrant up</code> and <code>vagrant ssh</code> again on the host machine.</p>
<p>When vagrant boots your VM, it automatically sets up the shared folder, but this doesn't always work if you reboot the VM yourself.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="shell-scripting-1"><a class="header" href="#shell-scripting-1">Shell Scripting</a></h1>
<p>Shell scripting is a huge topic - the shell is a full programming language after all.
In the video for this activity you have only seen a very brief introduction.</p>
<h2 id="compile-helper-exercise"><a class="header" href="#compile-helper-exercise">Compile helper exercise</a></h2>
<p>Write a shell script in a file called <code>b</code> (for build) that does the following:</p>
<ul>
<li>Your script should run under any Bourne-compatible shell (e.g. not just <code>bash</code>), and it should be written so that you can call it with <code>./b</code>.</li>
<li><code>./b compile NAME</code> should compile the file of the given name, so for example <code>./b compile hello</code> should run <code>gcc -Wall -std=c11 -g hello.c -o hello</code>.</li>
<li>However, your script should accept both <code>./b compile hello</code> and <code>./b compile hello.c</code> as input, and do the same thing in both cases, namely compile <code>hello.c</code>. The output file for gcc in both cases should be called just <code>hello</code>.</li>
<li>If the source file you provided as an argument does not exist (adding <code>.c</code> if necessary) then the script should print an error message and return a nonzero exit status - <em>not</em> invoke the C compiler.</li>
<li><code>./b run NAME</code> should run the program, assuming it exists in the current folder, so both <code>./b run hello</code> and <code>./b run hello.c</code> should run <code>./hello</code>. If it does not exist, again print an error message and exit with a nonzero status, don't try and run the program.</li>
<li><code>./b build NAME</code> should first compile the C source file, and then if the compile was successful it should run the program. If the compile failed, it should not try and run the program.</li>
<li>If you call <code>./b</code> without any parameters, or <code>./b COMMAND</code> with a command other than compile or run or build, it should print some information on how to use it. If you call <code>./b compile</code> or another command with no filename at all, then the script should print an error message and exit with a nonzero exit status.</li>
</ul>
<p>You now have a useful tool for when you are developing C programs. Of course you can add other features of your own like a <code>debug</code> command that compiles the file and launches it in <code>gdb</code>.</p>
<p><em>If you already know about makefiles, you might wonder why we don't just use <code>make</code> for this. You are correct, but this is specifically a shell scripting exercise. We will learn about makefiles soon.</em></p>
<h2 id="strict-mode"><a class="header" href="#strict-mode">Strict Mode</a></h2>
<p>Some programming languages have an optional <em>strict mode</em> which treats some constructs as errors that people often do by mistake. It is similar in spirit to <code>-Werror</code> in C that treats all warnings as errors. <a href="http://redsymbol.net/articles/unofficial-bash-strict-mode/">This page</a> suggests using the following line near the top of your shell scripts: <code>set -euo pipefail</code>. (It also talks about IFS to improve string handling with spaces, but that's a separate matter.)</p>
<p>You might want to use these yourself if you get into shell scripting. <code>set</code> is a shell internal command that sets shell flags which controls how commands are run.</p>
<ul>
<li><code>set -e</code> makes the whole script exit if any command fails. This way, if you want to run a list of commands, you can just put them in a script with <code>set -e</code> at the top, and as long as all the commands succeed (return 0), the shell will carry on; it will stop running any further if any command returns nonzero. It is like putting <code>|| exit $?</code> on the end of every command.</li>
<li><code>set -u</code> means referencing an undefined variable is an error. This is good practice for lots of reasons.</li>
<li><code>set -o pipefail</code> changes how pipes work: normally, the return value of a pipe is that of the <em>last</em> command in the pipe. With the <code>pipefail</code> option, if any command in the pipeline fails (non-zero return) then the pipeline returns that command's exit code.</li>
</ul>
<p>A couple of notes on <code>set -u</code>: if you write something like <code>rm -rf $FOLDER/</code> and <code>$FOLDER</code> isn't set, then you don't accidentally end up deleting the whole system! Of course, most <code>rm</code> implementations will refuse to delete <code>/</code> without the <code>--no-preserve-root</code> option, and you should not have that trailing slash in the first place. There was a <a href="https://drj11.wordpress.com/2015/01/20/steaming/">bug in a beta version of Steam for linux</a> where it tried to do <code>rm -rf "$STEAMROOT/"*</code> to delete all files in a folder (which explains the slash), but the variable in some cases got set to the <em>empty string</em>, which <code>-u</code> would not protect against. This was an installer script, so it ran as root which made things even worse.</p>
<p><strong>Exercise</strong>: think of an example in a shell script where <code>pipefail</code> makes a difference, that is where the last command in a pipe could succeed even if a previous one fails. As a counter-example, <code>cat FILE | grep STRING</code> would fail even without <code>pipefail</code> if the file does not exist, because grep would immediately get end-of-file on standard input.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-tools-2"><a class="header" href="#build-tools-2">Build Tools 2</a></h1>
<h2 id="videos-4"><a class="header" href="#videos-4">Videos</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/48cac422-9b33-4630-8c85-517f1f7cd619">Build Tools 1</a></td><td style="text-align: right">17 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EfuDdA92T65GqK6H_89K9IYBaFKiwvRwj7F-unUeP2iB1Q?e=TlIwVN">slides</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/0edff26c-c5ee-4ac6-9ea8-42238d98a4f1">Build Tools 2</a></td><td style="text-align: right">12 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EYzpCf0Y0pBNvGLdeJ3bHHcBZBE7HULs1h8lCNA_NIw1XQ?e=lK2prk">slides</a></td></tr>
</tbody></table>
</div>
<h2 id="exercises-4"><a class="header" href="#exercises-4">Exercises</a></h2>
<ul>
<li><a href="build2/c.html">C</a></li>
<li><a href="build2/python.html">Python</a></li>
<li><a href="build2/java.html">Java</a></li>
<li><a href="build2/spring.html">Spring</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-tools-c"><a class="header" href="#build-tools-c">Build tools: C</a></h1>
<p>In this exercise you will practice the traditional way of building C projects from source. We are going to use the sqlite database as an example project to build.</p>
<p>Download the source file <a href="https://sqlite.org/2021/sqlite-autoconf-3340100.tar.gz">https://sqlite.org/2021/sqlite-autoconf-3340100.tar.gz</a> into your VM with <code>wget</code> or similar and extract it with <code>tar -zxvf FILENAME</code>. This creates a subfolder, do a <code>cd</code> into it.</p>
<p>You can see a file called <code>INSTALL</code> which you can open in a text editor to find the standard instructions:</p>
<blockquote>
<p>Briefly, the shell commands <code>./configure; make; make install</code> should configure, build, and install this package.</p>
</blockquote>
<h2 id="configure"><a class="header" href="#configure">Configure</a></h2>
<p>If you look at the first line of the configure script, it starts <code>#! /bin/sh</code> as that path should be valid on just about any vaguely posix-compatible system. The whole thing is just over 16000 lines, so you don't want to read all of it.</p>
<p>Run the script with <code>./configure</code>. You can see that it does a lot of checking, including things like:</p>
<ul>
<li>Whether your system has a C compiler.</li>
<li>Whether your C compiler is gcc.</li>
<li>Whether your C compiler actually works.</li>
<li>Whether standard headers like <code>string.h</code> or <code>stdlib.h</code> exist.</li>
<li>Whether the readline library is installed on your system.</li>
</ul>
<p>Your configure script should run through and print <code>creating Makefile</code> on one of its last lines.</p>
<p>The configure script is basically a collection of tests for every single bug and oddity found on any system known to the autoconf developers that could break the build. For example, someone once reported a bug in a build on Sun OS 4 (released in 1988), so in lines 2422 and following of the configure script we read</p>
<blockquote>
<p><code># Use test -z because SunOS4 sh mishandles braces in ${var-val}.</code></p>
<p><code># It thinks the first close brace ends the variable substitution.</code></p>
<p><code>test -z "$INSTALL_PROGRAM" &amp;&amp; INSTALL_PROGRAM='${INSTALL}'</code></p>
</blockquote>
<h2 id="make"><a class="header" href="#make">Make</a></h2>
<p>Type <code>make</code> to build sqlite. If it's not installed, <code>sudo apt install make</code> will fix that.</p>
<p>Some of the compiler commands might take a while to run. While they're running, note the number of configuration variables (everything passed with a <code>-D</code>) involved; some of them turn on/off features (for example readline support is off if it can't find the header files for it on your system) and some of them set options specific to the operating system and compiler, for example <code>-DHAVE_STRING_H</code> defines whether <code>string.h</code> exists on your system.</p>
<p>These translate to <code>#ifdef</code> commands in the source files, for example in <code>shell.c</code> starting at line 121 we include readline, if the header files exist:</p>
<pre><code>#if HAVE_READLINE
# include &lt;readline/readline.h&gt;
# include &lt;readline/history.h&gt;
#endif
</code></pre>
<p>The last command run by the makefile is</p>
<pre><code>gcc [lots of options] -g -O2 -o sqlite3 sqlite3-shell.o sqlite3-sqlite3.o -lreadline -lcurses
</code></pre>
<p>This should build an executable <code>sqlite3</code> that you can run (use <code>.q</code> to quit again).</p>
<p><em>If you want to, you can now type <code>sudo make install</code> to copy the executable to <code>/usr/local/bin</code>.</em></p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>What do you do if it says it can't find a <code>.h</code> file, or can't link it to a library file (a <code>.so</code>)? C predates modern languages with package managers, so it probably means you haven't installed a library the code depends on.  Luckily <code>apt-file</code> can be really helpful here:  run <code>apt-file search &lt;name of file&gt;</code> to find out which package provides the file you're missing and install it.</p>
<p>I was trying to build a package that was complaining it couldn't find a library <code>libffi.so</code>: what package might have provided it?</p>
<p>Try not to panic if the software you're building won't build cleanly!  Read the error message and fix the bug.  Normally installing a library, or altering a path in the source code is enough to fix it.  Being able to fix simple bugs yourself is what makes Linux (and other OSs) really powerful!</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-tools-python"><a class="header" href="#build-tools-python">Build tools: Python</a></h1>
<p>The Python programming language comes with a package manager called <code>pip</code>.  Find the package that provides it and install it (<strong>hint</strong>: how did we find a missing library in the C exercise?).</p>
<p>We are going to practice installing the <a href="https://github.com/miyuchina/mistletoe">mistletoe</a> module, which renders markdown into HTML.</p>
<ul>
<li>In python, try the line <code>import mistletoe</code> and notice that you get <code>ModuleNotFoundError: No module named 'mistletoe'</code>.</li>
<li>Quit python again (Control-D) and try <code>pip3 install --user mistletoe</code>. You should get a success message (and possibly a warning, explained below).</li>
<li>Open python again and repeat <code>import mistletoe</code>. This produces no output, so the module was loaded.</li>
</ul>
<p>Create a small sample markdown file as follows, called <code>hello.md</code> for example:</p>
<pre><code># Markdown Example

Markdown is a *markup* language.
</code></pre>
<p>Open python again and type the following. You need to indent the last line (four spaces is usual) and press ENTER twice at the end.</p>
<pre><code>import mistletoe
with open('hello.md', 'r') as file:
    mistletoe.markdown(file)
</code></pre>
<p>This should print the markdown rendered to HTML, e.g.</p>
<pre><code>&lt;h1&gt;Markdown Example&lt;/h1&gt;\n&lt;p&gt;Markdown is a &lt;em&gt;markup&lt;/em&gt; language.&lt;/p&gt;
</code></pre>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Python version 3 came out in 2008 and has some syntax changes compared
to Python 2 (<code>print "hello world"</code> became <code>print("hello world")</code>). Version 2 is now considered deprecated; but the transition
was <em>long</em> and <em>extremely painful</em> because changing the syntax of a
thing like the print statement leads to an awful lot of code breaking
and an awful lot of people preferring not to fix their code and
instead just keep an old version of Python installed.</p>
<p>So whilst we were dealing with this it was typical for a system to
have multiple versions of Python installed <code>python2</code> for the old one
and <code>python3</code> for the newer on (and even then these were often
symlinks to specific subversions like <code>python2.6</code>), and then <code>python</code>
being a symlink for whatever your OS considered to be the "supported" version.</p>
<p>Different OSs absolutely had different versions of Python (MacOS was
particularly egregious for staying with Python 2 for far longer than
necessary) and so a solution was needed, because this was just
breaking things while OS designers bickered.</p>
<p>The solution is that for <em>most</em> dependencies (except for compiled
libraries) we generally use a programming language's own package
manager and ignore what the OS provides.  For Python that means <code>pip</code>
(occasionally called <code>pip3</code> or <code>pip2</code>).</p>
<p>Sometimes you'll see things telling you to install a package with
<code>sudo pip install</code> but don't do that! It will break things horribly
eventually.  You can use pip without sudo, by passing the <code>--user</code>
option which installs packages into a folder in your home directory
(<code>~/.local</code>) instead of in <code>/usr</code> which normally requires root
permissions.</p>
<p>Sometimes you'll still need to install a package through the OSs
package manager (<code>numpy</code> and <code>scipy</code> are common because they depend on
an awful lot of C code and so are a pain to install with <code>pip</code> as you
have to fix the library paths and dependencies manually) but in
general try and avoid it.</p>
<p>Python used to manage your OS should be run by the system designers;
Python used for your dev work should be managed by you.  And never the
twain shall meet.</p>
</div>
</div>
<h2 id="scipy"><a class="header" href="#scipy">Scipy</a></h2>
<p>We often use <code>scipy</code> for statistics, so you may as well install that too. Unfortunately, <code>pip</code> will not help you here because scipy depends on a C library for fast linear algebra. You could go and install all the dependencies (and you might have to do this if you need a specific version of it), but it turns out Debian has it all packaged up as a system package: Try searching for it with <code>apt search scipy</code>.</p>
<p>The following commands show if it is correctly installed, by sampling 5 times from a Normal distribution with mean 200 and standard deviation 10:</p>
<pre><code>from scipy.stats import norm
norm(loc=200, scale=10).rvs(5)
</code></pre>
<p>This should print an array of five values that are not too far off 200 (to be precise, with about 95% confidence they will be between 180 and 220 - more on this in Maths B later on).</p>
<h2 id="avoiding-sudo"><a class="header" href="#avoiding-sudo">Avoiding sudo</a></h2>
<p>If you need to install libraries you might be tempted to install them for all users by using <code>sudo pip</code> but this can lead to pain!  If you alter the system libraries and something in the system depends on a specific version of a library then it can lead to horrible breakage and things not working (in particular on OSs like Mac OS which tend to update libraries less often).</p>
<p>Python comes with a mechanism called <a href="https://docs.python.org/3/library/venv.html">venv</a> which lets you create a virtual python install that is owned by a user: you can alter the libraries in that without <code>sudo</code> and without fear of mucking up your host system.  Read the docs and get used to using it---it'll save you a world of pain later!</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p><code>pip freeze | tee requirements.txt</code> will list all the packages your using and what version they are and save them in a file called <code>requirements.txt</code>.</p>
<p><code>pip install -r requirements.txt</code> will install them again!</p>
<p>This makes it <em>super easy</em> to ensure that someone looking at your code has all the right dependencies without having to reel off a list of <em>go install these libraries</em> (and will make anyone whoever has to mark your code happy and more inclined to give you marks).</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-tools-java"><a class="header" href="#build-tools-java">Build tools: Java</a></h1>
<p>In the Java world,</p>
<ul>
<li>The <code>javac</code> compiler turns source files (<code>.java</code>) into <code>.class</code> files;</li>
<li>The <code>jar</code> tool packs class files into <code>.jar</code> files;</li>
<li>The <code>java</code> command runs class files or jar files.</li>
</ul>
<p>A Java Runtime Environment (JRE) contains only the <code>java</code> command, which is all you need to run java applications if you don't want to do any development. Many operating systems allow you to double-click jar files (at least ones containing a special file called a <code>manifest</code>) to run them in a JRE.</p>
<p>A Java Development Kit (JDK) contains the <code>javac</code> and <code>jar</code> tools as well as a JRE. This is what you need to develop in java.</p>
<p><code>maven</code> is a Java package manager and build tool. It is not part of the Java distribution, so you will need to install it separately.</p>
<p>You can do this exercise either in your VM, or on your own machine where you have probably already installed Java for the OOP/Algorithms unit, and you can use your favourite editor. The exercises should work exactly the same way in both cases, there is nothing POSIX-specific here.</p>
<h2 id="installing-on-debian"><a class="header" href="#installing-on-debian">Installing on Debian</a></h2>
<p>On Debian, install the <code>openjdk-17-jdk</code> and <code>maven</code> packages. This
should set things up so you're ready to go but if you have <em>multiple
versions</em> of Java installed you may need to set the <code>JAVA_HOME</code> and
<code>PATH</code> variables to point to your install.</p>
<p>For example:</p>
<pre><code class="language-sh">export JAVA_HOME='/usr/lib/jvm/java-17-openjdk'
export PATH="${PATH}:${JAVA_HOME}/bin"
</code></pre>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Debian also has a special command called <code>update-alternatives</code> that
can help manage alternative development environments for you.  Read
the manual page!</p>
</div>
</div>
<h2 id="installing-on-your-own-machine-1"><a class="header" href="#installing-on-your-own-machine-1">Installing on your own machine</a></h2>
<p>Use whatever package manager your OS comes with.  If you can't and
have to install it manually:</p>
<ul>
<li>download the <a href="http://openjdk.java.net/">OpenJDK</a> distribution</li>
<li>unzip it somewhere</li>
<li>add the binaries folder to your <code>PATH</code></li>
<li>set the <code>JAVA_HOME</code> variable to point to the folder where you unzipped the JDK.</li>
</ul>
<p>To install maven, <a href="https://maven.apache.org/install.html">follow these instructions</a> which again involve downloading a ZIP file, unzipping it somewhere and then putting the <code>bin</code> subfolder on your <code>PATH</code>.</p>
<p>Note: <code>JAVA_HOME</code> must be set correctly for maven to work.</p>
<h2 id="running-maven"><a class="header" href="#running-maven">Running maven</a></h2>
<p>Open a shell and type <code>mvn archetype:generate</code>. This lets you <em>generate an artifact from an archetype</em>, which is maven-speak for create a new folder with a maven file.</p>
<p><em>If you get a "not found" error, then most likely the maven <code>bin</code>
folder is not on your path. If you're on a POSIX system and have used
your package manager, this should be set up automatically, but if
you've downloaded and unzipped maven then you have to <code>export   PATH="$PATH:..."</code> where you replace the three dots with the path to
the folder, and preferably put that line in your <code>~/.profile</code> too.</em></p>
<p>|||advanced
On Windows, if you must user it, search online for instructions how
to set up the path variable, or you can drag-and-drop the <code>mvn.cmd</code>
file from an Explorer window into a Windows CMD terminal and it
should paste the full path, then press SPACE and enter the arguments
you want to pass.
|||</p>
<p>The first time you run it, maven will download a lot of libraries.</p>
<p>Maven will first show a list of all archetypes known to humankind (3046 at the time of counting) but you can just press ENTER to use the default, 2098 ("quickstart"). Maven now asks you for the version to use, press ENTER again.</p>
<p>You now have to enter the triple of (groupId, artifactId, version) for your project - it doesn't really matter but I suggest the following:</p>
<pre><code>groupId: org.example
artifactId: project
version: 0.1
</code></pre>
<p>Just press ENTER again for the following questions, until you get a success message.</p>
<p>Maven has created a folder named after your artifactId, but you can move and rename it if you want and maven won't mind as long as you run it from inside the folder. Use <code>cd project</code> or whatever you called it to go inside the folder.</p>
<p>If you're in a POSIX shell, then <code>find .</code> should show everything in the folder (in Windows, <code>start .</code> opens it in Explorer instead):</p>
<pre><code>.
./src
./src/main
./src/main/java
./src/main/java/org
./src/main/java/org/example
./src/main/java/org/example/App.java
./src/test
./src/test/java
./src/test/java/org
./src/test/java/org/example
./src/test/java/org/example/AppTest.java
./pom.xml
</code></pre>
<p>This is the standard maven folder structure. Your java sources live under <code>src/main/java</code>, and the default package name is <code>org.example</code> or whatever you put as your groupId so the main file is currently <code>src/main/java/org/example/App.java</code>. Since it's common to develop Java from inside an IDE or an editor with "folding" for paths (such as VS code), this folder structure is not a problem, although it's a bit clunky on the terminal.</p>
<h2 id="the-pom-file"><a class="header" href="#the-pom-file">The POM file</a></h2>
<p>Have a look at <code>pom.xml</code> in an editor. The important parts you need to know about are:</p>
<p>The artifact's identifier (group id, artifact id, version):</p>
<pre><code class="language-xml">&lt;groupId&gt;org.example&lt;/groupId&gt;
&lt;artifactId&gt;project&lt;/artifactId&gt;
&lt;version&gt;0.1&lt;/version&gt;
</code></pre>
<p>The build properties determine what version of Java to compile against (by passing a flag to the compiler). Unfortunately, the default maven template seems to go with version 7 (which for complicated reasons is called 1.7), but version 8 was released back in 2014 which is stable enough for us, so please change the 1.7 to 1.8 (there are some major changes from version 9 onwards, which I won't go into here):</p>
<pre><code class="language-xml">&lt;properties&gt;
    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;
    &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;
&lt;/properties&gt;
</code></pre>
<p>The dependencies section is where you add libraries you want to use. By default, your project uses <code>junit</code>, a unit testing framework - note that this is declared with <code>&lt;scope&gt;test&lt;/scope&gt;</code> to say that it's only used for tests, not the project itself. You do not add this line when declaring your project's real dependencies.</p>
<pre><code class="language-xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;junit&lt;/groupId&gt;
        &lt;artifactId&gt;junit&lt;/artifactId&gt;
        &lt;version&gt;4.11&lt;/version&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>The <code>&lt;plugins&gt;</code> section contains the plugins that maven uses to compile and build your project. This section isn't mandatory, but it's included to "lock" the plugins to a particular version so that if a new version of a plugin is released, that doesn't change how your build works.</p>
<p>The one thing you should add here is the <code>exec-maven-plugin</code> as follows, so that you can actually run your project:</p>
<pre><code class="language-xml">&lt;plugin&gt;
    &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
    &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;3.0.0&lt;/version&gt;
    &lt;configuration&gt;
        &lt;mainClass&gt;org.example.App&lt;/mainClass&gt;
    &lt;/configuration&gt;
&lt;/plugin&gt;
</code></pre>
<p>The important line is the <code>mainClass</code> which you set to the full name (with path components) of your class with the <code>main()</code> function.</p>
<h2 id="compile-run-and-develop"><a class="header" href="#compile-run-and-develop">Compile, run and develop</a></h2>
<p><code>mvn compile</code> compiles the project. The very first time you do this, it will download a lot of plugins, after that it will be pretty fast. Like <code>make</code>, it only compiles files that have changed since the last run, but if this ever gets out of sync (for example because you cancelled a compile halfway through) then <code>mvn clean</code> will remove all compiled files so the next compile will rebuild everything.</p>
<p>The <code>App.java</code> file contains a basic "Hello World!" program (have a look at this file). You can run the compiled project with <code>mvn exec:java</code> if you've set up the plugin as above. After you've run it the first time and it's downloaded all the files it needs, lines coming from maven itself will start with <code>[INFO]</code> or <code>[ERROR]</code> or similar, so lines without any prefix like that are printed by your program itself. You should see the hello world message on your screen.</p>
<p>The development workflow is now as follows: you make your edits, then run <code>mvn compile test exec:java</code> to recompile, run your tests, then run the program. (Like <code>make</code>, you can put more than one target on a command, separated by spaces.)</p>
<p><code>mvn test</code> runs the tests in <code>src/test/java</code>. There is an example test already created for you (have a look).</p>
<p><code>mvn package</code> creates a jar file of your project in the <code>target/</code> folder.</p>
<p>I assume that you will be storing your Java projects in git repositories. In this case, you should create a file <code>.gitignore</code> in the same folder as the <code>pom.xml</code> and add the line <code>target/</code> to it, since you don't want the compiled classes and other temporary files and build reports in the repository. The <code>src/</code> folder, the <code>pom.xml</code> and the <code>.gitignore</code> file itself should all be checked in to the repository.</p>
<p><em>Exercise: make a change to the Java source code, then recompile and run with maven.</em></p>
<h2 id="adding-a-dependency"><a class="header" href="#adding-a-dependency">Adding a dependency</a></h2>
<p><a href="https://www.thymeleaf.org/">Thymeleaf</a> is a Java templating library. It lets you write a template file or string for example (depending on the syntax of your library)</p>
<pre><code>Hello, ${name}!
</code></pre>
<p>which you can later render with a particular name value. This is one of the standard ways of creating web applications, for example to display someone's profile page you would write a page template that takes care of the layout, styles, links etc. but uses template variables for the fields (name, email, photo etc.) which you render when someone accesses the profile page for a particular person. You will see this in more detail in your SPE project next year.</p>
<p>To use Thymeleaf or any other library, you first have to add it to your pom file. Go to <a href="https://mvnrepository.org">mvnrepository.org</a> and search for Thymeleaf, then find the latest stable ("release") version. There is a box where you can copy the <code>&lt;dependency&gt;</code> block to paste in your pom file. The next <code>mvn compile</code> will download thymeleaf and all its dependencies.</p>
<p>Next, make a template file called <code>unit</code> in the folder <code>src/main/resources/templates</code> (you will have to create the folder first), and put the following lines in it:</p>
<pre><code>Unit: [(${name})]

In this unit, you will learn about:

[# th:each="topic: ${topics}"]
  - [(${topic})]
[/]
</code></pre>
<p>This is thymeleaf "text" syntax, where the first line renders the value of a variable and the third-from-last line is the template equivalent of a 'for' loop that renders its contents once for each element in a list (or other collection data structure).</p>
<p>Thymeleaf needs to know where to find its template files, and in this example we are going to demonstrate loading resources from the classpath because that is the correct way to work with resources in a java application (there are special considerations for web applications, but they usually end up using the classpath in the end anyway).</p>
<p>In your Java source file, you can now do the following. First, the imports you will need:</p>
<pre><code class="language-java">import java.util.List;
import java.util.Arrays;

import org.thymeleaf.TemplateEngine;
import org.thymeleaf.context.Context;
import org.thymeleaf.templatemode.TemplateMode;
import org.thymeleaf.templateresolver.ClassLoaderTemplateResolver;
</code></pre>
<p>And the code:</p>
<pre><code class="language-java">ClassLoaderTemplateResolver resolver = new ClassLoaderTemplateResolver();
resolver.setTemplateMode(TemplateMode.TEXT);
resolver.setPrefix("templates/");

TemplateEngine engine = new TemplateEngine();
engine.setTemplateResolver(resolver);

Context c = new Context();
c.setVariable("name", "Software Tools");
List&lt;String&gt; topics = Arrays.asList("Linux", "Git", "Maven");
c.setVariable("topics", topics);
String greeting = engine.process("unit", c);

System.out.println(greeting);
</code></pre>
<p>Compile and run this, and you should see:</p>
<pre><code>Unit: Software Tools

In this unit, you will learn about:

  - Linux
  - Git
  - Maven
</code></pre>
<p>Let's look at how the code works.</p>
<ol>
<li>A template resolver is a class that finds a template when you give it a name (here: "unit"). In this case we use a resolver that loads off the classpath, so we just have to put the template files somewhere under <code>src/main/resources</code>; we tell it that we want the template files treated as text (e.g. not HTML), and that the template files are in a subfolder called <code>templates</code>.</li>
<li>The template engine is the class that does the work of rendering the template, once the resolver has found the source file.</li>
<li>To render a template, you need a template name for the resolver to look up, and a context - an object on which you can set key/value parameters. In this case we're setting the key "name" to "Software Tools" and the key "topics" to a list of three topics. The names and types of keys obviously have to match what's in the template file.</li>
</ol>
<p><em>Exercise: rewrite this example to be a bit more object-oriented by creating a unit class:</em></p>
<pre><code class="language-java">public class Unit {
    private String name;
    private List&lt;String&gt; topics;
    public Unit(String name, List&lt;String&gt; topics) {
        this.name = name;
        this.topics = topics;
    }
    public String getName() { return this.name; }
    public List&lt;String&gt; getTopics() { return this.topics; }
}
</code></pre>
<p><em>You will still need one single <code>setVariable</code> call, and in the template the syntax <code>[(${unit.name})]</code> should translate into a call to the getter.</em></p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>More recent releases of Java have wonderful things called <code>records</code>
that make your life <em>a lot</em> easier.  All that above code translates to just:</p>
<pre><code class="language-java">public record Unit(String name, List&lt;String&gt; topics) {}
</code></pre>
<p>Unfortunately support for more recent Java releases is a bit spotty
(and worse in the <em>real</em> world).  You'll need to get rid of the
<code>maven.compiler.target</code> and <code>maven.compiler.source</code> bits you added in
your pom.xml and replace it with a new:</p>
<pre><code>&lt;maven.compiler.release&gt;17&lt;/maven.compiler.release&gt;
</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="spring"><a class="header" href="#spring">Spring</a></h1>
<p>The <a href="https://spring.io/">Spring framework</a> helps you develop modern
web / cloud / microservice / serverless / <em>(insert buzzword here)</em>
applications in Java. Netflix, for example, uses it.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Jo is cantankerous and old and so doesn't use it and prefers to
either use CGI scripts, or a rather weird old thing called inetd.
They're out of fashion nowadays, but worth reading up on---especially
inetd which can save you a bunch of code for a simple webapp.</p>
</div>
</div>
<h2 id="vagrant-preparation"><a class="header" href="#vagrant-preparation">Vagrant preparation</a></h2>
<p>Web applications listen to a port (normally TCP port 80 for HTTP, 443
for HTTPS in production; 8000 or 8080 while in development). If you
are following these exercises on your host OS, you can skip this
preparation. If you are in a VM on vagrant, then although you can quickly get an application to work on port 8080 inside the VM, you need one extra step to make it accessible from your browser outside the VM.</p>
<p>Add the line</p>
<pre><code>config.vm.network "forwarded_port", guest: 8080, host: 8080
</code></pre>
<p>to your Vagrantfile just below the <code>config.vm.box</code> line, then restart the VM by logging out and doing <code>vagrant halt</code> then <code>vagrant up</code>. Your firewall may pop up a warning and ask you to approve this.</p>
<p>Now, while the VM is running, any connection to port 8080 on your host OS will be sent to the VM (this also means that if you're doing web development on the host, you can't use port 8080 for anything else while the VM is up - if you need port 8080, just pick another port number for the <code>guest</code> part).</p>
<h2 id="spring-set-up"><a class="header" href="#spring-set-up">Spring set-up</a></h2>
<p>Spring wants to make setting up a project as easy as possible, so go to <a href="https://start.spring.io/">start.spring.io</a> and you get a graphical interface to create a spring/maven project.</p>
<ul>
<li>Pick "Maven Project" and "Java language".</li>
<li>Enter a group id and artifact id (you can use <code>org.example</code> and <code>project</code>).</li>
<li>Make sure "packaging" is on JAR and "Java" (version) is on 17 (or
whatever you have installed).</li>
<li>Under <em>Dependencies</em> on the right, click "Add Dependencies" and add "Spring Web".</li>
<li>Click "Generate" at the bottom, this downloads a ZIP of a project (complete with pom.xml file and folders) that you can unzip either on the host or in the VM.</li>
</ul>
<p>To unzip the file in the VM, place it in the same folder as your
Vagrantfile on the host, then inside the VM it will appear in the
<code>/vagrant</code> folder. The command <code>unzip</code> is your friend.  Install it if
not already installed.</p>
<p>This project uses Spring Boot, a library and plugin to help with building and running Spring applications, so the only maven command you need is</p>
<pre><code>mvn spring-boot:run
</code></pre>
<p>which will recompile if necessary, and then run the application. Once it's running, you can go to <a href="http://localhost:8080">localhost:8080</a> in a browser on your host OS (whether the Spring application is running on the host, or inside the VM as long as you've set up the port forwarding as described above). You will see an error message as there's no pages yet, but the application is running. Stop it with Control+C.</p>
<h2 id="development"><a class="header" href="#development">Development</a></h2>
<p>Open the source file under <code>src/main/java/...</code>. I called mine "project" so the class is <code>ProjectApplication</code>, but the name doesn't matter.</p>
<ul>
<li>Add the <code>@RestController</code> annotation to the application class.</li>
<li>Create a method as follows:</li>
</ul>
<pre><code class="language-java">@GetMapping("/")
public String mainPage() {
    return "Hello, Software Tools!\n";    
}
</code></pre>
<ul>
<li>Add the imports for the two annotations you've just used; they're both in the package <code>org.springframework.web.bind.annotation</code>.</li>
</ul>
<p>Now you can re-run the project with maven, go to <code>localhost:8080</code> on your browser and you should see the message. Congratulations - you've built your first Java/Maven/Spring web application!</p>
<p><em>You can also access the web page from the terminal on your host machine with <code>wget localhost:8080 -q -O /dev/stdout</code> which should print "Hello, Software Tools!" on your terminal. If you just do <code>wget localhost:8080</code> it will save the output to a file with the default name <code>index.html</code>.</em></p>
<p>The <code>@GetMapping</code> means, when a HTTP GET request comes in for a URL with the path in the annotation (such as a browser would send), then run this function. For example, accessing <code>localhost:8080/pages/index.html</code> would look for a mapping <code>/pages/index.html</code> where as the <code>/</code> mapping covers when you type no path at all. You can start to see that URL paths on the web are modelled on POSIX paths as you learnt in this unit, with forward slashes and a concept of a "root folder" <code>/</code> which is what gets returned when you type a website's name in your browser without a path on the end.</p>
<p>You've seen that build tools like maven automate the process of downloading the libraries your project needs and compiling your project. The Spring Framework automates (as far as possible) the process of running these libraries when your application starts, and getting them all to work nicely together (there is a <em>lot</em> going on in the background from a web request arriving to your function being called to get the page contents).
The obvious next step would be to use thymeleaf to render HTML templates to make proper pages. This is indeed something you'll learn about later in this unit, but there are a few more steps you'll need to know to do this - and that's quite enough material for one workshop.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-tools-1"><a class="header" href="#build-tools-1">Build Tools 1</a></h1>
<h2 id="videos-5"><a class="header" href="#videos-5">Videos</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/10926ab8-e10e-43b4-b486-495ce9f775c2">Debugging</a></td><td style="text-align: right">34 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EX0-s0boltxDq0oNPgudC40BsWc1PnK6pEWXJuRabPQnHA?e=ccd8Gh">slides</a></td></tr>
</tbody></table>
</div>
<h2 id="exercise"><a class="header" href="#exercise">Exercise</a></h2>
<ul>
<li><a href="build1/./exercise.html">Debugging exercise</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="debugging-exercise"><a class="header" href="#debugging-exercise">Debugging exercise</a></h1>
<p>Clone the repository <code>git@github.com:cs-uob/COMSM0085</code> if you have not done so already and open the folder <code>code/debugging</code>.</p>
<p>There is a program <code>stackcalc.c</code> that attempts to implement the specification in <code>stackcalc.txt</code> for a Reverse Polish Notation calculator, but it does not work correctly. For example, <code>1 2 +</code> should produce <code>3.0000</code> but produces <code>Error, operator on empty stack</code>. (Read the notes in the text file about how to compile the program with the required library.)</p>
<p>Your exercise is to debug and fix the program, making as few changes to the general structure as possible (so don't just rewrite the whole thing from scratch).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bonus-posix-activity"><a class="header" href="#bonus-posix-activity">Bonus POSIX Activity</a></h1>
<p><em>This activity is optional, and non-examinable. We recommend that you watch the videos anyway.</em></p>
<h2 id="videos-6"><a class="header" href="#videos-6">Videos</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/8f01c778-9ead-4e15-b5ad-21305dc96eba">inodes</a></td><td style="text-align: right">18 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EUke3KQirYBEtq809FUGEjMBKbE9VWpbn2q7t9T6KrnGAA?e=kX4ZY6">slides</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/bc1a7bdd-1f40-47e6-b86b-ec9eef84fe39">The TTY</a></td><td style="text-align: right">22 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EaUyN9P0dr5NoHkdvYGPRzkB2mR3hYuHqoJ4W1OqT1830w?e=YdPV0f">slides</a></td></tr>
</tbody></table>
</div>
<h2 id="exercises-5"><a class="header" href="#exercises-5">Exercises</a></h2>
<ul>
<li><a href="posix4/./stat.html">inodes and system calls</a></li>
<li><a href="posix4/./concurrent.html">Concurrent programming in POSIX</a></li>
<li><a href="posix4/./cpipe.html">Pipes in C</a></li>
<li><a href="posix4/./c_io.html">Input/Output in C</a></li>
<li><a href="posix4/./posix_io.html">Input/Output in POSIX</a></li>
<li><a href="posix4/./final.html">The final challenge</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="inodes-and-system-calls"><a class="header" href="#inodes-and-system-calls">Inodes and System Calls</a></h1>
<p>In this exercise we will look under the hood of the <code>stat</code> system call, which returns information about an inode.</p>
<p><em>Note: for this exercise it's even more important than usual that you are using Debian within Vagrant, as you will get different results if you try it on Windows Subsystem for Linux or on a Mac for example.</em></p>
<p>A system call is a way for a linux user or program to interact with the kernel, and there are usually at least three ways of calling each one:</p>
<ol>
<li>Execute the system call directly in assembly.</li>
<li>Use the wrapper function provided by your C library.</li>
<li>Use a command-line program provided by your distribution.</li>
</ol>
<h2 id="preparation"><a class="header" href="#preparation">Preparation</a></h2>
<p>Have a look at the manual page <code>man stat</code> for the <code>stat</code> system call. The abbreviated headers are:</p>
<pre><code class="language-C">#include &lt;sys/stat.h&gt;

int stat(const char *pathname, struct stat *statbuf);
int fstat(int fd, struct stat *statbuf);
int lstat(const char *pathname, struct stat *statbuf);
</code></pre>
<p><code>stat</code> is the main system call: you give it a pathname and it fills a <code>struct stat</code> for you with information about the inode associated with this pathname, however if the pathname is a symbolic link then it follows the link and returns information about the target inode. If you do not want this behaviour, you can use <code>lstat</code> instead.</p>
<p><code>fstat</code> takes an open file descriptor instead of a file name: this is fine for getting the inode information (in the kernel, a file descriptor contains an inode number) but you will not be able to get a file name back from this - remember, <em>files don't have names; names have files</em>.</p>
<p>Later in the manual page, it explains the <code>struct stat</code> contents. Let's have a look at the sources directly though:</p>
<ul>
<li><code>nano /usr/include/sys/stat.h</code> shows you the header file and the function definitions, including the bitmasks for the mode bits e.g. <code>#define S_IRUSR 0400</code> is the "user can read" bit and the file type bits e.g. <code>#define S_IFDIR 0040000</code>. Note, in C, numbers with a leading 0 are octal!</li>
<li>The definition of the <code>struct stat</code> is in another file included from <code>sys/stat.h</code>, namely <code>bits/stat.h</code>; open that in your editor too and have a look at it.</li>
<li>The types of the fields in the structure (<code>dev_t</code>) etc. are yet in another file - <code>bits/alltypes.h</code> if you're curious - but eventually they get defined as <code>long</code>, through intermediate definitions of <code>_Int64</code> etc. Basically, on a 64-bit machine, most of these fields are 64 bits.</li>
</ul>
<p>Run the following short C program to check the size of your <code>struct stat</code>; I get 144 bytes but note down if you get something different:</p>
<pre><code class="language-C">#include &lt;sys/stat.h&gt;
#include &lt;stdio.h&gt;
int main() {
    printf("Size: %lu bytes\n", sizeof(struct stat));
    return 0;
}
</code></pre>
<h2 id="the-assembly-level"><a class="header" href="#the-assembly-level">The assembly level</a></h2>
<p>Create a file with the following content - the convention for assembly files is usually to end in <code>.s</code>, so I've called mine <code>dostat.s</code>:</p>
<pre><code class="language-asm">.section .text
.global  _start

_start:
    mov $6,  %rax
    lea str, %rdi
    lea buf, %rsi
    syscall

    mov $60, %rax
    mov $0,  %rdi
    syscall

str: .asciz "/dev/stdin"

.section .data
buf: .skip 144
</code></pre>
<p>Change the 144 in the last line if you got a different size for your structure.</p>
<p>Let's see what's going on here:</p>
<ol>
<li><code>.section .text</code> is an assembly directive to say <em>the following is code</em>, more precisely <em>it goes in the code section (which we named 'text' for obscure historical reasons)</em>.</li>
<li><code>.global _start</code> says to export the label <code>_start</code> to the linker, which is the assembly version of <code>main</code>: in fact, C programs really start at <code>_start</code> too as you can check by setting a breakpoint on this label in a debugger, this function is part of the C library and it sets a few things up and then calls <code>main</code>. When you return from <code>main</code>, then <code>_start</code> does some cleanup and exits the program cleanly with the correct return value.</li>
<li>The way you invoke a system call is you put the system call number in the <code>rax</code> register, and parameters according to the platform convention - on Intel/AMD 64 bit, the first parameter goes in the <code>rdi</code> register, the second one in the <code>rsi</code> register. System calls and their parameters are documented <a href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">in this table</a> for example. Return values from system calls end up in the <code>rax</code> register again. Looking ahead a bit in our assembly code, system call 60 is <code>sys_exit</code> and takes an exit code in <code>rdi</code>, so the lines <code>mov $60, %rax; mov $0,  %rdi; syscall</code> are the equivalent of <code>return 0;</code> in a main function of a C program or <code>exit(0);</code> anywhere else (indeed, that is the last thing the C library <code>_start</code> will do when <code>main</code> returns to it).</li>
<li>System call 6 is <code>sys_lstat</code>, so the lines <code>mov $6,  %rax; lea str, %rdi; lea buf, %rsi; syscall</code> call <code>sys_lstat(str, buf)</code> where both <code>str</code> and <code>buf</code> are pointers. (<code>lea</code> stands for <em>load effective address</em> and is similar to the <code>&amp;var</code> address-of operator in C).</li>
<li><code>syscall</code> is an assembly instruction that hands control over to the operating system. It is comparable to a software interrupt as you might have learnt in Computer Architecture, but it is an optimised version (since many programs do a lot of system calls) that doesn't have the full overhead of the older interrupt mechanism on x86.</li>
<li><code>.asciz</code> is a zero-terminated string in C style (which is what the kernel expects). <code>.section .data</code> says <em>the following goes in the data section</em>, which we need because the buffer variable needs to be written to and the code section is read-only when a program is running. <code>.skip</code> reserves a block of the given size in bytes, similar to <code>byte buf[144];</code> in C (you can read <code>char</code> for <code>byte</code> if you want).</li>
</ol>
<p>Assemble the program with</p>
<ul>
<li><code>as dostat.s -g -o dostat.o</code></li>
<li><code>ld dostat.o -o dostat</code></li>
</ul>
<p>The first command is the assembler itself, which produces and object file (C compilers usually do this too, but you don't see it unless you ask for it). <code>-g</code> is the same as for gcc, it includes debug information. <code>ld</code> is the linker which produces an executable.</p>
<p>You can run the program with <code>./dostat</code>, but it will simply exit with status 0. What we want to do is debug it with <code>gdb dostat</code> (install <code>gdb</code> with <code>apk</code> if you don't have it installed already), then do the following:</p>
<ul>
<li><code>break _start</code> to set a breakpoint.</li>
<li><code>run</code> to start running (and hit the breakpoint).</li>
<li><code>si</code> steps a single assembly instruction. Do this until you have passed the first <code>syscall</code> and land on the line <code>mov $60, %rax</code>.</li>
<li>The memory at <code>buf</code> now contains filled-in <code>struct stat</code> for <code>/dev/stdin</code>, the standard input file. Look at this with <code>x/40xb &amp;buf</code> (memory dump, show 40 hex bytes starting at the buffer).</li>
</ul>
<p>Based on what you know about the <code>struct stat</code> memory layout, what is the inode number and mode of <code>/dev/stdin</code>? Note down the inode number in decimal, and the low 16 bits of the mode word in binary. Note that the memory layout is most likely little-endian, and you are working with 64-bit long integers.</p>
<p>From this information, and the bit patterns in <code>/usr/include/sys/stat.h</code>, decode the file type and permissions of <code>/dev/stdin</code>.</p>
<p>You can then quit gdb with <code>q</code>, and answer yes when it askes whether you want to terminate the program.</p>
<h2 id="the-c-level"><a class="header" href="#the-c-level">The C level</a></h2>
<p>We will now do the same in C. Create this program, I've called it <code>exstat.c</code>, then compile and run it:</p>
<pre><code class="language-C">#include &lt;sys/stat.h&gt;
#include &lt;stdio.h&gt;

int main() {
    struct stat buf;
    char *str = "/dev/stdin";
    int r = lstat(str, &amp;buf);
    if (r != 0) {
        puts("An error occurred.");
        return 1;
    }
    printf("The inode number is %lu.\n", buf.st_ino);
    if (S_ISDIR(buf.st_mode)) { puts("It's a directory.");}
    if (S_ISCHR(buf.st_mode)) { puts("It's a character device.");}
    if (S_ISBLK(buf.st_mode)) { puts("It's a block device.");}
    if (S_ISREG(buf.st_mode)) { puts("It's a regular file.");}
    if (S_ISFIFO(buf.st_mode)) { puts("It's a FIFO.");}
    if (S_ISLNK(buf.st_mode)) { puts("It's a soft link.");}
    if (S_ISSOCK(buf.st_mode)) { puts("It's a socket.");}

    return 0;
}
</code></pre>
<p>Here we can see that we:</p>
<ol>
<li>Set up the buffer structure and execute the system call.</li>
<li>Check the return value! If it's not 0, then an error occurred - the file <code>/usr/include/bits/errno.h</code> contains a table of error codes, although the system call will return the negative error code in register <code>rax</code>. The <code>man stat</code> manual page explains the meaning of each error code for this particular system call.</li>
<li>Print the inode number (in decimal) and the file type.</li>
</ol>
<p>Check that you get the same inode number and file type as you did with the assembly version.</p>
<h2 id="symbolic-links"><a class="header" href="#symbolic-links">Symbolic links</a></h2>
<p>The point of checking the file type is that <code>/dev/stdin</code> is a symbolic link. To find out where it points, you can use this function:</p>
<pre><code class="language-C">#include &lt;unistd.h&gt;
ssize_t readlink(const char *pathname, char *buf, size_t bufsiz)
</code></pre>
<p>This is another system call wrapper (readlink is system call 89) which takes the pathname of a symbolic link and writes its contents (e.g. the file it points at) in a buffer. However, be aware of the following:</p>
<ul>
<li><code>readlink</code> does not zero-terminate its buffer! That is your responsibility as caller.</li>
<li>The returned value (yet another unsigned long) indicates what happened:
<ul>
<li>A positive value indicates the number of bytes written, so you know where to put the zero byte at the end.</li>
<li>If the return value is equal to the buffer size, then your buffer was too short, and the buffer may contain a truncated string.</li>
<li>If the return value was negative, then an error occurred.</li>
</ul>
</li>
</ul>
<p>In the assembly version, the negative error code would land directly in <code>rax</code>. This is why system calls return negative error codes, to distinguish them from successful return values as a successful call will never write a negative number of bytes.</p>
<p>However, the C wrapper is different as you can read in <code>man readlink</code>: it always returns -1 on error, but puts the error code (this time positive again) in a global variable called <code>errno</code>. You can match this against the codes in <code>errno.h</code> as before, and then check the manual page for an explanation of each one for this particular system call.</p>
<p><strong>Exercise</strong>: write a C program that, starting with a filename you pass in <code>argv[1]</code>:</p>
<ol>
<li><code>lstat</code>s the file and prints the inode number and file type of the file.</li>
<li>If the file is a symbolic link, calls <code>readlink</code> to get the link target and repeats from 1. for the target file.</li>
</ol>
<p>Since this is systems programming, make sure you check the return value of system calls, and correctly zero-terminate strings. If a system call fails, your program should print an error message and exit, and <em>never</em> look at the buffer or string the system call wrote to, as it might not contain valid data.</p>
<p>Call your program for <code>/dev/stdin</code> and <code>/dev/stdout</code> to follow the chain of soft links for these files. Also try it on a few standard files and directories (including soft links).</p>
<h2 id="on-the-command-line"><a class="header" href="#on-the-command-line">On the command line</a></h2>
<p>To check the results of your program, the <code>stat</code> command line program (<code>/bin/stat</code>, in fact yet another soft link to busybox) calls stat and prints the output to the terminal. You can see with <code>stat --help</code> that it offers lots of custom formats.</p>
<p>Note that the <code>stat</code> command line tool calls the <code>lstat</code> system call by default, e.g. it does not follow soft links. <code>stat -L</code> gets you the link-following version.</p>
<p>To see how the command line version works, we are going to have a look at its sources.</p>
<p>Clone the busybox repository with <code>git clone git://busybox.net/busybox.git</code> (if that doesn't work for some reason, try the https version). Inside the cloned folder, the source file is <code>coreutils/stat.c</code> - open that and have a look:</p>
<ul>
<li>The comments at the start are read by a custom build tool. The <code>//applet</code> line (currently line 38) says to build a command called <code>stat</code>.</li>
<li><code>file_type</code> (line 123 at the time of writing) is the code for turning mode bits into strings, note there are lots of <code>#ifdef</code>s depending on what options you compile busybox with. Also, if you <code>stat</code> a file that does not match any known type, you get the string "weird file".</li>
<li>Most of the source file is the kind of "plumbing" that you need in any real C program. The interesting part is <code>do_stat</code> (line 588 at the time of writing):</li>
</ul>
<p>First, it allocates a <code>struct stat</code> buffer like we did before.</p>
<p>The key line is currently line 605 and following:</p>
<pre><code class="language-C">if ((option_mask32 &amp; OPT_DEREFERENCE ? stat : lstat) (filename, &amp;statbuf) != 0) {
    bb_perror_msg("can't stat '%s'", filename);
    return 0;
}
</code></pre>
<p>Based on the value of <code>OPT_DEREFERENCE</code> (the <code>-L</code> command line flag), we call either the <code>stat</code> or <code>lstat</code> system call wrapper in the C library, and complain and exit if we don't get a success return value - remember, in case of errors, <code>struct stat statbuf</code> could be corrupted so we shouldn't look at it.</p>
<p>The rest of the function is basically setting up one giant <code>printf</code> statement to output the results in the correct format. Note here that the <code>struct stat</code> still doesn't know anything about the file's name, as that's not in the inode, but the command-line program does because you gave the name as an argument.</p>
<p>If the file is a soft link, then we call a version of readlink - currently <code>xmalloc_readlink_or_warn</code> in line 713 - to display the link target. This function is implemented in <code>libbb/xreadlink.c</code> where it currently delegates to <code>xmalloc_readlink</code> on line 20, which calls <code>readlink</code> in a loop with increasing buffer sizes until it finds one that is big enough for the target - have a look at how this is implemented.</p>
<p>The main function for this utility is <code>stat_main</code>, currently on line 757. All this does is parse the command line arguments with <code>getopt32</code>, call the <code>do_stat</code> function in a loop for each command line argument (lines 787 and following in the current version) and then return success if all files were successfully processed, otherwise failure.</p>
<p>If nothing else, the learning point of this activity is that system programming in C and calling syscalls directly is a lot more involved than you may think! Please don't be that kind of programmer who <a href="https://rachelbythebay.com/w/2014/08/19/fork/">ignores system call error values, and makes terrible things happen</a>.</p>
<p>If you want to explore this code further, you can build your own busybox - install <code>ncurses</code> and <code>linux-headers</code>, then run <code>make menuconfig</code> to bring up a configuration menu (this is the part that uses ncurses, which is the menu system) and just select exit (with TAB then ENTER). Then you can <code>make</code> the whole thing.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="concurrent-programming-in-posix"><a class="header" href="#concurrent-programming-in-posix">Concurrent programming in POSIX</a></h1>
<p>In the undergraduate degree at Bristol, students study concurrent programming using the go programming language, which provides an abstraction called <em>channels</em> that different <em>actors</em> can use to talk to each other. In the case of go, the actors are threads, but the same principle applies to a concurrent system with different processes, in which case channels are a kind of <em>inter-process communication (IPC)</em>. In POSIX, pipes are a kind of channel.</p>
<ul>
<li>If one process reads from a pipe, then this blocks the process until another process writes to it.</li>
<li>If one process writes to a pipe, then this blocks the process until another process reads from it.</li>
<li>If one process reads from a pipe and another process writes to it (it does not matter who goes first) then the data is transferred from the reader to the writer, and both processes continue.</li>
</ul>
<p>For example, when you use a command like <code>cat logfile | grep Error | wc -l</code> to count the number of lines containing the word "Error", then there are three processes (not counting the terminal) and two pipes involved:</p>
<p><img src="posix4/../resources/pipe1.png" alt="pipe diagram" /></p>
<p><em>In this diagram, green boxes are processes with standard input on the left and standard output (top) and standard error (bottom) on the right. The little squares all represent file descriptors; a pipe has two of them, one each for reading and writing.</em></p>
<p>This is not yet a fully concurrent system though, as data is only flowing in one direction: there are no loops.</p>
<p>As a little example of something that does have a loop, we are going to use the <code>bc</code> calculator program, which (once installed) reads a line from standard input, evaluates it as a formula, and writes the result to standard output:</p>
<pre><code>vagrant@debian12$ bc
(you type ) 2+3
(bc prints) 5
(you type ) 1+1
(bc prints) 2
</code></pre>
<p><code>bc</code> reads in a loop, so type <code>^D</code> to close its standard input, then you get back to the terminal.</p>
<p>As a diagram, the interaction with bc looks like this:</p>
<p><img src="posix4/../resources/pipe2.png" alt="pipe diagram of terminal interaction" /></p>
<p><em>Here the terminal's right file descriptor is the one that the terminal reads, and the left one is where the terminal writes your keyboard input. But there's still a human in the loop here.</em></p>
<p>We are going to write a program that can talk to <code>bc</code>. This means we have two processes, our program and <code>bc</code>, and they need to communicate with each other. We will use pipes for this, giving the following diagram where we call the pipes <em>up</em> and <em>down</em>:</p>
<p><img src="posix4/../resources/pipe3.png" alt="pipe digram for a program controlling bc" /></p>
<p><em>In this diagram, data flows through pipes from left to right, but logically the "down" pipe is for data flowing from our program downwards to bc, and the "up" pipe is for data flowing back up again. Standard error is not shown (it still goes to the terminal).</em></p>
<p>The <code>bc</code> program does not need to know about any of this: it still reads expressions from its standard input, evaluates them, and writes them to standard output.</p>
<p>Notice that when we used a pipe character <code>|</code> in the shell, it automatically set up the pipes for us so each pipe had one reader and one writer. When we set the pipes up ourselves, we will have to take care of this ourselves too.</p>
<h2 id="the-first-program"><a class="header" href="#the-first-program">The first program</a></h2>
<p>Study the following program. It tries to add the numbers from 1 to 10 by writing the sums (1+2 etc.) to standard output, and reading the result back from standard input. You can compile it with <code>gcc -std=c99 -Wall ipc1.c -o ipc1</code> and then run it yourself: it prints <code>1+2</code> and if you reply <code>3</code>, it follows up with <code>3+3</code> and so on. After ten steps, it prints the result and exits.</p>
<pre><code class="language-c">/* ipc1.c */
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;errno.h&gt;
#include &lt;stdlib.h&gt;

void check(int ok, char *where) {
  if (ok &lt; 0) {
    fprintf(stderr, "Error in %s: %s\n", where, strerror(errno));
    exit(1);
  }
}

int evaluate(char *buffer, int len) {
  fprintf(stderr, "&gt; %s", buffer);

  int ok = printf("%s", buffer);
  if (ok &lt; 0) {
    return -1;
  }
  char* p = fgets(buffer, len, stdin);
  if (p == NULL) {
    return -1;
  }
  fprintf(stderr, "&lt; %s", buffer);
  return 0;
}

int main() {
  char buffer[100];
  int ok;

  setbuf(stdout, NULL);
  setbuf(stdin, NULL);

  strcpy(buffer, "1+2\n");

  ok = evaluate(buffer, sizeof(buffer));
  check(ok, "I/O");
  
  for (int i = 3; i &lt;= 10; i++) {
    sprintf(buffer + strlen(buffer) - 1, "+%u\n", i);
    ok = evaluate(buffer, sizeof(buffer));
    check(ok, "I/O");
  }
  fprintf(stderr, "The result is %s", buffer);
  return 0;
}
</code></pre>
<p>The program also prints a copy of all its input and output to standard error so you can see what data is being transferred. The transfer happens in <code>evaluate</code>:</p>
<ol>
<li>First, it prints the buffer to standard error.</li>
<li>Then, it prints the buffer to standard output with printf. Checking the return value of printf is extremely paranoid, but we're about to use the program in a situation where standard output is not the terminal, so it could potentially fail.</li>
<li>Next, it reads a line from standard input with fgets. Checking the return value here is good practice even if you're not paranoid.</li>
<li>Finally, it prints the received value to standard error - note that if <code>fgets</code> had returned NULL, then it would not be safe to access the buffer.</li>
</ol>
<p>Once you are familiar with how the program works, you can comment out the lines that print to standard error if you like and run it again to see exactly what happens on standard input/output and nothing else. Then, uncomment the lines again.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>You could also use another trick to disambiguate standard output/error (for programs that don't, like this one, indicate which is which: the lines starting <code>&gt;</code> or <code>&lt;</code> are standard error).</p>
<pre><code class="language-sh">escape=$(printf '\033')
./ipc 2&gt; &gt;(sed -e "s/\(.*\)/${escape}[32m\1${escape}[0m/")
</code></pre>
<p>This might mess up the last line on your terminal a bit, but you can reset it with Control+L.
The first command sets a shell variable to the ANSI escape character. The second line redirects standard error (<code>2&gt;</code>) to a subprocess (<code>&gt;(...)</code>) which calls the stream editor <code>sed</code> to replace each line with the line surrounded by <code>\e[32m</code> (set colour to green) and <code>\e[0m</code> (reset colour). This will make the standard error lines appear in green.</p>
<p>Incidentally, some versions of sed support the <code>\e</code> escape sequence directly, or at least the version <code>\x1b</code> that creates a character from its ASCII code in hexadecimal, but some versions do not, so you need the shell variable trick with a fall back to octal (033) notation!</p>
</div>
</div>
<p>And now for the interesting part:</p>
<ul>
<li>Make two named pipes (FIFOs) with <code>mkfifo up</code> and <code>mkfifo down</code>.</li>
<li>You will need two terminals open for the following. Either ssh into your Debian box a second time or, better still, use tmux (<code>Control+B, %</code> opens a second terminal beside the first one; you can use <code>Control+B, Left</code> and <code>Control+B, Right</code> to switch between them).</li>
<li>Run the program with <code>./ipc1 &gt; down &lt; up</code> to redirect standard input and output to the pipes. This blocks (exercise: which statement is it currently blocking on?).</li>
<li>In the second terminal, run <code>bc &lt; down &gt; up</code>.</li>
</ul>
<p>Both processes should now terminate, and although you won't see the pipes directly, standard error of your program is printing a copy to the terminal, where <code>&gt;</code> is data sent to down pipe and <code>&lt;</code> is data received on the up pipe:</p>
<pre><code>&gt; 1+2
&lt; 3
&gt; 3+3
&lt; 6
&gt; 6+4
&lt; 10
...
&gt; 45+10
&lt; 55
The result is 55
</code></pre>
<p>Note that the program printed the "The result is ..." line to standard error too, otherwise you would not see it here.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="pipes-in-c"><a class="header" href="#pipes-in-c">Pipes in C</a></h2>
<h2 id="types-of-inter-process-communication"><a class="header" href="#types-of-inter-process-communication">Types of inter-process communication</a></h2>
<p>You can use any of the following for one process to talk to another:</p>
<ul>
<li>Pipes in the shell, e.g. <code>cat FILE | grep STRING</code>. We are going to learn how to manage these pipes ourselves from a C program.</li>
<li>Named pipes (FIFOs), which are pipes that have filenames.</li>
<li><code>popen</code>, a C function that launches a new process with a pipe either for reading or writing, but not both.</li>
<li>TTYs, as explained in the lectures. The C interface for using TTYs starts with <code>posix_openpt()</code> and is fairly complicated.</li>
<li>Sockets. This includes both network sockets (TCP) and also UNIX sockets, which are another type of special file. Unlike pipes, sockets provide bidirectional communication.</li>
</ul>
<p>We are going to be using pairs of pipes, since a single pipe only works in one direction.</p>
<h2 id="c-functions"><a class="header" href="#c-functions">C functions</a></h2>
<p>We will need the following functions for our task, all from <code>unistd.h</code>:</p>
<ul>
<li><code>int pipe(int fd[2])</code> creates a pipe. It takes an array of two integers and creates two file descriptors in them, one for the reading and one for the writing end of the pipe. Details in <code>man 2 pipe</code>, and like all system calls, you need to check the return value and look at <code>errno</code> if it is negative <a href="http://rachelbythebay.com/w/2014/08/19/fork/">otherwise bad things <em>will</em> happen</a>.</li>
<li><code>int dup2(int oldfd, int newfd)</code> changes <code>newfd</code> to point to the same file descriptor as <code>oldfd</code>. This is the system call version of the shell redirect.</li>
<li><code>pid_t fork()</code> creates a copy of the current process, and is the starting point for launching another process. Once you are sure that it has not returned an error, then the child process will see return value 0 and the parent process will see a return value &gt;0, which is the process id of the child process.</li>
<li><code>int execve(const char *path, char *const argv[], char *const envp[])</code> replaces the current process by the indicated process, this is the C version of typing a shell command except that (1) the shell does fork-then-exec and (2) there is no shell involved, so you cannot use shell features like <code>*</code> expansion or builtin commands like cd here.</li>
</ul>
<p>Here is the basic way to launch a program from another, keeping the original program running:</p>
<pre><code class="language-C">/* launch.c */
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;errno.h&gt;
#include &lt;string.h&gt;

char* command = "/bin/echo";
char* argv[] = {"echo", "Hello", NULL};
char* envp[] = {NULL};
/* both argv and envp must be NULL-terminated arrays,
   also argv[0] has to be the program name (busybox cares about this)
 */

int main() {
    int ok = fork();
    if (ok &lt; 0) {
        printf("fork() failed: %s\n", strerror(errno));
        return 1;
    }
    /* ok, fork succeeded and the following code will now be running TWICE */
    if (ok == 0) {
        /* This is the child process */
        ok = execve(command, argv, envp);
        if (ok &lt; 0) {
            printf("execve() failed: %s\n", strerror(errno));
            return 1;
        }
        /* we will never get here as if execve succeeded, we're gone */
    }
    
    /* if we got here, then we're the parent process */
    printf("Launched a child process, it has pid %u.\n", ok);
    
    return 0;
}
</code></pre>
<p>If you run this several times in a row, you might see the PID of the child increasing by 2 each time, why is this?</p>
<p>And here is the basic way to work with pipes:</p>
<pre><code class="language-C">#include &lt;stdio.h&gt;
#include &lt;errno.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

typedef int fd;
typedef fd Pipe[2];
fd Reader(Pipe p) { return p[0]; }
fd Writer(Pipe p) { return p[1]; }

void check(int ok, char *where) {
  if (ok &lt; 0) {
    fprintf(stderr, "Error in %s: %s\n", where, strerror(errno));
    exit(1);
  }
}

int main() {
  int ok;
  Pipe p;
  ok = pipe(p);           check(ok, "opening pipe");
  ok = close(Reader(p));  check(ok, "closing reader");
  /* here we can write to p */
  ok = close(Writer(p));  check(ok, "closing writer");
  return 0;
}
</code></pre>
<p>Let's go through this step by step.</p>
<ul>
<li>A file descriptor is simply an integer. so we make a typedef for this.</li>
<li>A pipe is a pair of file descriptors for reading and writing, implemented as an array of length 2. The second typedef is C syntax for defining <code>Pipe</code> with a capital P to be <code>fd[2]</code> We use a capital P because lowercase <code>pipe</code> is already in use for the function that sets up a pipe.</li>
<li>The functions <code>Reader</code> and <code>Writer</code> are just for convenience.</li>
<li>In main, we declare a variable of type <code>Pipe</code> and open it with <code>pipe()</code>. Like all POSIX functions this returns a negative number in case of errors, and we have to check for this: it's not safe to use the pipe if it was not opened correctly. The pipe does not need a name as it's local to our program, but you can print the value of the integers if you like, it should be something like (3, 4) as 0-2 are already in use for standard input, output and error.</li>
<li>In this example we want to use a pipe for writing to, so we close the reading end first. This is important when sharing a pipe between two processes: only one process should have each end open. (There are scenarios where you might want both ends of a pipe open in the same process, but they are more advanced than what we are doing here.)</li>
<li>In the line where the comment is, we can write to the pipe - you will see how soon.</li>
<li>Finally, before returning, we close the writing end of the pipe to ensure the process on the other end knows we're done: if we don't do this, they could get a "broken pipe" (EPIPE) error.</li>
</ul>
<p>We still need to learn how to write to a file descriptor, though. And this pipe won't do anything useful until we can connect something to the other end.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>If you look at the pattern for checking return values</p>
<pre><code>ok = pipe(p); check(ok, "create pipe");
</code></pre>
<p>you might be wondering why we don't just combine it into one:</p>
<pre><code>check(pipe(p), "create pipe");
</code></pre>
<p>This is absolutely fine except if we want to debug the function being called, as it makes using the debugger's step features more complicated (more on this in future weeks of this unit). It's just a personal preference of mine not to combine the two.</p>
<p>Of course, if you want to use line-based features of debuggers like breakpoints a lot, you might even want to put the check on a separate line.</p>
<p>You might have wondered if the problem with the all-in-one pattern is that it "swallows" the return value. That is not a problem: we could adapt <code>check</code> to return its first parameter as the return value if it's not an error, then where you do need the value you can do things like</p>
<pre><code class="language-C">int pid = check(fork(), "trying to fork");
if (pid &gt; 0 ) { /* parent */ }
else { /* child */ }
</code></pre>
<p>This is one of several patterns for error handling you will see in C, although this particular one is commonly implemented as a macro so it can also print the file and line where the error occurred:</p>
<pre><code class="language-C">#define check(ok, where) _check(ok, where, __FILE__, __LINE__)
int _check(int ok, char *where, char *file, int line) {
  if (ok &lt; 0) {
    fprintf(stderr, "Error at %s on line %i while %s: %s\n", 
            file, line, where, strerror(errno));
    exit(1);
  }
  return ok;
}
</code></pre>
<p>Since C99 you can also use <code>__func__</code> to get the name of the current function.</p>
<p>You will find various patterns like this a lot if you start looking into real C code bases. Of course, most real programs will try to handle an error where possible rather than just exit the whole program.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="inputoutput-in-c"><a class="header" href="#inputoutput-in-c">Input/Output in C</a></h1>
<h2 id="reminder-c-file-handling"><a class="header" href="#reminder-c-file-handling">Reminder: C file handling</a></h2>
<p>You should already be familiar with the following C functions from <code>&lt;stdio.h&gt;</code>, though you can look up details with <code>man 3 FUNCNAME</code> on a lab machine:</p>
<ul>
<li><code>FILE *fopen(const char *path, const char *mode)</code> opens a file, returning a file handle if successful and NULL otherwise. On some systems, it makes a difference whether you read a file in text mode (<code>r</code>) or binary mode (<code>rb</code>), the difference being that the former activates an extra "line discipline" in the C library. For example on Windows, text mode translates a lone <code>\n</code> character to <code>\r\n</code>. <em>On POSIX systems, there is no difference between text and binary mode.</em></li>
<li><code>int fclose(FILE *file)</code> closes a file, and flushes any pending writes. It returns 0 on success and nonzero in case of errors.</li>
<li><code>int fflush(FILE *file)</code> flushes a file: for output, it makes sure any buffered characters are written out. For input, it throws away any unread input in the c library input buffer. It returns 0 on success and nonzero in case of errors. <code>fflush(NULL)</code> flushes all open files.</li>
<li><code>int feof(FILE *file)</code> returns nonzero if the file in question has reached end-of-file, and zero otherwise. This is the only correct way to test for an end-of file condition.</li>
<li><code>int ferror(FILE *file)</code> returns nonzero if the file in question is in an error state. For example after a <code>fread</code> that did not return the expected number of blocks, exactly one of <code>feof</code> and <code>ferror</code> will return nonzero, indicating what happened. In case of an error, the global variable <code>errno</code> will contain the error code.</li>
<li><code>size_t fread(void *dest, size_t size, size_t num, FILE *file)</code> reads up to <code>num</code> blocks of <code>size</code> bytes into the buffer at <code>dest</code> and returns the number of blocks read (for a block size of 1, this is the number of bytes). If the return value is less than <code>num</code> then either an error occurred or the end of the file was reached.</li>
<li><code>size_t fwrite(const void *buffer, size_t size, size_t num, FILE *file)</code> writes up to <code>num</code> blocks of <code>size</code> bytes from the <code>buffer</code> to the <code>file</code> and returns the number of blocks written. If this is less than <code>num</code>, then an error occurred during the writing.</li>
</ul>
<p>A number of utility functions build upon these:</p>
<ul>
<li><code>int fprintf(FILE *stream, const char *format, ...)</code> writes formatted output to a file, usually by calling <code>fwrite</code> behind the scenes. <code>printf</code> is a shortcut for <code>fprintf(stdout, ...)</code>. These functions to not print a newline unless you ask for one. It returns the number of characters written, or a negative number if an error occurred.</li>
<li><code>int fputs(const char *string, FILE *file)</code> writes a zero-terminated string to the file, not including the zero terminator. <code>puts</code> is a shortcut that writes to <code>stdout</code> <em>and</em> adds a newline at the end.</li>
<li><code>int fputc(int c, FILE *file)</code> writes a single character (<code>c</code> is cast to an <code>unsigned char</code> first) and <code>putchar</code> is a shortcut for writing to <code>stdout</code> (but does not add a newline, unlike <code>puts</code>).</li>
<li><code>int fgetc(FILE *file)</code> reads a single character from a file (but returns it as an int, however it's safe to cast to char). <code>getchar</code> is a shortcut that reads from standard input.</li>
<li><code>char *fgets(char *buffer, int size, FILE *file)</code> reads up to <code>size-1</code> bytes into the buffer, stopping early if it finds a null byte, newline or end-of-file character. It then adds a zero-terminator to the string. If it stopped early because of a newline, the newline is included in the buffer; if it stopped due to an end-of-file then this is not included. Older versions of C included a <code>gets</code> version that reads from standard input and does not take a size argument; this is insecure as it can produce a buffer overflow and it should never be used. <code>fgets</code> is safe if the length of the buffer is at least <code>size</code> bytes. It returns a pointer to buffer on success and NULL if an error occurred. End-of-file counts as an error for this purpose if no characters could be read at all.</li>
</ul>
<p>Fread (and fwrite) can return in one of three different states:</p>
<ol>
<li>The return value is equal to the number of items you asked to read/write (third argument). This means that the read/write was successful.</li>
<li>The return value is not equal to the number of items, <code>ferror</code> returns nonzero on the file: an error occurred. The return value indicates how many items were successfully read or written before the error occurred. <code>errno</code> contains more information about what happened.</li>
<li>The return value is not equal to the number of items, <code>ferror</code> returns zero on the file: end of file. Calling <code>feof</code> on the file will return nonzero. End of file when reading means exactly what it says; end of file when writing to something with a program on the other side (pipe, socket, pty) means the other side has closed the connection.</li>
</ol>
<h2 id="exercises-6"><a class="header" href="#exercises-6">Exercises</a></h2>
<p>For our next exercise, we investigate how the C library file functions interact with the terminal. Compile this program:</p>
<pre><code class="language-C">// program: input1.c //
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;errno.h&gt;

// Utility function to print an error message and return from main,
// use: return error(code, text); // in main
// prints text and the current errno value, then returns code.
int error(int ret, char* text) {
  int e = errno;
  printf("Error %s: %s (code %i).\n", text, strerror(e), e);
  return ret;
}

int main(int argc, char **argv) {
    if (argc &lt; 2) { printf("Use: %s FILENAME\n", argv[0]); return 1; }
    printf("Opening [%s]\n", argv[1]);
    FILE *file = fopen(argv[1], "r");
    if (file == NULL) { return error(2, "opening file"); }
    
    char c, d;
    size_t result = fread(&amp;c, 1, 1, file);
    if (result &lt; 1) { 
      if (ferror(file)) {
        return error(2, "reading first character");
      } else {
        puts("No first character - end of file?");
        return 2;
      }
    }
    printf("Read character: [%c].\n", c);
    result = fread(&amp;d, 1, 1, file);
    if (result &lt; 1) { 
      if (ferror(file)) {
        return error(2, "reading second character"); 
      } else {
        puts("No second character - end of file?");
        return 2;
      }
    }
    printf("Read another character: [%c].\n", d);
    
    int e = fclose(file);
    if (e) { return error(2, "closing file."); }
    return 0;
}
</code></pre>
<p>The essence of the program are the four lines</p>
<pre><code>fread(&amp;c, 1, 1, file);
printf(..., c);
fread(&amp;d, 1, 1, file);
printf(..., d);
</code></pre>
<p>which read two characters from the file indicated in its first argument, then print them out.
Note that we print the first character before reading the second, as this will become relevant.</p>
<p>The rest of the program is error handilng, and although some tutorials leave this off to make the code look easier, this sets you up for terrible habits - in the real world, errors happen and you need to handle them properly. So this program also shows the absolute minimum of error handling when you work with a file.</p>
<ul>
<li>Make a file <code>file</code> containing some characters such as <code>abc</code> and run <code>./input1 file</code>. Convince yourself that the program prints the first two characters (first two bytes, to be precise).</li>
<li>Next, run <code>./input1 /dev/stdin</code>, to make it read from standard input. Notice that it blocks.
Type a few characters such as <code>abc</code> and notice that the program prints nothing, until you press ENTER at which point both the "Read character" and "Read another character" output appears at once. <strong>What is the reason for this?</strong></li>
<li>Restart the program, and when it is waiting for input, type <code>ab[BACKSPACE]c[ENTER]</code>. <strong>Explain what you see.</strong></li>
<li>What happens if you enter only one character and then press ENTER? What if you press ENTER and haven't typed anything at all?</li>
<li>If you want, verify that using fgetc / getchar produces the same behaviour on standard input: the program does not proceed past the first read command until you press ENTER. You can even try debugging with gdb to make sure.</li>
<li>Insert the line <code>setbuf(file, NULL);</code> just after the <code>fopen</code> line to make sure it's not the C library buffering.</li>
</ul>
<p>Have you answered the questions in bold above before reading on?</p>
<ul>
<li>Next, on your terminal, execute <code>stty -icanon</code>, which turns off the "icanon" setting. (The convention for <code>stty</code> is that an option name in an argument turns it on, except if prefixed with a minus which turns it off.)</li>
<li>Rerun the program (<code>./input1 /dev/stdin</code>) and see what happens now.</li>
<li>Turn "icanon" back on with <code>stty icanon</code>.</li>
<li>Research what <code>icanon</code> does, for example in <code>man stty</code> on a lab machine or online.</li>
<li><strong>Why does BACKSPACE and <code>^U</code> work in your bash shell, even with icanon turned off?</strong></li>
</ul>
<p>Next, we are going to experiment with the terminal in fully raw mode:</p>
<ul>
<li><code>stty -g</code> prints the current terminal setting in a format that you can save and load again. Take a look, then store them with the shell command <code>state=$(stty -g)</code>.</li>
<li>Execute <code>stty raw</code>, then run your program again. <strong>The terminal looks a bit "messed up" - can you tell what is happening?</strong> Try another command like <code>ls</code> in raw mode too if that helps.</li>
<li>Restore your terminal settings with <code>stty $state</code>, reading them back from the variable where you stored them. You can then reset the window with <code>^L</code>.</li>
</ul>
<p>There is an important warning here if you are ever benchmarking a program that produces (standard) output - the total running time will be the sum of the program's running time and the connected terminal's running time to process the output. For example, printing a sequence of newline characters is typically slower than printing a sequence of 'a's, even if both programs are doing <code>putc</code> in a loop, because the terminal has extra work to do on each newline.</p>
<p>Here is another C program to experiment with:</p>
<pre><code class="language-C">// input2.c //
// Reads characters in a loop and prints their hex codes. 
// Quit with 'Q'.

#include &lt;stdio.h&gt;

int main() {
  unsigned char c;
  int r;
  setbuf(stdout, NULL);
  while(1) {
    r = fread(&amp;c, 1, 1, stdin);
    if (r &lt; 1) break; // bail out on error or eof
    if (c == 'Q') break;
    printf("(%02X) ", c);
  }
  return 0;
}
</code></pre>
<ul>
<li>What do you expect to happen if you run this in a "normal" terminal and type a few characters?</li>
<li>Run it in a terminal with icanon turned off and type a few characters. Notice that you can still cancel it with <code>^C</code>.</li>
<li>Run it in a terminal in raw mode and type a few characters. What happens now when you press <code>^C</code>?</li>
</ul>
<p>Luckily, we built in another way to quit the program with Q!</p>
<ul>
<li>In raw mode, try a few "special" keys such as ENTER, ESC, the arrow keys, function keys (F1, F2) etc.</li>
<li>We turned off buffering for standard <em>output</em>. Why is this important - what happens otherwise and who is doing the buffering?</li>
</ul>
<p>What actually happens when you press Control-C in a terminal in "cooked" mode is it sends the signal <code>SIGINT</code> (interrupt) to the connected program - the default behaviour for this signal is to terminate the program. Putting the terminal in raw mode just passes the control code for Control-C on to the program, though it would still quit if you sent it a SIGINT another way (e.g. with the <code>kill</code> command from another terminal). However, you could also write a signal handler in your own program that reacts to SIGINT and does something else, for example just ignores the signal.</p>
<p>When you type say an <code>a</code>, even in raw mode, the character appears on your screen even though there's no print command for it. This is the terminal echo; you can turn even this off with <code>stty -echo</code> but you are now typing blind! You can still start your program with <code>./input2</code> followed by ENTER, and it will still print the hex codes of everything you type from then on until you press Q but it will no longer show you the characters themselves. If you saved the terminal state before, then typing <code>stty $state</code> and ENTER will get you your echo back.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="inputoutput-in-posix"><a class="header" href="#inputoutput-in-posix">Input/output in POSIX</a></h1>
<p>Both the C library and the POSIX standard library contain file I/O functions. Usually, the C library ones build on the POSIX ones if you are on a POSIX system.</p>
<p>The POSIX I/O functions are declared in <code>fcntl.h</code> and <code>unistd.h</code>. The main ones are:</p>
<h2 id="open-and-close"><a class="header" href="#open-and-close">Open and Close</a></h2>
<ul>
<li><code>int open(const char *pathname, int flags, [mode_t mode])</code> opens a file and returns a file descriptor. The flags are the boolean OR (<code>|</code>) of one or more of the following:
<ul>
<li><code>O_CREAT</code>: if the file does not exist, create it. In this case the <em>optional</em> mode parameter can be used to specify the permissions for the newly created file. If the <code>O_CREAT</code> flag is omitted and the file does not exist, <code>open</code> returns an error.</li>
<li><code>O_EXCL</code>: return an error if the file already exists (only really useful together with <code>O_CREAT</code>).</li>
<li><code>O_PATH</code>: don't really open the file, just make a file descriptor (that you can use to e.g. <code>stat</code> the file). In this case you do not need one of the three flags mentioned in the next point.</li>
<li><code>O_RDONLY</code>, <code>O_WRONLY</code>, <code>O_RDWR</code>: exactly one of these mutually exclusive flags must be set to indicate whether you want read, write or both access modes on the file.</li>
<li><code>O_TRUNC</code>: if the file already exists, then its previous contents are overwritten if you open it to write.</li>
<li><code>O_NONBLOCK</code>: this is the most interesting option and the main reason why you might want to use <code>open</code> over <code>fopen</code>. More details on this in the next activity.</li>
<li>There are a lot more flags that you can see with <code>man 2 open</code>.</li>
</ul>
</li>
<li>
<ul>
<li><code>int close(int fd)</code>: close a file descriptor. Returns 0 on success and -1 (setting errno) on error.</li>
</ul>
</li>
</ul>
<p>You might wonder how a C function call can have an <em>optional</em> parameter. The function is actually declared in <code>fcntl.h</code> as <code>int open(const char*, ...)</code> where the ellipsis means <em>any number of parameters of any type</em> just like <code>printf</code> uses.</p>
<p>If <code>open()</code> fails, it returns a negative number that indicates the error code: see <code>errno.h</code> for the names of the codes and the manual page (<code>man 2 open</code>) for what each one means for this function.</p>
<h2 id="nonblocking-io"><a class="header" href="#nonblocking-io">(Non)blocking IO</a></h2>
<p>When you read from a regular file, there is a short delay while the kernel does the actual reading for you - possibly it has to fetch the data from disk. This is not what is meant by blocking. However, when you read from a pipe (e.g. you call <code>a | b</code> in the shell and <code>b</code> reads from standard input) or from a named pipe (FIFO), then if no process is connected to the writing end, your system call blocks until someone writes to the pipe.</p>
<p>The Posix functions offer an option <code>O_NONBLOCK</code> that makes a call fail instead of block. This is one of the reasons that you might use <code>read</code> directly rather than <code>fread</code>. While this is an important topic for concurrent programming (and especially network programming), that can wait until second year.</p>
<h2 id="read-and-write"><a class="header" href="#read-and-write">Read and Write</a></h2>
<ul>
<li><code>ssize_t read(int fd, void *buf, size_t count)</code>: read up to <code>count</code> bytes from the file descriptor <code>fd</code> into the buffer. In case of an error, this returns -1 and puts the error code in <code>errno</code>. If the end of file is reached, then the return value might be less than count (possibly zero) but this does not count as an error.</li>
<li><code>ssize_t write(int fd, const void *buf, size_t count)</code>: the same but for writing to a file (descriptor).</li>
</ul>
<p>Before you use any of these functions, there are two warnings. The small one is that unlike the C library which provides <em>buffered</em> input/output, the POSIX functions do not - so while it's ok to read a large file one character at a time with <code>fread</code> due to buffering, this becomes really inefficient if you use the basic <code>read</code>.</p>
<p>The big warning is that checking return values is even more important than usual because these functions can return two kinds of errors: fatal ones (e.g. file not found) and temporary ones, which basically means <em>try again</em>, so in some cases the correct pattern to use these functions is to call them in a loop that repeats until the function either succeeds or returns a fatal error. Specifically, <code>read()</code> can return any of the following:</p>
<ul>
<li>-1, <code>errno = EINTR</code>: the call was interrupted, try again.</li>
<li>-1, <code>errno = EAGAIN</code> or <code>errno = EWOULDBLOCK</code>: you have requested non-blocking IO, and the call would block.</li>
<li>-1, any other errno: a fatal error occurred and <code>errno</code> gives more information. You must not retry the call.</li>
</ul>
<h2 id="exercise-1"><a class="header" href="#exercise-1">Exercise</a></h2>
<p>In the sources for busybox (<code>git clone git://busybox.net/busybox.git</code>), use your shell skills to find the source file and line where the function <code>safe_read</code> is defined, and study the pattern used there to operate <code>read</code> in a loop.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="the-final-challenge"><a class="header" href="#the-final-challenge">The final challenge</a></h2>
<p>The final challenge for this part of the unit is to write a C program that uses pipes to interact with bc to add the numbers from 1 to 10, as an example of concurrency and inter-process communication in action. For this, you will need to put together items from the previous pages for this activity.</p>
<p>The general ideas are:</p>
<ol>
<li>Create two pipe variables called <code>up</code> and <code>down</code>.</li>
<li>Fork the process. This shares the pipes between both copies of the process.</li>
<li>The parent process will write to the down pipe and read from the up pipe, so it should close the down reader and the up writer.</li>
<li>The child process closes the down writer and the up reader, redirects its standard input to the down reader and its standard output to the up writer, and then execs <code>bc</code>. This keeps the redirected standard input and output.</li>
<li>The parent process now writes its sums starting with <code>1+2</code> to the down writer with <code>write</code> and then uses <code>read</code> on the up reader to get the result. You can use a function <code>evaluate()</code> like in the previous example that handles the reading/writing and prints debug information to standard output (we don't need standard error as the pipe is a separate file descriptor).</li>
<li>The parent cleanly closes the pipes when it is done, and writes the result to standard output.</li>
</ol>
<p>Two constraints here:</p>
<ul>
<li>All calls to Posix or file I/O functions <em>must</em> be checked for error return values. It is ok to terminate the program in case of fatal errors rather than try and fix the cause, but not to just carry on ignoring the return value. You can reuse the <code>check()</code> function for this.</li>
<li>Calls to <code>read</code> and <code>write</code> must be assumed to be able to fail with <code>EINTR</code>, in which case they need to be retried, so these functions must be called from within loops as you saw in the busybox sources.</li>
</ul>
<p>The one new function you need to know is <code>int dup2(int src, int dest)</code> which redirects the destination to be a duplicate of the source. For example if <code>dr</code> is a file decriptor for the down reader, then <code>ok = dup2(dr, 0)</code> redirects standard input (file descriptor 0) to read from the down reader. Of course, you have to check the return value <code>ok</code>!</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>One way of using <code>dup2</code> is to redirect your own standard output to a file, then any calls to <code>printf</code> or other functions from then on should end up in the file. If you later on want to restore the original standard output, you can first call <code>int dup(int fd)</code> which makes a copy of the file descriptor - for example, if a file is open on file descriptor 3, then</p>
<pre><code class="language-C">saved = dup(1);      check(saved, "duplicating standard output");
ok = dup2(3, 1);     check(ok, "redirecting standard output");
/* any printf etc here will go to the file on fd 3 */
ok = dup2(saved, 1); check(ok, "restoring standard output");
ok = close(saved);   check(ok, "closing duplicate");
</code></pre>
<p>shows how you can restore the original standard output by making a copy. If no other file descriptors are open, then <code>saved</code> will likely have a value of 4, as file descriptors are just numbers to communicate with the kernel and the kernel usually gives you the next consecutive unused one when you open or duplicate a file descriptor.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-to-sql"><a class="header" href="#introduction-to-sql">Introduction to SQL</a></h1>
<p>This is the first of three activities to teach you about relational databases and the SQL programming language.</p>
<h2 id="videos-7"><a class="header" href="#videos-7">Videos</a></h2>
<p>The videos for this activity are:</p>
<div class="table-wrapper"><table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/b3d41a41-17ec-4194-bec1-9666cc234e40">Introduction to databases</a></td><td style="text-align: right">16 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EX_d8Ny3NAtPuVuybL02Mf8BmK-iwH_AAZKU8aa03RWNow?e=qvMIo6">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/2b6639e2-35e4-42bf-9e50-fc5228c4e321">Entity Relationship Diagrams</a></td><td style="text-align: right">11 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EaEjGii_A6dFlwr9H99i6bgBKenNumCIYqUmZmmOJ1DBFw?e=0yBFi3">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/8f2881d9-82f7-4364-a227-e555b776cda0">Intro to SQL</a></td><td style="text-align: right">29 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EaUps_sEdCNAneB4qz3VcS0Bw-yqRF7knK6ODUGu00GtNA?e=d1Neil">PDF</a></td></tr>
<tr><td><a href="https://web.microsoftstream.com/video/6a9b6876-9e38-4e92-afed-7aaa872714cf?list=studio">Normal Forms</a></td><td style="text-align: right">14 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EQzXXyCAs-NCicgguerjs2AB6uzpeLsteXg2I07g0MjLZg?e=SzrlgF">PDF</a></td></tr>
</tbody></table>
</div>
<h2 id="exercises-7"><a class="header" href="#exercises-7">Exercises</a></h2>
<ul>
<li><a href="db1/./setup.html">Set up the database</a></li>
<li><a href="db1/./er-diagram.html">ER diagrams</a></li>
<li><a href="db1/./er2.html">More modelling</a></li>
<li><a href="db1/../db2/explore-database.html">Explore the database</a></li>
<li><a href="db1/../db2/elections.html">Bristol elections</a></li>
<li><a href="db1/../db2/census.html">The UK census</a></li>
<li><a href="db1/../db2/normalforms.html">Normal forms</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="set-up-the-database"><a class="header" href="#set-up-the-database">Set up the database</a></h1>
<h2 id="history"><a class="header" href="#history">History</a></h2>
<p>In this unit, we will be using the free database MariaDB, which is a clone of MySQL and was written by the same author - Michael "Monty" Widenius, from Finland. The history behind the naming is that Monty first created MySQL (named after his daughter, My) which became the most popular open-source database. He sold MySQL to Sun, who were in turn bought by Oracle - who are famous for their commercial database software. As a result, Monty created a clone of MySQL called MariaDB (named after his other daughter). MySQL and MariaDB are compatible in many ways and most of what we learn on this unit will apply equally to both of them, although both Oracle (for MySQL) and the open-source community (for MariaDB) have added new features to their databases.</p>
<p>Although we will be using MariaDB, in some places the name MySQL will still appear - most notably as the name of the command-line program that you use to access the database.</p>
<h2 id="install-the-database"><a class="header" href="#install-the-database">Install the database</a></h2>
<p>Open your VM and install the database with the appropriate commands.
On Debian that is:</p>
<pre><code class="language-sh">$ sudo apt install mariadb-{server,client}
</code></pre>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>What's that funky squiggly bracket doing?  Bash expands it to
<code>mariadb-server mariadb-client</code>.  Similarly if you typed:
<code>cc -o hello{,.c}</code> it would get expanded to <code>cc -o hello hello.c</code>.
There are <em>loads</em> of shorthand tricks for typing stuff quicker in a
shell: try and pick them up as you go!</p>
<p><strong>Question:</strong> What does <code>echo {a,b,c}-{1,2,3}</code> print?  Try and guess
before running it.</p>
</div>
</div>
<p>The <code>mariadb-server</code> package contains the server that stores the data and lets clients log in. <code>mariadb-client</code> is a command-line client (with the command name <code>mysql</code>); later on we will also use a Java client to access a database from a Java application.</p>
<p>The database server is now installed, but our system won't start it
unless you ask it to.  On Debian the service manager is <em>SystemD</em>.  We
can start the server running with:</p>
<pre><code class="language-sh">$ sudo systemctl start mariadb
</code></pre>
<p>Check that the service is running with</p>
<pre><code class="language-sh">$ sudo systemctl status mariadb
$ sudo journalctl -u mariadb
</code></pre>
<p>Set it to run by default with:</p>
<pre><code class="language-sh">$ sudo systemctl enable mariadb
</code></pre>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Whilst Linux has <em>more or less</em> standardized on using SystemD as the
service manager... it is unpopular in certain quarters.  Other systems
exist!  Alpine Linux (which was the VM image we <em>used</em> to use) uses
OpenRC.  The BSDs mostly do it with a hodge-podge of shellscripts.
Macs use something called <code>launchctl</code>.</p>
<p>The argument against SystemD is that it breaks compatibility with the
POSIX OS standard and goes against <em>The UNIX Way</em> (do one thing
well); that the developer Lennart Poettering is a bit controversial
(soft skills are important!);
and quite frankly the overreach of the project is incredible.  As well
as managing services it can also encrypt your home folder, manage WiFi
connections, manage your log files and system name and much, much, more.</p>
<p>The arguments for it are that it is fast, gets rid of a bunch of janky
shell scripts, and standardizes things in a way that makes sense for
Linux.  Linux distro's used to be much more diverse but nowadays the
choice is mostly what package manager do you want to use and what
desktop do you want by default.</p>
<p>For now SystemD seems to be what we've settled on for Linux.  It's
mostly fine once you learn it but do try a BSD system and see what it
used to be like and if you prefer it!</p>
</div>
</div>
<h2 id="security"><a class="header" href="#security">Security</a></h2>
<p>To log in to a database, you normally need a user account and an
authentication factor (such as a password, or a private key). However,
in the latest version, mysql user accounts are linked to system user
accounts. You should probably secure it though.  Running a
public-facing database without security will end in databreaches and
fines quicker than you can type <code>metasploit</code>.</p>
<p>The default set-up will allow anyone to log in and see some of the
database, for example the <code>test</code> tables but this is not particularly
secure. Most distributions come with a <code>mysql_secure_installation</code>
script that sets up more secure access rights. Run it and set a
password for the root user (otherwise it'll be the default root
password or blank).</p>
<h2 id="creating-a-database"><a class="header" href="#creating-a-database">Creating a database</a></h2>
<p>Right, you have a mysql server running! Lets connect it to a database!
To create the database:</p>
<pre><code class="language-sh">mysqladmin -u root -p create mydatabase
</code></pre>
<p>To connect to it:</p>
<pre><code class="language-sh">mysql -u root -p mydatabase
</code></pre>
<p>That should drop you into a prompt!  Congratulations! You have a
running database.</p>
<h2 id="importing-sample-data"><a class="header" href="#importing-sample-data">Importing sample data</a></h2>
<p>We have prepared some sample data that we will be using in this and the following weeks.</p>
<p>First, download the following two files and place them in the same folder as your Vagrantfile. This folder is important as the <code>sample-data.sql</code> script contains hard-coded absolute paths starting in <code>/vagrant/</code> to import some of the data. You can download the files the same way as you did before with the secure setup file.</p>
<pre><code class="language-sh">cd /vagrant
wget https://raw.githubusercontent.com/cs-uob/COMSM0085/master/code/databases/sample-data.sql
wget https://raw.githubusercontent.com/cs-uob/COMSM0085/master/code/databases/sampledata.tar
tar -xvf sampledata.tar
</code></pre>
<p>This creates a folder sampledata with the files we need.</p>
<p>If you are using a local copy of this repository, you can also find the files under <code>/code/databases</code>.</p>
<p>The <code>tar</code> file is a <em>tape archive</em>: a file that contains further files and folders, as if it were a folder itself.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>The options here are x=extract a file, v=verify (print the name of every processed file to standard output), f=the filename is in the following argument. You may sometimes see this command without the '-' for these options -- this works because <code>tar</code> supports an older convention where options are not prefixed with a dash, but to be safe you should stick to the modern convention (which it also understands).</p>
<p>To create a tar file yourself, the command would be <code>tar -cvf ARCHIVE.tar FILE1 FILE2...</code> where c=create the archive if it doesn't exist, and assume all arguments not consumed by another flag refer to files to be added. In fact, <code>tar -xvf ARCHIVE.tar FILES...</code> also works and only extracts the named files from the archive.</p>
</div>
</div>
<p>Load the sample data with the following command:</p>
<pre><code class="language-sh">mysql -u root -p -e 'source /vagrant/sample-data.sql'
</code></pre>
<p>This pulls in some data in CSV files (have a look at the script if you want) and creates a default user "vagrant" who can log in to the database without a password, but can only read and not write the two sample databases "census" and "elections". There is another database called "data" which starts out empty, and "vagrant" can both read and write it.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>It also seems to throw a bunch of errors and was left to us by the
people who previously ran the unit.  It's on our list of jobs to fix,
but it seems to work anyway?  YOLO.  Pull requests appreciated.</p>
</div>
</div>
<p>You can now log in to the database and try the following:</p>
<ul>
<li><code>mysql</code> on its own logs you in, you now get the database prompt <code>MariaDB [(none)]&gt;</code> to show that you haven't loaded a particular database yet.</li>
<li><code>SHOW DATABASES;</code> on the database prompt gives you a list of databases which you have access too.</li>
<li>Select one with the USE command, for example <code>USE elections;</code>. Your prompt should now read <code>MariaDB [elections]&gt;</code>.</li>
<li><code>SHOW TABLES;</code> will show the tables in the selected database.</li>
<li>There's a Party table in the elections database, so <code>SELECT * FROM Party;</code> will show you the data.</li>
<li>You could also use <code>DESCRIBE Party;</code> to show a list of columns and types in the Party table.</li>
<li>Finally, <code>exit</code> or Control+D on a line of its own gets you back to the shell.</li>
</ul>
<p>You can open the SQL and CSV files under <code>/vagrant/sampledata</code> to compare with the output you get from MariaDB. Study this until it makes sense to you. The <code>setup.sql</code> files contain the database schemas and the <code>import.sql</code> ones pull in the sample data.</p>
<h2 id="on-a-lab-machine"><a class="header" href="#on-a-lab-machine">On a lab machine</a></h2>
<p>On a lab machine, to save disk space your VMs may not remain between
reboots - and because they are not hosted on the network file system,
if you log in to a different machine next time, your changes will not
be saved either but you will get the VM reinstalled from scratch. To
make sure the database is ready whenever you need it, open the
<code>Vagrantfile</code> in a text editor and add the setup commands to the
provisioning script. The commands are the same ones that we have done just now
manually.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reading-an-er-diagram"><a class="header" href="#reading-an-er-diagram">Reading an ER diagram</a></h1>
<p>Here is an ER diagram for a fictional university database:</p>
<p><img src="db1/../resources/uni-diagram.png" alt="ER diagram" /></p>
<p>The foreign key columns are not included in the tables - in this diagram, they are implied by the relationships, e.g. the <code>Unit.director</code> column comes from the "directs" relationship.</p>
<p>Looking at the diagram and the table schemas, answer the following questions for yourself:</p>
<ul>
<li>Which relationships are mandatory or optional? (For example, must every unit have at least one student enrolled?)</li>
<li>Which relationships are one-one, one-many or many-many?</li>
<li>How do the above affect the placement of foreign keys? For example, why is the foreign key for "lecturer belongs to research group" on the Lecturer table?</li>
</ul>
<h1 id="drawing-an-er-diagram"><a class="header" href="#drawing-an-er-diagram">Drawing an ER diagram</a></h1>
<p>Draw an ER diagram for the following scenario.</p>
<blockquote>
<p>The University of Bristol Hoverboard Society (HovSoc) wants to create a database to manage its membership and events. Each member has a name, an optional student number, a contact e-mail address and a hoverboard riding skill level (represented as an integer, minimum 0). We assume that e-mail addresses are unique among members.</p>
<p>The committee consists of some of the members, each of which has a unique committee role. We assume that committee roles do not change during the year and that each committee role must be filled every year.</p>
<p>An event has a date, a name, a location, an optional description and an organiser who must be a society member (not necessarily a committee member). An event is attended by a set of members. There is never more than one event at the same location on the same date but event names are not unique.</p>
</blockquote>
<p>You can draw the diagram with pen and paper or you can use a free modelling tool like <a href="https://draw.io">draw.io</a>.</p>
<ul>
<li>For draw.io, open the "Entity Relation" section in the menu on the left and use the "Table" (first item) object for tables. Clicking on it adds a table to your diagram.</li>
<li>To add a row to a table, select an existing row and press Control-D (duplicate item). To delete a row, press the delete key.</li>
<li>To add a relationship, select a table by clicking its header and drag one of the blue triangles that appear round the edges onto another table. You can change the type of a relationship in the details panel on the right (the "line start" and "line end" boxes).</li>
<li>File/Save as lets you download your diagram in an XML-based format, which you can open and edit later. File/Export as lets you download it as an image.</li>
</ul>
<h1 id="implementing-a-schema"><a class="header" href="#implementing-a-schema">Implementing a Schema</a></h1>
<p>Write a CREATE/DROP script for the schema that you have just designed.</p>
<ul>
<li>A create/drop script starts with a sequence of DROP TABLE IF EXISTS statements followed by a sequence of CREATE TABLE scripts. The effect of running it is to make sure all tables exist and are empty, whether or not the tables existed before.</li>
<li>If table A has a foreign key to table B then you must create table B before A and drop table A before dropping B. The simple way to do this is work out the CREATE order, then put all DROP statements in the exact opposite order.</li>
</ul>
<p>Save your script as a file (the extension <code>.sql</code> is usual for SQL scripts).</p>
<p>To test that it works, log in to the database with <code>mysql</code> on the command line in the lab machine, from a terminal in the same folder as your create/drop script. Then run the command</p>
<pre><code>USE data;
</code></pre>
<p>to select the (initially empty) database called <code>data</code>, on which you have read and write permissions. Note that there is a semicolon at the end.</p>
<p>As long as you started your MariaDB session in the folder with your script, you can now run the command <code>\. SCRIPTNAME.SQL</code>, that is a backslash, a period, a space and then the name of the script. As this is a command directly for the MariaDB client rather than a command to be run on the server, it does not take a semicolon.</p>
<p>If you get any errors, then <code>SHOW ERRORS;</code> will display more information. If not, check with <code>SHOW TABLES;</code> that your tables exist.</p>
<p>Now, run the script a second time. If the order of all commands is correct, then it should run through again without errors.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="more-modelling"><a class="header" href="#more-modelling">More modelling</a></h1>
<p>Using what you have learnt so far about relational modelling, think about and discuss in groups how you would model a university database to store student's academic progress, such as units enrolled on and completed, marks obtained etc. based on your understanding of how the University of Bristol works. For example, a unit can have different assessments with different weights. You will of course also need a <code>Students</code> table, and you can make the model more involved if you like by including that different students are on different degree programmes, and that sometimes students have to resit units.</p>
<p>You should end up with a more detailed version of the model briefly shown at the top of the previous page - if you have the time you can make both an ER diagram and a create/drop script.</p>
<p>This is also a good point to mention another fact of how marks and credit points work: exam boards. At the end of each academic year around May, your unit directors all report their marks for each student to an exam board, which sits and decides on final marks and awarding credit. For example, an exam board can moderate the marks for a unit. This is why you do not get your exam marks until a long time after the exam has happened, even if it's a multiple choice exam that can be marked automatically: the marks still have to go through an exam board. (There is another, smaller exam board around the start of Teaching Block 2 so you don't have to wait until summer for your January exam marks to be released.)
If you want to model this in your schema, the idea here is that a student has two marks associated with each unit: the "actual mark" (the input to the exam board) and the "agreed mark" (the one that comes out of the board and goes on your transcript). Of course, for most students most of the time, the two are the same. Your schema will need to store "agreed marks" explicitly, but there are ways of doing the model that does not store the "actual mark" directly. Think about how you could recompute it from other information in the database - we will of course learn how to do this in SQL in a later activity.</p>
<p>The key idea in relational modelling is not to store information more than once if you can avoid it. If you have stored in several places that Fred is taking Introduction to Programming, and then Fred switches his units, you don't want to end up with a situation where this change is only reflected in some parts of the database.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="explore-the-database"><a class="header" href="#explore-the-database">Explore the database</a></h1>
<p>Open the virtual machine and type <code>mysql</code>. Assuming you have installed the database correctly as in the previous activity, you should see the prompt <code>MariaDB [(none)]&gt;</code> which shows that you are connected to a database server but you have not selected a database yet.</p>
<p>Have a look at the databases that exist with the command</p>
<pre><code>SHOW DATABASES;
</code></pre>
<p>Like all SQL commands, it needs a semicolon at the end. You should see four databases including <code>census</code> and <code>elections</code>. Let's select one of them:</p>
<pre><code>USE elections;
</code></pre>
<p>SQL keywords like <code>USE</code> are not case-sensitive, but it is convention to write them in all upper case. SQL names of tables, columns etc. like <code>elections</code> however are case-sensitive. Your prompt should now show <code>MariaDB [elections]&gt;</code>.</p>
<p>Have a look at the tables in this database with</p>
<pre><code>SHOW TABLES;
</code></pre>
<p>You should see <code>Candidate</code>, <code>Party</code> and <code>Ward</code>. Let's have a look at one:</p>
<pre><code>DESCRIBE Candidate;
</code></pre>
<p>The output will look like this:</p>
<pre><code>+-------+--------------+------+-----+---------+----------------+
| Field | Type         | Null | Key | Default | Extra          |
+-------+--------------+------+-----+---------+----------------+
| id    | int(11)      | NO   | PRI | NULL    | auto_increment |
| name  | varchar(100) | NO   | UNI | NULL    |                |
| party | int(11)      | YES  | MUL | NULL    |                |
| ward  | int(11)      | YES  | MUL | NULL    |                |
| votes | int(11)      | YES  |     | NULL    |                |
+-------+--------------+------+-----+---------+----------------+
</code></pre>
<p>The first two columns tell you the names and types of columns in this table. The third column (Null) tells you if NULL values are allowed in this column. The Key column tells us that id is the primary key (PRI), name has a unique constraint (UNI), party and ward are foreign keys (MUL) and there are no key constraints at all on votes.</p>
<p>For even more information, try this:</p>
<pre><code>SHOW CREATE TABLE Candidate;
</code></pre>
<p>The output is a bit messy but it shows you (more or less) the statement used to create the table. From here we can read off the details of the foreign keys:</p>
<pre><code>CONSTRAINT `Candidate_ibfk_1` FOREIGN KEY (`party`) REFERENCES `Party` (`id`)
CONSTRAINT `Candidate_ibfk_2` FOREIGN KEY (`ward`) REFERENCES `Ward` (`id`)
</code></pre>
<p>So the <code>party</code> column is a foreign key pointing at the <code>id</code> column in the <code>Party</code> table.</p>
<p>Now let's look at some data. This command shows you all entries in the Candidate table:</p>
<pre><code>SELECT * FROM Candidate;
</code></pre>
<p>There are 141 entries. Looking at the first one:</p>
<pre><code>+-----+--------------------------------+-------+------+-------+
| id  | name                           | party | ward | votes |
+-----+--------------------------------+-------+------+-------+
|   1 | Patrick Dorian Hulme           |     1 |    1 |    16 |
</code></pre>
<p>The party and ward ids on their own don't tell us much, but as they are foreign keys we can use them to join on the tables that do contain this information:</p>
<pre><code>SELECT * FROM Candidate
INNER JOIN Party ON Party.id = Candidate.party
INNER JOIN Ward ON Ward.id = Candidate.ward;
</code></pre>
<p>On the MariaDB prompt, if you don't end with a semicolon then the program assumes you want to type a command over multiple lines, and shows the continuation prompt <code>-&gt;</code> for the next ones. This also allows you to copy-paste multi-line commands from a text editor into the MariaDB client. Ending a line with a semicolon executes the query and drops you back to the main prompt.</p>
<p>You will now see a much longer listing, starting like this (I have shortened some columns):</p>
<pre><code>+-----+----------------------+-------+------+-------+----+--------------+----+-----------+------------+
| id  | name                 | party | ward | votes | id | name         | id | name      | electorate |
+-----+----------------------+-------+------+-------+----+--------------+----+-----------+------------+
|   7 | Matthew Simon Melias |     7 |    1 |  1067 |  7 | Conservative |  1 | Avonmouth |       9185 |
</code></pre>
<p>The first thing to note is that the results are no longer in the same order: P. D. Hulme is no longer at the top. Unless you tell the database that you want a particular order, it is allowed to choose its own one and depending on what joins you do, this might change.</p>
<p>There are several columns here named id, one from each of the tables - in general, doing <code>SELECT *</code> on a joined table gets you more data than you need.
This would be a nicer query unless you're actially interested in the ids:</p>
<pre><code>SELECT Candidate.name AS name,
Party.name AS party,
Ward.name AS ward,
votes,
electorate
FROM Candidate
INNER JOIN Party ON Party.id = Candidate.party
INNER JOIN Ward ON Ward.id = Candidate.ward;
</code></pre>
<p>Here is the start of the output that I get:</p>
<pre><code>+----------------------+--------------+-----------+-------+------------+
| name                 | party        | ward      | votes | electorate |
+----------------------+--------------+-----------+-------+------------+
| Matthew Simon Melias | Conservative | Avonmouth |  1067 |       9185 |
</code></pre>
<p>Explore the elections database a bit to get a feel for how the data is structured.
For example, what party and ward did Patrick Dorian Hulme from above stand for?
What is the schema of the elections database - you might want to draw a diagram?</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bristol-elections"><a class="header" href="#bristol-elections">Bristol elections</a></h1>
<p>In 2014, Bristol held council elections for 24 of its wards. Each ward elected one councillor to represent the ward on the city council. The results are in the <code>elections</code> database, with the following schema as you have hopefully just discovered:</p>
<p><img src="db2/../resources/elections.png" alt="elections ER diagram" /></p>
<p>From an ER diagram you can derive a <em>JOIN strategy</em>, a way of representing all the useful information in a database. For individual queries, you may only need a subset of this information so you can leave off unnecessary parts of the full JOIN strategy. In this case, the following would work:</p>
<pre><code>SELECT Candidate.name AS name, Party.name AS party, Ward.name AS ward, Candidate.votes, Ward.electorate
FROM Candidate 
INNER JOIN Party ON Candidate.party = Party.id
INNER JOIN Ward ON Candidate.ward = Ward.id
</code></pre>
<h2 id="exercises-8"><a class="header" href="#exercises-8">Exercises</a></h2>
<p>Find SQL statements to answer the following questions. Your answer to each question should be a single query, and you should not hard-code any ids. For example, if a question is about the Labour party, you should use the string <code>'Labour'</code> in your query somewhere, not look up the party id and hard-code that in your query.</p>
<p>Although you can answer all the exercises in this section by taking the join strategy and adding clauses where necessary, there is sometimes a quicker way. But if you don't know where to start, consider how you would extract the result you want from the joined table. The WHERE clause determines which rows appear in the result and the SELECT clause picks the columns that appear in the result.</p>
<ol>
<li>List the names of all parties that stood in the election, ordered alphabetically by name.</li>
<li>List the names of all parties that stood in the Bedminster ward.</li>
<li>How many votes did Labour get in the Stockwood ward?</li>
<li>List the names, parties and number of votes obtained for all candidates in the Southville ward. Order the candidates by number of votes obtained descending (winner comes first).</li>
<li>List the name, party and number of votes obtained for the winner only in the Knowle ward. <em>(Hint: apart from changing the ward name, you only need one small modification to the statement from the last question. You may assume no ties.)</em></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-2011-uk-census"><a class="header" href="#the-2011-uk-census">The 2011 UK Census</a></h1>
<p>In 2011, the UK took a census of all households. We will look at the data for one particular question: "KS608 Occupation".</p>
<h2 id="background-uk-geography"><a class="header" href="#background-uk-geography">Background: UK Geography</a></h2>
<p>The United Kingdom of Great Britain and Northern Ireland (UK) is a country that contains the individual countries England, Wales, Scotland (at the time of writing) and Northern Ireland (but not the Republic of Ireland). The census data for this question comes from the Office of National Statistics (ONS) which is for England and Wales only. Scotland and Northern Ireland have separate statistical offices.</p>
<p>England itself can be divided into 9 regions:</p>
<ul>
<li>The North West</li>
<li>Yorkshire and The Humber</li>
<li>The North East</li>
<li>The West Midlands</li>
<li>The East Midlands</li>
<li>The South West</li>
<li>The East</li>
<li>The South East</li>
<li>London</li>
</ul>
<p>The UK used to be further divided into counties but these are much less important nowadays. In fact there is a mix of counties, unitary authorities and boroughs - 152 in total. These are all called "county-level units" (CLUs).</p>
<p>The smallest relevant unit for political and statistical purposes is the electoral ward, often simply called ward. Wards elect their own councillors (as we have seen) and national statistics are available at a ward level. There were 8570 wards at the time of the 2011 census. For example, the City of Bristol unitary authority contained 35 wards, of which the University of Bristol was in the Cabot ward.</p>
<p>Each statistical unit (ward, county, unitary authority etc.) is assigned a 9-character code by the ONS of the form <code>Xaabbbbbb</code> where X is E for England and W for Wales. The first two digits <code>aa</code> identify the type of unit: 05 is a ward, 06 a unitary authority; in England only E12 is a region, E08 is a borough (metropolitan), E09 is a borough of London and E10 is a county. The last 6 digits identify the individual unit. Finally, the codes for all of England and Wales are E92000001 and W92000004.</p>
<p>An interactive online map of the statistical units of the UK is available online at <a href="http://ukdataexplorer.com/census/">UK data explorer</a> or <a href="https://datashine.org.uk">DataShine</a>. All census data for individual questions is publicly available. (The most interesting data - correlations between questions - is not all openly available due to privacy issues. Researchers can apply to the ONS to get access to particular data sets.)</p>
<h2 id="data-format"><a class="header" href="#data-format">Data format</a></h2>
<p>The <code>census</code> database has the following schema.</p>
<p><img src="db2/../resources/census.png" alt="census ER diagram" /></p>
<p>For wards in England, the <code>parent</code> FK points at the county table and identifies the CLU (county-level unit) to which the ward belongs. For wards in Wales, the <code>Ward.parent</code> column is <code>NULL</code> which you need to take into account when working out a JOIN strategy.</p>
<h2 id="ks608-occupation"><a class="header" href="#ks608-occupation">KS608: Occupation</a></h2>
<p>Question KS608 on the 2011 census asked all UK citizens in employment and between the ages of 16 and 74 to classify themselves as one of 9 occupation classes.</p>
<ul>
<li>Have a look at the <code>Occupation</code> table in the <code>census</code> database to see the 9 occupation classes.</li>
</ul>
<p>The answers to the question are recorded in the <code>Statistic</code> table in the following format. Gender is 1 for women an 0 for men; in the 2011 census these where the only gender options.</p>
<pre><code>+-----------+-------+--------+------+
| wardId    | occId | gender | data |
+-----------+-------+--------+------+
| E05000001 |     1 |      1 |   54 |
+-----------+-------+--------+------+
</code></pre>
<p>This row records that in ward <code>E05000001</code> (Aldersgate), 54 women (gender=1) said that they worked as "Managers, directors and senior officials" (occId=1).</p>
<p>Note how (in the ER diagram) the primary key of the Statistic table is a composite of three columns (wardId, occId, gender). This is exactly what you would expect in a table that has one data value per ward, occupation class and gender.</p>
<h2 id="exercises-9"><a class="header" href="#exercises-9">Exercises</a></h2>
<ol>
<li>The university of Bristol is situated in the <code>Cabot</code> ward (ward names are not always distinct, but this one is). Find the names and codes of the CLU, region and country containing the Cabot ward (CLU = county level unit = "row in County table").</li>
<li>If you used multiple SQL queries for the last question, do it in one single query now. (In other words, find a join strategy for the tables you need.)</li>
<li>Find the number of women in occupation class 1 (managers etc.) in the Cabot ward. You may use ward code for Cabot that you found in the first query and the occupation id 1 directly - you do not need any JOINs for this query.</li>
<li>For the Stoke Bishop ward (E05002003), list the 9 occupation class names and the number of men in each occupation. Your table should have two columns called <code>name</code> and <code>number</code>. You can use the provided ward code, you do not need to join on the ward name.</li>
</ol>
<p>We will soon be able to do more interesting statistical queries on the census data but for that we need SQL's statistical functions which we will learn next week.</p>
<p>Here's a slightly more tricky question to finish off with. It can be done with only the techniques that we have learnt so far.</p>
<ul>
<li>Find all ward names that are not unique, and print them in alphabetical order (only once each).</li>
</ul>
<p><em>There are 400 distinct such names in total (for example, there are 21 wards called 'Abbey') so your query will produce quite a long table. Your query might also take a while to execute, there are faster ways to do this but not with the material we've learnt so far. The table starts "Abbey, Alexandra, All Saints" and ends "Worsley, Wyke, Yarborough".</em></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="normal-forms"><a class="header" href="#normal-forms">Normal Forms</a></h1>
<p>For this exercise, you may want to work in groups. There are two schemas, for both of which you have to decide which normal form(s) they are in, and how you would change the schemas to be in 3NF (BCNF if possible).</p>
<p>The standard way of doing this is:</p>
<ol>
<li>Identify the candidate key(s) in every table.</li>
<li>From this, deduce the key and non-key attributes in every table.</li>
<li>Find the functional dependencies (FDs) in each table.</li>
<li>Determine which normal forms from (1NF, 2NF, 3NF, BCNF) the schema does or does not satisfy.</li>
<li>If the schema is not in BCNF, normalise it as far as possible by splitting tables using Heath's Theorem on the FDs that are causing the problem.</li>
</ol>
<h2 id="schema-1"><a class="header" href="#schema-1">Schema 1</a></h2>
<p>A school's database looks like this (it was set up by someone more used to spreadsheets):</p>
<div class="table-wrapper"><table><thead><tr><th>stuId</th><th>name</th><th>gender</th><th>unit</th><th>grade</th></tr></thead><tbody>
<tr><td>101</td><td>Fred</td><td>M</td><td>Mathematics</td><td>75</td></tr>
<tr><td>101</td><td>Fred</td><td>M</td><td>German</td><td>65</td></tr>
<tr><td>101</td><td>Fred</td><td>M</td><td>English</td><td>90</td></tr>
<tr><td>102</td><td>Sam</td><td>X</td><td>Mathematics</td><td>60</td></tr>
<tr><td>102</td><td>Sam</td><td>X</td><td>English</td><td>60</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
</tbody></table>
</div>
<p>stuId is a student id that is unique per student. Students' names are not required to be unique, i.e. you can have two 'Fred's in the school. Gender is one of {M, F, X}. For each student and each unit they take, there is one row containing among other things the student name, unit name and the grade (0-100) that the student got on this unit. In the example above, we can see that Fred took three units (Mathematics, German and English). No two units have the same name but a unit name can appear several times in the database since many students can take the same unit. The first row of the example tells us that there is a student called Fred with id 101, who is male, and took the Mathematics unit and got a grade of 75 on it.</p>
<h2 id="schema-2"><a class="header" href="#schema-2">Schema 2</a></h2>
<p>The CIA world factbook contains geographical, political and military information about the world. Here is part of one table listing principal cities from 2015:</p>
<div class="table-wrapper"><table><thead><tr><th>*city</th><th>country</th><th style="text-align: right">pop</th><th style="text-align: right">co_pop</th><th>capital</th></tr></thead><tbody>
<tr><td>...</td><td>...</td><td style="text-align: right">...</td><td style="text-align: right">...</td><td>...</td></tr>
<tr><td>Paris</td><td>France</td><td style="text-align: right">10.8M</td><td style="text-align: right">66.8M</td><td>yes</td></tr>
<tr><td>Lyon</td><td>France</td><td style="text-align: right">1.6M</td><td style="text-align: right">66.8M</td><td>no</td></tr>
<tr><td>Marseille</td><td>France</td><td style="text-align: right">1.6M</td><td style="text-align: right">66.8M</td><td>no</td></tr>
<tr><td>Papeete</td><td>French Polynesia</td><td style="text-align: right">133K</td><td style="text-align: right">285K</td><td>yes</td></tr>
<tr><td>Libreville</td><td>Gabon</td><td style="text-align: right">707K</td><td style="text-align: right">1.7M</td><td>yes</td></tr>
<tr><td>...</td><td>...</td><td style="text-align: right">...</td><td style="text-align: right">...</td><td>...</td></tr>
</tbody></table>
</div>
<p>We will assume for this exercise that city names are globally unique and therefore the "City" column has been chosen as the primary key for this table. The "pop" column lists the city's population and the "co_pop" lists the population of the country in which the city is located (with abbreviations K = 1000, M=1000000). The "capital" column is a Boolean yes/no value that is set to "yes" for exactly one city in each country. (While the capital is included in the table for every country however small, non-captial cities are only included if they are of international significance.)</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="intermediate-sql"><a class="header" href="#intermediate-sql">Intermediate SQL</a></h1>
<p>This is the third of four activities to teach you about relational databases and SQL.</p>
<h2 id="videos-8"><a class="header" href="#videos-8">Videos</a></h2>
<p>The videos for this activity are:</p>
<div class="table-wrapper"><table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/455af5a1-bcca-4378-a0e1-6b52891b20a4">Intermediate SQL</a></td><td style="text-align: right">22 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EWv9-8AjCwpBpO0V9einLsEBSugn1YIDSV_18mknho_Vvw?e=L0TOLh">slides</a></td></tr>
</tbody></table>
</div>
<h2 id="exercises-10"><a class="header" href="#exercises-10">Exercises</a></h2>
<p>The exercises for this activity are all on one page:</p>
<ul>
<li><a href="db3/./exercises.html">Intermediate SQL</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="census-and-elections-exercises"><a class="header" href="#census-and-elections-exercises">Census and elections exercises</a></h1>
<p>Here are some more advanced exercises based on the census and elections schemas from the last activity.</p>
<p>Your answer to each question should be a single SQL query, that is one semicolon at the end. JOINs, subqueries, WITH clauses etc. are allowed of course.
Where an identifier is given in the question you may use it, e.g. when I say "the Cabot ward (E05001979)" you can use the ward id directly and do not need to join on the ward table to look up the name, but if I say "the Green party" then you do need to join on the party table to look up the name instead of hard-coding the party id.</p>
<h2 id="elections"><a class="header" href="#elections">Elections</a></h2>
<p><img src="db3/../resources/elections.png" alt="elections ER diagram" /></p>
<ol>
<li>How many votes were cast in all of Bristol in the 2014 elections?</li>
<li>How many votes were cast in the 'Windmill Hill' ward and what percentage of the electorate in this ward does this represent? Your statement should produce a table with one row and two columns called 'votes' and 'percentage'.</li>
<li>List the names, parties and <em>percentage</em> of votes obtained for all candidates in the Southville ward. Order the candidates by percentage of votes obtained descending.</li>
<li>How successful (in % of votes cast) was the Conservative party in each ward?</li>
<li>Which rank did Labour end up in the 'Whitchurch Park' ward? Your statement should produce a table with a single row and column containing the answer as a number. You can assume no ties.</li>
<li>What is the total number of votes that each party got in the elections? Your result should be a table with two columns party, votes.</li>
<li>Find all wards where the Green party beat Labour and create a table with two columns ward, difference where the difference column is the number of Green votes minus the number of Labour votes. Your table should be ordered by difference, with the highest one first.</li>
</ol>
<h2 id="census"><a class="header" href="#census">Census</a></h2>
<p><img src="db3/../resources/census.png" alt="census ER diagram" /></p>
<ol>
<li>How many <em>women</em> work in sales and customer service occupations and live in the Cabot ward of Bristol (E05001979)?</li>
<li>How many <em>people</em> work in sales and customer service occupations and live in the Cabot ward of Bristol (E05001979)?</li>
<li>How many people work in caring, leisure and other service occupations (occupation class 6) in all of the City of Bristol CLU (E06000023)?</li>
<li>In the Cabot ward (E05001979), produce a table listing the names of the 9 occupation classes and the number of people in each of the classes in this ward.</li>
<li>Find the working population, ward name and CLU name for the smallest ward (by working population) in the 2011 census.</li>
<li>The same as the last question, but now produce a table with two rows, one for the smallest and one for the largest ward. There's no quicker way than repeating the last query twice, the question is how to stick the two "copies" together.</li>
<li>Find the average size of a ward's working population in the London (E12000007) region.</li>
<li>The same as the last question but now for every region - your query should produce a table with one row per region. The intention here is <em>not</em> to repeat the above query 9 times.</li>
<li>Produce a table that lists, for each of the 9 regions of England, the percentage of people in managerial (class 1) occupations who are women.</li>
<li>For all CLUs in the London (E12000007) region, produce a table with three columns called <code>CLU</code>, <code>occupation</code> and <code>count</code> such that:
<ul>
<li><code>CLU</code> is the CLU name.</li>
<li><code>count</code> is the number of people of the occupation class in question in the given CLU.</li>
<li><code>occupation</code> is the name of the occupation class.</li>
<li>Only rows with <code>count &gt;= 10000</code> appear in the table.</li>
<li>The table is sorted by <code>count</code> ascending.</li>
</ul>
</li>
<li>Create a table with three columns <code>occupation</code>, <code>women</code> and <code>men</code> and one row per occupation class. The <code>occupation</code> column should list the occupation class names. The <code>women</code> and <code>men</code> columns in each row should list the total number of women resp. men in the row's occupation class in the whole dataset. The intention here is not to have to copy-paste a subquery 9 times.</li>
<li>The same as question 9, but now with a 10th row in the table listing the value for all of England. You can use the string <code>'England'</code> for the region column.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sql-and-java"><a class="header" href="#sql-and-java">SQL and Java</a></h1>
<p>In this activity you will learn how to connect to an SQL database from a Java program using the JDBC interface and the Hibernate ORM.</p>
<h2 id="videos-9"><a class="header" href="#videos-9">Videos</a></h2>
<p>The videos for this activity are:</p>
<div class="table-wrapper"><table><thead><tr><th>Video</th><th style="text-align: right">Length</th><th>Slides</th></tr></thead><tbody>
<tr><td><a href="https://web.microsoftstream.com/video/9c046863-65f4-44a2-91bb-0bf1023c78b4">JDBC</a></td><td style="text-align: right">25 minutes</td><td><a href="https://uob-my.sharepoint.com/:b:/g/personal/me17847_bristol_ac_uk/EZqSbPzVyMBOjLk7wVVV4ecBcg_JSPIYMPT2AkTC0npttw?e=E2qtCw">slides</a></td></tr>
</tbody></table>
</div>
<h2 id="exercises-11"><a class="header" href="#exercises-11">Exercises</a></h2>
<p>The exercises for this activity are:</p>
<ul>
<li><a href="db4/./jdbc.html">JDBC</a></li>
<li><a href="db4/./hibernate.html">Hibernate</a></li>
<li><a href="db4/./sqlite.html">SQLite</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="jdbc"><a class="header" href="#jdbc">JDBC</a></h1>
<p>In this activity you will learn to connect to a SQL database using Java and the JDBC classes.
JDBC (Java DataBase Connectivity) is a low-level, not particularly object-oriented mechanism for accessing a database, on top of which other systems (e.g. Hibernate ORM) can be built.</p>
<h2 id="jdbc-interfaces"><a class="header" href="#jdbc-interfaces">JDBC Interfaces</a></h2>
<p>The JDBC classes live in the <code>java.sql</code> package. Most methods on these classes can throw a <code>SQLException</code> which is a checked exception, meaning your code won't compile if you don't handle it. For simple programs, this means wrapping in a <code>RuntimeException</code> to terminate the program if something goes wrong:</p>
<pre><code class="language-java">try {
    // do stuff with JDBC
} catch (SQLException e) {
    throw new RuntimeException(e);
}
</code></pre>
<p>Two comments on this pattern:</p>
<ol>
<li>In a real program e.g. web server, you of course do not want to take the server down whenever an individual method causes an error. Here you need to do something like log the error, and display an error message to that particular caller (e.g. HTTP 500 Internal Server Error) while keeping the rest of the server running. How you achieve this depends on which libraries or frameworks you are using.</li>
<li>Most JDBC work will actually take place in try-with-resources blocks, which work the same as far as exception handling is concerned but have an extra bracketed term immediately after the <code>try</code>.</li>
</ol>
<h2 id="try-with-resources"><a class="header" href="#try-with-resources">Try-with-resources</a></h2>
<p>A resource is something that you need to close exactly once when you are done with it, but only if it got properly opened in the first place. For example, in C heap memory is a resource: you acquire (open) it with <code>malloc</code>, and when you are done you must call <code>free</code> exactly once on the memory, except if <code>malloc</code> returned NULL in the first place (allocation failed) in which case calling <code>free</code> is an error. (You do check your <code>malloc</code> return value for NULL, don't you?) It is also an error to call <code>free</code> twice on the same memory, and it is a memory leak not to call it at all.</p>
<p>In Java, we don't have to manage memory by hand, but there are other kinds of resources:</p>
<ul>
<li>Files.</li>
<li>Network connections.</li>
<li>Graphics objects in some drawing/window systems.</li>
<li>Database connections.</li>
</ul>
<p>To help manage these, Java provides an interface <code>java.lang.AutoCloseable</code> with a single method <code>void close()</code> and the try-with-resources construction:</p>
<pre><code class="language-java">try (Resource r = ...) {
    // do things with r here
}
</code></pre>
<p>As long as the resource implements <code>AutoCloseable</code> (it's a syntax error to use this pattern otherwise), this pattern guarantees that</p>
<ol>
<li>If the initialisation statement (in the round brackets) fails, either by returning null or throwing an exception, then the block will never be executed.</li>
<li>If the initialisation succeeds, then when the block exits, <code>r.close()</code> will be called exactly once, whether the block reached its end, exited early (e.g. return statement) or threw an exception.</li>
</ol>
<p>A try-with-resources block can, but does not have to, include one or more <code>catch</code> statements, in which case they apply to the block, the initialisation statement and the implied <code>close()</code>.</p>
<p>You can also include more than one resource in the try statement by separating them with semicolons inside the bracketed term.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Earlier versions of java used the <code>finally</code> keyword to achieve something similar, but it was more challenging to get right especially if the close function could also throw an exception. Since Java 7, try-with-resources is the correct pattern to use and you should almost never need a <code>finally</code> block. You can implement <code>AutoCloseable</code> on your own classes to support this.</p>
</div>
</div>
<h2 id="opening-a-connection"><a class="header" href="#opening-a-connection">Opening a connection</a></h2>
<p>You open a connection by calling</p>
<pre><code class="language-java">try(Connection c = DriverManager.getConnection(connection_string)) {
    // do stuff with connection
} catch (SQLException e) {
    // handle exception, for example by wrapping in RuntimeException
}
</code></pre>
<p>The connection string is a string containing a URL such as</p>
<pre><code>jdbc:mariadb://localhost:3306/DATABASE?user=USER&amp;localSocket=/var/run/mysqld/mysqld.sock
</code></pre>
<p>When you try and open a connection, Java looks for a driver on your classpath that implements the addressing scheme (e.g. <code>mariadb</code>) that you have requested. This makes setting up the classpath a bit tricky, but we have maven to manage that for us.</p>
<p>However, we need to understand a bit about networking and security to make sense of that URL.</p>
<p>In a traditional database set-up, the database lives on its own machine (or cluster of machines) and applications connect to it over the network. To do this, by default, databases listen on TCP port 3306.</p>
<p>For security reasons, a competent adminstrator will set things up so that there
is a firewall preventing access to the database from any machines except those
of applications (and possibly developers and administrators), the database
machine will certainly not be available directly from the internet. Then,
applications will also need a username and password to connect to the database.
Since these passwords are used by applications, and do not need to be remembered
by humans, there is absolutely no excuse for choosing weak ones: the absolute
minimum is something with 128 bits of entropy. Computers have no problems
remembering something this long! In this case you add the extra <code>pass=</code> argument
to the connection string, and to prevent passwords being sent unencrypted over
the network (even if it's your internal network) you can also set up TLS or a
similar tunneling technology.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>Learning how to secure things takes time but doing things like long
passwords and encryption by default is only a start.  If you want to
get clever you could muck about with behavioural checks so that if
someone starts doing something they don't normally do it triggers
logs.  How are you going to spot when your database has been attacked?
How are you going to tell when its being attacked but hasn't yet been
broken in to?  How are you going to get it back up and running before
someone comes and yells at you?</p>
<p>Whilst the clever stuff is all fun and good an <em>awful</em> lot of this
ultimately boils down to good old fashioned sysadmining.  Backup
everything regularly. Note what changes.  Get your logs off the
machine ASAP before they can be tampered with.  Rotate your keys
regularly because you can write a shellscript for it and whilst it
make anything more secure it'll make a compliance person happy.</p>
<p>For a more complete guide to managing a computer, see any of Michael W
Lucas's books.</p>
</div>
</div>
<p>On our VM, when you set up mariadb by default, the database server and client
are both running on the same machine, so you can gain both security and
performance by not using a network connection at all - instead when you type
<code>mysql</code> it connects over a POSIX socket, another special type of file (type <code>s</code>
in <code>ls -l</code>), in this case <code>/var/run/mysqld/mysqld.sock</code>. A POSIX socket is like
a pair of pipes in that it allows bidirectional, concurrent communication
between different processes, but with an API closer to that of a network (TCP)
socket.</p>
<p>The point of all this discussion is that for your VM, your connection string
will look like this (all on one line with no newlines):</p>
<pre><code>jdbc:mariadb://localhost:3306/DATABASE?user=USER&amp;localSocket=/var/run/mysqld/mysqld.sock
</code></pre>
<p>The <code>localSocket</code> option overrides the host/port at the start. For this to work, you need the mariadb driver and a library called JNA (Java Native Access) on your classpath, and of course your system needs to support sockets.</p>
<p>The more standard connection string for a TCP connection would look like this:</p>
<pre><code>jdbc:mariadb://localhost:3306/DATABASE?user=USER
</code></pre>
<p>Which really does connect to TCP port 3306 on localhost.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>You can configure this on your VM if you wanted to: the main mariadb
configuration file is <code>/etc/my.cnf</code> which in our case just contains a statement
to include all files in the <code>/etc/my.cnf.d/</code> folder; in there we have
<code>mariadb-server.cnf</code> which contains the lines</p>
<pre><code>[mysqld]
skip-networking
</code></pre>
<p>Remove the last line and restart the server (<code>systemctl restart mariadb</code>) and then your mariadb server (<code>mysqld</code>) will really be listening on port 3306.</p>
<p>We didn't notice this with the console client <code>mysql</code> because that by default tries the socket first, and then port 3306 if the socket doesn't exist. However the JDBC driver will only try exactly the options you give, and if you don't tell it to use the socket, it will try port 3306 and throw and exception if nothing is listening there.</p>
</div>
</div>
<h2 id="pom-file"><a class="header" href="#pom-file">POM file</a></h2>
<p>Under <code>code/jdbc/</code> in this unit's repository you can find a minimal JDBC application that uses the <code>elections</code> database. Download this to your VM with <code>wget</code> (or get it from the unit repository, if you have cloned it there) and extract it to an otherwise empty folder (<code>tar -xvf jdbc-example.tar</code>). It contains a file <code>pom.xml</code> and a file <code>src/main/java/org/example/Example.java</code>.</p>
<p>In the POM file, we note the following dependencies:</p>
<pre><code class="language-xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.mariadb.jdbc&lt;/groupId&gt;
        &lt;artifactId&gt;mariadb-java-client&lt;/artifactId&gt;
        &lt;version&gt;2.7.1&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;net.java.dev.jna&lt;/groupId&gt;
        &lt;artifactId&gt;jna&lt;/artifactId&gt;
        &lt;version&gt;5.6.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;net.java.dev.jna&lt;/groupId&gt;
        &lt;artifactId&gt;jna-platform&lt;/artifactId&gt;
        &lt;version&gt;5.6.0&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>The first one is the mariadb JDBC driver. When maven runs a program, it automatically puts the dependencies on the classpath; if you left this off then creating the <code>Connection</code> would throw an exception.</p>
<p>The other two are the JNA (Java Native Access) libraries for your platform, that the driver uses to connect to a POSIX socket. If you left these off, the driver would ignore the <code>localSocket</code> option, try to connect to port 3306, and throw an exception because there is nothing listening there (unless you have configured it).</p>
<ul>
<li>Run <code>mvn compile</code> in the folder with the POM file to download the dependencies and compile the example program.</li>
<li>Run <code>mvn exec:java</code> to run the program. This uses the <code>exec-maven-plugin</code> configured later in the POM file to launch the program with the main class <code>org.example.Example</code> and the correct classpath. It should print out a list of parties.</li>
<li>If you want, you can use <code>mvn package</code> to build two JAR files in <code>target</code>: one is just the compiled example class, but the more interesting one has <code>jar-with-dependencies</code> in its name and contains the compiled class and all dependencies, namely the JDBC mariadb driver and JNA (and all their dependencies). You can run this jar with <code>java -cp jdbc-example-0.1-jar-with-dependencies.jar org.example.Example</code> without using maven if you want to. This file is built by the <code>maven-assembly-plugin</code> which we have also configured in the POM file.</li>
</ul>
<h2 id="sql-from-java"><a class="header" href="#sql-from-java">SQL from Java</a></h2>
<p>In the <code>Example.java</code> class, we can see an example of JDBC in action:</p>
<pre><code class="language-java">private void readData(Connection c) {
    String SQL = "SELECT id, name FROM Party";
    try (PreparedStatement s = c.prepareStatement(SQL)) {
        ResultSet r = s.executeQuery();
        while (r.next()) {
            int id = r.getInt("id");
            String name = r.getString("name");
            System.out.println("Party #" + id + " is: " + name);
        }
    } catch (SQLException e) {
        throw new RuntimeException(e);
    }
}
</code></pre>
<ul>
<li>The SQL command goes in a string. If we wanted to add parameters for a prepared statement, we put question marks here.</li>
<li>We create a <code>PreparedStatement</code> in another try-with-resources block: we need to close statements as soon as we are done with them, but it's ok for a program to keep the database connection open for as long as it runs.</li>
<li>In this case, we have no parameters to pass, so we execute the query to get a <code>ResultSet</code>, a "cursor" (a kind of iterator) on the results. (A <code>ResultSet</code> is also a resource, but it closes automatically when its statement closes, so we don't have to handle this ourselves.)</li>
<li>We iterate over the rows of the result and do something with them, in this case printing to standard output.</li>
<li>All these operations can throw an <code>SQLException</code>, so we catch it at the end, and because this is just a small example program, we handle it by throwing an exception to terminate the whole program.</li>
</ul>
<h2 id="result-sets"><a class="header" href="#result-sets">Result Sets</a></h2>
<p>Java is an object-oriented language with a compile-time type system: if you declare that a <code>class Person</code> has a field <code>int age</code>, then the compiler will stop you from ever trying to put a string in there. JDBC cannot offer you this level protection because when you compile your Java program, you don't know what tables and fields exist in the database (even if you do know, someone could change them after the program has been compiled).
So you have to fall back to some more C-like patterns for using the database.</p>
<p>A result set can either be pointing at a row in the database or not. If it is pointing at a row, you can read values with the <code>get...</code> methods. If the result set is not pointing at a row, then trying to read anything throws an SQLException. The rules here are:</p>
<ul>
<li>When you get the result set back, it starts out pointing <em>before the first row</em>, so reading immediately would throw an error.</li>
<li>Calling <code>boolean next()</code> tries to advance a row. If this returns true, then you have got a new row and can read from it; if you get false then you have stepped beyond the last row and it would be an error to read. (If there are no rows in your result at all, then the first call to <code>next()</code> will already return false.)</li>
</ul>
<p>The correct pattern to use the result set is normally a while loop, as each time you land in the loop body you're guaranteed to have found a row:</p>
<pre><code class="language-java">while (r.next()) {
    // we have a row, do something with it
}
</code></pre>
<p>There are however a couple of exceptions to this pattern. First, some statements like <code>select count(...)</code> will always return exactly one row - maybe the value in the row will be zero, but that's not the same thing as no row at all - so in this case you can do</p>
<pre><code class="language-java">if (r.next()) {
    // this should always happen    
} else {
    // this should never happen
    // throw an exception or something
}
</code></pre>
<p>It would still be an error to access the one row before calling <code>next()</code>, and we are not the kind of people who ignore return values from API calls.</p>
<p>Another special case is if you want to do something special with the first row:</p>
<pre><code class="language-java">if (r.next()) {
    // if we get here then there was at least one row
    // we're on the first row and can do something special with it
    do {
        // this block will be called exactly once for every row
        // including the first one
    } while (r.next())
} else {
    // if we get here then there were no rows at all
}
</code></pre>
<p>The <code>do-while</code> loop lets us write a block that is called exactly once for every row, while still letting us do something special with the first row without needing an ugly <code>boolean isFirstRow</code> flag or something like that.</p>
<p>Inside a result set, as long as we're sure we're on a row, we can read values from columns by declaring their name and type:</p>
<pre><code class="language-java">int id = r.getInt("id");
</code></pre>
<p>This tells JDBC that there is a column named <code>id</code> of type <code>int</code>, and to get its value. (You get an exception if the name or type are wrong.) Other methods include <code>getString</code>, <code>getDouble</code> etc.</p>
<p>For this reason, in your SQL statement, you want to be clear about the names and order of the colums you're fetching:</p>
<ul>
<li>If a column is something more complicated than a field, then give it an alias, e.g. <code>SELECT COUNT(1) AS c</code> then you can do <code>getInt("c")</code>.</li>
<li>Never do <code>SELECT *</code> from JDBC, always list exactly the columns you need. This both fixes the order you get them in, and is more efficient if you don't need all of them.</li>
</ul>
<h2 id="exercise-1"><a class="header" href="#exercise-1">Exercise 1</a></h2>
<p>Modify the example program so it takes a party ID as a parameter, and displays only that party's name, or the string "No party with this ID." if there isn't one in the database.</p>
<p>To do this you will have to change the following:</p>
<ul>
<li><code>main</code> reads a parameter off <code>args</code>, or prints an error message if you didn't pass an argument.</li>
<li><code>main</code> passes the parameter as an extra int argument to <code>readData</code>.</li>
<li>Set the parameter as a question mark in the prepared statement, and then bind the parameter to the statement.</li>
</ul>
<p>The command for binding a parameter is <code>s.setInt(pos, value)</code> where <code>pos</code> is the index of the parameter (question mark) in the string, <em>starting the count at 1 not 0</em>. So you simply want <code>s.setInt(1, value)</code>. Of course there are also <code>setString</code> etc. and these methods on the statement take a second parameter of the appropriate type.</p>
<p>The easiest way to run your command with a parameter is to build a jar with dependencies and then to call <code>java -cp JARFILE MAINCLASS PARAMETERS</code>, any further command line parameters to Java after the main class get passed as arguments to this class.</p>
<h2 id="exercise-2"><a class="header" href="#exercise-2">Exercise 2</a></h2>
<p>A service is a piece of code that can be called by other code and typically accesses resources for them. This exercise is about writing a <code>DataService</code> that abstracts away the JDBC access for the rest of your program.</p>
<p>Create the following classes in their own files (you can use private fields with public constructors/getters/setters if you prefer):</p>
<pre><code class="language-java">public class Party {
    public int id;
    public String name;
}

public class Ward {
    public int id;
    public String name;
    public int electorate;
}

public class Candidate {
    public int id;
    public String name;
    public Party party;
    public Ward ward;
    public int votes;
}
</code></pre>
<p>Now, write a class <code>DataService</code> with the following description:</p>
<ul>
<li>DataService implements <code>AutoCloseable</code>. It has one public constructor that takes a connection string and creates a <code>Connection</code> using this string, which it stores in a private field. The <code>close()</code> method closes the connection.</li>
<li>A method <code>public List&lt;Party&gt; getParties()</code> that returns a list of all parties in the database, by using JDBC on the provided connection.</li>
<li>A method <code>public Party getParty(int id)</code> that returns the party for this id, if there is one, otherwise null.</li>
</ul>
<p>These methods should handle all possible cases (e.g. <code>getWards</code> must still work if there are no wards in the database). but they should not throw an SQLException. Instead, make your own exception class called something like <code>DataServiceException</code> derived from <code>RuntimeException</code> (this can be an inner class of <code>DataService</code> if you want) and wrap the <code>SQLException</code> in that.</p>
<p><em>This is not an excuse for sloppy programmers to ignore the exceptions, by the way!</em></p>
<p>Now, adapt the <code>Example</code> program so that</p>
<ul>
<li>The main program uses the <code>DataService</code> and the domain classes (e.g. <code>Party</code>) and doesn't know about JDBC directly.</li>
<li>If you pass an id as a parameter, it fetches the party with this id (if there is one) and displays party information from the <code>Party</code> instance.</li>
<li>If you don't pass an id, it displays the list of all parties.</li>
</ul>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>The <code>DataService</code> class is a resource, and it opens a connection in its constructor and closes it when you close the instance. This is a standard pattern and works perfectly if the programmer using it uses it in a try-with-resources block.</p>
<p>However, someone could create an instance, close it manually, and then try to continue using it, which would cause a <code>SQLException</code> on the connection. To handle this case by programming defensively, you could:</p>
<ol>
<li>In the close method, set the connection field to null after closing it as a sign that this instance has been closed.</li>
<li>In all other methods, check that the connection field is not null first thing in the method and throw and exception if it is (you can write your own private method for this). According to Java conventions, the correct exception to throw in this case is a <code>java.lang.IllegalStateException</code> which means roughly <em>you are calling a method at the wrong time</em> - in this case after closing the resource in question.</li>
</ol>
</div>
</div>
<h2 id="exercise-3"><a class="header" href="#exercise-3">Exercise 3</a></h2>
<p>Implement a <code>Candidate getCandidate(int id)</code> method on the data service too. This will require you to use a JOIN in your SQL and to create instances of all three domain classes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hibernate"><a class="header" href="#hibernate">Hibernate</a></h1>
<p>JDBC lets us connect to a database and pull out data, but we have to do a lot of manual coding to check and convert types, deal with result sets and exceptions etc. We can abstract away most of this into a service class like the <code>DataService</code> at the end of the last page, but we still have to write the data service - even though it is a lot of boilerplate code that we almost need to copy-paste from a template for each new class. We could write a script that given an ER diagram in some machine-readable format, automatically generates a data service for this class to automate all this - or we could use Hibernate to do this for us.</p>
<p>Hibernate is an object-relational mapping (ORM) framework, that is to say it automatically generates an advanced form of data service at runtime which includes many extra features such as sessions, transactions, caches and connection pools. It implements the Java Persistence Api (JPA), an API that in turn builds on JDBC for the purpose of implementing ORMs. Actually Hibernate has its own features that go beyond JPA, such as its own query language.</p>
<p>In a real application, you will be using an ORM most of the time, but you can fall back to SQL for more advanced queries that the ORM cannot support easily.</p>
<h2 id="example-application---set-up"><a class="header" href="#example-application---set-up">Example application - set-up</a></h2>
<p>There is an example application in <code>code/orm</code> in the unit repository.</p>
<p>The POM file simply has an extra dependency on Hibernate:</p>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
    &lt;artifactId&gt;hibernate-core&lt;/artifactId&gt;
    &lt;version&gt;5.4.27.Final&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>Hibernate's configuration lives in <code>src/main/resources/hibernate.cfg.xml</code>. Hibernate uses a <em>Session Factory</em> to create sessions, in which you can make queries:</p>
<pre><code class="language-xml">&lt;?xml version = "1.0" encoding = "utf-8"?&gt;
&lt;!DOCTYPE hibernate-configuration SYSTEM 
"http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd"&gt;
&lt;hibernate-configuration&gt;
  &lt;session-factory&gt;
    
    &lt;!-- These properties set up the database connection. --&gt;
    &lt;property name="dialect"&gt;org.hibernate.dialect.MySQLDialect&lt;/property&gt;
    &lt;property name="connection.url"&gt;jdbc:mariadb://localhost/elections?localSocket=/var/run/mysqld/mysqld.sock&lt;/property&gt;
    &lt;property name="connection.username"&gt;vagrant&lt;/property&gt;
    
    &lt;!-- Don't use this in production, use a connection pool instead. --&gt;
    &lt;property name="current_session_context_class"&gt;thread&lt;/property&gt;

    &lt;!-- Display generated SQL on the console. --&gt;
    &lt;property name="show_sql"&gt;true&lt;/property&gt;

    &lt;!-- The classes to map to database tables. --&gt;
    &lt;mapping class="org.example.Candidate" /&gt;
    &lt;mapping class="org.example.Party" /&gt;
    &lt;mapping class="org.example.Ward" /&gt;
    
  &lt;/session-factory&gt;
&lt;/hibernate-configuration&gt;
</code></pre>
<ul>
<li>The <em>dialect</em> selects the SQL dialect to speak to the database, in this case <em>MySQL</em> (there's no separate MariaDB one because the two are for all practical purposes identical).</li>
<li>The connection string lives in <code>connection.url</code>, minus the username/password because there are separate properties for these. Note though that we have included the socket option here.</li>
<li>Username and, if you need it, password go in separate properties.</li>
<li>The connection pool is really important for performance in real applications, but we don't bother with that here and just say one connection per thread (we don't use multiple threads in our program so it doesn't matter as much).</li>
<li><code>show_sql</code> is a debuging property that prints all generated SQL to standard output. This is useful to know about when debugging your own applications.</li>
<li>Finally, we list all the classes we want Hibernate to take care of. In SPE, you are going to use the Spring Framework which takes care of this automatically, but for now we're listing them all.</li>
</ul>
<p>The classes themselves are standard Java value classes (private fields, public getter/setter) decorated with JPA annotations to explain to Hibernate how they work:</p>
<pre><code class="language-java">import javax.persistence.Entity;
import javax.persistence.Id;

@Entity
public class Party {
    @Id private int id;
    private String name;
    
    public Party() {}
    
    public int getId()      { return id; }
    public String getName() { return name; }

    public void setId(int id)         { this.id = id; }
    public void setName(String name)  { this.name = name; }
}
</code></pre>
<ul>
<li><code>@Entity</code> means this is something that maps to a table in the database. By default, Hibernate guesses the table name from the class name, but you could change this with a parameter e.g. <code>@Entity(name="Parties")</code>.</li>
<li><code>@Id</code> indicates the primary key.</li>
</ul>
<p>The candidate class is a bit more interesting as it has foreign keys:</p>
<pre><code class="language-java">@ManyToOne 
@JoinColumn(name = "party")
private Party party;
</code></pre>
<ul>
<li><code>@ManyToOne</code> tells Hibernate that this is a foreign key for a many-to-one relationship (there is also <code>@ManyToMany</code>).</li>
<li><code>@JoinColumn</code> sets the name of the foreign key column, as the default here would be <code>party_id</code>.</li>
</ul>
<h2 id="example-application---querying"><a class="header" href="#example-application---querying">Example application - querying</a></h2>
<p>Let's look at the main class (Example.java). First, Hibernate uses a session factory to manage its own database connections and sessions:</p>
<pre><code class="language-java">import org.hibernate.SessionFactory;
import org.hibernate.Session;
import org.hibernate.cfg.Configuration;

public class Example implements AutoCloseable {

  SessionFactory sessionFactory;

  public Example() {
    sessionFactory = new Configuration().configure().buildSessionFactory();
  }

  public void close() {
    sessionFactory.close();
  }

  // ...
}
</code></pre>
<p>You get one from the global <code>Configuration</code> class, to which you could pass parameters to override the ones in the XML file if you wanted to (this would let you change settings in response to command line arguments, for example). A session factory is a resource, so we make our own example class a resource too which lets us run it like this:</p>
<pre><code class="language-java">public static void main(String[] args) {
    try (Example example = new Example()) {
        example.run();
    }
  System.out.println("Done.");
  System.exit(0);
}
</code></pre>
<p>The exit command at the end makes sure the program exits even if Hibernate still has a background thread running.</p>
<p>In the <code>run()</code> method, we use a Hibernate session, which manages a database connection:</p>
<pre><code class="language-java">try (Session session = sessionFactory.openSession()) {
    // code
}
</code></pre>
<p>We then have three examples of using Hibernate.</p>
<h3 id="loading-an-entity-by-id"><a class="header" href="#loading-an-entity-by-id">Loading an entity by ID</a></h3>
<pre><code class="language-java">Party p1 = session.get(Party.class, 1);
System.out.println("    The party with id=1 is: " + p1.getName());
</code></pre>
<p>To fetch an instance by id, we just call <code>get</code> on the session with the class we want and the id. Passing the class both tells Hibernate which table to load from, and it tells the compiler what type of object to return - the way Java generics work, this lets us assign the result to a <code>Party</code> variable directly without having to do a cast.</p>
<h3 id="loading-with-a-query"><a class="header" href="#loading-with-a-query">Loading with a query</a></h3>
<pre><code class="language-java">TypedQuery&lt;Ward&gt; query = session.createQuery("FROM Ward", Ward.class);
List&lt;Ward&gt; wards = query.getResultList();
System.out.println("  Wards:");
for (Ward ward : wards) {
    System.out.println("    " + ward.getName());
}
</code></pre>
<p>A <code>TypedQuery</code> object takes a string in HQL, Hibernate's own query language (based on SQL) and the class of the object to return - this is so that the Java compiler can figure out the return type. <code>getResultList</code> returns all results as a list.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>The <code>TypedQuery</code> interface is part of JPA and is declared roughly as follows:</p>
<pre><code class="language-java">interface TypedQuery&lt;T&gt; {
  // ...
  List&lt;T&gt; getResultList();
}
</code></pre>
<p>This use of generics allows the compiler to be sure that the return type matches the type parameter you gave when you created the query. Of course, you don't create it directly but you ask for a query object from the Hibernate session, but behind the scenes there's an <a href="https://docs.jboss.org/hibernate/orm/5.2/javadocs/org/hibernate/query/internal/QueryImpl.html">org.hibernate.query.internal.QueryImpl<T></a> as well as many other Hibernate-related implementation classes.</p>
<p>These classes could take the type parameter as an argument to their constructor, but if you <a href="https://github.com/hibernate/hibernate-orm/blob/master/hibernate-core/src/main/java/org/hibernate/query/internal/QueryImpl.java">look at the sources</a>, they don't: it seems that Hibernate does a cast internally to get the types right, which is safe as long as the Hibernate developers know what they're doing.</p>
</div>
</div>
<h3 id="queries-with-joins-and-parameters"><a class="header" href="#queries-with-joins-and-parameters">Queries with joins and parameters</a></h3>
<p>For a more involved example, we look at the following:</p>
<pre><code class="language-java">TypedQuery&lt;Candidate&gt; q = session.createQuery("FROM Candidate c WHERE c.party.name = :name", Candidate.class);
q.setParameter("name", "Labour");
List&lt;Candidate&gt; candidates = q.getResultList();
System.out.println("  Labour Candidates:");
for (Candidate c : candidates) {
    System.out.println("    " + c.getName() + " (" + c.getWard().getName() + ")");
}
</code></pre>
<p>HQL, like SQL, allows a WHERE clause to filter results. It also allows prepared statements, but goes one better than JDBC in that parameters can have names. You declare a parameter with a colon in the query string (<code>:name</code>) and then use <code>setParameter(name, value)</code> to bind it - this method is written so that it can take a value of any type, presumably with a combination of overloading for int/float types and <code>Object</code> for everything else.</p>
<p>Hibernate will automatically do the JOINs necessary to fetch the party associated with each Candidate, the SQL it runs for this query looks like this on my machine:</p>
<pre><code class="language-SQL">select party0_.id as id1_1_0_, party0_.name as name2_1_0_ from Party party0_ 
where party0_.id=?

select candidate0_.id as id1_0_, candidate0_.name as name2_0_, 
candidate0_.party as party4_0_, candidate0_.votes as votes3_0_, 
candidate0_.ward as ward5_0_ from Candidate candidate0_ 
cross join Party party1_ where candidate0_.party=party1_.id and party1_.name=?
</code></pre>
<p>Hibernate has decided to do two queries here (maybe in parallel, so the order the statements are printed on the terminal may not be accurate). The first one is because if there is no party with the supplied name, then Hibernate can stop and return an empty list; if there is then it continues with the second query to join the two tables.</p>
<h2 id="the-n1-problem"><a class="header" href="#the-n1-problem">The N+1 problem</a></h2>
<p>Note that in the queries above, Hibernate does not fetch the ward names. It doesn't matter here because they are already in Hibernate's cache from the previous query. However, if you comment out the first two queries and leave only the third one (lines 41-50 in Example.java), something horrible happens:</p>
<pre><code class="language-SQL">select candidate0_.id as id1_0_, candidate0_.name as name2_0_, candidate0_.party as party4_0_, candidate0_.votes as votes3_0_, candidate0_.ward as ward5_0_ from Candidate candidate0_ cross join Party party1_ where candidate0_.party=party1_.id and party1_.name=?
select party0_.id as id1_1_0_, party0_.name as name2_1_0_ from Party party0_ where party0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
select ward0_.id as id1_2_0_, ward0_.electorate as electora2_2_0_, ward0_.name as name3_2_0_ from Ward ward0_ where ward0_.id=?
</code></pre>
<p>Hibernate is firing off one query per ward! This is called the N+1 problem, because one HQL query that returns N results ends up producing N+1 SQL queries, which is horribly inefficient expecialy for large N.</p>
<p>Looking at the loop structure:</p>
<pre><code class="language-java">TypedQuery&lt;Candidate&gt; q = session.createQuery("FROM Candidate c WHERE c.party.name = :name", Candidate.class);
q.setParameter("name", "Labour");
List&lt;Candidate&gt; candidates = q.getResultList();
System.out.println("  Labour Candidates:");
for (Candidate c : candidates) {
    System.out.println("    " + c.getName() + " (" + c.getWard().getName() + ")");
}
</code></pre>
<p>From the query itself, it is not clear to Hibernate whether ward names will be needed or not, so Hibernate does not JOIN them by default which would be more efficient if you don't actually need them. In the for loop at the bottom however, you do access the names, so on every pass through the loop, Hibernate is forced to run a new query to get the name of the relevant ward.</p>
<div class="advanced container">
<header><span class="advanced-title"></span></header>
<div class="container-content">
<p>How does Hibernate trigger a query off a simple <code>.getWard().getName()</code>, that you have implemented yourself in the Candidate and Ward classes?</p>
<p>The answer is that instead of actual Candidate objects, Hibernate creates a proxy subclass of Candidate at runtime and returns instances of this instead. These proxy objects have <code>getWard()</code> overridden to fire off another query if, and only if, they are actually called.</p>
</div>
</div>
<p>The solution here is to tell Hibernate at query time that you'll need the wards:</p>
<pre><code class="language-java">TypedQuery&lt;Candidate&gt; q = session.createQuery("FROM Candidate c JOIN FETCH c.ward WHERE c.party.name = :name", Candidate.class);
</code></pre>
<p>This is HQL for "I'm going to use the wards, so please do a JOIN to load them too". And Hibernate now uses a single query for the Candidates again:</p>
<pre><code class="language-SQL">select party0_.id as id1_1_0_, party0_.name as name2_1_0_ from Party party0_ where party0_.id=?

select candidate0_.id as id1_0_0_, ward1_.id as id1_2_1_, candidate0_.name as name2_0_0_,
candidate0_.party as party4_0_0_, candidate0_.votes as votes3_0_0_,
candidate0_.ward as ward5_0_0_, ward1_.electorate as electora2_2_1_,
ward1_.name as name3_2_1_
from Candidate candidate0_
inner join Ward ward1_ on candidate0_.ward=ward1_.id
cross join Party party2_
where candidate0_.party=party2_.id and party2_.name=?
</code></pre>
<p>There is another way to solve this problem: if every time you load a Candidate, you want the ward name to be loaded as well, then you can declare this on the JPA annotation:</p>
<pre><code class="language-java">@ManyToOne(fetch = FetchType.EAGER)
</code></pre>
<h2 id="exercise-1-1"><a class="header" href="#exercise-1-1">Exercise 1</a></h2>
<p>Implement a JPA/Hibernate example application for the census database using the Country, Region, County and Ward tables (ignore Statistic/Occupation for this exercise). You could implement the following in your main program for example:</p>
<ul>
<li>Given a ward code, load the ward and print out all related information (ward name, county name etc.).</li>
<li>Given a ward name, print out all the counties that have a ward with that name.</li>
</ul>
<p>Pay attention to avoiding the N+1 problem in the second case.</p>
<h2 id="exercise-2-1"><a class="header" href="#exercise-2-1">Exercise 2</a></h2>
<p>What you have learnt so far will allow you to navigate upwards in the hierarchy, e.g. given a ward you can find its associated county. This exercise is about the other way round: given a county object, you want to find all wards in it.</p>
<p>To do this, add the following property to your County class:</p>
<pre><code class="language-java">@OneToMany(mappedBy = "county")
private List&lt;Ward&gt; wards;
</code></pre>
<p>The argument to <code>mappedBy</code> must be the field name of the field in the Ward class that contains the county reference - you might have called it <code>parent</code> or something else in your class.</p>
<p>Then, add a getter and setter for this list property.</p>
<p>You have now created what is called a <em>bidirectional association</em>: a ward contains a county property, and a county contains a list of wards. You can navigate in both directions in your Java code.</p>
<p>Write a query that loads the City of Bristol county (E06000023) and prints a list of all its ward names with a Java for loop starting from the county object. Make sure you write your HQL query so that you don't cause an N+1 problem here.</p>
<p>This example also helps to explain why we don't make everything eager fetched by default: if you did that with bidirectional associations, then loading any object at all would load the entire database into memory!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sqlite"><a class="header" href="#sqlite">SQLite</a></h1>
<p><a href="https://sqlite.org/index.html">SQLite</a> is a really good tool for "just getting stuff done", especially when you hit the limits of Microsoft Excel (or other spreadsheet software).</p>
<p>According to <a href="https://sqlite.org/index.html">its authors</a>, SQLite is used in some form in every single Windows 10, Mac, Android and iOS device as well as built into the Firefox, Chrome (including Edge) and Safari browsers: the browsers store their browsing history and cookies in SQLite-format databases and you can manually edit these with the command line tool if you like.</p>
<p>Currently in version 3.34.1, the command-line program is called <code>sqlite3</code> and exists for all major operating systems, you should be able to download it as a single file executable, put in in any folder you like and just run it. On Alpine, you can install the <code>sqlite</code> package with <code>apk</code>.</p>
<p>SQLite is an embedded database, which means there is no separate server process. Databases are simply files. When you run the command line tool, the tool fulfils both the client and server roles at once; when you use SQLite from a program, the SQLite driver also acts as the "server".</p>
<h2 id="census-exercise"><a class="header" href="#census-exercise">Census exercise</a></h2>
<p>You will need the census files from databases activity 1: make a folder with the <code>setup.sql</code> file and the census csv files.</p>
<p>Download or install sqlite and run <code>sqlite3 census.db</code> to create a database file.</p>
<p>To create the tables, the command <code>.read setup.sql</code> reads and executes the commands in a file (similar to <code>source</code> on the shell). SQLite system commands start with a dot and do not take a semicolon at the end - see <code>.help</code> for a list. (Don't run the <code>import.sql</code> file, that's MariaDB-specific.)</p>
<p>Use <code>.tables</code> to show the tables and check that they have been created. With <code>.schema Ward</code> for example you can show the create statement for a single table.</p>
<p>The source data is in simple CSV files, for example if (back on the shell) you did a <code>head -n 5 County.csv</code> you would see this:</p>
<pre><code>E09000001,"City of London",E12000007,E92000001
E09000002,"Barking and Dagenham",E12000007,E92000001
E09000003,Barnet,E12000007,E92000001
E09000004,Bexley,E12000007,E92000001
E09000005,Brent,E12000007,E92000001
</code></pre>
<p>which matches the following, from the setup script:</p>
<pre><code>CREATE TABLE County (
    code VARCHAR(10) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    parent VARCHAR(10),
    country VARCHAR(10),

    FOREIGN KEY (parent) REFERENCES Region(code),
    FOREIGN KEY (country) REFERENCES Country(code)
);
</code></pre>
<p>To import the data, run the following on the SQLite prompt:</p>
<pre><code>.mode csv
.header off
.import Country.csv Country
.import Region.csv Region
.import County.csv County
.import Ward.csv Ward
.import Occupation.csv Occupation
.import Statistic.csv Statistic
</code></pre>
<p>You should now have all the data imported and you could try any SQL queries from the previous exercises in this database. The SQL dialect of SQLite is not entirely the same as MariaDB: for example, SQLite can do INNER and LEFT OUTER JOIN (and CROSS JOIN) but it cannot do RIGHT OUTER or FULL OUTER JOIN.</p>
<p>SQLite is also extremely forgiving when it comes to data types: it treats types more or less as comments, so it will let you store a string in an integer column if you try. You can also write a CREATE TABLE statement and just leave out the types, SQLite will not mind. SQLite also <em>does not enforce your FOREIGN KEY constraints by default</em>, though you can <a href="https://sqlite.org/foreignkeys.html">turn this on</a> if you want to. These are all design choices made by the SQLite developers that might or might not be the best ones for any particular use case.</p>
<h2 id="modes-and-file-output"><a class="header" href="#modes-and-file-output">Modes and file output</a></h2>
<p>SQLite has different ways of displaying a table of data. Try <code>.mode csv</code>, <code>.header on</code> then <code>SELECT * FROM Region;</code> to see the regions as a CSV file with headers (mode and header settings apply until you change them or quit SQLite). If you want to actually produce a CSV file, <code>.once FILENAME</code> tells SQLite to send the result of the following query only to a file, so you can work on a query until it does what you want, then run the <code>.once</code> command and re-run the query (SQLite supports readline on most platforms so the UP key gets the last line back) to send it to a file.</p>
<p>The default mode, <code>list</code>, shows columns separated by bar characters. You can also try <code>.mode column</code> which is a bit more human-readable, printing in lined-up columns with spaces in between. Or, if you want to include a table in a HTML page, <code>.mode html</code> prints the table with HTML tags. If you are on your host OS (not the alpine VM) and you have Excel installed, <code>.excel</code> opens the result of the following query in Excel.</p>
<p>You have now learned an extremely powerful way to analyze data that is presented to you in one or more CSV files - or any data format that you can easily export to CSV (for example most Excel files).</p>
<h2 id="sqlite-from-java"><a class="header" href="#sqlite-from-java">SQLite from Java</a></h2>
<p>You can access a SQLite database from a Java program by using the JDBC driver. In Maven, declare the following dependency:</p>
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;org.xerial&lt;/groupId&gt;
  &lt;artifactId&gt;sqlite-jdbc&lt;/artifactId&gt;
  &lt;version&gt;3.34.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>The connection string takes the format <code>jdbc:sqlite:FILEPATH</code>. An absolute path to a file should always work (you have to spell it out and not use the <code>~</code> shortcut though), or if you are running a JAR file from the same folder as the database file then just giving the file name with no path should work too.</p>
<p>Exercise: write a minimal Maven/Java application that prints the region names from the sqlite database you just created.</p>
<h2 id="sqlite-from-python"><a class="header" href="#sqlite-from-python">SQLite from Python</a></h2>
<p>Python is a great language for Data Science, and if you ever need to connect to a SQLite database from Python then here is how:</p>
<pre><code class="language-python"># you may have to 'pip install sqlite3'
import sqlite3
with sqlite3.connect('FILENAME') as connection:
    cursor = connection.cursor()
    for row in cursor.execute('SELECT * FROM Ward WHERE name LIKE ?', WARDNAME):
        # do something with row
        print(row)
</code></pre>
<ul>
<li>The <code>with</code> statement is the equivalent to Java's try-with-resources.</li>
<li>The <code>execute</code> statement executes a prepared statement. You put the statement itself in the first arguments, then the values to replace the placeholders as additional arguments.</li>
<li>The <code>execute</code> command returns an iterator that you can loop over, the rows themselves are python tuples (you can also do <code>.fetchall()</code> to get them in a list).</li>
</ul>
<p>See <a href="https://docs.python.org/3/library/sqlite3.html">the Python sqlite documentation</a> for more information.</p>
<p>One important warning here: if you write any data to the database, you have to call <code>connection.commit()</code> afterwards otherwise the data will not actually be written to disk.</p>
<h2 id="sqlite-from-c"><a class="header" href="#sqlite-from-c">SQLite from C</a></h2>
<p>The final exercise here is to write a C program, following the instructions in the slides, that reads your SQLite <code>census.db</code>, iterates over the regions table and prints "Region NAME is code CODE", where NAME/CODE are replaced with the region's name and code.</p>
<p>Of course you need to handle potential errors from the <code>sqlite3_</code> functions: it's only safe to continue if they return <code>SQLITE_OK</code>.</p>
<p>You will need to install the <code>sqlite-dev</code> package which contains the <code>sqlite3.h</code> header file, and link against the library with <code>-lsqlite3</code> in your <code>gcc</code> command.</p>
<p>If you are using <code>sqlite3_exec</code> with a callback function, the callback must return 0 on success and nonzero if it encountered an error, which will in turn cause <code>sqlite_exec</code> to return an error too.</p>
<p>For other methods, see <a href="https://www.sqlite.org/cintro.html">the SQLite C API</a>. For example <code>sqlite3_step</code> lets you iterate over the rows of a SQL result without using a callback function.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
